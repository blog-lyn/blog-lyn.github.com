<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />



  <meta name="description" content="Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes" />




  <meta name="keywords" content="Lyn's blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta property="og:type" content="website">
<meta property="og:title" content="Lyn's Blog">
<meta property="og:url" content="http://lyn.s76.org/index.html">
<meta property="og:site_name" content="Lyn's Blog">
<meta property="og:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lyn's Blog">
<meta name="twitter:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Lyn's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36568696-2', 'auto');
  ga('send', 'pageview');

</script>








  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lyn's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Node.js Angular.js Express.js HTML5 Mongodb Programing Notes</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/06/04/commit-formart-rules/" itemprop="url">
                  commit-formart-rules
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2017-06-04T22:14:02+08:00" content="2017-06-04">
              2017-06-04
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="如何规范_commit_comment">如何规范 commit comment</h1><h2 id="为什么要把commit标准化?">为什么要把commit标准化?</h2><h3 id="好处:">好处:</h3><ul>
<li>可以根据标准的格式自动生成changelog.md</li>
<li>可以更好的给自己的工作归类</li>
<li>他人也可以更好地理解你的代码提交的历史记录</li>
</ul>
<h3 id="例如:">例如:</h3><hr>
<figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">feat(分享功能)</span>: 添加了分享功能</div><div class="line"></div><div class="line"><span class="haml">这里是对commit的详细描述</span></div><div class="line">-<span class="ruby"> 这里是还是描述内容<span class="number">1</span></span></div><div class="line">-<span class="ruby"> 这里是还是描述内容<span class="number">2</span></span></div><div class="line">-<span class="ruby"> 这里是还是描述内容<span class="number">3</span></span></div><div class="line"></div><div class="line">Close #1</div></pre></td></tr></table></figure>
<p>changelog的生成结果如下:</p>
<h3 id="Features">Features</h3><ul>
<li><strong>分享功能:</strong> 添加了分享功能 (<a href="https://github.com/78e4b6e" target="_blank" rel="external">78e4b6e</a>) closes <a href="https://github.com/issues/1" target="_blank" rel="external">#1</a></li>
</ul>
<hr>
<h3 id="type">type</h3><p>其中<code>feat</code>代表的是<code>commit</code>的<code>type</code></p>
<p>可以使用如下类别：</p>
<ul>
<li>feat：新功能（feature）</li>
<li>fix：修补bug</li>
<li>doc：文档（documentation）</li>
<li>style： 代码风格或格式（不影响代码运行的变动）</li>
<li>refactor：重构（即不是新增功能，也不是修改bug的代码变动）</li>
<li>test：增加测试</li>
<li>build: 构建过程或辅助工具的变动</li>
<li>chore：其它类型提交,无关src目录以及test目录</li>
</ul>
<h3 id="scope">scope</h3><ul>
<li>括号里的<code>分享功能</code> 就是scope 指的是这一次commit的影响的内容</li>
<li>填名词类的</li>
</ul>
<h3 id="subject">subject</h3><p>其中的<code>添加了分享功能</code>就是subject</p>
<ul>
<li>subject是 commit 目的的简短描述。</li>
<li>以动词开头，使用第一人称现在时，比如change，而不是changed或changes</li>
<li>第一个字母小写</li>
<li>结尾不加句号（。）</li>
</ul>
<h3 id="Issue">Issue</h3><ul>
<li>关联 Issue:本次提交如果和摸个issue有关系则需要写上这个，格式如下：<br><code>Issue #1, #2, #3</code></li>
<li>关闭 Issue:如果当前提交信息解决了某个issue，那么可以在 Footer 部分关闭这个 issue，关闭的格式如下：<code>Close #1, #2, #3</code></li>
</ul>
<h2 id="可不可以工具来完成?">可不可以工具来完成?</h2><h3 id="交互式commit_comment工具">交互式commit comment工具</h3><p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-6-4/72487683.jpg" alt=""></p>
<p><a href="https://github.com/commitizen/cz-cli" target="_blank" rel="external">Commitizen</a>是一个撰写合格 Commit message 的工具。</p>
<p>我们可以使用它来完成.</p>
<p>安装以后，凡是用到git commit命令，一律改为使用<code>git cz -a</code>(如果运行前没有<code>git add</code> 的话工具会报错 <code>-a</code> 就相当于 <code>git commit -am &#39;msg&#39;</code>)。</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 先安装</span></div><div class="line">npm install commitizen -g</div><div class="line"></div><div class="line"><span class="comment">// 在project目录初始化</span></div><div class="line">commitizen init lyn-conventional-changelog --<span class="built_in">save</span>-<span class="built_in">dev</span> --<span class="built_in">save</span>-exact</div></pre></td></tr></table></figure>
<h3 id="changelog生成工具">changelog生成工具</h3><h4 id="安装_conventional-changelog-cli">安装 conventional-changelog-cli</h4><ul>
<li><code>npm install -g conventional-changelog-cli</code></li>
<li>在<code>package.json</code>的<code>scripts</code>中增加脚本:</li>
</ul>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"commit"</span>: <span class="string">"git-cz -a"</span>,</div><div class="line">    <span class="comment">// 全部重新生成changlog</span></div><div class="line">    <span class="string">"changelog"</span>: <span class="string">"conventional-changelog -p angular -i CHANGELOG.md -s -r 0"</span>,</div><div class="line">    <span class="comment">// 增量生成changelog 不会覆盖以前的changelog</span></div><div class="line">    <span class="string">"addChangeLog"</span>: <span class="string">"conventional-changelog -p angular -i CHANGELOG.md -s"</span></div><div class="line">  &#125;,</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h4 id="commit流程:">commit流程:</h4><ol>
<li>修改代码</li>
<li>Commit(提交)</li>
<li>运行ci</li>
<li>修改版本号(可选)</li>
<li>运行<code>npm run changelog</code>生成<code>changelog</code></li>
<li>commit<code>package.json</code> 和<code>CHANGELOG.md</code> </li>
<li>npm tag(可选)</li>
<li>push commit</li>
</ol>
<ul>
<li>生成好的changelog.md:</li>
</ul>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-6-4/37235873.jpg" alt=""></p>
<h2 id="commit_comment规则验证">commit comment规则验证</h2><p>如果需要校验每个人提交的commit都符合规范那么还需要如下两个工具:</p>
<h3 id="validate-commit-msg">validate-commit-msg</h3><p>用于检查项目Commit的 message 是否符合格式。</p>
<ul>
<li>安装<code>npm install --save-dev validate-commit-msg</code> </li>
<li><code>package.json</code>中增加scripts配置</li>
<li>增加<code>.vcmrc</code>配置文件</li>
</ul>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">	// 验证commit msg</div><div class="line">	<span class="string">"commitmsg"</span>: <span class="string">"validate-commit-msg"</span> </div><div class="line">    // 生成commit msg</div><div class="line">    <span class="string">"commit"</span>: <span class="string">"git-cz -a"</span>,</div><div class="line">    // 全部重新生成changlog</div><div class="line">    <span class="string">"changelog"</span>: <span class="string">"conventional-changelog -p angular -i CHANGELOG.md -s -r 0"</span>,</div><div class="line">    // 增量生成changelog 不会覆盖以前的changelog</div><div class="line">    <span class="string">"addChangeLog"</span>: <span class="string">"conventional-changelog -p angular -i CHANGELOG.md -s"</span></div><div class="line">  &#125;,</div><div class="line"> &#125;</div><div class="line"></div><div class="line">// 配置文件需要在project目录下 新建一个.vcmrc文件,内容如下:</div><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="string">"types"</span>: [<span class="string">"feat"</span>, <span class="string">"fix"</span>, <span class="string">"docs"</span>, <span class="string">"style"</span>, <span class="string">"refactor"</span>, <span class="string">"perf"</span>, <span class="string">"test"</span>, <span class="string">"chore"</span>, <span class="string">"revert"</span>], // <span class="keyword">default</span></div><div class="line">  <span class="string">"scope"</span>: &#123;</div><div class="line">    required: true, // <span class="keyword">default</span> false, </div><div class="line">    allowed: *, // <span class="keyword">default</span> is '*' for anything,</div><div class="line">    validate: false, // <span class="keyword">default</span>,</div><div class="line">    multiple: false // <span class="keyword">default</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"warnOnFail"</span>: false, // <span class="keyword">default</span></div><div class="line">  <span class="string">"maxSubjectLength"</span>: <span class="number">100</span>, // <span class="keyword">default</span></div><div class="line">  <span class="string">"subjectPattern"</span>: <span class="string">".+"</span>, // <span class="keyword">default</span></div><div class="line">  <span class="string">"subjectPatternErrorMsg"</span>: <span class="string">"subject does not match subject pattern!"</span>, // <span class="keyword">default</span></div><div class="line">  <span class="string">"helpMessage"</span>: <span class="string">""</span>, // <span class="keyword">default</span></div><div class="line">  <span class="string">"autoFix"</span>: false // <span class="keyword">default</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="hosky:_git_hook工具">hosky: git hook工具</h3><ul>
<li>安装: <code>npm install husky --save-dev</code></li>
<li>scripts中增加<code>&quot;precommit&quot;:&quot;npm run commitmsg&quot;</code>  </li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">	<span class="comment">//钩子函数</span></div><div class="line"><span class="symbol">	precommit:</span><span class="string">"npm run commitmsg"</span></div><div class="line">	<span class="comment">// 验证commit msg</span></div><div class="line">	<span class="string">"commitmsg"</span>: <span class="string">"validate-commit-msg"</span> </div><div class="line">    <span class="comment">// 生成commit msg</span></div><div class="line">    <span class="string">"commit"</span>: <span class="string">"git-cz -a"</span>,</div><div class="line">    <span class="comment">// 全部重新生成changlog</span></div><div class="line">    <span class="string">"changelog"</span>: <span class="string">"conventional-changelog -p angular -i CHANGELOG.md -s -r 0"</span>,</div><div class="line">    <span class="comment">// 增量生成changelog 不会覆盖以前的changelog</span></div><div class="line">    <span class="string">"addChangeLog"</span>: <span class="string">"conventional-changelog -p angular -i CHANGELOG.md -s"</span></div><div class="line">  &#125;,</div><div class="line"> &#125;</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/05/09/rule-learning/" itemprop="url">
                  规则学习学习笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2017-05-09T23:03:41+08:00" content="2017-05-09">
              2017-05-09
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="规则学习">规则学习</h1><h2 id="应用场景">应用场景</h2><blockquote>
<p>沃尔玛曾今对数据仓库中一年多的原始交易数据进行了详细的分析，发现与尿布一起被购买最多的商品竟然是啤酒。借助数据仓库和关联规则，发现了这个隐藏在背后的事实：美国的妇女经常会嘱咐丈夫下班后为孩子买尿布，而30%~40%的丈夫在买完尿布之后又要顺便购买自己爱喝的啤酒。根据这个发现，沃尔玛调整了货架的位置，把尿布和啤酒放在一起销售，大大增加了销量。</p>
</blockquote>
<h3 id="推荐场景">推荐场景</h3><p> <img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-5-7/85818585-file_1494088146071_6fb5.png" alt=""></p>
<h2 id="Apriori算法">Apriori算法</h2><p>关联规则学习算法</p>
<h3 id="Apriori性质：">Apriori性质：</h3><ul>
<li>任一频繁项集(frequent item set)的所有非空子集也必须是频繁的，反之，如果某个候选的非空子集不是频繁的，那么该候选肯定不是频繁的，从而可以将其删除。</li>
</ul>
<h3 id="评估的指标">评估的指标</h3><ul>
<li>支持度/覆盖率(support/coverage)</li>
<li>置信度/准确度(confidence/accuracy)</li>
<li>提升度 (lift)</li>
</ul>
<h3 id="支持度/覆盖率(support/coverage)">支持度/覆盖率(support/coverage)</h3><h4 id="Concept:">Concept:</h4><ul>
<li>支持度：P(A ∩ B)，A和B同时出现的概率. (沃尔玛购物篮的例子里尿布和啤酒同时购买的概率)</li>
</ul>
<h4 id="Example:">Example:</h4><ul>
<li>某天共有100个顾客到负一楼吃拉面，其中有10个顾客同时点了炒拉面和荷包蛋，那么上述规则的支持度就是10％。</li>
</ul>
<h3 id="置信度/准确度(confidence/accuracy)">置信度/准确度(confidence/accuracy)</h3><h4 id="Concept:-1">Concept:</h4><ul>
<li>置信度confidence=P(B|A)=P(AB)/P(A),指的是发生事件A的基础上又发生事件B的概率。</li>
</ul>
<h4 id="Example:-1">Example:</h4><ul>
<li>炒拉面 =&gt; 荷包蛋 (support=10%, confidence=60%)，</li>
<li>表示:当天所有顾客中的中有10%的顾客同时点了炒拉面和荷包蛋，并且点了炒拉面的顾客中有60%也点了荷包蛋.</li>
</ul>
<h3 id="查找频繁集(frequent_item_set)">查找频繁集(frequent item set)</h3><p>过程为:</p>
<ol>
<li>扫描所有子元素 </li>
<li>计算support</li>
<li>比较support</li>
<li>产生频繁项集(穷尽组合)</li>
<li>连接(加入候选)、剪枝(从后选中删除)，产生候选项集.  </li>
</ol>
<p>重复步骤（1）~（5）直到候选集为空.</p>
<h4 id="Example:-2">Example:</h4><p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-5-7/49910433-file_1494089240390_5e2e.png" alt=""></p>
<ol>
<li>连接：C3 &lt;= L2  [<code>{A,C},{B,C},{B,E},{C,E}</code>] =&gt;[<code>{A,B,C},{A,C,E},{B,C,E}</code>]</li>
<li>使用Apriori性质剪枝：频繁项集的所有子集必须是频繁的，对候选项C3，我们可以删除其子集为非频繁的选项：<ul>
<li>{A,B,C}的2项子集是{A,B},{A,C},{B,C}，其中{A,B}不是L2的元素，所以删除这个选项；</li>
<li>{A,C,E}的2项子集是{A,C},{A,E},{C,E}，其中{A,E} 不是L2的元素，所以删除这个选项；</li>
<li>{B,C,E}的2项子集是{B,C},{B,E},{C,E}，它的所有2－项子集都是L2的元素，因此保留这个选项。</li>
</ul>
</li>
<li>这样，剪枝后得到C3=[<code>{B,C,E}</code>]</li>
</ol>
<h3 id="缺点：">缺点：</h3><ul>
<li>在每一步产生侯选项目集时循环产生的组合过多，没有排除不应该参与组合的元素;</li>
<li>每次计算项集的支持度时，都对数据库D中的全部记录进行了一遍扫描比较，如果是一个大型的数据库的话，这种扫描比较会大大增加计算机系统的I/O开销。而这种代价是随着数据库的记录的增加呈现出几何级数的增加。</li>
<li>因此人们开始寻求更好性能的算法:FP-growth算法 </li>
</ul>
<h1 id="规则学习的概念Concept">规则学习的概念Concept</h1><p>规则学习(rule learning) 是从训练数据中学习出一组由原子命题组成的IF-THEN的规则,属于非监督学习的一种,常用被归属为分类的一种.</p>
<p>Examples:</p>
<ul>
<li>购买尿片 -&gt; 购买啤酒</li>
<li>(Blood Type = Warm) ∧ (Lay Eggs = Yes) → Birds</li>
</ul>
<h2 id="规则学习的规则分为两种:">规则学习的规则分为两种:</h2><h3 id="命题规则（propositional_rule）">命题规则（propositional rule）</h3><ul>
<li>由”原子命题”(propositional atom)和逻辑连接词 与、或、非和蕴含构成的简单陈述句。</li>
<li>Examples: <ul>
<li>Rule1: (胎生 = no) ∧ (会飞 = yes) → 鸟类</li>
<li>Rule2: (胎生 = no) ∧ (在水里生活 = yes) → 鱼类</li>
</ul>
</li>
</ul>
<h3 id="一阶规则(first-order_rule)">一阶规则(first-order rule)</h3><ul>
<li>不像命题规则只处理简单的陈述命题，一阶逻辑还额外包含了断言和量化。</li>
<li>一阶规则能表达复杂的关系，也被称为关系型规则(relational rule)。</li>
<li><p>Example:</p>
<ul>
<li><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/5cd315e97e458fa08ff143c5c287efbf12e9f765" alt=""></li>
</ul>
</li>
</ul>
<h2 id="生成规则的方法也分为两种:">生成规则的方法也分为两种:</h2><ul>
<li>直接生成法(Direct Method) : 直接从训练集中归纳出规则</li>
<li>间接生产法(Indirect Method) : 从决策树转换而来</li>
</ul>
<h1 id="直接法(Direct_Method)">直接法(Direct Method)</h1><h2 id="序列覆盖_(Sequencial_Covering)">序列覆盖 (Sequencial Covering)</h2><p>即逐条归纳：在训练集上每学习到一条规则，就将该规则覆盖的训练样例去除，然后以剩下的样例组成训练集重复上述过程，由于每次只处理一部分数据，因此也被称为分治(separate-and-conquer)的策略。</p>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-5-7/33027406-file_1494098757940_15bae.png" alt=""></p>
<p>Start with an empty rule: if ? Then b</p>
<ul>
<li><p>先给 “b” 找一个可能的规则:</p>
<ul>
<li>If x ≤ 1.2 then class = b</li>
</ul>
</li>
<li><p>在原有的基础上再增加一条规则直到接近完美:  </p>
<ul>
<li>If x &gt; 1.2 and y ≤ 2.6 then class = b</li>
</ul>
</li>
</ul>
<h3 id="规则产生的策略：">规则产生的策略：</h3><p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-5-7/63691173-file_1494130268720_3591.png" alt=""></p>
<ul>
<li>自顶向下（top-down）：从比较一般的规则开始，逐渐添加新文字以缩小规则覆盖范围，直到满足预定的条件为止。亦称“生成－测试”（generate-then-test）法，是规则逐渐“特化”（specialization）的过程。(类似决策树)</li>
<li>自底向上（bottom-top）：从比较特殊的规则开始，逐渐删除文字以扩大规则覆盖范围，直到满足条件为止，亦称数据驱动(data-driven)方法，是规则逐渐泛化(generalazation)的过程。</li>
</ul>
<h4 id="区别：">区别：</h4><ul>
<li>第一种策略更容易产生泛化性能更好的规则，第二种策略更适合于训练样本较少的情况。</li>
<li>第一种策略对噪声的鲁棒性比后者强。</li>
<li>命题规则学习中通常使用第一种策略.</li>
<li>第二种策略在一阶规则学习这类假设空间非常复杂的任务上使用<br>较多。</li>
</ul>
<h2 id="剪枝优化:">剪枝优化:</h2><ul>
<li>原因: 序列覆盖是一个贪心搜索的过程,需要机制来缓解过拟合的风险.</li>
<li>决策树一样分为: <code>预剪枝</code> 和 <code>后剪枝</code>.</li>
</ul>
<p>几种优化常用算法:</p>
<ul>
<li>PRISM算法,第一个提出序列覆盖的算法,基于准确率和覆盖率进行判断.</li>
<li>CN2算法 (第一个考虑过拟合的算法,预剪枝,基于AQ算法并结合ID3算法处理噪音数据,用熵对结果进行判断,熵越小则质量越高)</li>
<li>FOIL算法 (基于CN2算法的改进,基于FOIL Gain 进行质量判断,适用于一阶规则学习)<ul>
<li>Gain(R0, R1) = p1 [ log (p1/(p1+n1)) – log (p0/(p0 + n0)) <img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-5-7/46972476-file_1494168211119_789a.png" alt=""></li>
</ul>
</li>
<li>REP算法 (Reduce Error Pruning) O(m^4),后剪枝,用准确率作为剪枝指标,先生存Rule集合,再剪枝.</li>
<li>IREP算法（Incremental REP） O(mlog^2m),后剪枝,相比REP高效,每生成一个规则就进行剪枝验证.</li>
<li>REIPPER算法 (基于IREP* 代替IREP的准确率, 防止局部最优,泛化性能好,学习速度比决策树更快)</li>
</ul>
<h3 id="REP算法(Reduce_Error_Pruning)">REP算法(Reduce Error Pruning)</h3><ol>
<li>将样例集划分为训练集和验证集，</li>
<li>从训练集上学得规则集R后进行多轮剪枝，在每一轮穷举所有可能的剪枝操作，</li>
<li>然后用验证集对剪枝产生的所有候选规则集进行(accuracy= f+/n)比较，保留最好的规则集进行下一轮剪枝.(也可以理解为如果错误增加了,就剪掉,否则保留)</li>
<li>复杂度为O(m^4)。</li>
</ol>
<p>其中: f+ = # of positive instances covered by rule </p>
<h3 id="IREP算法(Incremental_Reduce_Error_Pruning)">IREP算法(Incremental Reduce Error Pruning)</h3><ol>
<li>在生成每条规则之前，先将当前样例集划分为训练集和验证集，</li>
<li>在训练集上生成一条规则r，</li>
<li>立即在验证集上对其进行REP剪枝，得到规则r’；</li>
<li>将r’覆盖的样例去除，</li>
<li>在更新后的样例集上重复上述过程。</li>
</ol>
<h4 id="区别:">区别:</h4><ul>
<li>REP是针对规则集进行剪枝，</li>
<li>IREP 仅对单条规则进行剪枝，因此后者更高效。</li>
</ul>
<h3 id="REIPPER算法(Repeated_Incremental_Pruning_to_Produce_Error_Reduction)">REIPPER算法(Repeated Incremental Pruning to Produce Error Reduction)</h3><p>WEKA(Weka是由新西兰怀卡托大学用Java开发的数据挖掘常用软件)中JRIP实现了REIPPER</p>
<p>使用IREP* 代替IREP的准确率(accuracy= f+/n)来作为评判标准:</p>
<ul>
<li>Gain(R0, R1) = p1 [ log (p1/(p1+n1)) – log (p0/(p0 + n0)) ] </li>
</ul>
<pre><code>-<span class="ruby">  <span class="symbol">p0:</span> <span class="comment"># of positive instances covered by R0</span>
</span>-<span class="ruby">  <span class="symbol">n0:</span> <span class="comment"># of negative instances covered by R0</span>
</span>-<span class="ruby">  <span class="symbol">p1:</span> <span class="comment"># of positive instances covered by R1</span>
</span>-<span class="ruby">  <span class="symbol">n1:</span> <span class="comment"># of negative instances covered by R1 </span></span>
</code></pre><p>将剪枝机制和其他一些后处理手段结合起来,防止局部最优,对规则集进行优化。</p>
<h1 id="间接方法(Indirect_Method)">间接方法(Indirect Method)</h1><ul>
<li>从决策树生成:</li>
</ul>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-5-7/32070981-file_1494099432991_f7c7.png" alt=""></p>
<h1 id="与决策树的比较">与决策树的比较</h1><ul>
<li>规则学习每次只考虑当前的分类,而不考虑对其他规则的分类造成什么影响.(只考虑自己不管别的)</li>
<li>决策树则需要使用<code>ID3决策树算法</code>,<code>C4.5决策树算法</code>,<code>CART决策树算法</code> 来保证把样本空间划分为不重叠的等价类,每个分类的的纯度更高.(顾全大局)</li>
<li>然而因为规则学习不顾大局,更简单,所以复杂度更低.</li>
</ul>
<h1 id="总结:">总结:</h1><p>在富含结构信息和领域知识的任务中,逻辑表达的重要性凸现出来,所以发展的趋势是概率统计和规则学习相结合(如:关系贝叶斯网(retional Bayesian Network),在逻辑归纳程序设计中引入概率模型的”概率归纳逻辑程序设计”(probabilistic ILP)).</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/04/02/rxjs/" itemprop="url">
                  rxjs
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2017-04-02T15:44:47+08:00" content="2017-04-02">
              2017-04-02
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/03/02/Dependency-Injection-AMD-CMD/" itemprop="url">
                  从依赖注入（Dependency Injection）到AMD模式 CMD模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2017-03-02T21:34:13+08:00" content="2017-03-02">
              2017-03-02
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="什么是依赖注入呢？">什么是依赖注入呢？</h1><p>先看看维基百科的解释:</p>
<blockquote>
<p>控制反转（Inversion of Control，缩写为IoC），是面向对象编程中的一种设计原则，可以用来减低计算机代码之间的耦合度。其中最常见的方式叫做依赖注入（Dependency Injection，简称DI），还有一种方式叫“依赖查找”（Dependency Lookup）。通过控制反转，对象在被创建的时候，由一个调控系统内所有对象的外界实体，将其所依赖的对象的引用传递给它。也可以说，依赖被注入到对象中。</p>
</blockquote>
<p>也就是说依赖注入是为了降低代码之间的耦合度,但这样做的好处又是什么呢?<br>可以马上想到的一个好处就是提高代码的testablity.</p>
<p>我们通过下面的例子来理解</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPostTitleById</span>(<span class="params">id</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> fetch(<span class="string">`https://jsonplaceholder.typicode.com/posts/<span class="subst">$&#123;id&#125;</span>`</span>)</div><div class="line">        .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</div><div class="line">        .then(<span class="function"><span class="params">data</span> =&gt;</span> data.title)</div><div class="line">&#125;</div><div class="line"></div><div class="line">getPostTitleById(<span class="number">6</span>)</div><div class="line">.then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`Title is <span class="subst">$&#123;data&#125;</span>`</span>);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>当我们在浏览器里运行这段代码的时候,可以正常的执行.<br>但如果我们把这段代码放到node下面执行的时候,你就会发现报错了:</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">return</span> fetch(`<span class="javascript">https:<span class="comment">//jsonplaceholder.typicode.com/posts/$&#123; id &#125;</span></span>`)</div><div class="line">         ^</div><div class="line">ReferenceError: fetch <span class="keyword">is</span> <span class="keyword">not</span> defined</div></pre></td></tr></table></figure>
<p>这是因为我们的<code>getPostTitleById</code>这个函数的内部实际上依赖的是浏览器的window.fetch这个api.<br>有没有什么办法可以让我们的代码在node下也运行起来呢?</p>
<p>肯定会想到一个简单的办法:</p>
<ul>
<li>引入一个npm包,作为函数的外部变量.</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">const fetch = require('<span class="keyword">node</span><span class="title">-fetch</span>');</div></pre></td></tr></table></figure>
<p>但是:</p>
<ul>
<li>如果我们想单独测试这个函数呢?</li>
<li>如果我们不知道这个函数内部依赖的<code>api</code>的名字呢?或者内部依赖的名字改变了呢?代码一样失效了.</li>
</ul>
<p>如何进一步的优化的呢?</p>
<h1 id="实现依赖注入?">实现依赖注入?</h1><p>众所周知在JavaScript中函数是一等公民,也就是函数实际上也是和String,Number,Array这样的变量可以作为函数的参数.最常用的的例子就是我们可以把函数最后一个参数写成回调函数.</p>
<ul>
<li>所以我们可以把我们依赖的函数作为参数传入函数内部作为一个函数局部作用域的局部变量使用.</li>
</ul>
<p>只需要简单的改造下我们的代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 将我们函数内部的依赖作为第一个参数传入到函数内部.</span></div><div class="line"> <span class="function"><span class="keyword">function</span> <span class="title">getPostTitleById</span>(<span class="params">fetch, id</span>) </span>&#123;</div><div class="line">   <span class="keyword">return</span> fetch(<span class="string">`https://jsonplaceholder.typicode.com/posts/<span class="subst">$&#123;id&#125;</span>`</span>)</div><div class="line">        .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</div><div class="line">        .then(<span class="function"><span class="params">data</span> =&gt;</span> data.title)</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"><span class="comment">// 下面两种调用方式可以把我们想要的api传入进去,</span></div><div class="line"><span class="comment">// node 下 使用npm包</span></div><div class="line"> getPostTitleById(fetch, <span class="number">6</span>)</div><div class="line">  .then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Title is <span class="subst">$&#123;data&#125;</span>`</span>);</div><div class="line">  &#125;)</div><div class="line"></div><div class="line"><span class="comment">// 浏览器下使用 window.fetch</span></div><div class="line"> getPostTitleById(<span class="built_in">window</span>.fetch, <span class="number">6</span>)</div><div class="line">  .then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Title is <span class="subst">$&#123;data&#125;</span>`</span>);</div><div class="line">  &#125;)</div></pre></td></tr></table></figure>
<ul>
<li>依赖注入的概念就是这么简单的实现了.</li>
</ul>
<h1 id="为什么要这样?">为什么要这样?</h1><ul>
<li>通过这样做,很明显降低能代码之间的耦合度.</li>
<li>在自动化测试中,如果有依赖注入那么我们可以通过各种模拟来使得测试会变得更加简单和有效.</li>
</ul>
<p>我们来实现一下上面的例子的测试用例,来说明这样做的好处~</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">describe(<span class="string">'getPostTitleById'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  it(<span class="string">'should call the right url'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="regexp">//</span>实现一个自定义的fetch函数,用于测试api的接口url正确</div><div class="line">    const fakeFetch = <span class="function"><span class="params">(url)</span> =&gt;</span> &#123;</div><div class="line">      assert(</div><div class="line">         url.indexOf(<span class="string">'https://jsonplaceholder.typicode.com/posts'</span>) !== <span class="number">-1</span></div><div class="line">       )</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Promise(<span class="function"><span class="params">(resolve)</span> =&gt;</span> &#123;</div><div class="line"></div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">    getPostTitleById(fakeFetch, <span class="number">6</span>);</div><div class="line">  &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">describe(<span class="string">'getPostTitleById'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  it(<span class="string">'should parse the json response into object'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="regexp">//</span>实现一个fetch来返回一个promise对象,promise对象中包含一个json方法,json方法会resolve 一个对象.</div><div class="line">    const fakeFetch = <span class="function"><span class="params">(url)</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> Promise.resolve(&#123;</div><div class="line">        json: <span class="function"><span class="params">()</span> =&gt;</span> Promise.resolve(&#123;</div><div class="line">          userId: <span class="number">1</span>,</div><div class="line">          id: <span class="number">6</span>,</div><div class="line">          title: <span class="string">'dolorem eum magni eos aperiam quia'</span>,</div><div class="line">          body: <span class="string">'ut aspernatur corporis harum nihil quis provident sequi\nmollitia nobis aliquid molestiae\nperspiciatis et ea nemo ab reprehenderit accusantium quas\nvoluptate dolores velit et doloremque molestiae'</span>,</div><div class="line">        &#125;),</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">    getPostTitleById(fakeFetch, <span class="number">6</span>);</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>通过上面的代码不难看出:</p>
<ul>
<li>这样的测试用例更加独立灵活且可以实现方便的定制.</li>
</ul>
<p>这时候我们可能会想到管理依赖的两种常见模块化规范:AMD和CMD了.</p>
<h1 id="AMD规范">AMD规范</h1><p>require.js是 AMD规范的代表.</p>
<p>有没有好奇他们具体是怎么实现依赖管理的呢?</p>
<p>require.js 核心的两个函数<code>require</code>和<code>define</code></p>
<p>其中<code>require</code>是 入口函数(main函数)以及设置依赖模块的路径(理解为src)等.</p>
<ol>
<li>加载require.js文件读取main.js.</li>
<li>解析main.js里的绝对引用路径和相对引用路径.</li>
<li>从入口文件开始解析依赖.</li>
<li>把需要加载的依赖的路径创建Script标签.设置onload事件把依赖的factory赋值给依赖缓存对象.</li>
<li>当所有依赖onload事件都完成时,将依赖通过形参传递到factory的作用域里.</li>
<li>如果依赖的factory还有别的依赖则会递归查找依赖</li>
</ol>
<h1 id="CMD规范">CMD规范</h1><p>相比于AMD而言 CMD的代表Sea.js 的理念是类似lazyload 这样的懒加载理念,也就是就近加载,<br>那他是怎么实现的呢?</p>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/17-3-25/91725590-file_1490414828813_16764.jpg" alt=""></p>
<ol>
<li>通过 use 方法来加载入口模块，并接收一个回调函数， 当模块加载完成， 会调用回调函数，并传入对应的模块作为参数。</li>
<li>从缓存或创建并加载 来获取到模块后，等待模块（包括模块依赖的模块）加载完成会调用回调函数。</li>
<li>在图片虚线部分中，加载factory及分析出模块的依赖，按依赖关系递归执行 document.createElement(‘script’) 。</li>
<li>Sea.js中不能声明依赖的识别Id,而是使用路径作为依赖的Id.</li>
</ol>
<h1 id="requireJs和_seaJs的区别">requireJs和 seaJs的区别</h1><p>SeaJS按需执行依赖避免浪费，但是require时才解析的行为对性能有影响。<br>SeaJS是异步加载模块的没错, 但执行模块的顺序也是严格按照模块在代码中出现(require)的顺序。</p>
<p>RequireJS更遵从js异步编程方式，提前执行依赖，输出顺序取决于哪个 js 先加载完（不过 RequireJS 从 2.0 开始，也改成可以延迟执行）。如果一定要让 模块B 在 模块A 之后执行，需要在 define 模块时申明依赖，或者通过 require.config 配置依赖。</p>
<p>如果两个模块之间突然模块A依赖模块B：SeaJS的懒执行可能有问题，而RequireJS不需要修改当前模块。</p>
<p>当模块A依赖模块B，模块B出错了：如果是SeaJS，模块A执行了某操作，可能需要回滚。RequireJS因为尽早执行依赖可以尽早发现错误，不需要回滚。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/02/19/generator-yield/" itemprop="url">
                  Generators  入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2017-02-19T22:20:18+08:00" content="2017-02-19">
              2017-02-19
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>相比起ES6中引入的其他概念 Generator 算是一个比较难以理解的 <code>黑科技</code>了.</p>
<p>Generator的引入使得js中的异步调用语法更像是同步语法.但是yield 一开始接触的时候,总给人感觉难以理解.</p>
<p>今天总结下Generator的用法.</p>
<h1 id="配置环境">配置环境</h1><h2 id="package-json">package.json</h2><p>为了在node中使用es6语法,先创建package.json,用babel来转换es6语法</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"generator"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="attr">"description"</span>: <span class="string">"about generator"</span>,</div><div class="line">  <span class="attr">"main"</span>: <span class="string">"main.js"</span>,</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"start"</span>: <span class="string">"babel-node main.js"</span>,</div><div class="line">    <span class="attr">"build"</span>: <span class="string">"babel src --out-dir lib"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</div><div class="line">  <span class="attr">"license"</span>: <span class="string">"MIT"</span>,</div><div class="line">  <span class="attr">"dependencies"</span>: &#123;</div><div class="line">    <span class="attr">"node-fetch"</span>: <span class="string">"^1.6.3"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"babel-cli"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-core"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-destructuring"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-modules-commonjs"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-parameters"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-spread"</span>: <span class="string">"^6.8.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-strict-mode"</span>: <span class="string">"^6.18.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="-babelrc">.babelrc</h2><p>和package.json同一级目录下的<code>.babelrc</code> 是babel的配置文件.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="attr">"plugins"</span>: [</div><div class="line">    <span class="string">"transform-strict-mode"</span>,</div><div class="line">    <span class="string">"transform-es2015-modules-commonjs"</span>,</div><div class="line">    <span class="string">"transform-es2015-spread"</span>,</div><div class="line">    <span class="string">"transform-es2015-destructuring"</span>,</div><div class="line">    <span class="string">"transform-es2015-parameters"</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="从一个简单的异步调用开始">从一个简单的异步调用开始</h1><p>除了<code>generator</code>,es6中还引入了<code>promise</code>,我们先使用<code>promise</code>和<code>fetch</code> 来实现一个简单的异步调用</p>
<p>关于<code>fetch</code>是xhr的升级实现:</p>
<ul>
<li>对generator/yield，async/await 更加友好,它将返回结果包装在promise中.</li>
<li>提供了对response.json()的转换方法提供对json数据的原生支持.</li>
<li>更多细节参考:<code>https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch</code></li>
</ul>
<h2 id="promise异步调用代码如下:">promise异步调用代码如下:</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"></div><div class="line">fetch(<span class="string">'http://jsonplaceholder.typicode.com/posts/1'</span>)</div><div class="line"> .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</div><div class="line"> .then(<span class="function"><span class="params">post</span> =&gt;</span> post.title)</div><div class="line"> .then(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Title is:'</span>, x))</div></pre></td></tr></table></figure>
<h3 id="运行:">运行:</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bash-<span class="number">3.2</span>$ npm <span class="literal">start</span></div><div class="line"></div><div class="line">&gt; generator@<span class="number">1.0</span>.<span class="number">0</span> <span class="literal">start</span> </div><div class="line">&gt; babel-<span class="keyword">node</span> <span class="title">main</span>.js</div><div class="line"></div><div class="line">Title is: sunt aut facere repellat provident occaecati excepturi optio reprehenderit</div></pre></td></tr></table></figure>
<h2 id="试试generator_:">试试generator :</h2><h3 id="引入co">引入<code>co</code></h3><p><code>npm install co --save</code></p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"><span class="keyword">const</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> <span class="built_in">url</span> = <span class="string">'http://jsonplaceholder.typicode.com/posts/1'</span>;</div><div class="line">  <span class="keyword">const</span> response = <span class="keyword">yield</span> fetch(<span class="built_in">url</span>);</div><div class="line">  <span class="keyword">const</span> post = <span class="keyword">yield</span> response.json();</div><div class="line">  <span class="keyword">const</span> title = post.title;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Title is:'</span>, title);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="运行结果:">运行结果:</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bash-<span class="number">3.2</span>$ npm <span class="literal">start</span></div><div class="line"></div><div class="line">&gt; generator@<span class="number">1.0</span>.<span class="number">0</span> <span class="literal">start</span>  </div><div class="line">&gt; babel-<span class="keyword">node</span> <span class="title">main</span>.js</div><div class="line"></div><div class="line">Title is: sunt aut facere repellat provident occaecati excepturi optio reprehenderit</div><div class="line">bash-<span class="number">3.2</span>$</div></pre></td></tr></table></figure>
<h2 id="实现一个函数取代co">实现一个函数取代<code>co</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">generator</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> iterator = generator();</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'iterator:'</span>, iterator);</div><div class="line">  <span class="keyword">const</span> iteration = iterator.next();</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'iteration:'</span>, iteration);</div><div class="line">  <span class="keyword">const</span> promise = iteration.value;</div><div class="line">  promise.then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> anotherIterator = iterator.next(response);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'anotherIterator :'</span>, anotherIterator);</div><div class="line">    <span class="keyword">const</span> anotherPromise = anotherIterator.value;</div><div class="line">    anotherPromise.then(<span class="function"><span class="params">post</span> =&gt;</span> iterator.next(post));</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line">run(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> url = <span class="string">'http://jsonplaceholder.typicode.com/posts/1'</span>;</div><div class="line">  <span class="keyword">const</span> response = <span class="keyword">yield</span> fetch(url);</div><div class="line">  <span class="keyword">const</span> post = <span class="keyword">yield</span> response.json();</div><div class="line">  <span class="keyword">const</span> title = post.title;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Title is:'</span>, title);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="运行结果">运行结果</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">bash<span class="number">-3.2</span>$ npm start</div><div class="line"></div><div class="line">&gt; generator@<span class="number">1.0</span><span class="number">.0</span> start  </div><div class="line">&gt; babel-node main.js</div><div class="line"><span class="symbol"></span></div><div class="line">iterator: &#123;&#125;</div><div class="line"><span class="string">iteration:</span> &#123; <span class="string">value:</span> Promise &#123; &lt;pending&gt; &#125;, <span class="string">done:</span> <span class="literal">false</span> &#125;</div><div class="line"><span class="string">anotherIterator :</span> &#123; <span class="string">value:</span> Promise &#123; &lt;pending&gt; &#125;, <span class="string">done:</span> <span class="literal">false</span> &#125;</div><div class="line">Title <span class="string">is:</span> sunt aut facere repellat provident occaecati excepturi optio reprehenderit</div></pre></td></tr></table></figure>
<h2 id="使用递归">使用递归</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">generator</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> iterator = generator();</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">iterate</span>(<span class="params">iteration</span>) </span>&#123;</div><div class="line">  	 <span class="comment">//终止条件</span></div><div class="line">    <span class="keyword">if</span> (iteration.done) <span class="keyword">return</span> iteration.value;</div><div class="line">    <span class="keyword">const</span> promise = iteration.value;</div><div class="line">    <span class="comment">//递归调用iterate</span></div><div class="line">    <span class="keyword">return</span> promise.then(<span class="function"><span class="params">x</span> =&gt;</span> iterate(iterator.next(x)))</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> iterate(iterator.next());</div><div class="line">&#125;</div><div class="line"></div><div class="line">run(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> url = <span class="string">'http://jsonplaceholder.typicode.com/posts/1'</span>;</div><div class="line">  <span class="keyword">const</span> response = <span class="keyword">yield</span> fetch(url);</div><div class="line">  <span class="keyword">const</span> post = <span class="keyword">yield</span> response.json();</div><div class="line">  <span class="keyword">const</span> title = post.title;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Title is:'</span>, title);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/02/14/redux-saga-js/" itemprop="url">
                  redux-saga的简单入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2017-02-14T21:37:45+08:00" content="2017-02-14">
              2017-02-14
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Redux-saga">Redux-saga</h1><p>在之前的blog中,我们在react应用中把油副作用的部分都放在了action函数中,把异步调用包装成一个thunk 函数.也能满足我们实际的需求,那为什么还需要redux-saga呢?</p>
<ol>
<li>redux-sage的异步调用部分,都是很标准的依赖注入(<code>dependencies injection</code>)的写法</li>
<li>因为有依赖注入的写法,我们可以很方便的在单元测试中使用一些fake函数来模拟异步调用.</li>
<li>综上saga实际上是在testablity上比thunk来处理异步更有优势.</li>
<li>由于使用了generator函数, 所以可以在局部保持一个state 来实现一些thunk不太方便实现的功能.</li>
<li>代码看上去更加类似同步编程(<code>sync</code>)</li>
</ol>
<p>劣势:</p>
<ol>
<li><code>generator</code> 和 <code>yield</code>的概念,无疑增加团队的学习成本.  </li>
</ol>
<h1 id="安装">安装</h1><p>很简单: <code>npm intsall redux-saga --save</code></p>
<h1 id="middleWare">middleWare</h1><p>为了拦截到指定的action,我们需要在middleware中监听指定的<code>action.type</code></p>
<p>所以我们在createStore时候需要在middleware中加入 redux-saga</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  applyMiddleware,</div><div class="line">  createStore,</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">import</span> createSageMiddleWare <span class="keyword">from</span> <span class="string">'redux-saga'</span>;</div><div class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'redux-logger'</span>;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducers'</span>;</div><div class="line"><span class="keyword">import</span> rootSaga <span class="keyword">from</span> <span class="string">'./services/sagas'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 创建saga中间件实例</span></div><div class="line"><span class="keyword">const</span> sagaMiddleware = createSageMiddleWare();</div><div class="line"><span class="comment">// 将saga中间件合并到redux中间件数组集合中.</span></div><div class="line"><span class="keyword">const</span> middleware = applyMiddleware(sagaMiddleware, logger());</div><div class="line"></div><div class="line"><span class="comment">//依赖于 reducers和 中间件来创建一个Store.</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> createStore(reducer, middleware);</div><div class="line"></div><div class="line"><span class="comment">// 需要在创建Store以后通过run()方法调用rootSaga</span></div><div class="line">sagaMiddleware.run(rootSaga);</div></pre></td></tr></table></figure>
<h1 id="sagas">sagas</h1><ul>
<li>我们先把<code>rootsaga</code> <code>watchsaga</code> <code>workersaga</code> 写在一个文件中 <code>./services/sagas.js</code></li>
<li>当文件大了以后可以进行拆分.</li>
<li>调用顺序如下:</li>
</ul>
<ol>
<li>rootsaga 被middleware调用 </li>
<li><code>rootsaga</code>中<code>yield</code>引用 <code>watchsaga</code></li>
<li><code>watchsaga</code>中调用具体的<code>worker</code>来执行异步操作. </li>
</ol>
<h2 id="常用Api:">常用Api:</h2><ul>
<li><code>take</code> 获取指定类型(action.type)的action.</li>
<li><code>takeEvery</code> 多个action 每个都会触发.</li>
<li><code>takelatest</code> 多个action时,只执行最后一个,自动cancel前面take的actions</li>
<li><code>call</code> 阻塞式异步调用,第一个参数是要调用的generator函数,后面的参数是传递的参数.会阻塞直到promise返回结果.如果阻塞时有其他action,那么这些action都会错过,不会被执行.</li>
<li><code>fork</code> 非阻塞时调用,可以理解为子任务单独处理.每个action都会得到处理,不会错过执行的时机.</li>
<li><code>put</code>  相当于是<code>disptach</code>函数,用于在generator中dispatch <code>action</code></li>
<li><code>cancel</code>  可以取消fork出来的子任务, 将在当前执行的任务中抛出一个 SagaCancellationException 类型的异常,可以通过try catch捕捉到,但是这个错误并不会向上冒泡.</li>
<li><code>race</code> 返回先完成的任务,自动cancel其他的.参考如下:</li>
</ul>
<hr>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">import &#123; race, take, <span class="keyword">put</span> &#125; from <span class="string">'redux-saga/effects'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">fetchPostsWithTimeout</span><span class="params">()</span> &#123;</span></div><div class="line">  const &#123;posts, timeout&#125; = yield race(&#123;</div><div class="line">    posts   : <span class="keyword">call</span>(fetchApi, <span class="string">'/posts'</span>),</div><div class="line">    timeout : <span class="keyword">call</span>(delay, <span class="number">1000</span>)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(posts)&#123;</div><div class="line">  	<span class="keyword">put</span>(&#123;<span class="built_in">type</span>: <span class="string">'POSTS_RECEIVED'</span>, posts&#125;)</div><div class="line">  &#125;</div><div class="line">   </div><div class="line">  <span class="keyword">else</span>&#123;</div><div class="line">  	<span class="keyword">put</span>(&#123;<span class="built_in">type</span>: <span class="string">'TIMEOUT_ERROR'</span>&#125;)</div><div class="line">  &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="rootsaga">rootsaga</h2><p>这里yield了一个数组,素组中的generator是并发执行的.不会相互影响.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; take, fork, call, put &#125; <span class="keyword">from</span> <span class="string">'redux-saga/effects'</span>;</div><div class="line"><span class="keyword">import</span> &#123; takeEvery &#125; <span class="keyword">from</span> <span class="string">'redux-saga'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> [</div><div class="line">    watchPostRequests(),</div><div class="line">  ];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="watchsaga">watchsaga</h2><p>监听<code>FETCH_POSTS</code>类型的action.并且调用fetchPost函数.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">watchPostRequests</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> takeEvery(<span class="string">'FETCH_POSTS'</span>, fetchPost);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>takeEvery</code> 与下面的<code>while(true){ yield fork()}</code>的写法实现同样效果.</li>
</ul>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//The watcher: watch actions and coordinate worker tasks</span></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">watchPostRequests</span>(<span class="params"></span>) </span>&#123;</div><div class="line"> <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">    <span class="keyword">const</span> <span class="built_in">url</span> = <span class="string">'/api/posts'</span>;</div><div class="line">    <span class="keyword">const</span> action = <span class="keyword">yield</span> take(<span class="string">'FETCH_POSTS'</span>);</div><div class="line">     <span class="built_in">console</span>.log(<span class="string">'catch action from dispatch'</span>, action);</div><div class="line">     <span class="keyword">yield</span> fork(fetchPost, <span class="built_in">url</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="workersaga">workersaga</h2><p>使用<code>call</code>阻塞式的执行异步调用.直到返回结果后使用<code>put</code>来dispatch action.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> axios from <span class="string">'axios'</span>;</div><div class="line"></div><div class="line"><span class="comment">// The worker: perform the requested task</span></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">fetchPost</span>(<span class="params">action</span>) </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'catch action from dispatch'</span>, action);</div><div class="line">    <span class="keyword">yield</span> put(&#123; <span class="keyword">type</span>: <span class="string">'FETCH_POSTS_PENDING'</span> &#125;);</div><div class="line">    <span class="keyword">const</span> res = <span class="keyword">yield</span> call(axios.get, <span class="string">'/api/posts'</span>);</div><div class="line">    <span class="keyword">yield</span> put(&#123;</div><div class="line">      <span class="keyword">type</span>: <span class="string">'FETCH_POSTS_FULFILLED'</span>,</div><div class="line">      payload: res.data.data,</div><div class="line">    &#125;);</div><div class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    <span class="keyword">yield</span> put(&#123;</div><div class="line">      <span class="keyword">type</span>: <span class="string">'FETCH_POSTS_REJECTED'</span>,</div><div class="line">      payload: e.message,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="参考:">参考:</h1><ul>
<li><a href="http://leonshi.com/redux-saga-in-chinese/docs/advanced/ComposingSagas.html" target="_blank" rel="external">http://leonshi.com/redux-saga-in-chinese/docs/advanced/ComposingSagas.html</a></li>
<li><a href="https://github.com/superRaytin/redux-saga-in-chinese" target="_blank" rel="external">https://github.com/superRaytin/redux-saga-in-chinese</a></li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/12/25/kcp/" itemprop="url">
                  kcp-config
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-12-25T22:10:21+08:00" content="2016-12-25">
              2016-12-25
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Kcptun">Kcptun</h1><p>项目地址:<a href="https://github.com/xtaci/kcptun" target="_blank" rel="external">https://github.com/xtaci/kcptun</a></p>
<h1 id="效果:">效果:</h1><p>先看下效果:<br><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-12-25/58961318-file_1482679564423_934a.png" alt=""></p>
<h2 id="运行逻辑:">运行逻辑:</h2><blockquote>
<p>将TCP包转成加密的UDP包,能以比 TCP 浪费10%-20%的带宽的代价，换取平均延迟降低 30%-40%，且最大延迟降低三倍的传输效果。</p>
<p>Kcptun 是KCP 协议的一个简单应用，可以用于任意 TCP 网络程序的传输承载，以提高网络流畅度，降低掉线情况。由于 Kcptun 使用 Go 语言编写，内存占用低（经测试，在64M内存服务器上稳定运行），而且适用于所有平台，甚至 Arm 平台。</p>
</blockquote>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-12-25/72476905-file_1482677511680_6e9f.png" alt=""></p>
<h1 id="服务端自动安装">服务端自动安装</h1><p>kcptun 一键安装脚本:</p>
<h2 id="kcp-server:">kcp-server:</h2><blockquote>
<p><a href="https://github.com/clangcn/kcp-server" target="_blank" rel="external">https://github.com/clangcn/kcp-server</a></p>
</blockquote>
<h3 id="Install">Install</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget --no-check-certificate https://github.com/clangcn/kcp-server/raw/master/install-kcp-server.sh -O ./install-kcp-server.sh</div><div class="line">chmod 500 ./install-kcp-server.sh</div><div class="line">./install-kcp-server.sh install</div></pre></td></tr></table></figure>
<h3 id="UnInstall">UnInstall</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./install-kcp-server.sh uninstall</div></pre></td></tr></table></figure>
<h3 id="Update">Update</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./install-kcp-server.sh update</div></pre></td></tr></table></figure>
<h3 id="服务器管理">服务器管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Usage: /etc/init.d/kcp-server &#123;start|stop|restart|status&#125;</div></pre></td></tr></table></figure>
<h1 id="手动安装">手动安装</h1><p>步骤:</p>
<ol>
<li>使用<code>wget</code>下载解压到有权限的目录,可以使用 <code>chown</code>改变文件夹所有者为自己解决权限问题,</li>
<li>给解压出来的程序添加运行权限<code>chmod +x ./server_linux_amd64</code>.</li>
<li>开放TCP要使用的防火墙的端口.<code>UDP</code>和<code>TCP</code>都打开</li>
<li>在解压目录下配置配置文件 config.json,配置本地的ss服务器地址为<code>127.0.0.1</code></li>
<li>在服务器上增加启动脚本<code>start.sh</code> 或者直接运行<code>./server_linux_amd64 -c /你的配置文件路径/config.json</code> 来启动服务端程序</li>
<li>在本地增加启动脚本或者直接运行<code>./client_darwin_amd64 -c /你的配置文件路径/config.json</code> 来启动客户端程序</li>
<li>rc.local中设置开机任务</li>
</ol>
<h2 id="关于下载:">关于下载:</h2><p>分别在sever上和client端下载对应的版本,每个压缩包里都包含一个可以运行的客户端和服务端(client_linux_amd64和server_linux_amd64).</p>
<p>比如:</p>
<ul>
<li>server上使用wget下载linux版本(kcptun-linux-amd64-20161222.tar.gz,并使用./server_linux_amd64 运行),</li>
<li>本地使用的Mac的编译版本 (kcptun-darwin-amd64-20161222.tar.gz)</li>
</ul>
<p>Ps:</p>
<ul>
<li>下载地址: <a href="https://github.com/xtaci/kcptun/releases" target="_blank" rel="external">https://github.com/xtaci/kcptun/releases</a> </li>
<li>注意 sever和client上的版本需要一致.</li>
</ul>
<h2 id="关于配置防火墙">关于配置防火墙</h2><h3 id="配置iptables的方式">配置iptables的方式</h3><p>在/etc/iptables.firewall.rules 中增加</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-A INPUT -<span class="selector-tag">p</span> udp --dport 你的vRay2端口 -j ACCEPT</div></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo iptables-restore &lt; /etc/iptables<span class="selector-class">.firewall</span><span class="selector-class">.rules</span> <span class="comment">//加载配置的iptables 规则</span></div><div class="line"></div><div class="line">sudo iptables -L  <span class="comment">//查看是否配置生效</span></div></pre></td></tr></table></figure>
<h3 id="ufw配置防火墙">ufw配置防火墙</h3><p>如果觉得iptable太麻烦可以使用ufw<br>首先，用如下命令来检查下系统上是否已经安装了 UFW 。</p>
<ul>
<li><code>$ sudo dpkg --get-selections | grep ufw</code></li>
</ul>
<p>如还没有安装，可以使用 apt 命令来安装，如下所示：</p>
<ul>
<li><code>$ sudo apt-get install ufw</code></li>
</ul>
<h4 id="常用命令:">常用命令:</h4><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo ufw  status        <span class="comment">//查询显示ufw状态以及规则</span></div><div class="line">sudo ufw  enable|disable|<span class="built_in">reload</span> <span class="comment">//启动\关闭\重启</span></div><div class="line">sudo ufw logging on|off|LEVEL   <span class="comment">//日志 启动\关闭\级别</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>                      <span class="built_in">Action</span>      <span class="keyword">From</span></div><div class="line">--                     ------      ----</div><div class="line"><span class="number">24</span>                      ALLOW       Anywhere</div></pre></td></tr></table></figure>
<h4 id="配置端口:">配置端口:</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 把25替换成你的kcptun端口</span></div><div class="line">ufw allow <span class="number">25</span>/udp </div><div class="line"></div><div class="line"><span class="meta"># 可以使用这个命令为动态端口需要开放一段端口(这个例子中是12290~12300这个10个端口) </span></div><div class="line">sudo ufw allow <span class="number">12290</span>:<span class="number">12300</span>/udp </div><div class="line"></div><div class="line"><span class="meta">#检查是否生效</span></div><div class="line">sudo ufw  status</div></pre></td></tr></table></figure>
<h2 id="关于kcp配置参数:">关于kcp配置参数:</h2><h3 id="两端参数必须一致的有:">两端参数必须一致的有:</h3><ul>
<li>datashard –前向纠错 默认 10</li>
<li>parityshard –前向纠错 默认 3</li>
<li>nocomp –是否关闭压缩 默认 false</li>
<li>key –密钥 建议自己设置</li>
<li>crypt –加密算法 建议使用aes128以上的加密方式</li>
</ul>
<p>其余为两边可独立设定的参数</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">GLOBAL OPTIONS:</div><div class="line">   --localaddr <span class="keyword">value</span>, -<span class="function">l <span class="keyword">value</span>   local listen <span class="title">address</span> (<span class="params"><span class="keyword">default</span>: <span class="string">":12948"</span></span>)</span></div><div class="line">   --remoteaddr <span class="keyword">value</span>, -r <span class="keyword">value</span>  kcp server <span class="title">address</span> (<span class="params"><span class="keyword">default</span>: <span class="string">"vps:29900"</span></span>)</div><div class="line">   --key <span class="keyword">value</span>                   pre-shared secret between client and <span class="title">server</span> (<span class="params"><span class="keyword">default</span>: <span class="string">"it's a secrect"</span></span>) [$KCPTUN_KEY]</div><div class="line">   --crypt <span class="keyword">value</span>                 aes, aes-128, aes-192, salsa20, blowfish, twofish, cast5, 3des, tea, xtea, xor, <span class="title">none</span> (<span class="params"><span class="keyword">default</span>: <span class="string">"aes"</span></span>)</div><div class="line">   --mode <span class="keyword">value</span>                  profiles: fast3, fast2, fast, <span class="title">normal</span> (<span class="params"><span class="keyword">default</span>: <span class="string">"fast"</span></span>)</div><div class="line">   --conn <span class="keyword">value</span>                  <span class="keyword">set</span> num of UDP connections to <span class="title">server</span> (<span class="params"><span class="keyword">default</span>: <span class="number">1</span></span>)</div><div class="line">   --autoexpire <span class="keyword">value</span>            <span class="keyword">set</span> auto expiration <span class="title">time</span>(<span class="params"><span class="keyword">in</span> seconds</span>) <span class="keyword">for</span> a single UDP connection, 0 to <span class="title">disable</span> (<span class="params"><span class="keyword">default</span>: <span class="number">0</span></span>)</div><div class="line">   --mtu <span class="keyword">value</span>                   <span class="keyword">set</span> maximum transmission unit <span class="keyword">for</span> UDP <span class="title">packets</span> (<span class="params"><span class="keyword">default</span>: <span class="number">1350</span></span>)</div><div class="line">   --sndwnd <span class="keyword">value</span>                <span class="keyword">set</span> send window <span class="title">size</span>(<span class="params">num of packets</span>) (<span class="params"><span class="keyword">default</span>: <span class="number">128</span></span>)</div><div class="line">   --rcvwnd <span class="keyword">value</span>                <span class="keyword">set</span> receive window <span class="title">size</span>(<span class="params">num of packets</span>) (<span class="params"><span class="keyword">default</span>: <span class="number">1024</span></span>)</div><div class="line">   --datashard <span class="keyword">value</span>             <span class="keyword">set</span> reed-solomon erasure coding - <span class="title">datashard</span> (<span class="params"><span class="keyword">default</span>: <span class="number">10</span></span>)</div><div class="line">   --parityshard <span class="keyword">value</span>           <span class="keyword">set</span> reed-solomon erasure coding - <span class="title">parityshard</span> (<span class="params"><span class="keyword">default</span>: <span class="number">3</span></span>)</div><div class="line">   --dscp <span class="keyword">value</span>                  <span class="keyword">set</span> <span class="title">DSCP</span>(<span class="params"><span class="number">6</span>bit</span>) (<span class="params"><span class="keyword">default</span>: <span class="number">0</span></span>)</div><div class="line">   --nocomp                      disable compression</div><div class="line">   --log <span class="keyword">value</span>                   specify a log file to output, <span class="keyword">default</span> goes to stderr</div><div class="line">   -c <span class="keyword">value</span>                      config <span class="keyword">from</span> json file, which will <span class="keyword">override</span> the command <span class="keyword">from</span> shell</div><div class="line">   --help, -h                    show help</div><div class="line">   --version, -v                 print the version</div></pre></td></tr></table></figure>
<h3 id="简易窗口自我调优方法：">简易窗口自我调优方法：</h3><ul>
<li>第一步：同时在两端逐步增大client rcvwnd和server sndwnd;</li>
<li>第二步：尝试下载，观察如果带宽利用率（服务器＋客户端两端都要观察）接近物理带宽则停止，否则跳转到第一步。</li>
</ul>
<p>Ps: 建议调整到能正常观看油管的程度就可以了,不要设置太高的client rcvwnd和server sndwnd 不然很容易被运营商封端口.(我这边电信只需要设置server的sndwnd:1024就可以实现观看10000kps的速度了)</p>
<h3 id="SS的设置">SS的设置</h3><p>SS设置只需要把原来配置中ss服务器IP替换成<code>127.0.0.1</code>即可, 因为KCP会监听config.json中localaddr字段设置的本地的SS端口,并自动转发到服务器端的端口上.</p>
<h3 id="客户端的config-json">客户端的config.json</h3><p>如果运行报错,记得删除所有注释</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"localaddr"</span>: <span class="string">":8888"</span>, <span class="comment">//本地需要被加速的端口</span></div><div class="line">  <span class="string">"remoteaddr"</span>: <span class="string">"服务端的ip地址:18888"</span>,<span class="comment">//服务端的kcp端口</span></div><div class="line">  <span class="string">"key"</span>: <span class="string">"你在服务器端设置的秘钥"</span>,</div><div class="line">  <span class="string">"crypt"</span>: <span class="string">"salsa20"</span>,<span class="comment">//加密方式 需要和服务器端一致</span></div><div class="line">  <span class="string">"mode"</span>: <span class="string">"fast"</span>,<span class="comment">//重传的频率 一般设置fast就可以了 重传的越多约浪费流量 响应就越快</span></div><div class="line">  <span class="string">"mtu"</span>: <span class="number">1350</span>,</div><div class="line">  <span class="string">"sndwnd"</span>: <span class="number">256</span>,</div><div class="line">  <span class="string">"rcvwnd"</span>: <span class="number">2048</span>,</div><div class="line">  <span class="string">"datashard"</span>:<span class="number">10</span>,</div><div class="line">  <span class="string">"parityshard"</span>: <span class="number">3</span>,</div><div class="line">  <span class="string">"dscp"</span>: <span class="number">0</span>,</div><div class="line">  <span class="string">"conn"</span>: <span class="number">1</span>,</div><div class="line">  <span class="string">"autoexpire"</span>: <span class="number">60</span>,</div><div class="line">  <span class="string">"nocomp"</span>: <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="服务端的config-json">服务端的config.json</h3><p>保存前,删除所有注释</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"listen"</span>: <span class="string">"服务器的ip地址:18888"</span>,<span class="comment">//服务端的kcp端口</span></div><div class="line">    <span class="string">"target"</span>: <span class="string">"127.0.0.1:8888"</span>, <span class="comment">//ss端口   </span></div><div class="line">    <span class="string">"key"</span>: <span class="string">"你的秘钥"</span>,<span class="comment">//加密方式 需要和客户端端一致</span></div><div class="line">    <span class="string">"crypt"</span>: <span class="string">"salsa20"</span>,<span class="comment">//加密方式 需要和服务器端一致</span></div><div class="line">    <span class="string">"mode"</span>: <span class="string">"fast"</span>,<span class="comment">//重传的频率 一般设置fast就可以了 重传的越多约浪费流量 响应就越快</span></div><div class="line">    <span class="string">"mtu"</span>: <span class="number">1350</span>,</div><div class="line">    <span class="string">"sndwnd"</span>: <span class="number">1024</span>,</div><div class="line">    <span class="string">"rcvwnd"</span>: <span class="number">2048</span>,</div><div class="line">    <span class="string">"datashard"</span>: <span class="number">10</span>,</div><div class="line">    <span class="string">"parityshard"</span>: <span class="number">3</span>,</div><div class="line">    <span class="string">"dscp"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"nocomp"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"acknodelay"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"nc"</span>: <span class="number">1</span>,</div><div class="line">    <span class="string">"sockbuf"</span>: <span class="number">4194304</span>,</div><div class="line">    <span class="string">"keepalive"</span>: <span class="number">10</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="启动脚本:">启动脚本:</h2><p>为了方便我们用vi写一个非常简单的启动脚本 命名为start.sh:</p>
<ol>
<li><p><code>vim start.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">nohup  /你的kcp路径/server_linux_amd64 -c /你的配置文件路径/config.json&gt; /dev/null  2&gt;&amp;1  &amp;</div></pre></td></tr></table></figure>
</li>
<li><p>给sh脚本增加运行权限:<code>chmod +x start.sh</code></p>
</li>
<li><p>编辑/etc/rc.local文件,增加一行:</p>
</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/你的kcp路径/</span>start.sh &amp;&gt;<span class="regexp">/dev/</span><span class="keyword">null</span> &amp;</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/12/22/v2ray-config/" itemprop="url">
                  v2ray-config
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-12-22T14:35:38+08:00" content="2016-12-22">
              2016-12-22
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="V2ray">V2ray</h1><h2 id="安装">安装</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">su //切换为root用户</div><div class="line"></div><div class="line">bash &lt;(curl -L -s https://install.direct/go.sh) //运行这一行命令</div><div class="line"></div><div class="line">bash &lt;(curl -L -s https://install.direct/go.sh)</div><div class="line">/dev/fd/63: line 88: /usr/bin/v2ray/v2ray: No such file<span class="built_in"> or </span>directory</div><div class="line">Installing V2Ray v2.10.5 on x86_64</div><div class="line">Downloading https://github.com/v2ray/v2ray-core/releases/download/v2.10.5/v2ray-linux-64.zip directly.</div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line">100   595    0   595    0     0    774      0 --:--:-- --:--:-- --:--:--   774</div><div class="line">100 2351k  100 2351k    0     0   157k      0  0:00:14  0:00:14 --:--:--  150k</div><div class="line">Extracting V2Ray package to /tmp/v2ray.</div><div class="line">Archive:  /tmp/v2ray/v2ray.zip</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/systemd/v2ray.service</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/systemv/v2ray</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/v2ray</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/vpoint_socks_vmess.json</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/vpoint_vmess_freedom.json</div><div class="line">PORT:27514</div><div class="line">UUID:d75cca2f-e955-4b32-b3fe-ba6f3e50b013</div><div class="line">Updating software repo via apt-get.</div><div class="line">Installing daemon via apt-get.</div><div class="line">Selecting previously unselected package daemon.</div><div class="line">(Reading database ... 31003 files<span class="built_in"> and </span>directories currently installed.)</div><div class="line">Preparing to unpack .../daemon_0.6.4-1_amd64.deb ...</div><div class="line">Unpacking daemon (0.6.4-1) ...</div><div class="line">Processing triggers for man-db (2.6.7.1-1ubuntu1) ...</div><div class="line">Setting up daemon (0.6.4-1) ...</div><div class="line"> Adding<span class="keyword"> system</span> startup for /etc/init.d/v2ray ...</div><div class="line">   /etc/rc0.d/K20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc1.d/K20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc6.d/K20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc2.d/S20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc3.d/S20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc4.d/S20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc5.d/S20v2ray -&gt; ../init.d/v2ray</div><div class="line">V2Ray v2.10.5 is installed.</div></pre></td></tr></table></figure>
<h2 id="配置防火墙">配置防火墙</h2><h3 id="配置iptables的方式">配置iptables的方式</h3><p>在/etc/iptables.firewall.rules 中增加</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-A INPUT -<span class="selector-tag">p</span> udp --dport 你的vRay2端口 -j ACCEPT</div></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo iptables-restore &lt; /etc/iptables<span class="selector-class">.firewall</span><span class="selector-class">.rules</span> <span class="comment">//加载配置的iptables 规则</span></div><div class="line"></div><div class="line">sudo iptables -L  <span class="comment">//查看是否配置生效</span></div></pre></td></tr></table></figure>
<h3 id="ufw配置防火墙">ufw配置防火墙</h3><p>如果觉得iptable太麻烦可以使用ufw<br>首先，用如下命令来检查下系统上是否已经安装了 UFW 。</p>
<ul>
<li><code>$ sudo dpkg --get-selections | grep ufw</code></li>
</ul>
<p>如还没有安装，可以使用 apt 命令来安装，如下所示：</p>
<ul>
<li><p><code>$ sudo apt-get install ufw</code></p>
</li>
<li><p>常用命令:</p>
</li>
</ul>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo ufw  status        <span class="comment">//查询显示ufw状态以及规则</span></div><div class="line">sudo ufw  enable|disable|<span class="built_in">reload</span> <span class="comment">//启动\关闭\重启</span></div><div class="line">sudo ufw logging on|off|LEVEL   <span class="comment">//日志 启动\关闭\级别</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>                      <span class="built_in">Action</span>      <span class="keyword">From</span></div><div class="line">--                     ------      ----</div><div class="line"><span class="number">24</span>                      ALLOW       Anywhere</div></pre></td></tr></table></figure>
<p>配置端口</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 把25替换成你的v2ray端口</span></div><div class="line">ufw allow <span class="number">25</span>/udp </div><div class="line"></div><div class="line"><span class="meta"># 可以使用这个命令为动态端口需要开放一段端口(这个例子中是12290~12300这个10个端口) </span></div><div class="line">sudo ufw allow <span class="number">12290</span>:<span class="number">12300</span>/udp </div><div class="line"></div><div class="line"><span class="meta">#检查是否生效</span></div><div class="line">sudo ufw  status</div></pre></td></tr></table></figure>
<h2 id="生成配置文件">生成配置文件</h2><ul>
<li>生成UUID:<a href="https://htfy96.github.io/v2ray-config-gen/#" target="_blank" rel="external">https://htfy96.github.io/v2ray-config-gen/#</a><br>推荐下面的方式来配置,比较简单(如果检查配置有报错的话,需要注意SS字段的level值应该是数字<code>1</code> 而不是字符串<code>&#39;1&#39;</code>):</li>
<li>web界面配置V2ray: <a href="https://htfy96.github.io/v2ray-config-gen/#" target="_blank" rel="external">https://htfy96.github.io/v2ray-config-gen/#</a></li>
<li>把生成好的服务端配置文件保存在 <code>/etc/v2ray/config.json</code>文件中</li>
<li>把生成的对应的客户端配置保存在本地的<code>config.json</code>文件中.</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"> &#123;</div><div class="line">  <span class="attr">"log"</span> : &#123;</div><div class="line">    <span class="attr">"access"</span>: <span class="string">"/var/log/v2ray/access.log"</span>,</div><div class="line">    <span class="attr">"error"</span>: <span class="string">"/var/log/v2ray/error.log"</span>,</div><div class="line">    <span class="attr">"loglevel"</span>: <span class="string">"warning"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">27514</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"d75cca2f-e955-4b32-b3fe-ba6f3e501113"</span>,</div><div class="line">          <span class="attr">"level"</span>: <span class="number">1</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outboundDetour"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"blackhole"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"blocked"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"routing"</span>: &#123;</div><div class="line">    <span class="attr">"strategy"</span>: <span class="string">"rules"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"rules"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">          <span class="attr">"ip"</span>: [            <span class="string">"0.0.0.0/8"</span>,</div><div class="line">            <span class="string">"10.0.0.0/8"</span>,</div><div class="line">            <span class="string">"100.64.0.0/10"</span>,</div><div class="line">            <span class="string">"127.0.0.0/8"</span>,</div><div class="line">            <span class="string">"169.254.0.0/16"</span>,</div><div class="line">            <span class="string">"172.16.0.0/12"</span>,</div><div class="line">            <span class="string">"192.0.0.0/24"</span>,</div><div class="line">            <span class="string">"192.0.2.0/24"</span>,</div><div class="line">            <span class="string">"192.168.0.0/16"</span>,</div><div class="line">            <span class="string">"198.18.0.0/15"</span>,</div><div class="line">            <span class="string">"198.51.100.0/24"</span>,</div><div class="line">            <span class="string">"203.0.113.0/24"</span>,</div><div class="line">            <span class="string">"::1/128"</span>,</div><div class="line">            <span class="string">"fc00::/7"</span>,</div><div class="line">            <span class="string">"fe80::/10"</span></div><div class="line">          ],</div><div class="line">          <span class="attr">"outboundTag"</span>: <span class="string">"blocked"</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"transport"</span>: &#123;</div><div class="line">    <span class="attr">"kcpSettings"</span>: &#123;</div><div class="line">      <span class="attr">"uplinkCapacity"</span>: <span class="number">2</span>,</div><div class="line">      <span class="attr">"downlinkCapacity"</span>: <span class="number">10</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="运行v2ray">运行v2ray</h1><p>使用以下命令可以指定配置文件启动v2ray</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">v2ray -<span class="built_in">config</span>  /etc/v2ray/<span class="built_in">config</span>.json</div></pre></td></tr></table></figure>
<h1 id="客户端运行">客户端运行</h1><p>在github上下载对应的系统版本的编译好的版本</p>
<ul>
<li><p><code>https://github.com/v2ray/v2ray-core/releases</code></p>
</li>
<li><p>解压到任意目录后,把上面生成的客户端配置文件保存到相同目录下 </p>
</li>
<li><p>在终端命令行中切换到解压的目录,使用这个命令运行 <code>./v2ray -config config.json</code> </p>
</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/10/15/docker-notes-01/" itemprop="url">
                  docker 笔记记录
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-10-15T14:48:55+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>工作中有一个工程需要运行在centos环境下,然而又不想在centos下进行编码和调试,于是就想还是用docker来映射container的端口到主机下,并且把代码的目录映射到centos的docker container中.这样就可以在本机中写代码和查看结果,并container中运行代码了.</p>
<p>几年前docker刚出来时,玩过几天,但是由于没有做笔记,把内容都忘光了,时隔几年,docker已经在微服务的互联网浪潮中大显光彩.趁此机会复习一下docker的常用命令.<br>于是有了下面的折腾过程:</p>
<p>简单解释的几个名词 :</p>
<ol>
<li>docker 当然指的就是蓝色的小鲸鱼啦  </li>
<li>container 是集装箱的意思 也就是鲸鱼背上的那些集装箱.也就是镜像运行的结果,我们代码运行的环境.</li>
</ol>
<h2 id="下载安装_Docker">下载安装 Docker</h2><p>首先把几年前装的旧版本先删除掉,再去官网下载docker的安装文件.</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 清理工作 先查看有哪些machine</div><div class="line"></div><div class="line">docker-machine <span class="keyword">ls</span> </div><div class="line">docker-machine <span class="keyword">rm</span> `docker-machine <span class="keyword">ls</span>`</div><div class="line">sudo <span class="keyword">rm</span> /usr/<span class="keyword">local</span>/bin/docker</div><div class="line">sudo <span class="keyword">rm</span> /usr/<span class="keyword">local</span>/bin/docker-compose</div><div class="line">sudo <span class="keyword">rm</span> /usr/<span class="keyword">local</span>/bin/docker-machine</div></pre></td></tr></table></figure>
<p>安装完成后小鲸鱼就会出现在任务栏中了.</p>
<p>windows版本需要windows10才支持docker,且需要打开hyper-V(打开后会与VMware有冲突).</p>
<h3 id="在Settings中增加镜像">在Settings中增加镜像</h3><p>找到Registry mirrors,增加网易docker镜像地址:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span><span class="comment">//hub.c.163.com</span></div></pre></td></tr></table></figure>
<h2 id="编写dockerFile">编写dockerFile</h2><p>内容如下:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Dockerfile</span></div><div class="line"></div><div class="line"><span class="keyword">FROM</span> centos:latest</div><div class="line"><span class="keyword">MAINTAINER</span> Lyn</div><div class="line"></div><div class="line"><span class="keyword">LABEL</span><span class="bash"> Name=<span class="string">"centos/tailorc"</span></span></div><div class="line"></div><div class="line"><span class="comment"># 上面是设置docker的镜像来源,下面是升级并安装项目依赖文件,并设置暴露的端口.</span></div><div class="line"><span class="comment"># RUN可以有多个 而CMD则指的是container执行后运行的命令.只能有一条,如果有多条那么只会运行最后一条.</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> yum --assumeyes --setopt=tsflags=nodocs update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> yum -y  install libevent gtk2 alsa-lib  libXt    </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> yum clean all</span></div><div class="line"><span class="keyword">EXPOSE</span> <span class="number">1306</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/bin/bash"</span>]</span></div></pre></td></tr></table></figure>
<h2 id="build_docker镜像">build docker镜像</h2><blockquote>
<p>注意:需要先切换到dockerFile的路径下</p>
<p>-f 参数 是指定dockerFile的路径. -t 则是为新建的镜像指定tag name和version</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd <span class="regexp">/Users/</span>Lyn<span class="regexp">/Tailor/</span></div><div class="line">docker build -f <span class="string">"/Users/Lyn/Tailor/dockerFile"</span> -t <span class="string">tailor:</span><span class="number">1.0</span> .</div></pre></td></tr></table></figure>
<p>build 成功以后可以通过<code>docker images</code>命令来查看系统中所有的docker镜像:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Lyn-Cheung-MBP:Tailor Lyn$ docker images</div><div class="line">REPOSITORY          <span class="keyword">TAG</span>                 <span class="title">IMAGE</span> ID            CREATED             SIZE</div><div class="line">tailor              <span class="number">1.0</span>                 <span class="number">74</span>f386530eb3        <span class="number">27</span> minutes ago      <span class="number">510</span> MB</div><div class="line">centos              latest              <span class="number">980</span>e0e4c79ec        <span class="number">5</span> weeks ago         <span class="number">196.8</span> MB</div></pre></td></tr></table></figure>
<h2 id="run_docker镜像">run docker镜像</h2><p>运行下面这个命令就会启动一个标签叫tailorC的container,并进入到container的终端中(输入exit 会退出terminal并关闭这个container的运行,可以通过<code>docker start &lt;container的name&gt;</code> 来重新启动container,通过<code>docker attach &lt;docker container name&gt;</code> 来进入terminal)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run  -v /Users/Lyn/folder:/opt/Tailor -<span class="selector-tag">p</span> <span class="number">1306</span>:<span class="number">1306</span>  --name tailorC  -t -<span class="selector-tag">i</span>  tailor:<span class="number">1.0</span></div></pre></td></tr></table></figure>
<h3 id="参数解析:">参数解析:</h3><ol>
<li>-v 指的是volume 把本地的目录映射挂载到container的指定目录中 </li>
<li>-p 指的是Port 把host主机的端口的浏览转发到container的指定端口</li>
<li>–name 指的是给container指定别名.</li>
<li>-t 指的是terminal 选项让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上</li>
<li>-i 则让容器的标准输入保持打开。</li>
</ol>
<p>最后跟着的是镜像的名字<br>也可以在镜像名字后面再跟上默认执行的[CMD]如果有这个参数那么就会覆盖dockerFile中的[CMD]命令</p>
<p>进入container的terminal以后就可以运行想要的运行的命令了.</p>
<h3 id="权限问题">权限问题</h3><p>如果要执行挂载进来的路径中的代码,需要注意两个问题:</p>
<ol>
<li>需要在docker的preference中设置允许挂载这个路径的文件.</li>
<li>在container中可能需要使用 <code>chmod -R 777 &lt;Container中具体路径位置&gt;</code> 命令来修改挂载目录的权限</li>
</ol>
<h3 id="访问container的服务">访问container的服务</h3><p>只要container中的服务启动<br>在本地的浏览器中 访问<code>http://127.0.0.1:1306/</code>就相当于是访问container中的1306端口了. </p>
<h2 id="查看运行的docker_container">查看运行的docker container</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker ps <span class="_">-a</span></div></pre></td></tr></table></figure>
<p>运行结果如下:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Lyn$ docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES</div><div class="line">80ac33b9d175        tailor:<span class="number">1.0</span>          <span class="string">"/bin/bash"</span>         <span class="number">4</span> hours ago         <span class="meta">Up</span> <span class="number">2</span> minutes        <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">1306</span>-&gt;<span class="number">1306</span>/tcp   tailorC</div></pre></td></tr></table></figure>
<h3 id="查看docker的网络配置">查看docker的网络配置</h3><p>当web服务有问题时,我们可以检查docker的网络配置</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Lyn$ docker network ls</div><div class="line">NETWORK ID          NAME                DRIVER              SCOPE</div><div class="line">18ed300147f8        bridge              bridge              <span class="built_in">local</span>               </div><div class="line"><span class="number">02d2c77c1549</span>        host                host                <span class="built_in">local</span>               </div><div class="line"><span class="number">8b3894017396</span>        none                null                <span class="built_in">local</span></div></pre></td></tr></table></figure>
<h3 id="查看具体的网络配置:">查看具体的网络配置:</h3><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">Lyn$ docker network inspect bridge</div><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"bridge"</span>,</div><div class="line">        <span class="string">"Id"</span>: <span class="string">"18ed300147f8ea03e7e94fc4ae289fdd50508c0fb8582520931843d409d9bf0b"</span>,</div><div class="line">        <span class="string">"Scope"</span>: <span class="string">"local"</span>,</div><div class="line">        <span class="string">"Driver"</span>: <span class="string">"bridge"</span>,</div><div class="line">        <span class="string">"EnableIPv6"</span>: false,</div><div class="line">        <span class="string">"IPAM"</span>: &#123;</div><div class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</div><div class="line">            <span class="string">"Options"</span>: null,</div><div class="line">            <span class="string">"Config"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"Subnet"</span>: <span class="string">"172.17.0.0/16"</span>,</div><div class="line">                    <span class="string">"Gateway"</span>: <span class="string">"172.17.0.1"</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"Internal"</span>: false,</div><div class="line">        <span class="string">"Containers"</span>: &#123;</div><div class="line">            <span class="string">"80ac33b9d175f91416cae336dfd52f4bcce5a0741dbb0c06d4c1c55d44d7d019"</span>: &#123;</div><div class="line">                <span class="string">"Name"</span>: <span class="string">"tailorC"</span>,</div><div class="line">                <span class="string">"EndpointID"</span>: <span class="string">"801d9177f10ac31475a3c1dcd2de46cbe1009c352fe1e12e6eae0888a705fdc5"</span>,</div><div class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:ac:11:00:02"</span>,</div><div class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"172.17.0.2/16"</span>,</div><div class="line">                <span class="string">"IPv6Address"</span>: <span class="string">""</span></div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"Options"</span>: &#123;</div><div class="line">            <span class="string">"com.docker.network.bridge.default_bridge"</span>: <span class="string">"true"</span>,</div><div class="line">            <span class="string">"com.docker.network.bridge.enable_icc"</span>: <span class="string">"true"</span>,</div><div class="line">            <span class="string">"com.docker.network.bridge.enable_ip_masquerade"</span>: <span class="string">"true"</span>,</div><div class="line">            <span class="string">"com.docker.network.bridge.host_binding_ipv4"</span>: <span class="string">"0.0.0.0"</span>,</div><div class="line">            <span class="string">"com.docker.network.bridge.name"</span>: <span class="string">"docker0"</span>,</div><div class="line">            <span class="string">"com.docker.network.driver.mtu"</span>: <span class="string">"1500"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"Labels"</span>: &#123;&#125;</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="清理_docker">清理 docker</h2><h3 id="删除指定的镜像">删除指定的镜像</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">docker</span> <span class="selector-tag">rmi</span> <span class="selector-tag">tailor</span><span class="selector-pseudo">:1.0</span></div></pre></td></tr></table></figure>
<h3 id="移除_dangling_镜像">移除 dangling 镜像</h3><p>dangling 指的也就是在build过程下载和产生的tag为none:none的镜像 </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">docker</span> images -qf dangling=<span class="literal">true</span> | xargs docker rmi</div></pre></td></tr></table></figure>
<h3 id="移除_dangling_volumes">移除 dangling volumes</h3><p>dangling 指的也就是在build过程下载和产生的tag为none:none的镜像 </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">volume</span><span class="bash"> ls -qf dangling=<span class="literal">true</span> | xargs -r docker volume rm</span></div></pre></td></tr></table></figure>
<h3 id="删除已经没有运行的containers">删除已经没有运行的containers</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">rm</span> `docker ps -aq`</div><div class="line"></div><div class="line"><span class="comment">//或者</span></div><div class="line">docker <span class="keyword">rm</span> $(docker ps -a -q)</div><div class="line"></div><div class="line">#windows下 :</div><div class="line"><span class="keyword">FOR</span> /f <span class="string">"tokens=*"</span> %i <span class="keyword">IN</span> ('docker ps -a -q') <span class="keyword">DO</span> docker <span class="keyword">rm</span> %<span class="built_in">i</span></div></pre></td></tr></table></figure>
<h3 id="kill_所有正在运行的_containers">kill 所有正在运行的 containers</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">kill</span> <span class="string">`docker ps -aq`</span></div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/10/15/functional_programming/" itemprop="url">
                  函数式编程笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-10-15T14:48:55+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="函数式编程?">函数式编程?</h1><blockquote>
<p>函数式编程是和传统命令式编程区分的一种编程思想，“在函数式编程语言中，函数是第一类的对象，也就是说，函数 不依赖于任何其他的对象而可以独立存在，而在面向对象的语言中，函数 ( 方法 ) 是依附于对象的，属于对象的一部分。这一点决定了函数在函数式语言中的一些特别的性质，比如作为传出 / 传入参数，作为一个普通的变量等。[1]”</p>
<p>函数式编程思想的源头可以追溯到 20 世纪 30 年代，数学家阿隆左 . 丘奇在进行一项关于问题的可计算性的研究，也就是后来的 lambda 演算。lambda 演算的本质为 一切皆函数，函数可以作为另外一个函数的输出或者 / 和输入，一系列的函数使用最终会形成一个表达式链，这个表达式链可以最终求得一个值，而这个过程，即为计算的本质。</p>
<p>然而，这种思想在当时的硬件基础上很难实现，历史最终选择了同丘奇的 lambda 理论平行的另一种数学理论：图灵机作为计算理论，而采取另一位科学家冯 . 诺依曼的计算机结构，并最终被实现为硬件。由于第一台计算机即为冯 . 诺依曼的程序存储结构，因此运行在此平台的程序也继承了这种基因，程序设计语言如 C/Pascal 等都在一定程度上依赖于此体系。</p>
<p>到了 20 世纪 50 年代，一位 MIT 的教授 John McCarthy 在冯 . 诺依曼体系的机器上成功的实现了 lambda 理论，取名为 LISP(LISt Processor), 至此函数式编程语言便开始活跃于计算机科学领域。</p>
</blockquote>
<h2 id="函数式编程的好处">函数式编程的好处</h2><h3 id="更少的Bug">更少的Bug</h3><p>函数式编程由于使用了高阶函数(Higher Order Function)通常来说比传统的命令式编程的代码,代码会少很多,每行代码也更容易被理解.这样出现bug的可能性会明显降低,代码的质量会明显更高一些.</p>
<h3 id="更少的coding时间">更少的coding时间</h3><p>相比于传统的命令式编程,函数式编程因为代码更少,而且函数式编程的可以复用更多的函数和代码,所以编程需要的时间会更少一些.</p>
<h1 id="环境配置">环境配置</h1><h2 id="package-json">package.json</h2><p>先配置一个package.json文件. 然后运行 <code>npm install</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"test"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="attr">"description"</span>: <span class="string">"es6"</span>,</div><div class="line">  <span class="attr">"main"</span>: <span class="string">"main.js"</span>,</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"start"</span>: <span class="string">"babel-node main.js"</span>,</div><div class="line">    <span class="attr">"build"</span>: <span class="string">"babel src --out-dir lib"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</div><div class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"babel-cli"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-core"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-destructuring"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-modules-commonjs"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-parameters"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-spread"</span>: <span class="string">"^6.8.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-strict-mode"</span>: <span class="string">"^6.18.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="配置Babel">配置Babel</h2><p>在项目目录下新建 .babelrc:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"plugins"</span>: [</div><div class="line">    <span class="string">"transform-strict-mode"</span>,</div><div class="line">    <span class="string">"transform-es2015-modules-commonjs"</span>,</div><div class="line">    <span class="string">"transform-es2015-spread"</span>,</div><div class="line">    <span class="string">"transform-es2015-destructuring"</span>,</div><div class="line">    <span class="string">"transform-es2015-parameters"</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<!--# why Fucntional programming

 1. lessCode = lessBug
-->
<h1 id="常用的函数:_filter,_map,_reduce:">常用的函数: filter, map, reduce:</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">var animals = [</div><div class="line">  &#123;name: <span class="string">'a'</span> , specie<span class="variable">s:</span> <span class="string">'dog'</span>, weigh<span class="variable">t:</span> <span class="number">11</span>&#125;,</div><div class="line">  &#123;name: <span class="string">'b'</span>, specie<span class="variable">s:</span> <span class="string">'cat'</span>, weigh<span class="variable">t:</span> <span class="number">10</span>&#125;,</div><div class="line">  &#123;name: <span class="string">'c'</span>, specie<span class="variable">s:</span> <span class="string">'fish'</span>, weigh<span class="variable">t:</span> <span class="number">1</span>&#125;,</div><div class="line">  &#123;name: <span class="string">'d'</span>, specie<span class="variable">s:</span> <span class="string">'cat'</span>, weigh<span class="variable">t:</span> <span class="number">8</span>&#125;,</div><div class="line">  &#123;name: <span class="string">'e'</span>, specie<span class="variable">s:</span> <span class="string">'rabbit'</span>, weigh<span class="variable">t:</span> <span class="number">3</span>&#125;</div><div class="line">]</div><div class="line">// 找到所有种类为猫的动物</div><div class="line">animals.<span class="built_in">filter</span>((animal) =&gt; animal.species === <span class="string">'cat'</span>)</div><div class="line">// [ &#123; name: <span class="string">'b'</span>, specie<span class="variable">s:</span> <span class="string">'cat'</span> &#125;, &#123; name: <span class="string">'d'</span>, specie<span class="variable">s:</span> <span class="string">'cat'</span> &#125; ]</div><div class="line"></div><div class="line">// 返回所有动物的名字</div><div class="line">animals.<span class="keyword">map</span>((animal) =&gt; animal.name)</div><div class="line">// [ <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span> ]</div><div class="line"></div><div class="line">// 动物总重</div><div class="line">animals.reduce((<span class="keyword">pre</span>, animal) =&gt; <span class="keyword">pre</span> + animal.weight, <span class="number">0</span>)</div><div class="line">//<span class="number">33</span></div></pre></td></tr></table></figure>
<p>怎么样? 如果用循环来写肯定不可能一行代码就搞定吧.</p>
<h1 id="一个简单的例子:">一个简单的例子:</h1><h2 id="Task:读取data文件中的数据转化为对象:">Task:读取data文件中的数据转化为对象:</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mark johnson  waffle  iron  <span class="number">80</span>  <span class="number">2</span></div><div class="line">mark johnson  blender  <span class="number">200</span>  <span class="number">1</span></div><div class="line">mark johnson  knife  <span class="number">10</span>  <span class="number">4</span></div><div class="line">nikita Smith  waffle  iron  <span class="number">80</span>  <span class="number">1</span></div><div class="line">nikita Smith  knife <span class="number">10</span>  <span class="number">2</span></div><div class="line">nikita Smith  pot <span class="number">20</span>  <span class="number">3</span></div></pre></td></tr></table></figure>
<ul>
<li>把上面的data文件数据(每行不同属性之间由Tab制表符分割(或者两个空格)),转换成下面的对象格式:</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"mark johnson"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"waffle"</span>, <span class="attr">"price"</span>: <span class="string">"iron"</span>,<span class="attr">"quantity"</span>: <span class="string">"80"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"blender"</span>,<span class="attr">"price"</span>: <span class="string">"200"</span>, <span class="attr">"quantity"</span>: <span class="string">"1"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"knife"</span>,<span class="attr">"price"</span>: <span class="string">"10"</span>,<span class="attr">"quantity"</span>: <span class="string">"4"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"nikita Smith"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"waffle"</span>,<span class="attr">"price"</span>: <span class="string">"iron"</span>,<span class="attr">"quantity"</span>: <span class="string">"80"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"knife"</span>, <span class="attr">"price"</span>: <span class="string">"10"</span>, <span class="attr">"quantity"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"pot"</span>, <span class="attr">"price"</span>: <span class="string">"20"</span>,<span class="attr">"quantity"</span>: <span class="string">"3"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="1-首先,利用fs-readFileSync读取出文件中的内容">1.首先,利用<code>fs.readFileSync</code>读取出文件中的内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span> </div><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</div><div class="line"><span class="keyword">var</span> output = fs.readFileSync(<span class="string">'data'</span>, <span class="string">'utf-8'</span>)</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'output: \n'</span>,output);</div></pre></td></tr></table></figure>
<ul>
<li>使用 <code>npm start</code> 运行main.js文件:</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">npm <span class="literal">start</span></div><div class="line"></div><div class="line">&gt; test@<span class="number">1.0</span>.<span class="number">0</span> <span class="literal">start</span> /src/<span class="keyword">node</span><span class="title">/fnProgramming</span></div><div class="line">&gt; babel-<span class="keyword">node</span> <span class="title">main</span>.js</div><div class="line"></div><div class="line">output:</div><div class="line">mark johnson  waffle iron <span class="number">80</span> <span class="number">2</span></div><div class="line">mark johnson  blender <span class="number">200</span> <span class="number">1</span></div><div class="line">mark johnson  knife <span class="number">10</span> <span class="number">4</span></div><div class="line">nikita Smith waffle  iron <span class="number">80</span> <span class="number">1</span></div><div class="line">nikita Smith knife  <span class="number">10</span> <span class="number">2</span></div><div class="line">nikita Smith pot <span class="number">20</span> <span class="number">3</span></div></pre></td></tr></table></figure>
<h3 id="2-_根据换行符\n_进行分割字符串为数组-">2. 根据换行符<code>\n</code> 进行分割字符串为数组.</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span> </div><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</div><div class="line"><span class="keyword">var</span> output = fs.readFileSync(<span class="string">'data'</span>, <span class="string">'utf-8'</span>)</div><div class="line">				  .split(<span class="string">'\n'</span>)</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'output: \n'</span>,output);</div></pre></td></tr></table></figure>
<ul>
<li>结果中数组最后一项为空是因为文件是以空行结尾的.可以使用trim()方法过滤掉掉头尾的空格</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="string">output:</span></div><div class="line"> [ <span class="string">'mark johnson  waffle iron 80 2'</span>,</div><div class="line">  <span class="string">'mark johnson  blender 200 1'</span>,</div><div class="line">  <span class="string">'mark johnson  knife 10 4'</span>,</div><div class="line">  <span class="string">'nikita Smith waffle  iron 80 1'</span>,</div><div class="line">  <span class="string">'nikita Smith knife  10 2'</span>,</div><div class="line">  <span class="string">'nikita Smith pot 20 3  '</span>,</div><div class="line">  <span class="string">''</span> ]</div></pre></td></tr></table></figure>
<h3 id="3-_根据制表符对每行数据进行分割:">3.  根据制表符对每行数据进行分割:</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span> </div><div class="line"></div><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span>  output = fs.readFileSync(<span class="string">'data'</span>, <span class="string">'utf-8'</span>)</div><div class="line">        .trim()</div><div class="line">        .split(<span class="string">'\n'</span>)</div><div class="line">        .map(<span class="function"><span class="params">line</span>=&gt;</span>line.split(<span class="string">'\t'</span>)) <span class="comment">//如果你的编辑器把tab制表符转换成两个空格 这里就应该使用2个空格作为分割点      </span></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'output: \n'</span>,output);</div></pre></td></tr></table></figure>
<ul>
<li>输出结果:</li>
</ul>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">output:</div><div class="line"> [ [ <span class="string">'mark johnson'</span>, <span class="string">'waffle'</span>, <span class="string">'iron'</span>, <span class="string">'80'</span>, <span class="string">'2'</span> ],</div><div class="line">  [ <span class="string">'mark johnson'</span>, <span class="string">'blender'</span>, <span class="string">'200'</span>, <span class="string">'1'</span> ],</div><div class="line">  [ <span class="string">'mark johnson'</span>, <span class="string">'knife'</span>, <span class="string">'10'</span>, <span class="string">'4'</span> ],</div><div class="line">  [ <span class="string">'nikita Smith'</span>, <span class="string">'waffle'</span>, <span class="string">'iron'</span>, <span class="string">'80'</span>, <span class="string">'1'</span> ],</div><div class="line">  [ <span class="string">'nikita Smith'</span>, <span class="string">'knife 10'</span>, <span class="string">'2'</span> ],</div><div class="line">  [ <span class="string">'nikita Smith'</span>, <span class="string">'pot 20'</span>, <span class="string">'3'</span> ] ]</div></pre></td></tr></table></figure>
<h3 id="4-_使用reduce函数解析出每行的属性-">4. 使用reduce函数解析出每行的属性.</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span> </div><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span>  output = fs.readFileSync(<span class="string">'data'</span>, <span class="string">'utf-8'</span>)</div><div class="line">        .trim()</div><div class="line">        .split(<span class="string">'\n'</span>)</div><div class="line">        .map(<span class="function"><span class="params">line</span>=&gt;</span>line.split(<span class="string">'  '</span>))      </div><div class="line">        .reduce(<span class="function">(<span class="params">customers,line</span>)=&gt;</span>&#123;</div><div class="line">           customers[line[<span class="number">0</span>]]=customers[line[<span class="number">0</span>]]||[] <span class="comment">//当customers为空时,用[]赋值.</span></div><div class="line">           customers[line[<span class="number">0</span>]].push(&#123;</div><div class="line">             <span class="attr">name</span>:line[<span class="number">1</span>],</div><div class="line">             <span class="attr">price</span>:line[<span class="number">2</span>],</div><div class="line">             <span class="attr">quantity</span>:line[<span class="number">3</span>],</div><div class="line">           &#125;)</div><div class="line">           <span class="keyword">return</span> customers</div><div class="line">        &#125;,&#123;&#125;) <span class="comment">//这里传入&#123;&#125;空对象作为 reduce的第一个参数也就是customers</span></div><div class="line">        </div><div class="line"><span class="built_in">console</span>.log(<span class="string">'output: \n'</span>,<span class="built_in">JSON</span>.stringify(output,<span class="literal">null</span>,<span class="number">2</span>));</div></pre></td></tr></table></figure>
<ul>
<li>结果:</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"> &#123;</div><div class="line">  <span class="attr">"mark johnson"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"waffle"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"iron"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"80"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"blender"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"200"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"1"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"knife"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"10"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"4"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"nikita Smith"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"waffle"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"iron"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"80"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"knife"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"10"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"pot"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"20"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"3"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="常用高阶函数举例">常用高阶函数举例</h2><p> 让我们看一些更深入更有意思的例子吧.比如这道比较经典的算法题: </p>
<h3 id="给定一个字符串”abcdaabc”统计每个字符的出现次数-">给定一个字符串”abcdaabc”统计每个字符的出现次数.</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 一般做法是这样的</span></div><div class="line"><span class="keyword">var</span> str=<span class="string">"abcdaabc"</span></div><div class="line"><span class="keyword">var</span> <span class="keyword">count</span> = &#123;&#125;;</div><div class="line"><span class="keyword">var</span> i;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(i=0;i&lt;str.length;i++)&#123;</div><div class="line">    <span class="keyword">var</span> chr = str.charAt(i);</div><div class="line">    <span class="keyword">if</span>( <span class="keyword">typeof</span> <span class="keyword">count</span>[chr] === <span class="string">"undefined"</span>)&#123;</div><div class="line">        <span class="keyword">count</span>[chr] = 1;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">count</span>[chr]++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>利用函数式编程思想的方法是这样的:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line">var <span class="keyword">res</span> = str.<span class="keyword">split</span>(<span class="string">''</span>)</div><div class="line">             .reduce((<span class="keyword">pre</span>, cur) =&gt; (<span class="keyword">pre</span>[cur]++ || (<span class="keyword">pre</span>[cur] = <span class="number">1</span>), <span class="keyword">pre</span>), &#123;&#125;)</div></pre></td></tr></table></figure>
<p>由上面的例子可见, 高阶函数的特性让我们在处理这类问题时比普通的方法要方便的多. 在更实际的应用场景中函数式编程的便利性更能充分的体现, 其中一个经典的例子:</p>
<h3 id="统计文本中出现频率最高的十个单词:">统计文本中出现频率最高的十个单词:</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> content = fs.readFileSync(<span class="string">'words.txt'</span>).toString();</div><div class="line"><span class="keyword">var</span> words = content.split(<span class="regexp">/[\s.,\/:\n]+/</span>);</div><div class="line"></div><div class="line"><span class="comment">// 把单词全部变为小写并利用上一个例子的方法统计单词出现的次数</span></div><div class="line"><span class="keyword">var</span> tally = words.map(<span class="function">(<span class="params">word</span>) =&gt;</span> word.toLowerCase())</div><div class="line">                 .reduce(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> (pre[cur]++ || (pre[cur]=<span class="number">1</span>), pre), &#123;&#125;)</div><div class="line"><span class="comment">//把object的key变成数组并进行排序</span></div><div class="line"><span class="keyword">var</span> top10 = <span class="built_in">Object</span>.keys(tally)</div><div class="line">                  .map(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</div><div class="line">                    <span class="keyword">return</span> &#123;<span class="attr">word</span>: key, <span class="attr">count</span>: tally[key]&#125;</div><div class="line">                  &#125;)</div><div class="line">                  .sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> b.count - a.count)</div><div class="line">                  .slice(<span class="number">0</span>, <span class="number">10</span>)</div><div class="line"><span class="built_in">console</span>.log(top10)</div></pre></td></tr></table></figure>
<p>上面这个例子充分体现了函数式编程思想的魅力,代码精简并且可读性高!</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/author.png" alt="Lyn's Blog" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Lyn's Blog</p>
        </div>
        <p class="site-description motion-element" itemprop="description">Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">61</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">32</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lyn's Blog</span>
</div>

<div class="powered-by">
  <a class="theme-link" href="http://hexo.io">Powered by Hexo
  </a>
</div>

<div class="theme-info">
  
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>

</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
