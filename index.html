<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />



  <meta name="description" content="Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes" />




  <meta name="keywords" content="Lyn's blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta property="og:type" content="website">
<meta property="og:title" content="Lyn's Blog">
<meta property="og:url" content="http://lyn.s76.org/index.html">
<meta property="og:site_name" content="Lyn's Blog">
<meta property="og:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lyn's Blog">
<meta name="twitter:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Lyn's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36568696-2', 'auto');
  ga('send', 'pageview');

</script>








  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lyn's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Node.js Angular.js Express.js HTML5 Mongodb Programing Notes</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/02/19/generator-yield/" itemprop="url">
                  Generators  入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2017-02-19T22:20:18+08:00" content="2017-02-19">
              2017-02-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/19/generator-yield/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/19/generator-yield/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>相比起ES6中引入的其他概念 Generator 算是一个比较难以理解的 <code>黑科技</code>了.</p>
<p>Generator的引入使得js中的异步调用语法更像是同步语法.但是yield 一开始接触的时候,总给人感觉难以理解.</p>
<p>今天总结下Generator的用法.</p>
<h1 id="配置环境">配置环境</h1><h2 id="package-json">package.json</h2><p>为了在node中使用es6语法,先创建package.json,用babel来转换es6语法</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"generator"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="attr">"description"</span>: <span class="string">"about generator"</span>,</div><div class="line">  <span class="attr">"main"</span>: <span class="string">"main.js"</span>,</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"start"</span>: <span class="string">"babel-node main.js"</span>,</div><div class="line">    <span class="attr">"build"</span>: <span class="string">"babel src --out-dir lib"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</div><div class="line">  <span class="attr">"license"</span>: <span class="string">"MIT"</span>,</div><div class="line">  <span class="attr">"dependencies"</span>: &#123;</div><div class="line">    <span class="attr">"node-fetch"</span>: <span class="string">"^1.6.3"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"babel-cli"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-core"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-destructuring"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-modules-commonjs"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-parameters"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-spread"</span>: <span class="string">"^6.8.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-strict-mode"</span>: <span class="string">"^6.18.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="-babelrc">.babelrc</h2><p>和package.json同一级目录下的<code>.babelrc</code> 是babel的配置文件.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="attr">"plugins"</span>: [</div><div class="line">    <span class="string">"transform-strict-mode"</span>,</div><div class="line">    <span class="string">"transform-es2015-modules-commonjs"</span>,</div><div class="line">    <span class="string">"transform-es2015-spread"</span>,</div><div class="line">    <span class="string">"transform-es2015-destructuring"</span>,</div><div class="line">    <span class="string">"transform-es2015-parameters"</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="从一个简单的异步调用开始">从一个简单的异步调用开始</h1><p>除了<code>generator</code>,es6中还引入了<code>promise</code>,我们先使用<code>promise</code>和<code>fetch</code> 来实现一个简单的异步调用</p>
<p>关于<code>fetch</code>是xhr的升级实现:</p>
<ul>
<li>对generator/yield，async/await 更加友好,它将返回结果包装在promise中.</li>
<li>提供了对response.json()的转换方法提供对json数据的原生支持.</li>
<li>更多细节参考:<code>https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch</code></li>
</ul>
<h2 id="promise异步调用代码如下:">promise异步调用代码如下:</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"></div><div class="line">fetch(<span class="string">'http://jsonplaceholder.typicode.com/posts/1'</span>)</div><div class="line"> .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</div><div class="line"> .then(<span class="function"><span class="params">post</span> =&gt;</span> post.title)</div><div class="line"> .then(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Title is:'</span>, x))</div></pre></td></tr></table></figure>
<h3 id="运行:">运行:</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bash-<span class="number">3.2</span>$ npm <span class="literal">start</span></div><div class="line"></div><div class="line">&gt; generator@<span class="number">1.0</span>.<span class="number">0</span> <span class="literal">start</span> </div><div class="line">&gt; babel-<span class="keyword">node</span> <span class="title">main</span>.js</div><div class="line"></div><div class="line">Title is: sunt aut facere repellat provident occaecati excepturi optio reprehenderit</div></pre></td></tr></table></figure>
<h2 id="试试generator_:">试试generator :</h2><h3 id="引入co">引入<code>co</code></h3><p><code>npm install co --save</code></p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"><span class="keyword">const</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</div><div class="line"></div><div class="line">co(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> <span class="built_in">url</span> = <span class="string">'http://jsonplaceholder.typicode.com/posts/1'</span>;</div><div class="line">  <span class="keyword">const</span> response = <span class="keyword">yield</span> fetch(<span class="built_in">url</span>);</div><div class="line">  <span class="keyword">const</span> post = <span class="keyword">yield</span> response.json();</div><div class="line">  <span class="keyword">const</span> title = post.title;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Title is:'</span>, title);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="运行结果:">运行结果:</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bash-<span class="number">3.2</span>$ npm <span class="literal">start</span></div><div class="line"></div><div class="line">&gt; generator@<span class="number">1.0</span>.<span class="number">0</span> <span class="literal">start</span>  </div><div class="line">&gt; babel-<span class="keyword">node</span> <span class="title">main</span>.js</div><div class="line"></div><div class="line">Title is: sunt aut facere repellat provident occaecati excepturi optio reprehenderit</div><div class="line">bash-<span class="number">3.2</span>$</div></pre></td></tr></table></figure>
<h2 id="实现一个函数取代co">实现一个函数取代<code>co</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">generator</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> iterator = generator();</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'iterator:'</span>, iterator);</div><div class="line">  <span class="keyword">const</span> iteration = iterator.next();</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'iteration:'</span>, iteration);</div><div class="line">  <span class="keyword">const</span> promise = iteration.value;</div><div class="line">  promise.then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> anotherIterator = iterator.next(response);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'anotherIterator :'</span>, anotherIterator);</div><div class="line">    <span class="keyword">const</span> anotherPromise = anotherIterator.value;</div><div class="line">    anotherPromise.then(<span class="function"><span class="params">post</span> =&gt;</span> iterator.next(post));</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line">run(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> url = <span class="string">'http://jsonplaceholder.typicode.com/posts/1'</span>;</div><div class="line">  <span class="keyword">const</span> response = <span class="keyword">yield</span> fetch(url);</div><div class="line">  <span class="keyword">const</span> post = <span class="keyword">yield</span> response.json();</div><div class="line">  <span class="keyword">const</span> title = post.title;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Title is:'</span>, title);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="运行结果">运行结果</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">bash<span class="number">-3.2</span>$ npm start</div><div class="line"></div><div class="line">&gt; generator@<span class="number">1.0</span><span class="number">.0</span> start  </div><div class="line">&gt; babel-node main.js</div><div class="line"><span class="symbol"></span></div><div class="line">iterator: &#123;&#125;</div><div class="line"><span class="string">iteration:</span> &#123; <span class="string">value:</span> Promise &#123; &lt;pending&gt; &#125;, <span class="string">done:</span> <span class="literal">false</span> &#125;</div><div class="line"><span class="string">anotherIterator :</span> &#123; <span class="string">value:</span> Promise &#123; &lt;pending&gt; &#125;, <span class="string">done:</span> <span class="literal">false</span> &#125;</div><div class="line">Title <span class="string">is:</span> sunt aut facere repellat provident occaecati excepturi optio reprehenderit</div></pre></td></tr></table></figure>
<h2 id="使用递归">使用递归</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">generator</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> iterator = generator();</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">iterate</span>(<span class="params">iteration</span>) </span>&#123;</div><div class="line">  	 <span class="comment">//终止条件</span></div><div class="line">    <span class="keyword">if</span> (iteration.done) <span class="keyword">return</span> iteration.value;</div><div class="line">    <span class="keyword">const</span> promise = iteration.value;</div><div class="line">    <span class="comment">//递归调用iterate</span></div><div class="line">    <span class="keyword">return</span> promise.then(<span class="function"><span class="params">x</span> =&gt;</span> iterate(iterator.next(x)))</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> iterate(iterator.next());</div><div class="line">&#125;</div><div class="line"></div><div class="line">run(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> url = <span class="string">'http://jsonplaceholder.typicode.com/posts/1'</span>;</div><div class="line">  <span class="keyword">const</span> response = <span class="keyword">yield</span> fetch(url);</div><div class="line">  <span class="keyword">const</span> post = <span class="keyword">yield</span> response.json();</div><div class="line">  <span class="keyword">const</span> title = post.title;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Title is:'</span>, title);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/02/14/redux-saga-js/" itemprop="url">
                  redux-saga的简单入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2017-02-14T21:37:45+08:00" content="2017-02-14">
              2017-02-14
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/14/redux-saga-js/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/14/redux-saga-js/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Redux-saga">Redux-saga</h1><p>在之前的blog中,我们在react应用中把油副作用的部分都放在了action函数中,把异步调用包装成一个thunk 函数.也能满足我们实际的需求,那为什么还需要redux-saga呢?</p>
<ol>
<li>redux-sage的异步调用部分,都是很标准的依赖注入(<code>dependencies injection</code>)的写法</li>
<li>因为有依赖注入的写法,我们可以很方便的在单元测试中使用一些fake函数来模拟异步调用.</li>
<li>综上saga实际上是在testablity上比thunk来处理异步更有优势.</li>
<li>由于使用了generator函数, 所以可以在局部保持一个state 来实现一些thunk不太方便实现的功能.</li>
<li>代码看上去更加类似同步编程(<code>sync</code>)</li>
</ol>
<p>劣势:</p>
<ol>
<li><code>generator</code> 和 <code>yield</code>的概念,无疑增加团队的学习成本.  </li>
</ol>
<h1 id="安装">安装</h1><p>很简单: <code>npm intsall redux-saga --save</code></p>
<h1 id="middleWare">middleWare</h1><p>为了拦截到指定的action,我们需要在middleware中监听指定的<code>action.type</code></p>
<p>所以我们在createStore时候需要在middleware中加入 redux-saga</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  applyMiddleware,</div><div class="line">  createStore,</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">import</span> createSageMiddleWare <span class="keyword">from</span> <span class="string">'redux-saga'</span>;</div><div class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'redux-logger'</span>;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducers'</span>;</div><div class="line"><span class="keyword">import</span> rootSaga <span class="keyword">from</span> <span class="string">'./services/sagas'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 创建saga中间件实例</span></div><div class="line"><span class="keyword">const</span> sagaMiddleware = createSageMiddleWare();</div><div class="line"><span class="comment">// 将saga中间件合并到redux中间件数组集合中.</span></div><div class="line"><span class="keyword">const</span> middleware = applyMiddleware(sagaMiddleware, logger());</div><div class="line"></div><div class="line"><span class="comment">//依赖于 reducers和 中间件来创建一个Store.</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> createStore(reducer, middleware);</div><div class="line"></div><div class="line"><span class="comment">// 需要在创建Store以后通过run()方法调用rootSaga</span></div><div class="line">sagaMiddleware.run(rootSaga);</div></pre></td></tr></table></figure>
<h1 id="sagas">sagas</h1><ul>
<li>我们先把<code>rootsaga</code> <code>watchsaga</code> <code>workersaga</code> 写在一个文件中 <code>./services/sagas.js</code></li>
<li>当文件大了以后可以进行拆分.</li>
<li>调用顺序如下:</li>
</ul>
<ol>
<li>rootsaga 被middleware调用 </li>
<li><code>rootsaga</code>中<code>yield</code>引用 <code>watchsaga</code></li>
<li><code>watchsaga</code>中调用具体的<code>worker</code>来执行异步操作. </li>
</ol>
<h2 id="常用Api:">常用Api:</h2><ul>
<li><code>take</code> 获取指定类型(action.type)的action.</li>
<li><code>takeEvery</code> 多个action 每个都会触发.</li>
<li><code>takelatest</code> 多个action时,只执行最后一个,自动cancel前面take的actions</li>
<li><code>call</code> 阻塞式异步调用,第一个参数是要调用的generator函数,后面的参数是传递的参数.会阻塞直到promise返回结果.如果阻塞时有其他action,那么这些action都会错过,不会被执行.</li>
<li><code>fork</code> 非阻塞时调用,可以理解为子任务单独处理.每个action都会得到处理,不会错过执行的时机.</li>
<li><code>put</code>  相当于是<code>disptach</code>函数,用于在generator中dispatch <code>action</code></li>
<li><code>cancel</code>  可以取消fork出来的子任务, 将在当前执行的任务中抛出一个 SagaCancellationException 类型的异常,可以通过try catch捕捉到,但是这个错误并不会向上冒泡.</li>
<li><code>race</code> 返回先完成的任务,自动cancel其他的.参考如下:</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; race, take, <span class="built_in">put</span> &#125; from <span class="string">'redux-saga/effects'</span></div><div class="line"></div><div class="line">function* fetchPostsWithTimeout() &#123;</div><div class="line">  <span class="keyword">const</span> &#123;posts, timeout&#125; = <span class="built_in">yield</span> race(&#123;</div><div class="line">    posts   : call(fetchApi, <span class="string">'/posts'</span>),</div><div class="line">    timeout : call(<span class="built_in">delay</span>, <span class="number">1000</span>)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  <span class="built_in">if</span>(posts)</div><div class="line">    <span class="built_in">put</span>(&#123;type: <span class="string">'POSTS_RECEIVED'</span>, posts&#125;)</div><div class="line">  <span class="built_in">else</span></div><div class="line">    <span class="built_in">put</span>(&#123;type: <span class="string">'TIMEOUT_ERROR'</span>&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#<span class="meta"># rootsaga</span></div><div class="line"></div><div class="line">这里<span class="built_in">yield</span>了一个数组,素组中的generator是并发执行的.不会相互影响.</div></pre></td></tr></table></figure>
<p>import { take, fork, call, put } from ‘redux-saga/effects’;<br>import { takeEvery } from ‘redux-saga’;</p>
<p>export default function* rootSaga() {<br>  yield [<br>    watchPostRequests(),<br>  ];<br>}</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## watchsaga</div><div class="line"></div><div class="line">监听`FETCH_POSTS `类型的action.并且调用fetchPost函数.</div></pre></td></tr></table></figure>
<p>function* watchPostRequests() {<br>  yield takeEvery(‘FETCH_POSTS’, fetchPost);<br>}</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">`takeEvery` 与下面的`while(<span class="literal">true</span>)&#123; yield fork()&#125;`的写法实现同样效果.</div></pre></td></tr></table></figure>
<p> //The watcher: watch actions and coordinate worker tasks<br> function* watchPostRequests() {<br>  while (true) {<br>     const url = ‘/api/posts’;<br>     const action = yield take(‘FETCH_POSTS’);<br>      console.log(‘catch action from dispatch’, action);<br>      yield fork(fetchPost, url);<br>    }<br> }</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## workersaga</div><div class="line"></div><div class="line">使用`call`阻塞式的执行异步调用.直到返回结果后使用`put`来dispatch action.</div></pre></td></tr></table></figure>
<p>import axios from ‘axios’;</p>
<p>// The worker: perform the requested task<br>function* fetchPost(action) {<br>  try {<br>    console.log(‘catch action from dispatch’, action);<br>    yield put({ type: ‘FETCH_POSTS_PENDING’ });<br>    const res = yield call(axios.get, ‘/api/posts’);<br>    yield put({<br>      type: ‘FETCH_POSTS_FULFILLED’,<br>      payload: res.data.data,<br>    });<br>  } catch (e) {<br>    yield put({<br>      type: ‘FETCH_POSTS_REJECTED’,<br>      payload: e.message,<br>    });<br>  }<br>}<br>```</p>
<h1 id="参考:">参考:</h1><ul>
<li><a href="http://leonshi.com/redux-saga-in-chinese/docs/advanced/ComposingSagas.html" target="_blank" rel="external">http://leonshi.com/redux-saga-in-chinese/docs/advanced/ComposingSagas.html</a></li>
<li><a href="https://github.com/superRaytin/redux-saga-in-chinese" target="_blank" rel="external">https://github.com/superRaytin/redux-saga-in-chinese</a></li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/12/25/kcp/" itemprop="url">
                  kcp-config
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-12-25T22:10:21+08:00" content="2016-12-25">
              2016-12-25
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/25/kcp/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/25/kcp/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Kcptun">Kcptun</h1><p>项目地址:<a href="https://github.com/xtaci/kcptun" target="_blank" rel="external">https://github.com/xtaci/kcptun</a></p>
<h1 id="效果:">效果:</h1><p>先看下效果:<br><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-12-25/58961318-file_1482679564423_934a.png" alt=""></p>
<h2 id="运行逻辑:">运行逻辑:</h2><blockquote>
<p>将TCP包转成加密的UDP包,能以比 TCP 浪费10%-20%的带宽的代价，换取平均延迟降低 30%-40%，且最大延迟降低三倍的传输效果。</p>
<p>Kcptun 是KCP 协议的一个简单应用，可以用于任意 TCP 网络程序的传输承载，以提高网络流畅度，降低掉线情况。由于 Kcptun 使用 Go 语言编写，内存占用低（经测试，在64M内存服务器上稳定运行），而且适用于所有平台，甚至 Arm 平台。</p>
</blockquote>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-12-25/72476905-file_1482677511680_6e9f.png" alt=""></p>
<h1 id="服务端自动安装">服务端自动安装</h1><p>kcptun 一键安装脚本:</p>
<h2 id="kcp-server:">kcp-server:</h2><blockquote>
<p><a href="https://github.com/clangcn/kcp-server" target="_blank" rel="external">https://github.com/clangcn/kcp-server</a></p>
</blockquote>
<h3 id="Install">Install</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget --no-check-certificate https://github.com/clangcn/kcp-server/raw/master/install-kcp-server.sh -O ./install-kcp-server.sh</div><div class="line">chmod 500 ./install-kcp-server.sh</div><div class="line">./install-kcp-server.sh install</div></pre></td></tr></table></figure>
<h3 id="UnInstall">UnInstall</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./install-kcp-server.sh uninstall</div></pre></td></tr></table></figure>
<h3 id="Update">Update</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./install-kcp-server.sh update</div></pre></td></tr></table></figure>
<h3 id="服务器管理">服务器管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Usage: /etc/init.d/kcp-server &#123;start|stop|restart|status&#125;</div></pre></td></tr></table></figure>
<h1 id="手动安装">手动安装</h1><p>步骤:</p>
<ol>
<li>使用<code>wget</code>下载解压到有权限的目录,可以使用 <code>chown</code>改变文件夹所有者为自己解决权限问题,</li>
<li>给解压出来的程序添加运行权限<code>chmod +x ./server_linux_amd64</code>.</li>
<li>开放TCP要使用的防火墙的端口.<code>UDP</code>和<code>TCP</code>都打开</li>
<li>在解压目录下配置配置文件 config.json,配置本地的ss服务器地址为<code>127.0.0.1</code></li>
<li>在服务器上增加启动脚本<code>start.sh</code> 或者直接运行<code>./server_linux_amd64 -c /你的配置文件路径/config.json</code> 来启动服务端程序</li>
<li>在本地增加启动脚本或者直接运行<code>./client_darwin_amd64 -c /你的配置文件路径/config.json</code> 来启动客户端程序</li>
<li>rc.local中设置开机任务</li>
</ol>
<h2 id="关于下载:">关于下载:</h2><p>分别在sever上和client端下载对应的版本,每个压缩包里都包含一个可以运行的客户端和服务端(client_linux_amd64和server_linux_amd64).</p>
<p>比如:</p>
<ul>
<li>server上使用wget下载linux版本(kcptun-linux-amd64-20161222.tar.gz,并使用./server_linux_amd64 运行),</li>
<li>本地使用的Mac的编译版本 (kcptun-darwin-amd64-20161222.tar.gz)</li>
</ul>
<p>Ps:</p>
<ul>
<li>下载地址: <a href="https://github.com/xtaci/kcptun/releases" target="_blank" rel="external">https://github.com/xtaci/kcptun/releases</a> </li>
<li>注意 sever和client上的版本需要一致.</li>
</ul>
<h2 id="关于配置防火墙">关于配置防火墙</h2><h3 id="配置iptables的方式">配置iptables的方式</h3><p>在/etc/iptables.firewall.rules 中增加</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-A INPUT -<span class="selector-tag">p</span> udp --dport 你的vRay2端口 -j ACCEPT</div></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo iptables-restore &lt; /etc/iptables<span class="selector-class">.firewall</span><span class="selector-class">.rules</span> <span class="comment">//加载配置的iptables 规则</span></div><div class="line"></div><div class="line">sudo iptables -L  <span class="comment">//查看是否配置生效</span></div></pre></td></tr></table></figure>
<h3 id="ufw配置防火墙">ufw配置防火墙</h3><p>如果觉得iptable太麻烦可以使用ufw<br>首先，用如下命令来检查下系统上是否已经安装了 UFW 。</p>
<ul>
<li><code>$ sudo dpkg --get-selections | grep ufw</code></li>
</ul>
<p>如还没有安装，可以使用 apt 命令来安装，如下所示：</p>
<ul>
<li><code>$ sudo apt-get install ufw</code></li>
</ul>
<h4 id="常用命令:">常用命令:</h4><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo ufw  status        <span class="comment">//查询显示ufw状态以及规则</span></div><div class="line">sudo ufw  enable|disable|<span class="built_in">reload</span> <span class="comment">//启动\关闭\重启</span></div><div class="line">sudo ufw logging on|off|LEVEL   <span class="comment">//日志 启动\关闭\级别</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>                      <span class="built_in">Action</span>      <span class="keyword">From</span></div><div class="line">--                     ------      ----</div><div class="line"><span class="number">24</span>                      ALLOW       Anywhere</div></pre></td></tr></table></figure>
<h4 id="配置端口:">配置端口:</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 把25替换成你的kcptun端口</span></div><div class="line">ufw allow <span class="number">25</span>/udp </div><div class="line"></div><div class="line"><span class="meta"># 可以使用这个命令为动态端口需要开放一段端口(这个例子中是12290~12300这个10个端口) </span></div><div class="line">sudo ufw allow <span class="number">12290</span>:<span class="number">12300</span>/udp </div><div class="line"></div><div class="line"><span class="meta">#检查是否生效</span></div><div class="line">sudo ufw  status</div></pre></td></tr></table></figure>
<h2 id="关于kcp配置参数:">关于kcp配置参数:</h2><h3 id="两端参数必须一致的有:">两端参数必须一致的有:</h3><ul>
<li>datashard –前向纠错 默认 10</li>
<li>parityshard –前向纠错 默认 3</li>
<li>nocomp –是否关闭压缩 默认 false</li>
<li>key –密钥 建议自己设置</li>
<li>crypt –加密算法 建议使用aes128以上的加密方式</li>
</ul>
<p>其余为两边可独立设定的参数</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">GLOBAL OPTIONS:</div><div class="line">   --localaddr <span class="keyword">value</span>, -<span class="function">l <span class="keyword">value</span>   local listen <span class="title">address</span> (<span class="params"><span class="keyword">default</span>: <span class="string">":12948"</span></span>)</span></div><div class="line">   --remoteaddr <span class="keyword">value</span>, -r <span class="keyword">value</span>  kcp server <span class="title">address</span> (<span class="params"><span class="keyword">default</span>: <span class="string">"vps:29900"</span></span>)</div><div class="line">   --key <span class="keyword">value</span>                   pre-shared secret between client and <span class="title">server</span> (<span class="params"><span class="keyword">default</span>: <span class="string">"it's a secrect"</span></span>) [$KCPTUN_KEY]</div><div class="line">   --crypt <span class="keyword">value</span>                 aes, aes-128, aes-192, salsa20, blowfish, twofish, cast5, 3des, tea, xtea, xor, <span class="title">none</span> (<span class="params"><span class="keyword">default</span>: <span class="string">"aes"</span></span>)</div><div class="line">   --mode <span class="keyword">value</span>                  profiles: fast3, fast2, fast, <span class="title">normal</span> (<span class="params"><span class="keyword">default</span>: <span class="string">"fast"</span></span>)</div><div class="line">   --conn <span class="keyword">value</span>                  <span class="keyword">set</span> num of UDP connections to <span class="title">server</span> (<span class="params"><span class="keyword">default</span>: <span class="number">1</span></span>)</div><div class="line">   --autoexpire <span class="keyword">value</span>            <span class="keyword">set</span> auto expiration <span class="title">time</span>(<span class="params"><span class="keyword">in</span> seconds</span>) <span class="keyword">for</span> a single UDP connection, 0 to <span class="title">disable</span> (<span class="params"><span class="keyword">default</span>: <span class="number">0</span></span>)</div><div class="line">   --mtu <span class="keyword">value</span>                   <span class="keyword">set</span> maximum transmission unit <span class="keyword">for</span> UDP <span class="title">packets</span> (<span class="params"><span class="keyword">default</span>: <span class="number">1350</span></span>)</div><div class="line">   --sndwnd <span class="keyword">value</span>                <span class="keyword">set</span> send window <span class="title">size</span>(<span class="params">num of packets</span>) (<span class="params"><span class="keyword">default</span>: <span class="number">128</span></span>)</div><div class="line">   --rcvwnd <span class="keyword">value</span>                <span class="keyword">set</span> receive window <span class="title">size</span>(<span class="params">num of packets</span>) (<span class="params"><span class="keyword">default</span>: <span class="number">1024</span></span>)</div><div class="line">   --datashard <span class="keyword">value</span>             <span class="keyword">set</span> reed-solomon erasure coding - <span class="title">datashard</span> (<span class="params"><span class="keyword">default</span>: <span class="number">10</span></span>)</div><div class="line">   --parityshard <span class="keyword">value</span>           <span class="keyword">set</span> reed-solomon erasure coding - <span class="title">parityshard</span> (<span class="params"><span class="keyword">default</span>: <span class="number">3</span></span>)</div><div class="line">   --dscp <span class="keyword">value</span>                  <span class="keyword">set</span> <span class="title">DSCP</span>(<span class="params"><span class="number">6</span>bit</span>) (<span class="params"><span class="keyword">default</span>: <span class="number">0</span></span>)</div><div class="line">   --nocomp                      disable compression</div><div class="line">   --log <span class="keyword">value</span>                   specify a log file to output, <span class="keyword">default</span> goes to stderr</div><div class="line">   -c <span class="keyword">value</span>                      config <span class="keyword">from</span> json file, which will <span class="keyword">override</span> the command <span class="keyword">from</span> shell</div><div class="line">   --help, -h                    show help</div><div class="line">   --version, -v                 print the version</div></pre></td></tr></table></figure>
<h3 id="简易窗口自我调优方法：">简易窗口自我调优方法：</h3><ul>
<li>第一步：同时在两端逐步增大client rcvwnd和server sndwnd;</li>
<li>第二步：尝试下载，观察如果带宽利用率（服务器＋客户端两端都要观察）接近物理带宽则停止，否则跳转到第一步。</li>
</ul>
<p>Ps: 建议调整到能正常观看油管的程度就可以了,不要设置太高的client rcvwnd和server sndwnd 不然很容易被运营商封端口.(我这边电信只需要设置server的sndwnd:1024就可以实现观看10000kps的速度了)</p>
<h3 id="SS的设置">SS的设置</h3><p>SS设置只需要把原来配置中ss服务器IP替换成<code>127.0.0.1</code>即可, 因为KCP会监听config.json中localaddr字段设置的本地的SS端口,并自动转发到服务器端的端口上.</p>
<h3 id="客户端的config-json">客户端的config.json</h3><p>如果运行报错,记得删除所有注释</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"localaddr"</span>: <span class="string">":8888"</span>, <span class="comment">//本地需要被加速的端口</span></div><div class="line">  <span class="string">"remoteaddr"</span>: <span class="string">"服务端的ip地址:18888"</span>,<span class="comment">//服务端的kcp端口</span></div><div class="line">  <span class="string">"key"</span>: <span class="string">"你在服务器端设置的秘钥"</span>,</div><div class="line">  <span class="string">"crypt"</span>: <span class="string">"salsa20"</span>,<span class="comment">//加密方式 需要和服务器端一致</span></div><div class="line">  <span class="string">"mode"</span>: <span class="string">"fast"</span>,<span class="comment">//重传的频率 一般设置fast就可以了 重传的越多约浪费流量 响应就越快</span></div><div class="line">  <span class="string">"mtu"</span>: <span class="number">1350</span>,</div><div class="line">  <span class="string">"sndwnd"</span>: <span class="number">256</span>,</div><div class="line">  <span class="string">"rcvwnd"</span>: <span class="number">2048</span>,</div><div class="line">  <span class="string">"datashard"</span>:<span class="number">10</span>,</div><div class="line">  <span class="string">"parityshard"</span>: <span class="number">3</span>,</div><div class="line">  <span class="string">"dscp"</span>: <span class="number">0</span>,</div><div class="line">  <span class="string">"conn"</span>: <span class="number">1</span>,</div><div class="line">  <span class="string">"autoexpire"</span>: <span class="number">60</span>,</div><div class="line">  <span class="string">"nocomp"</span>: <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="服务端的config-json">服务端的config.json</h3><p>保存前,删除所有注释</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"listen"</span>: <span class="string">"服务器的ip地址:18888"</span>,<span class="comment">//服务端的kcp端口</span></div><div class="line">    <span class="string">"target"</span>: <span class="string">"127.0.0.1:8888"</span>, <span class="comment">//ss端口   </span></div><div class="line">    <span class="string">"key"</span>: <span class="string">"你的秘钥"</span>,<span class="comment">//加密方式 需要和客户端端一致</span></div><div class="line">    <span class="string">"crypt"</span>: <span class="string">"salsa20"</span>,<span class="comment">//加密方式 需要和服务器端一致</span></div><div class="line">    <span class="string">"mode"</span>: <span class="string">"fast"</span>,<span class="comment">//重传的频率 一般设置fast就可以了 重传的越多约浪费流量 响应就越快</span></div><div class="line">    <span class="string">"mtu"</span>: <span class="number">1350</span>,</div><div class="line">    <span class="string">"sndwnd"</span>: <span class="number">1024</span>,</div><div class="line">    <span class="string">"rcvwnd"</span>: <span class="number">2048</span>,</div><div class="line">    <span class="string">"datashard"</span>: <span class="number">10</span>,</div><div class="line">    <span class="string">"parityshard"</span>: <span class="number">3</span>,</div><div class="line">    <span class="string">"dscp"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"nocomp"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"acknodelay"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"nc"</span>: <span class="number">1</span>,</div><div class="line">    <span class="string">"sockbuf"</span>: <span class="number">4194304</span>,</div><div class="line">    <span class="string">"keepalive"</span>: <span class="number">10</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="启动脚本:">启动脚本:</h2><p>为了方便我们用vi写一个非常简单的启动脚本 命名为start.sh:</p>
<ol>
<li><p><code>vim start.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">nohup  /你的kcp路径/server_linux_amd64 -c /你的配置文件路径/config.json&gt; /dev/null  2&gt;&amp;1  &amp;</div></pre></td></tr></table></figure>
</li>
<li><p>给sh脚本增加运行权限:<code>chmod +x start.sh</code></p>
</li>
<li><p>编辑/etc/rc.local文件,增加一行:</p>
</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/你的kcp路径/</span>start.sh &amp;&gt;<span class="regexp">/dev/</span><span class="keyword">null</span> &amp;</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/12/22/v2ray-config/" itemprop="url">
                  v2ray-config
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-12-22T14:35:38+08:00" content="2016-12-22">
              2016-12-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/22/v2ray-config/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/22/v2ray-config/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="V2ray">V2ray</h1><h2 id="安装">安装</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">su //切换为root用户</div><div class="line"></div><div class="line">bash &lt;(curl -L -s https://install.direct/go.sh) //运行这一行命令</div><div class="line"></div><div class="line">bash &lt;(curl -L -s https://install.direct/go.sh)</div><div class="line">/dev/fd/63: line 88: /usr/bin/v2ray/v2ray: No such file<span class="built_in"> or </span>directory</div><div class="line">Installing V2Ray v2.10.5 on x86_64</div><div class="line">Downloading https://github.com/v2ray/v2ray-core/releases/download/v2.10.5/v2ray-linux-64.zip directly.</div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line">100   595    0   595    0     0    774      0 --:--:-- --:--:-- --:--:--   774</div><div class="line">100 2351k  100 2351k    0     0   157k      0  0:00:14  0:00:14 --:--:--  150k</div><div class="line">Extracting V2Ray package to /tmp/v2ray.</div><div class="line">Archive:  /tmp/v2ray/v2ray.zip</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/systemd/v2ray.service</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/systemv/v2ray</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/v2ray</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/vpoint_socks_vmess.json</div><div class="line">  inflating: /tmp/v2ray/v2ray-v2.10.5-linux-64/vpoint_vmess_freedom.json</div><div class="line">PORT:27514</div><div class="line">UUID:d75cca2f-e955-4b32-b3fe-ba6f3e50b013</div><div class="line">Updating software repo via apt-get.</div><div class="line">Installing daemon via apt-get.</div><div class="line">Selecting previously unselected package daemon.</div><div class="line">(Reading database ... 31003 files<span class="built_in"> and </span>directories currently installed.)</div><div class="line">Preparing to unpack .../daemon_0.6.4-1_amd64.deb ...</div><div class="line">Unpacking daemon (0.6.4-1) ...</div><div class="line">Processing triggers for man-db (2.6.7.1-1ubuntu1) ...</div><div class="line">Setting up daemon (0.6.4-1) ...</div><div class="line"> Adding<span class="keyword"> system</span> startup for /etc/init.d/v2ray ...</div><div class="line">   /etc/rc0.d/K20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc1.d/K20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc6.d/K20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc2.d/S20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc3.d/S20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc4.d/S20v2ray -&gt; ../init.d/v2ray</div><div class="line">   /etc/rc5.d/S20v2ray -&gt; ../init.d/v2ray</div><div class="line">V2Ray v2.10.5 is installed.</div></pre></td></tr></table></figure>
<h2 id="配置防火墙">配置防火墙</h2><h3 id="配置iptables的方式">配置iptables的方式</h3><p>在/etc/iptables.firewall.rules 中增加</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-A INPUT -<span class="selector-tag">p</span> udp --dport 你的vRay2端口 -j ACCEPT</div></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo iptables-restore &lt; /etc/iptables<span class="selector-class">.firewall</span><span class="selector-class">.rules</span> <span class="comment">//加载配置的iptables 规则</span></div><div class="line"></div><div class="line">sudo iptables -L  <span class="comment">//查看是否配置生效</span></div></pre></td></tr></table></figure>
<h3 id="ufw配置防火墙">ufw配置防火墙</h3><p>如果觉得iptable太麻烦可以使用ufw<br>首先，用如下命令来检查下系统上是否已经安装了 UFW 。</p>
<ul>
<li><code>$ sudo dpkg --get-selections | grep ufw</code></li>
</ul>
<p>如还没有安装，可以使用 apt 命令来安装，如下所示：</p>
<ul>
<li><p><code>$ sudo apt-get install ufw</code></p>
</li>
<li><p>常用命令:</p>
</li>
</ul>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo ufw  status        <span class="comment">//查询显示ufw状态以及规则</span></div><div class="line">sudo ufw  enable|disable|<span class="built_in">reload</span> <span class="comment">//启动\关闭\重启</span></div><div class="line">sudo ufw logging on|off|LEVEL   <span class="comment">//日志 启动\关闭\级别</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>                      <span class="built_in">Action</span>      <span class="keyword">From</span></div><div class="line">--                     ------      ----</div><div class="line"><span class="number">24</span>                      ALLOW       Anywhere</div></pre></td></tr></table></figure>
<p>配置端口</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 把25替换成你的v2ray端口</span></div><div class="line">ufw allow <span class="number">25</span>/udp </div><div class="line"></div><div class="line"><span class="meta"># 可以使用这个命令为动态端口需要开放一段端口(这个例子中是12290~12300这个10个端口) </span></div><div class="line">sudo ufw allow <span class="number">12290</span>:<span class="number">12300</span>/udp </div><div class="line"></div><div class="line"><span class="meta">#检查是否生效</span></div><div class="line">sudo ufw  status</div></pre></td></tr></table></figure>
<h2 id="生成配置文件">生成配置文件</h2><ul>
<li>生成UUID:<a href="https://htfy96.github.io/v2ray-config-gen/#" target="_blank" rel="external">https://htfy96.github.io/v2ray-config-gen/#</a><br>推荐下面的方式来配置,比较简单(如果检查配置有报错的话,需要注意SS字段的level值应该是数字<code>1</code> 而不是字符串<code>&#39;1&#39;</code>):</li>
<li>web界面配置V2ray: <a href="https://htfy96.github.io/v2ray-config-gen/#" target="_blank" rel="external">https://htfy96.github.io/v2ray-config-gen/#</a></li>
<li>把生成好的服务端配置文件保存在 <code>/etc/v2ray/config.json</code>文件中</li>
<li>把生成的对应的客户端配置保存在本地的<code>config.json</code>文件中.</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"> &#123;</div><div class="line">  <span class="attr">"log"</span> : &#123;</div><div class="line">    <span class="attr">"access"</span>: <span class="string">"/var/log/v2ray/access.log"</span>,</div><div class="line">    <span class="attr">"error"</span>: <span class="string">"/var/log/v2ray/error.log"</span>,</div><div class="line">    <span class="attr">"loglevel"</span>: <span class="string">"warning"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">27514</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"d75cca2f-e955-4b32-b3fe-ba6f3e501113"</span>,</div><div class="line">          <span class="attr">"level"</span>: <span class="number">1</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outboundDetour"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"blackhole"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"blocked"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"routing"</span>: &#123;</div><div class="line">    <span class="attr">"strategy"</span>: <span class="string">"rules"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"rules"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">          <span class="attr">"ip"</span>: [            <span class="string">"0.0.0.0/8"</span>,</div><div class="line">            <span class="string">"10.0.0.0/8"</span>,</div><div class="line">            <span class="string">"100.64.0.0/10"</span>,</div><div class="line">            <span class="string">"127.0.0.0/8"</span>,</div><div class="line">            <span class="string">"169.254.0.0/16"</span>,</div><div class="line">            <span class="string">"172.16.0.0/12"</span>,</div><div class="line">            <span class="string">"192.0.0.0/24"</span>,</div><div class="line">            <span class="string">"192.0.2.0/24"</span>,</div><div class="line">            <span class="string">"192.168.0.0/16"</span>,</div><div class="line">            <span class="string">"198.18.0.0/15"</span>,</div><div class="line">            <span class="string">"198.51.100.0/24"</span>,</div><div class="line">            <span class="string">"203.0.113.0/24"</span>,</div><div class="line">            <span class="string">"::1/128"</span>,</div><div class="line">            <span class="string">"fc00::/7"</span>,</div><div class="line">            <span class="string">"fe80::/10"</span></div><div class="line">          ],</div><div class="line">          <span class="attr">"outboundTag"</span>: <span class="string">"blocked"</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"transport"</span>: &#123;</div><div class="line">    <span class="attr">"kcpSettings"</span>: &#123;</div><div class="line">      <span class="attr">"uplinkCapacity"</span>: <span class="number">2</span>,</div><div class="line">      <span class="attr">"downlinkCapacity"</span>: <span class="number">10</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="运行v2ray">运行v2ray</h1><p>使用以下命令可以指定配置文件启动v2ray</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">v2ray -<span class="built_in">config</span>  /etc/v2ray/<span class="built_in">config</span>.json</div></pre></td></tr></table></figure>
<h1 id="客户端运行">客户端运行</h1><p>在github上下载对应的系统版本的编译好的版本</p>
<ul>
<li><p><code>https://github.com/v2ray/v2ray-core/releases</code></p>
</li>
<li><p>解压到任意目录后,把上面生成的客户端配置文件保存到相同目录下 </p>
</li>
<li><p>在终端命令行中切换到解压的目录,使用这个命令运行 <code>./v2ray -config config.json</code> </p>
</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/10/15/docker-notes-01/" itemprop="url">
                  docker 笔记记录
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-10-15T14:48:55+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/15/docker-notes-01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/15/docker-notes-01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>工作中有一个工程需要运行在centos环境下,然而又不想在centos下进行编码和调试,于是就想还是用docker来映射container的端口到主机下,并且把代码的目录映射到centos的docker container中.这样就可以在本机中写代码和查看结果,并container中运行代码了.</p>
<p>几年前docker刚出来时,玩过几天,但是由于没有做笔记,把内容都忘光了,时隔几年,docker已经在微服务的互联网浪潮中大显光彩.趁此机会复习一下docker的常用命令.<br>于是有了下面的折腾过程:</p>
<p>简单解释的几个名词 :</p>
<ol>
<li>docker 当然指的就是蓝色的小鲸鱼啦  </li>
<li>container 是集装箱的意思 也就是鲸鱼背上的那些集装箱.也就是镜像运行的结果,我们代码运行的环境.</li>
</ol>
<h2 id="下载安装_Docker">下载安装 Docker</h2><p>首先把几年前装的旧版本先删除掉,再去官网下载docker的安装文件.</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 清理工作 先查看有哪些machine</div><div class="line"></div><div class="line">docker-machine <span class="keyword">ls</span> </div><div class="line">docker-machine <span class="keyword">rm</span> `docker-machine <span class="keyword">ls</span>`</div><div class="line">sudo <span class="keyword">rm</span> /usr/<span class="keyword">local</span>/bin/docker</div><div class="line">sudo <span class="keyword">rm</span> /usr/<span class="keyword">local</span>/bin/docker-compose</div><div class="line">sudo <span class="keyword">rm</span> /usr/<span class="keyword">local</span>/bin/docker-machine</div></pre></td></tr></table></figure>
<p>安装完成后小鲸鱼就会出现在任务栏中了.</p>
<p>windows版本需要windows10才支持docker,且需要打开hyper-V(打开后会与VMware有冲突).</p>
<h3 id="在Settings中增加镜像">在Settings中增加镜像</h3><p>找到Registry mirrors,增加网易docker镜像地址:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span><span class="comment">//hub.c.163.com</span></div></pre></td></tr></table></figure>
<h2 id="编写dockerFile">编写dockerFile</h2><p>内容如下:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Dockerfile</span></div><div class="line"></div><div class="line"><span class="keyword">FROM</span> centos:latest</div><div class="line"><span class="keyword">MAINTAINER</span> Lyn</div><div class="line"></div><div class="line"><span class="keyword">LABEL</span><span class="bash"> Name=<span class="string">"centos/tailorc"</span></span></div><div class="line"></div><div class="line"><span class="comment"># 上面是设置docker的镜像来源,下面是升级并安装项目依赖文件,并设置暴露的端口.</span></div><div class="line"><span class="comment"># RUN可以有多个 而CMD则指的是container执行后运行的命令.只能有一条,如果有多条那么只会运行最后一条.</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> yum --assumeyes --setopt=tsflags=nodocs update  </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> yum -y  install libevent gtk2 alsa-lib  libXt    </span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> yum clean all</span></div><div class="line"><span class="keyword">EXPOSE</span> <span class="number">1306</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/bin/bash"</span>]</span></div></pre></td></tr></table></figure>
<h2 id="build_docker镜像">build docker镜像</h2><blockquote>
<p>注意:需要先切换到dockerFile的路径下</p>
<p>-f 参数 是指定dockerFile的路径. -t 则是为新建的镜像指定tag name和version</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd <span class="regexp">/Users/</span>Lyn<span class="regexp">/Tailor/</span></div><div class="line">docker build -f <span class="string">"/Users/Lyn/Tailor/dockerFile"</span> -t <span class="string">tailor:</span><span class="number">1.0</span> .</div></pre></td></tr></table></figure>
<p>build 成功以后可以通过<code>docker images</code>命令来查看系统中所有的docker镜像:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Lyn-Cheung-MBP:Tailor Lyn$ docker images</div><div class="line">REPOSITORY          <span class="keyword">TAG</span>                 <span class="title">IMAGE</span> ID            CREATED             SIZE</div><div class="line">tailor              <span class="number">1.0</span>                 <span class="number">74</span>f386530eb3        <span class="number">27</span> minutes ago      <span class="number">510</span> MB</div><div class="line">centos              latest              <span class="number">980</span>e0e4c79ec        <span class="number">5</span> weeks ago         <span class="number">196.8</span> MB</div></pre></td></tr></table></figure>
<h2 id="run_docker镜像">run docker镜像</h2><p>运行下面这个命令就会启动一个标签叫tailorC的container,并进入到container的终端中(输入exit 会退出terminal并关闭这个container的运行,可以通过<code>docker start &lt;container的name&gt;</code> 来重新启动container,通过<code>docker attach &lt;docker container name&gt;</code> 来进入terminal)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run  -v /Users/Lyn/folder:/opt/Tailor -<span class="selector-tag">p</span> <span class="number">1306</span>:<span class="number">1306</span>  --name tailorC  -t -<span class="selector-tag">i</span>  tailor:<span class="number">1.0</span></div></pre></td></tr></table></figure>
<h3 id="参数解析:">参数解析:</h3><ol>
<li>-v 指的是volume 把本地的目录映射挂载到container的指定目录中 </li>
<li>-p 指的是Port 把host主机的端口的浏览转发到container的指定端口</li>
<li>–name 指的是给container指定别名.</li>
<li>-t 指的是terminal 选项让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上</li>
<li>-i 则让容器的标准输入保持打开。</li>
</ol>
<p>最后跟着的是镜像的名字<br>也可以在镜像名字后面再跟上默认执行的[CMD]如果有这个参数那么就会覆盖dockerFile中的[CMD]命令</p>
<p>进入container的terminal以后就可以运行想要的运行的命令了.</p>
<h3 id="权限问题">权限问题</h3><p>如果要执行挂载进来的路径中的代码,需要注意两个问题:</p>
<ol>
<li>需要在docker的preference中设置允许挂载这个路径的文件.</li>
<li>在container中可能需要使用 <code>chmod -R 777 &lt;Container中具体路径位置&gt;</code> 命令来修改挂载目录的权限</li>
</ol>
<h3 id="访问container的服务">访问container的服务</h3><p>只要container中的服务启动<br>在本地的浏览器中 访问<code>http://127.0.0.1:1306/</code>就相当于是访问container中的1306端口了. </p>
<h2 id="查看运行的docker_container">查看运行的docker container</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker ps <span class="_">-a</span></div></pre></td></tr></table></figure>
<p>运行结果如下:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Lyn$ docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES</div><div class="line">80ac33b9d175        tailor:<span class="number">1.0</span>          <span class="string">"/bin/bash"</span>         <span class="number">4</span> hours ago         <span class="meta">Up</span> <span class="number">2</span> minutes        <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">1306</span>-&gt;<span class="number">1306</span>/tcp   tailorC</div></pre></td></tr></table></figure>
<h3 id="查看docker的网络配置">查看docker的网络配置</h3><p>当web服务有问题时,我们可以检查docker的网络配置</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Lyn$ docker network ls</div><div class="line">NETWORK ID          NAME                DRIVER              SCOPE</div><div class="line">18ed300147f8        bridge              bridge              <span class="built_in">local</span>               </div><div class="line"><span class="number">02d2c77c1549</span>        host                host                <span class="built_in">local</span>               </div><div class="line"><span class="number">8b3894017396</span>        none                null                <span class="built_in">local</span></div></pre></td></tr></table></figure>
<h3 id="查看具体的网络配置:">查看具体的网络配置:</h3><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">Lyn$ docker network inspect bridge</div><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="string">"Name"</span>: <span class="string">"bridge"</span>,</div><div class="line">        <span class="string">"Id"</span>: <span class="string">"18ed300147f8ea03e7e94fc4ae289fdd50508c0fb8582520931843d409d9bf0b"</span>,</div><div class="line">        <span class="string">"Scope"</span>: <span class="string">"local"</span>,</div><div class="line">        <span class="string">"Driver"</span>: <span class="string">"bridge"</span>,</div><div class="line">        <span class="string">"EnableIPv6"</span>: false,</div><div class="line">        <span class="string">"IPAM"</span>: &#123;</div><div class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</div><div class="line">            <span class="string">"Options"</span>: null,</div><div class="line">            <span class="string">"Config"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"Subnet"</span>: <span class="string">"172.17.0.0/16"</span>,</div><div class="line">                    <span class="string">"Gateway"</span>: <span class="string">"172.17.0.1"</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"Internal"</span>: false,</div><div class="line">        <span class="string">"Containers"</span>: &#123;</div><div class="line">            <span class="string">"80ac33b9d175f91416cae336dfd52f4bcce5a0741dbb0c06d4c1c55d44d7d019"</span>: &#123;</div><div class="line">                <span class="string">"Name"</span>: <span class="string">"tailorC"</span>,</div><div class="line">                <span class="string">"EndpointID"</span>: <span class="string">"801d9177f10ac31475a3c1dcd2de46cbe1009c352fe1e12e6eae0888a705fdc5"</span>,</div><div class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:ac:11:00:02"</span>,</div><div class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"172.17.0.2/16"</span>,</div><div class="line">                <span class="string">"IPv6Address"</span>: <span class="string">""</span></div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"Options"</span>: &#123;</div><div class="line">            <span class="string">"com.docker.network.bridge.default_bridge"</span>: <span class="string">"true"</span>,</div><div class="line">            <span class="string">"com.docker.network.bridge.enable_icc"</span>: <span class="string">"true"</span>,</div><div class="line">            <span class="string">"com.docker.network.bridge.enable_ip_masquerade"</span>: <span class="string">"true"</span>,</div><div class="line">            <span class="string">"com.docker.network.bridge.host_binding_ipv4"</span>: <span class="string">"0.0.0.0"</span>,</div><div class="line">            <span class="string">"com.docker.network.bridge.name"</span>: <span class="string">"docker0"</span>,</div><div class="line">            <span class="string">"com.docker.network.driver.mtu"</span>: <span class="string">"1500"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"Labels"</span>: &#123;&#125;</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="清理_docker">清理 docker</h2><h3 id="删除指定的镜像">删除指定的镜像</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">docker</span> <span class="selector-tag">rmi</span> <span class="selector-tag">tailor</span><span class="selector-pseudo">:1.0</span></div></pre></td></tr></table></figure>
<h3 id="移除_dangling_镜像">移除 dangling 镜像</h3><p>dangling 指的也就是在build过程下载和产生的tag为none:none的镜像 </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">docker</span> images -qf dangling=<span class="literal">true</span> | xargs docker rmi</div></pre></td></tr></table></figure>
<h3 id="移除_dangling_volumes">移除 dangling volumes</h3><p>dangling 指的也就是在build过程下载和产生的tag为none:none的镜像 </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">volume</span><span class="bash"> ls -qf dangling=<span class="literal">true</span> | xargs -r docker volume rm</span></div></pre></td></tr></table></figure>
<h3 id="删除已经没有运行的containers">删除已经没有运行的containers</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">rm</span> `docker ps -aq`</div><div class="line"></div><div class="line"><span class="comment">//或者</span></div><div class="line">docker <span class="keyword">rm</span> $(docker ps -a -q)</div><div class="line"></div><div class="line">#windows下 :</div><div class="line"><span class="keyword">FOR</span> /f <span class="string">"tokens=*"</span> %i <span class="keyword">IN</span> ('docker ps -a -q') <span class="keyword">DO</span> docker <span class="keyword">rm</span> %<span class="built_in">i</span></div></pre></td></tr></table></figure>
<h3 id="kill_所有正在运行的_containers">kill 所有正在运行的 containers</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">kill</span> <span class="string">`docker ps -aq`</span></div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/10/15/functional_programming/" itemprop="url">
                  函数式编程笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-10-15T14:48:55+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/15/functional_programming/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/15/functional_programming/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="函数式编程?">函数式编程?</h1><blockquote>
<p>函数式编程是和传统命令式编程区分的一种编程思想，“在函数式编程语言中，函数是第一类的对象，也就是说，函数 不依赖于任何其他的对象而可以独立存在，而在面向对象的语言中，函数 ( 方法 ) 是依附于对象的，属于对象的一部分。这一点决定了函数在函数式语言中的一些特别的性质，比如作为传出 / 传入参数，作为一个普通的变量等。[1]”</p>
<p>函数式编程思想的源头可以追溯到 20 世纪 30 年代，数学家阿隆左 . 丘奇在进行一项关于问题的可计算性的研究，也就是后来的 lambda 演算。lambda 演算的本质为 一切皆函数，函数可以作为另外一个函数的输出或者 / 和输入，一系列的函数使用最终会形成一个表达式链，这个表达式链可以最终求得一个值，而这个过程，即为计算的本质。</p>
<p>然而，这种思想在当时的硬件基础上很难实现，历史最终选择了同丘奇的 lambda 理论平行的另一种数学理论：图灵机作为计算理论，而采取另一位科学家冯 . 诺依曼的计算机结构，并最终被实现为硬件。由于第一台计算机即为冯 . 诺依曼的程序存储结构，因此运行在此平台的程序也继承了这种基因，程序设计语言如 C/Pascal 等都在一定程度上依赖于此体系。</p>
<p>到了 20 世纪 50 年代，一位 MIT 的教授 John McCarthy 在冯 . 诺依曼体系的机器上成功的实现了 lambda 理论，取名为 LISP(LISt Processor), 至此函数式编程语言便开始活跃于计算机科学领域。</p>
</blockquote>
<h2 id="函数式编程的好处">函数式编程的好处</h2><h3 id="更少的Bug">更少的Bug</h3><p>函数式编程由于使用了高阶函数(Higher Order Function)通常来说比传统的命令式编程的代码,代码会少很多,每行代码也更容易被理解.这样出现bug的可能性会明显降低,代码的质量会明显更高一些.</p>
<h3 id="更少的coding时间">更少的coding时间</h3><p>相比于传统的命令式编程,函数式编程因为代码更少,而且函数式编程的可以复用更多的函数和代码,所以编程需要的时间会更少一些.</p>
<h1 id="环境配置">环境配置</h1><h2 id="package-json">package.json</h2><p>先配置一个package.json文件. 然后运行 <code>npm install</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"test"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="attr">"description"</span>: <span class="string">"es6"</span>,</div><div class="line">  <span class="attr">"main"</span>: <span class="string">"main.js"</span>,</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"start"</span>: <span class="string">"babel-node main.js"</span>,</div><div class="line">    <span class="attr">"build"</span>: <span class="string">"babel src --out-dir lib"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</div><div class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"babel-cli"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-core"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-destructuring"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-modules-commonjs"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-parameters"</span>: <span class="string">"^6.18.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-es2015-spread"</span>: <span class="string">"^6.8.0"</span>,</div><div class="line">    <span class="attr">"babel-plugin-transform-strict-mode"</span>: <span class="string">"^6.18.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="配置Babel">配置Babel</h2><p>在项目目录下新建 .babelrc:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"plugins"</span>: [</div><div class="line">    <span class="string">"transform-strict-mode"</span>,</div><div class="line">    <span class="string">"transform-es2015-modules-commonjs"</span>,</div><div class="line">    <span class="string">"transform-es2015-spread"</span>,</div><div class="line">    <span class="string">"transform-es2015-destructuring"</span>,</div><div class="line">    <span class="string">"transform-es2015-parameters"</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<!--# why Fucntional programming

 1. lessCode = lessBug
-->
<h1 id="常用的函数:_filter,_map,_reduce:">常用的函数: filter, map, reduce:</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">var animals = [</div><div class="line">  &#123;name: <span class="string">'a'</span> , specie<span class="variable">s:</span> <span class="string">'dog'</span>, weigh<span class="variable">t:</span> <span class="number">11</span>&#125;,</div><div class="line">  &#123;name: <span class="string">'b'</span>, specie<span class="variable">s:</span> <span class="string">'cat'</span>, weigh<span class="variable">t:</span> <span class="number">10</span>&#125;,</div><div class="line">  &#123;name: <span class="string">'c'</span>, specie<span class="variable">s:</span> <span class="string">'fish'</span>, weigh<span class="variable">t:</span> <span class="number">1</span>&#125;,</div><div class="line">  &#123;name: <span class="string">'d'</span>, specie<span class="variable">s:</span> <span class="string">'cat'</span>, weigh<span class="variable">t:</span> <span class="number">8</span>&#125;,</div><div class="line">  &#123;name: <span class="string">'e'</span>, specie<span class="variable">s:</span> <span class="string">'rabbit'</span>, weigh<span class="variable">t:</span> <span class="number">3</span>&#125;</div><div class="line">]</div><div class="line">// 找到所有种类为猫的动物</div><div class="line">animals.<span class="built_in">filter</span>((animal) =&gt; animal.species === <span class="string">'cat'</span>)</div><div class="line">// [ &#123; name: <span class="string">'b'</span>, specie<span class="variable">s:</span> <span class="string">'cat'</span> &#125;, &#123; name: <span class="string">'d'</span>, specie<span class="variable">s:</span> <span class="string">'cat'</span> &#125; ]</div><div class="line"></div><div class="line">// 返回所有动物的名字</div><div class="line">animals.<span class="keyword">map</span>((animal) =&gt; animal.name)</div><div class="line">// [ <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span> ]</div><div class="line"></div><div class="line">// 动物总重</div><div class="line">animals.reduce((<span class="keyword">pre</span>, animal) =&gt; <span class="keyword">pre</span> + animal.weight, <span class="number">0</span>)</div><div class="line">//<span class="number">33</span></div></pre></td></tr></table></figure>
<p>怎么样? 如果用循环来写肯定不可能一行代码就搞定吧.</p>
<h1 id="一个简单的例子:">一个简单的例子:</h1><h2 id="Task:读取data文件中的数据转化为对象:">Task:读取data文件中的数据转化为对象:</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mark johnson  waffle  iron  <span class="number">80</span>  <span class="number">2</span></div><div class="line">mark johnson  blender  <span class="number">200</span>  <span class="number">1</span></div><div class="line">mark johnson  knife  <span class="number">10</span>  <span class="number">4</span></div><div class="line">nikita Smith  waffle  iron  <span class="number">80</span>  <span class="number">1</span></div><div class="line">nikita Smith  knife <span class="number">10</span>  <span class="number">2</span></div><div class="line">nikita Smith  pot <span class="number">20</span>  <span class="number">3</span></div></pre></td></tr></table></figure>
<ul>
<li>把上面的data文件数据(每行不同属性之间由Tab制表符分割(或者两个空格)),转换成下面的对象格式:</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"mark johnson"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"waffle"</span>, <span class="attr">"price"</span>: <span class="string">"iron"</span>,<span class="attr">"quantity"</span>: <span class="string">"80"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"blender"</span>,<span class="attr">"price"</span>: <span class="string">"200"</span>, <span class="attr">"quantity"</span>: <span class="string">"1"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"knife"</span>,<span class="attr">"price"</span>: <span class="string">"10"</span>,<span class="attr">"quantity"</span>: <span class="string">"4"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"nikita Smith"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"waffle"</span>,<span class="attr">"price"</span>: <span class="string">"iron"</span>,<span class="attr">"quantity"</span>: <span class="string">"80"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"knife"</span>, <span class="attr">"price"</span>: <span class="string">"10"</span>, <span class="attr">"quantity"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"pot"</span>, <span class="attr">"price"</span>: <span class="string">"20"</span>,<span class="attr">"quantity"</span>: <span class="string">"3"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="1-首先,利用fs-readFileSync读取出文件中的内容">1.首先,利用<code>fs.readFileSync</code>读取出文件中的内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span> </div><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</div><div class="line"><span class="keyword">var</span> output = fs.readFileSync(<span class="string">'data'</span>, <span class="string">'utf-8'</span>)</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'output: \n'</span>,output);</div></pre></td></tr></table></figure>
<ul>
<li>使用 <code>npm start</code> 运行main.js文件:</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">npm <span class="literal">start</span></div><div class="line"></div><div class="line">&gt; test@<span class="number">1.0</span>.<span class="number">0</span> <span class="literal">start</span> /src/<span class="keyword">node</span><span class="title">/fnProgramming</span></div><div class="line">&gt; babel-<span class="keyword">node</span> <span class="title">main</span>.js</div><div class="line"></div><div class="line">output:</div><div class="line">mark johnson  waffle iron <span class="number">80</span> <span class="number">2</span></div><div class="line">mark johnson  blender <span class="number">200</span> <span class="number">1</span></div><div class="line">mark johnson  knife <span class="number">10</span> <span class="number">4</span></div><div class="line">nikita Smith waffle  iron <span class="number">80</span> <span class="number">1</span></div><div class="line">nikita Smith knife  <span class="number">10</span> <span class="number">2</span></div><div class="line">nikita Smith pot <span class="number">20</span> <span class="number">3</span></div></pre></td></tr></table></figure>
<h3 id="2-_根据换行符\n_进行分割字符串为数组-">2. 根据换行符<code>\n</code> 进行分割字符串为数组.</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span> </div><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</div><div class="line"><span class="keyword">var</span> output = fs.readFileSync(<span class="string">'data'</span>, <span class="string">'utf-8'</span>)</div><div class="line">				  .split(<span class="string">'\n'</span>)</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'output: \n'</span>,output);</div></pre></td></tr></table></figure>
<ul>
<li>结果中数组最后一项为空是因为文件是以空行结尾的.可以使用trim()方法过滤掉掉头尾的空格</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="string">output:</span></div><div class="line"> [ <span class="string">'mark johnson  waffle iron 80 2'</span>,</div><div class="line">  <span class="string">'mark johnson  blender 200 1'</span>,</div><div class="line">  <span class="string">'mark johnson  knife 10 4'</span>,</div><div class="line">  <span class="string">'nikita Smith waffle  iron 80 1'</span>,</div><div class="line">  <span class="string">'nikita Smith knife  10 2'</span>,</div><div class="line">  <span class="string">'nikita Smith pot 20 3  '</span>,</div><div class="line">  <span class="string">''</span> ]</div></pre></td></tr></table></figure>
<h3 id="3-_根据制表符对每行数据进行分割:">3.  根据制表符对每行数据进行分割:</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span> </div><div class="line"></div><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span>  output = fs.readFileSync(<span class="string">'data'</span>, <span class="string">'utf-8'</span>)</div><div class="line">        .trim()</div><div class="line">        .split(<span class="string">'\n'</span>)</div><div class="line">        .map(<span class="function"><span class="params">line</span>=&gt;</span>line.split(<span class="string">'\t'</span>)) <span class="comment">//如果你的编辑器把tab制表符转换成两个空格 这里就应该使用2个空格作为分割点      </span></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'output: \n'</span>,output);</div></pre></td></tr></table></figure>
<ul>
<li>输出结果:</li>
</ul>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">output:</div><div class="line"> [ [ <span class="string">'mark johnson'</span>, <span class="string">'waffle'</span>, <span class="string">'iron'</span>, <span class="string">'80'</span>, <span class="string">'2'</span> ],</div><div class="line">  [ <span class="string">'mark johnson'</span>, <span class="string">'blender'</span>, <span class="string">'200'</span>, <span class="string">'1'</span> ],</div><div class="line">  [ <span class="string">'mark johnson'</span>, <span class="string">'knife'</span>, <span class="string">'10'</span>, <span class="string">'4'</span> ],</div><div class="line">  [ <span class="string">'nikita Smith'</span>, <span class="string">'waffle'</span>, <span class="string">'iron'</span>, <span class="string">'80'</span>, <span class="string">'1'</span> ],</div><div class="line">  [ <span class="string">'nikita Smith'</span>, <span class="string">'knife 10'</span>, <span class="string">'2'</span> ],</div><div class="line">  [ <span class="string">'nikita Smith'</span>, <span class="string">'pot 20'</span>, <span class="string">'3'</span> ] ]</div></pre></td></tr></table></figure>
<h3 id="4-_使用reduce函数解析出每行的属性-">4. 使用reduce函数解析出每行的属性.</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span> </div><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span>  output = fs.readFileSync(<span class="string">'data'</span>, <span class="string">'utf-8'</span>)</div><div class="line">        .trim()</div><div class="line">        .split(<span class="string">'\n'</span>)</div><div class="line">        .map(<span class="function"><span class="params">line</span>=&gt;</span>line.split(<span class="string">'  '</span>))      </div><div class="line">        .reduce(<span class="function">(<span class="params">customers,line</span>)=&gt;</span>&#123;</div><div class="line">           customers[line[<span class="number">0</span>]]=customers[line[<span class="number">0</span>]]||[] <span class="comment">//当customers为空时,用[]赋值.</span></div><div class="line">           customers[line[<span class="number">0</span>]].push(&#123;</div><div class="line">             <span class="attr">name</span>:line[<span class="number">1</span>],</div><div class="line">             <span class="attr">price</span>:line[<span class="number">2</span>],</div><div class="line">             <span class="attr">quantity</span>:line[<span class="number">3</span>],</div><div class="line">           &#125;)</div><div class="line">           <span class="keyword">return</span> customers</div><div class="line">        &#125;,&#123;&#125;) <span class="comment">//这里传入&#123;&#125;空对象作为 reduce的第一个参数也就是customers</span></div><div class="line">        </div><div class="line"><span class="built_in">console</span>.log(<span class="string">'output: \n'</span>,<span class="built_in">JSON</span>.stringify(output,<span class="literal">null</span>,<span class="number">2</span>));</div></pre></td></tr></table></figure>
<ul>
<li>结果:</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"> &#123;</div><div class="line">  <span class="attr">"mark johnson"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"waffle"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"iron"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"80"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"blender"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"200"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"1"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"knife"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"10"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"4"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"nikita Smith"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"waffle"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"iron"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"80"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"knife"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"10"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"2"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"pot"</span>,</div><div class="line">      <span class="attr">"price"</span>: <span class="string">"20"</span>,</div><div class="line">      <span class="attr">"quantity"</span>: <span class="string">"3"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="常用高阶函数举例">常用高阶函数举例</h2><p> 让我们看一些更深入更有意思的例子吧.比如这道比较经典的算法题: </p>
<h3 id="给定一个字符串”abcdaabc”统计每个字符的出现次数-">给定一个字符串”abcdaabc”统计每个字符的出现次数.</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 一般做法是这样的</span></div><div class="line"><span class="keyword">var</span> str=<span class="string">"abcdaabc"</span></div><div class="line"><span class="keyword">var</span> <span class="keyword">count</span> = &#123;&#125;;</div><div class="line"><span class="keyword">var</span> i;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(i=0;i&lt;str.length;i++)&#123;</div><div class="line">    <span class="keyword">var</span> chr = str.charAt(i);</div><div class="line">    <span class="keyword">if</span>( <span class="keyword">typeof</span> <span class="keyword">count</span>[chr] === <span class="string">"undefined"</span>)&#123;</div><div class="line">        <span class="keyword">count</span>[chr] = 1;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">count</span>[chr]++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>利用函数式编程思想的方法是这样的:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line">var <span class="keyword">res</span> = str.<span class="keyword">split</span>(<span class="string">''</span>)</div><div class="line">             .reduce((<span class="keyword">pre</span>, cur) =&gt; (<span class="keyword">pre</span>[cur]++ || (<span class="keyword">pre</span>[cur] = <span class="number">1</span>), <span class="keyword">pre</span>), &#123;&#125;)</div></pre></td></tr></table></figure>
<p>由上面的例子可见, 高阶函数的特性让我们在处理这类问题时比普通的方法要方便的多. 在更实际的应用场景中函数式编程的便利性更能充分的体现, 其中一个经典的例子:</p>
<h3 id="统计文本中出现频率最高的十个单词:">统计文本中出现频率最高的十个单词:</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> content = fs.readFileSync(<span class="string">'words.txt'</span>).toString();</div><div class="line"><span class="keyword">var</span> words = content.split(<span class="regexp">/[\s.,\/:\n]+/</span>);</div><div class="line"></div><div class="line"><span class="comment">// 把单词全部变为小写并利用上一个例子的方法统计单词出现的次数</span></div><div class="line"><span class="keyword">var</span> tally = words.map(<span class="function">(<span class="params">word</span>) =&gt;</span> word.toLowerCase())</div><div class="line">                 .reduce(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> (pre[cur]++ || (pre[cur]=<span class="number">1</span>), pre), &#123;&#125;)</div><div class="line"><span class="comment">//把object的key变成数组并进行排序</span></div><div class="line"><span class="keyword">var</span> top10 = <span class="built_in">Object</span>.keys(tally)</div><div class="line">                  .map(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</div><div class="line">                    <span class="keyword">return</span> &#123;<span class="attr">word</span>: key, <span class="attr">count</span>: tally[key]&#125;</div><div class="line">                  &#125;)</div><div class="line">                  .sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> b.count - a.count)</div><div class="line">                  .slice(<span class="number">0</span>, <span class="number">10</span>)</div><div class="line"><span class="built_in">console</span>.log(top10)</div></pre></td></tr></table></figure>
<p>上面这个例子充分体现了函数式编程思想的魅力,代码精简并且可读性高!</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/10/02/redux-notes-04/" itemprop="url">
                  redux-note-04 - project structure
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-10-02T11:34:28+08:00" content="2016-10-02">
              2016-10-02
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/02/redux-notes-04/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/02/redux-notes-04/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="项目布局">项目布局</h1><p>为了方便维护,一般会把actions, components, reducers,Store 拆分成单独的文件,<br>并使用export 和 import 来引用.</p>
<p>参考下面的例子:</p>
<p>在userActions.js中 export setUserName </p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">export <span class="keyword">function</span> <span class="title">setUserName</span>(name) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="type">&#123;</span></div><div class="line">    <span class="keyword">type</span>: <span class="symbol">'SET_USER_NAME</span>',</div><div class="line">    payload: name,</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在需要dispatch action的地方直接 import进来使用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//引入所有的action </span></div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> user <span class="keyword">from</span> <span class="string">'./userActions'</span>;</div><div class="line"><span class="comment">//dispatch</span></div><div class="line">store.dispatch(user.setUserName(<span class="string">'lyn'</span>));</div><div class="line"></div><div class="line"><span class="comment">//引入具体的action</span></div><div class="line"><span class="keyword">import</span> &#123; setUserName &#125; <span class="keyword">from</span> <span class="string">'./userActions'</span></div><div class="line"><span class="comment">//dispatch</span></div><div class="line">store.dispatch(setUserName(<span class="string">'lyn'</span>));</div></pre></td></tr></table></figure>
<p>具体结构如下:</p>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-10-2/66705304.jpg" alt=""></p>
<p>actions, reudcers 和components 分别放在一个文件夹下.</p>
<h2 id="连接到_Redux">连接到 Redux</h2><p>我们需要做出两个变化，将 <code>App</code> 组件连接到 Redux 并且让它能够 dispatch actions 以及从 Redux store 读取到 state。</p>
<p>首先，我们需要获取从之前安装好的 <a href="http://github.com/reactjs/react-redux" target="_blank" rel="external"><code>react-redux</code></a> 提供的 <code>Provider</code>，并且在渲染之前<strong>将根组件包装进</strong>。</p>
<h3 id="index-js"><code>index.js</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></div><div class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span></div><div class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span></div><div class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></div><div class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./containers/App'</span></div><div class="line"><span class="keyword">import</span> todoApp <span class="keyword">from</span> <span class="string">'./reducers'</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> store = createStore(todoApp);</div><div class="line"></div><div class="line"><span class="keyword">let</span> rootElement = <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</div><div class="line">render(</div><div class="line">  <span class="xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span>,</div><div class="line">  rootElement</div><div class="line">)</div></pre></td></tr></table></figure>
<p>这使得我们的 store 能为下面的组件所用。（在内部，这个是通过 React 的 <a href="http://facebook.github.io/react/docs/context.html" target="_blank" rel="external">“context” 特性</a>实现。）</p>
<p>接着，我们<strong>想要通过 react-redux 提供的 connect() 方法将包装好的组件连接到Redux</strong>。尽量只做一个顶层的组件，或者 route 处理。从技术上来说你可以将应用中的任何一个组件 <code>connect()</code> 到 Redux store 中，但应该避免这么做，因为这个数据流很难追踪。</p>
<p><strong>任何一个从 connect() 包装好的组件都可以得到一个 dispatch 方法作为组件的 props，以及得到全局 state 中所需的任何内容。</strong> <code>connect()</code> 的唯一参数是 <strong>selector</strong>。此方法可以从 Redux store 接收到全局的 state，然后返回组件中需要的 props。最简单的情况下，可以返回一个初始的 <code>state</code>，但最好先将其进行转化。</p>
<p>我们在index.js 使用<code>Provider</code>方法,把store转换成react的props.在store.js,<br>使用connect方法选择store中,component需要的state形成一个新的store.</p>
<h2 id="index-js-1">index.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> ReactDom <span class="keyword">from</span> <span class="string">'react-dom'</span>;</div><div class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</div><div class="line"></div><div class="line"><span class="comment">//引入components</span></div><div class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">'./components/Layout'</span>;</div><div class="line"><span class="comment">//引入store</span></div><div class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./store'</span>;</div><div class="line"></div><div class="line"><span class="comment">//react 把components 绑定到指定的dom节点</span></div><div class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.getElementById(<span class="string">'app'</span>);</div><div class="line">ReactDom.render(<span class="xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span></div><div class="line">  <span class="tag">&lt;<span class="name">Layout</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Provider</span>&gt;</span>, app);</div></pre></td></tr></table></figure>
<h2 id="store-js">store.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  applyMiddleware,</div><div class="line">  createStore,</div><div class="line">  compose,</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 引入middleware</span></div><div class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'redux-logger'</span>;</div><div class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</div><div class="line"><span class="keyword">import</span> promise <span class="keyword">from</span> <span class="string">'redux-promise-middleware'</span>;</div><div class="line"><span class="comment">//引入createStore 需要的reducers</span></div><div class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducers'</span>;</div><div class="line"> </div><div class="line"><span class="keyword">const</span> middleware = applyMiddleware(promise(), thunk, logger());</div><div class="line"> </div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> createStore(reducer, compose(</div><div class="line">  middleware,</div><div class="line">  <span class="built_in">window</span>.devToolsExtension ? <span class="built_in">window</span>.devToolsExtension() : <span class="function"><span class="params">f</span> =&gt;</span> f</div><div class="line">));</div><div class="line"><span class="comment">// 不需要devtool的话,就不需要compose.</span></div><div class="line"><span class="comment">// export default createStore(reducer, initialState, middleware);</span></div></pre></td></tr></table></figure>
<h2 id="components_目录">components 目录</h2><h3 id="Layout-js">Layout.js</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> &#123; connect &#125; from <span class="string">'react-redux'</span>;</div><div class="line"><span class="keyword">import</span> &#123; fetchUser &#125; from <span class="string">'../actions/userActions'</span>;</div><div class="line"><span class="keyword">import</span> &#123; fetchPosts &#125; from <span class="string">'../actions/postsActions'</span>;</div><div class="line"></div><div class="line"><span class="comment">//接收整个 Redux store 的 state 作为 props，然后返回一个传入到组件 props 的对象.</span></div><div class="line"><span class="comment">//也就是 component里面的this.props</span></div><div class="line"><span class="meta">@connect((store)</span> =&gt; &#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    user: store.user.user,</div><div class="line">    userFetched: store.user.fetched,</div><div class="line">    post: store.post.posts,</div><div class="line">  &#125;;</div><div class="line">&#125;)</div><div class="line"></div><div class="line"></div><div class="line">export <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Layout</span> <span class="title">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  componentWillMount() &#123;</div><div class="line">    <span class="keyword">this</span>.props.dispatch(fetchUser());</div><div class="line">  &#125;</div><div class="line">  fetchPost() &#123;</div><div class="line">    <span class="keyword">this</span>.props.dispatch(fetchPosts());</div><div class="line">  &#125;</div><div class="line">  render() &#123;</div><div class="line">  	 <span class="comment">//从connect 包装得到的 this.props</span></div><div class="line">    const &#123; user, post &#125; = <span class="keyword">this</span>.props;</div><div class="line">    <span class="keyword">if</span> (!post.length) &#123;</div><div class="line">      <span class="keyword">return</span> (&lt;div&gt; &lt;h1&gt; welcome &#123;user.name&#125;&lt;/h1&gt;</div><div class="line">      &lt;button onClick=&#123;<span class="keyword">this</span>.fetchPost.bind(<span class="keyword">this</span>)&#125;&gt; check your posts &lt;/button&gt;&lt;/div&gt;)</div><div class="line">    &#125;</div><div class="line">    const mappedPosts = post.map(item =&gt; &lt;li key=&#123;item.id&#125;&gt; &#123;item.text&#125;&lt;/li&gt;)</div><div class="line">    <span class="keyword">return</span> (&lt;div&gt;</div><div class="line">      &lt;h1&gt; &#123;user.name&#125;&lt;/h1&gt;</div><div class="line">      &lt;ul&gt;&#123;mappedPosts&#125;&lt;/ul&gt;</div><div class="line">    &lt;/div&gt;)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="关于_修饰符@_和_connect">关于 修饰符@ 和 connect</h3><p>如果没有引入修饰符@ (需要引入<code>babel-plugin-transform-decorators-legacy</code>转换为es5 )</p>
<p>那么需要像这样Connect Component:<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">let Layout = connect(&#123;</div><div class="line">   <span class="keyword">user</span>: store.<span class="keyword">user</span>.<span class="keyword">user</span>,</div><div class="line">&#125;)(Layout);</div></pre></td></tr></table></figure></p>
<h4 id="简单的理解修饰符函数:">简单的理解修饰符函数:</h4><p>修饰器对类的行为的改变，是代码编译时发生的，而不是在运行时。这意味着，修饰器能在编译阶段运行代码。</p>
<p>在redux中 我们需要给react组件添加props属性(Store中的指定的state) ,简单的来说就是给class增加一个包含数据的属性.</p>
<p>下面的代码中，@testable就是一个修饰器。它修改了MyTestableClass这个类的行为，为它添加了静态属性isTestable。 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">testable</span>(<span class="params">target</span>) </span>&#123;</div><div class="line">  target.isTestable = <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@testable</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTestableClass</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(MyTestableClass.isTestable) <span class="comment">// true</span></div></pre></td></tr></table></figure>
<h4 id="connect_function_:">connect function :</h4><ul>
<li><p>函数将被调用两次。第一次是设置参数，第二次是组件与 Redux store 连接：connect(mapStateToProps, mapDispatchToProps, mergeProps)(MyComponent)。</p>
</li>
<li><p>connect 函数不会修改传入的 React 组件，返回的是一个新的已与 Redux store 连接的组件，而且你应该使用这个新组件。</p>
</li>
<li><p>mapStateToProps 函数接收整个 Redux store 的 state 作为 props，然后返回一个传入到组件 props 的对象。该函数被称之为 selector。参考使用 reselect 高效地组合多个 selector ，并对 收集到的数据进行处理。</p>
</li>
<li><p><code>[mapStateToProps(state, [ownProps]): stateProps] (Function)</code>: 如果定义该参数，组件将会监听 Redux store 的变化。任何时候，只要 Redux store 发生改变，mapStateToProps 函数就会被调用。该回调函数必须返回一个纯对象，这个对象会与组件的 props 合并。如果你省略了这个参数，你的组件将不会监听 Redux store。如果指定了该回调函数中的第二个参数 ownProps，则该参数的值为传递到组件的 props，而且只要组件接收到新的 props，mapStateToProps 也会被调用。 </p>
</li>
</ul>
<h2 id="reducers目录">reducers目录</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> post <span class="keyword">from</span> <span class="string">'./postReducer'</span>;</div><div class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">'./userReducer'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;</div><div class="line">  post,</div><div class="line">  user,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="postReducer-js">postReducer.js</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">export <span class="keyword">default</span> function reducer(<span class="keyword">state</span> = &#123;</div><div class="line">  fetching: false,</div><div class="line">  fetched: false,</div><div class="line">  posts: [],</div><div class="line">  error: null,</div><div class="line">&#125;, action) &#123;</div><div class="line">  switch (action.type) &#123;</div><div class="line">    case 'FETCH_POSTS_PENDING':</div><div class="line">      &#123;</div><div class="line">        return &#123;</div><div class="line">          ...<span class="keyword">state</span>,</div><div class="line">          fetching: true,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    case 'FETCH_POSTS_REJECTED':</div><div class="line">      &#123;</div><div class="line">        return &#123; ...<span class="keyword">state</span>,</div><div class="line">          fetching: false,</div><div class="line">          error: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    case 'FETCH_POSTS_FULFILLED':</div><div class="line">      &#123;</div><div class="line">        return &#123;</div><div class="line">          ...<span class="keyword">state</span>,</div><div class="line">          fetching: false,</div><div class="line">          fetched: true,</div><div class="line">          posts: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      return &#123;</div><div class="line">        ...<span class="keyword">state</span>,</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="userReducer-js">userReducer.js</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">export <span class="keyword">default</span> function reducer(<span class="keyword">state</span> = &#123;</div><div class="line">  fetching: false,</div><div class="line">  fetched: false,</div><div class="line">  <span class="keyword">user</span>: &#123;</div><div class="line">    id: null,</div><div class="line">    name: null,</div><div class="line">    age: null,</div><div class="line">  &#125;,</div><div class="line">  error: null,</div><div class="line">&#125;, action) &#123;</div><div class="line">  switch (action.type) &#123;</div><div class="line">    case 'FETCH_USER_PENDING':</div><div class="line">      &#123;</div><div class="line">        //<span class="keyword">state</span>.name =action.payload;</div><div class="line">        return &#123;</div><div class="line">          ...<span class="keyword">state</span>,</div><div class="line">          fetching: true,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    case 'FETCH_USER_REJECTED':</div><div class="line"></div><div class="line">      &#123;</div><div class="line">        //<span class="keyword">state</span>.name =action.payload;</div><div class="line">        return &#123;</div><div class="line">          ...<span class="keyword">state</span>,</div><div class="line">          fetching: false,</div><div class="line">          error: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    case 'FETCH_USER_FULFILLED':</div><div class="line">      &#123;</div><div class="line">        return &#123;</div><div class="line">          ...<span class="keyword">state</span>,</div><div class="line">          fetching: false,</div><div class="line">          fetched: true,</div><div class="line">          <span class="keyword">user</span>: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      return &#123;</div><div class="line">        ...<span class="keyword">state</span>,</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="actions目录">actions目录</h2><h3 id="userActions-js">userActions.js</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">export <span class="keyword">function</span> <span class="title">fetchUser</span>() &#123;</div><div class="line">  <span class="keyword">return</span> <span class="type">&#123;</span></div><div class="line">    <span class="keyword">type</span>: <span class="symbol">'FETCH_USER_FULFILLED</span>',</div><div class="line">    payload: &#123;</div><div class="line">      name: <span class="symbol">'lyn</span>',</div><div class="line">      age: <span class="number">35</span>,</div><div class="line">    &#125;,</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export <span class="keyword">function</span> <span class="title">setUserName</span>(name) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="type">&#123;</span></div><div class="line">    <span class="keyword">type</span>: <span class="symbol">'SET_USER_NAME</span>',</div><div class="line">    payload: name,</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export <span class="keyword">function</span> <span class="title">setUserAge</span>(age) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="type">&#123;</span></div><div class="line">    <span class="keyword">type</span>: <span class="symbol">'SET_USER_AGE</span>',</div><div class="line">    payload: age,</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="postActions-js">postActions.js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</div><div class="line"></div><div class="line"><span class="comment">//uasage examples:</span></div><div class="line"><span class="comment">// import * as user from './userActions';</span></div><div class="line"></div><div class="line"><span class="comment">// user.setUserName('lyn');</span></div><div class="line"><span class="comment">// import &#123; setUserName &#125; from './userActions'</span></div><div class="line"><span class="comment">// setUserName('lyn');</span></div><div class="line"></div><div class="line"><span class="comment">//thunk need return function</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchPosts</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">dispatch</span>) </span>&#123;</div><div class="line">    dispatch(&#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'FETCH_POSTS_PENDING'</span>,</div><div class="line">    &#125;);</div><div class="line">    axios.get(<span class="string">'/api/posts'</span>)</div><div class="line">    .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</div><div class="line">      dispatch(&#123;</div><div class="line">        <span class="attr">type</span>: <span class="string">'FETCH_POSTS_FULFILLED'</span>,</div><div class="line">        <span class="attr">payload</span>: res.data.data,</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">    .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">      dispatch(&#123;</div><div class="line">        <span class="attr">type</span>: <span class="string">'FETCH_POSTS_REJECTED'</span>,</div><div class="line">        <span class="attr">payload</span>: err,</div><div class="line">      &#125;);</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addPost</span>(<span class="params">id, text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'ADD_POST'</span>,</div><div class="line">    <span class="attr">payload</span>: &#123;</div><div class="line">      id,</div><div class="line">      text,</div><div class="line">    &#125;,</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updatePost</span>(<span class="params">id, text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'UPDATE_POST'</span>,</div><div class="line">    <span class="attr">payload</span>: &#123;</div><div class="line">      id,</div><div class="line">      text,</div><div class="line">    &#125;,</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">deletePost</span>(<span class="params">id</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'DELETE_POST'</span>,</div><div class="line">    <span class="attr">payload</span>: id,</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/09/29/redux-notes-03/" itemprop="url">
                  redux-notes-03 常用的middleware
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-09-29T21:36:47+08:00" content="2016-09-29">
              2016-09-29
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/29/redux-notes-03/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/29/redux-notes-03/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Show_me_ur_code">Show me ur code</h1><p> 先看代码,再分别解释各个知识点.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  applyMiddleware,</div><div class="line">  createStore,</div><div class="line">  compose,</div><div class="line">  combineReducers,</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</div><div class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">'redux-logger'</span>;</div><div class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</div><div class="line"><span class="keyword">import</span> promise <span class="keyword">from</span> <span class="string">'redux-promise-middleware'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 自定义middleware</span></div><div class="line"><span class="comment">// const logger = (store)=&gt;(next)=&gt; (action)=&gt;&#123;</span></div><div class="line"><span class="comment">// 	console.log('action fired', action);</span></div><div class="line"><span class="comment">// 	next(action);</span></div><div class="line"><span class="comment">// &#125;</span></div><div class="line"></div><div class="line"><span class="comment">//定义postreducer</span></div><div class="line"><span class="keyword">const</span> postReducer = (state = &#123;</div><div class="line">  <span class="attr">fetching</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">fetched</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">posts</span>: [],</div><div class="line">  <span class="attr">error</span>: <span class="literal">null</span>,</div><div class="line">&#125;, action) =&gt; &#123;</div><div class="line">  <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">'FETCH_POSTS_PENDING'</span>:</div><div class="line">      &#123;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">          ...state,</div><div class="line">          <span class="attr">fetching</span>: <span class="literal">true</span>,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">case</span> <span class="string">'FETCH_POSTS_REJECTED'</span>:</div><div class="line">      &#123;</div><div class="line">        <span class="keyword">return</span> &#123; ...state,</div><div class="line">          <span class="attr">fetching</span>: <span class="literal">false</span>,</div><div class="line">          <span class="attr">error</span>: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">case</span> <span class="string">'FETCH_POSTS_FULFILLED'</span>:</div><div class="line">      &#123;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">          ...state,</div><div class="line">          <span class="attr">fetching</span>: <span class="literal">false</span>,</div><div class="line">          <span class="attr">fetched</span>: <span class="literal">true</span>,</div><div class="line">          <span class="attr">posts</span>: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        ...state,</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义userReducer</span></div><div class="line"><span class="keyword">const</span> userReducer = (state = &#123;</div><div class="line">  <span class="attr">fetching</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">fetched</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">users</span>: &#123;</div><div class="line">    <span class="attr">id</span>: <span class="literal">null</span>,</div><div class="line">    <span class="attr">name</span>: <span class="literal">null</span>,</div><div class="line">    <span class="attr">age</span>: <span class="literal">null</span>,</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">error</span>: <span class="literal">null</span>,</div><div class="line">&#125;, action) =&gt; &#123;</div><div class="line">  <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">'FETCH_USERS_PENDING'</span>:</div><div class="line">      &#123;</div><div class="line">        <span class="comment">//state.name =action.payload;</span></div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">          ...state,</div><div class="line">          <span class="attr">fetching</span>: <span class="literal">true</span>,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">case</span> <span class="string">'FETCH_USERS_REJECTED'</span>:</div><div class="line"></div><div class="line">      &#123;</div><div class="line">        <span class="comment">//state.name =action.payload;</span></div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">          ...state,</div><div class="line">          <span class="attr">fetching</span>: <span class="literal">false</span>,</div><div class="line">          <span class="attr">error</span>: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">case</span> <span class="string">'FETCH_USERS_FULFILLED'</span>:</div><div class="line">      &#123;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">          ...state,</div><div class="line">          <span class="attr">fetching</span>: <span class="literal">false</span>,</div><div class="line">          <span class="attr">fetched</span>: <span class="literal">true</span>,</div><div class="line">          <span class="attr">users</span>: action.payload.data.data,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        ...state,</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//使用redux的combineReducers组合两个reducer为一个供createStore使用的reducer</span></div><div class="line"><span class="keyword">const</span> app = combineReducers(&#123;</div><div class="line">  <span class="attr">user</span>: userReducer,</div><div class="line">  <span class="attr">tweets</span>: postReducer,</div><div class="line">&#125;)</div><div class="line"></div><div class="line"> </div><div class="line"><span class="comment">// 定义middleware,将promise(),thunk,和createLogger()加入到middleware中</span></div><div class="line"><span class="keyword">const</span> middleware = applyMiddleware(promise(), thunk, createLogger());</div><div class="line"></div><div class="line"><span class="comment">//使用compose方法将定义好的middleware和devToolsExtension组合成createStore的middleware参数.</span></div><div class="line"><span class="keyword">const</span> store = createStore(app, compose(</div><div class="line">  middleware,</div><div class="line">  <span class="built_in">window</span>.devToolsExtension ? <span class="built_in">window</span>.devToolsExtension() : <span class="function"><span class="params">f</span> =&gt;</span> f</div><div class="line">));</div><div class="line"></div><div class="line"></div><div class="line">store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'store changed'</span>, store.getState());</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 使用axios发起异步请求,axios封装了xhr,redux-promise-middleware会自动为异步调用dispatch三种状态(pending ,fulfilled,rejected).</span></div><div class="line">store.dispatch(&#123;</div><div class="line">  <span class="attr">type</span>: <span class="string">'FETCH_USERS'</span>,</div><div class="line">  <span class="attr">payload</span>: axios.get(<span class="string">'/api/users'</span>),</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 如果没有使用redux-promise-middleware,一般使用下面的promise链式调用的方法发起异步请求</span></div><div class="line">store.dispatch(<span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</div><div class="line">  dispatch(&#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'FETCH_POSTS_PENDING'</span>,</div><div class="line">  &#125;);</div><div class="line">  axios.get(<span class="string">'/api/posts'</span>)</div><div class="line">    .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</div><div class="line">      dispatch(&#123;</div><div class="line">        <span class="attr">type</span>: <span class="string">'FETCH_POSTS_FULFILLED'</span>,</div><div class="line">        <span class="attr">payload</span>: res.data.data,</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">    .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">      dispatch(&#123;</div><div class="line">        <span class="attr">type</span>: <span class="string">'FETCH_POSTS_REJECTED'</span>,</div><div class="line">        <span class="attr">payload</span>: err,</div><div class="line">      &#125;);</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h1 id="redux中的middleware">redux中的middleware</h1><p>middleware的概念和express的middleware是一样的,在dispatch一个action以后,action会先经过所有的middleware的加工处理或者修改,再到达reducers.<br>下面是一个简单的logger middleware.它所实现的功能就是console输出所有经过这个middleware的action.</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">const logger = <span class="function"><span class="params">(store)</span>=&gt;</span><span class="function"><span class="params">(<span class="built_in">next</span>)</span>=&gt;</span> (action)=&gt;&#123;</div><div class="line">	console.log(<span class="string">'action fired'</span>, action);</div><div class="line">  	<span class="built_in">next</span>(action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是上面的实例中引入的middleware:</p>
<h2 id="redux-thunk">redux-thunk</h2><p>为什么需要thunk,thunk做了什么?</p>
<p>在默认情况下:</p>
<ol>
<li>createStore() 所创建的 Redux store 没有使用 middleware，所以只支持 同步数据流。</li>
<li>在redux中,触发的action实际上都是一个简单的对象,而不接受action是一个function/promise.</li>
</ol>
<p>当我们引入redux-thunk这个middleware以后,我们就可以dispatch function了.在function中我们可以写异步调用的逻辑,并且再根据不同的状态再diapatch出新的action.</p>
<blockquote>
<p>像 redux-thunk 或 redux-promise 这样支持异步的<code>middleware</code>都包装了<code>store</code>的<code>dispatch()</code> 方法，以此来让你<code>dispatch</code>一些除了 action 以外的其他内容(eg：函数或者<code>Promise</code>)。   </p>
<p>你所使用的任何 middleware 都可以以自己的方式解析你<code>dispatch</code>的任何内容，并继续传递<code>actions</code>给下一个 middleware. 比如，支持 <code>Promise</code> 的 <code>middleware</code> 能够拦截<code>Promise</code>，然后为每个<code>Promise</code> dispatch 特定的<code>action</code>(eg: pending / fulfilled / rejeted)。</p>
</blockquote>
<p>当 middleware 链中的最后一个<code>middleware</code>开始 <code>dispatch action</code> 时，这个<code>action</code>必须是一个普通对象,所以<code>redux-thunk</code>的作用也可以理解为把包含function或者promise的action运行并<code>dispatch</code>成redux可以处理的普通对象.</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//dispatch的对象</span></div><div class="line"><span class="selector-tag">store</span><span class="selector-class">.dispatch</span>(&#123;</div><div class="line">  <span class="attribute">type</span>: <span class="string">'CHANGE_NAME'</span>,</div><div class="line">  <span class="attribute">payload</span>: <span class="string">'LYN'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// dispatch了一个异步调用的箭头函数(thunk middleware 让我们可以dispatch我们定义的函数) </span></div><div class="line"><span class="selector-tag">store</span><span class="selector-class">.dispatch</span>((dispatch) =&gt; &#123;</div><div class="line">  <span class="selector-tag">dispatch</span>(&#123;</div><div class="line">    <span class="attribute">type</span>: <span class="string">'FETCH_POSTS_PENDING'</span>,</div><div class="line">  &#125;);</div><div class="line">  <span class="selector-tag">axios</span><span class="selector-class">.get</span>(<span class="string">'/api/posts'</span>)</div><div class="line">    <span class="selector-class">.then</span>((res) =&gt; &#123;</div><div class="line">      <span class="selector-tag">dispatch</span>(&#123;</div><div class="line">        <span class="attribute">type</span>: <span class="string">'FETCH_POSTS_FULFILLED'</span>,</div><div class="line">        <span class="attribute">payload</span>: res.data.data,</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">    <span class="selector-class">.catch</span>((err) =&gt; &#123;</div><div class="line">      <span class="selector-tag">dispatch</span>(&#123;</div><div class="line">        <span class="attribute">type</span>: <span class="string">'FETCH_POSTS_REJECTED'</span>,</div><div class="line">        <span class="attribute">payload</span>: err,</div><div class="line">      &#125;);</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<ul>
<li>运行的过程:</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//在进入redux-thunk之前的action</span></div><div class="line"><span class="selector-tag">action</span> <span class="selector-tag">fired</span> :</div><div class="line">(dispatch) &#123;</div><div class="line">	  <span class="selector-tag">dispatch</span>(&#123;</div><div class="line">	    <span class="attribute">type</span>: <span class="string">'FETCH_POSTS_PENDING'</span></div><div class="line">	  &#125;);</div><div class="line">	  <span class="selector-tag">_axios2</span><span class="selector-class">.default</span><span class="selector-class">.get</span>(<span class="string">'/api/posts'</span>)<span class="selector-class">.then</span>(function (res) &#123;</div><div class="line">	    <span class="selector-tag">dispatch</span>(&#123;</div><div class="line">	      <span class="attribute">type</span>: <span class="string">'FETCH_POSTS_FULFILLED'</span>,</div><div class="line">	   	   ...</div><div class="line"><span class="comment">//经过redux-thunk加工后:从上面的function转化为redux可以处理的普通对象</span></div><div class="line">action <span class="attribute">fired</span>:</div><div class="line"> Object &#123;<span class="attribute">type</span>: <span class="string">"FETCH_POSTS_PENDING"</span>&#125;<span class="attribute">type</span>: <span class="string">"FETCH_POSTS_PENDING"</span><span class="attribute">__proto__</span>: Object</div></pre></td></tr></table></figure>
<h2 id="axios_和_redux-promise-middleware">axios 和 redux-promise-middleware</h2><p> axios 是一个语法类似于jQuery的ajax方法(封装的http-xhr)</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> <span class="regexp">//</span> 如果没有使用redux-promise-middleware,一般使用下面的promise链式调用的方法发起异步请求</div><div class="line">store.dispatch(<span class="function"><span class="params">(dispatch)</span> =&gt;</span> &#123;</div><div class="line">  dispatch(&#123;</div><div class="line">    type: <span class="string">'FETCH_POSTS_PENDING'</span>,</div><div class="line">  &#125;);</div><div class="line">  axios.get(<span class="string">'/api/posts'</span>)</div><div class="line">    .<span class="keyword">then</span>(<span class="function"><span class="params">(res)</span> =&gt;</span> &#123;</div><div class="line">      dispatch(&#123;</div><div class="line">        type: <span class="string">'FETCH_POSTS_FULFILLED'</span>,</div><div class="line">        payload: res.data.data,</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">    .<span class="keyword">catch</span>(<span class="function"><span class="params">(err)</span> =&gt;</span> &#123;</div><div class="line">      dispatch(&#123;</div><div class="line">        type: <span class="string">'FETCH_POSTS_REJECTED'</span>,</div><div class="line">        payload: err,</div><div class="line">      &#125;);</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>如果有大量的ajax异步请求,那么大量dispatch的action都会是一样的pending,fulfilled或rejected,<br>为了让我们的代码更加简洁,我们可以引入<code>redux-promise-middleware</code>,当action为promise时,他会根据promise的状态自动的dispatch响应的action(pending,fulfilled或rejected)</p>
<p>所以代码就可以简化如下:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//引入redux-promise-middleware</span></div><div class="line"><span class="keyword">import</span> promise from <span class="string">'redux-promise-middleware'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 定义middleware,将promise(),thunk加入到middleware中</span></div><div class="line"><span class="keyword">const</span> middleware = applyMiddleware(promise(), thunk);</div><div class="line"></div><div class="line"><span class="keyword">const</span> store = createStore(app,middleware);</div><div class="line"></div><div class="line">store.dispatch(&#123;</div><div class="line">  type: <span class="string">'FETCH_USERS'</span>,</div><div class="line">  payload: axios.<span class="built_in">get</span>(<span class="string">'/api/users'</span>),</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="createLogger">createLogger</h2><p>一个很便捷的 middleware，用来打印 action 日志<br>需要注意的是,需要放在apply middleware的最后一个参数.</p>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-10-1/21740672.jpg" alt=""></p>
<h1 id="devToolsExtension">devToolsExtension</h1><p>一个非常爽的redux调试工具.</p>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-10-1/97705137.jpg" alt=""></p>
<p>三种使用方法:</p>
<ul>
<li>from <a href="https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd" target="_blank" rel="external">Chrome Web Store</a></li>
<li>or build it with npm i &amp;&amp; npm run build:extension and load the extension’s folder ./build/extension</li>
<li>or run it in dev mode with npm i &amp;&amp; npm start and load the extension’s folder ./dev.</li>
</ul>
<p>我是用的第一种方法:</p>
<ol>
<li>直接安装chrome插件.就会在chrome dev tool上看到redux的选项卡.</li>
<li>用compose方法将定义好的middleware和devToolsExtension组合成createStore的middleware参数.</li>
</ol>
<p>代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义middleware,将promise(),thunk,和createLogger()加入到middleware中</span></div><div class="line"><span class="keyword">const</span> middleware = applyMiddleware(promise(), thunk, createLogger());</div><div class="line"></div><div class="line"><span class="comment">//使用compose方法将定义好的middleware和devToolsExtension组合成createStore的middleware参数.</span></div><div class="line"><span class="keyword">const</span> store = createStore(app, compose(</div><div class="line">  middleware,</div><div class="line">  <span class="built_in">window</span>.devToolsExtension ? <span class="built_in">window</span>.devToolsExtension() : <span class="function"><span class="params">f</span> =&gt;</span> f</div><div class="line">));</div></pre></td></tr></table></figure>
<p>github 文档:<a href="https://github.com/zalmoxisus/redux-devtools-extension" target="_blank" rel="external">https://github.com/zalmoxisus/redux-devtools-extension</a></p>
<h1 id="dora-proxy">dora-proxy</h1><p>这个是ali出的一个mock data的利器,封装了常用的几种mock data的库,可以实现api转发,data mock等功能.<br><a href="https://github.com/dora-js/dora-plugin-proxy#规则定义" target="_blank" rel="external">https://github.com/dora-js/dora-plugin-proxy#规则定义</a></p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Learn more on how to config.</span></div><div class="line"><span class="comment">// - </span></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="string">'/api/todos'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    setTimeout(() =&gt; &#123;</div><div class="line">      res.json(&#123;</div><div class="line">        <span class="attribute">success</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attribute">data</span>: [&#123;</div><div class="line">          <span class="attribute">id:</span><span class="string"> 1,</span></div><div class="line">          text: <span class="string">'Learn antd'</span>,</div><div class="line">          <span class="attribute">isComplete</span>: <span class="literal">true</span>,</div><div class="line">        &#125;, &#123;</div><div class="line">          <span class="attribute">id:</span><span class="string"> 2,</span></div><div class="line">          text: <span class="string">'Learn ant-tool'</span>,</div><div class="line">        &#125;, &#123;</div><div class="line">          <span class="attribute">id:</span><span class="string"> 3,</span></div><div class="line">          text: <span class="string">'Learn dora'</span>,</div><div class="line">        &#125;, ],</div><div class="line">      &#125;);</div><div class="line">    &#125;, <span class="number">500</span>);</div><div class="line">  &#125;,</div><div class="line">  <span class="string">'/api/users'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.json(&#123;</div><div class="line">      <span class="attribute">success</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attribute">data</span>: [&#123;</div><div class="line">        <span class="attribute">name</span>: <span class="string">'lyn'</span>,</div><div class="line">        <span class="attribute">age</span>: <span class="number">28</span>,</div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="attribute">name</span>: <span class="string">'Lee'</span>,</div><div class="line">        <span class="attribute">age</span>: <span class="number">26</span>,</div><div class="line">      &#125;],</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">  <span class="string">'/api/posts'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.json(&#123;</div><div class="line">      <span class="attribute">success</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attribute">data</span>: [&#123;</div><div class="line">      	 <span class="attribute">id:</span><span class="string">1,</span></div><div class="line">        text: <span class="string">'helloworld1'</span>,</div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="attribute">id:</span><span class="string">2,</span></div><div class="line">        text: <span class="string">'helloworld2'</span>,</div><div class="line">      &#125;],</div><div class="line">    &#125;);</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h1 id="ES6相关知识点:">ES6相关知识点:</h1><h2 id="reducer中的-">reducer中的<code>...</code></h2><blockquote>
<p>The … operator (or spread operator) is already supported for arrays in ES6. There is also an ES7 proposal for Object Rest and Spread Properties.</p>
</blockquote>
<p>Spread Operator,即 3 个点 …，配合解构有如下几种不同的使用方法:<br>简单的说就是在处理state时,产生一个新的对象或者数组.而不是修改原有的state.</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//可用于组装数组:</span></div><div class="line"><span class="keyword">const</span> todos = [<span class="string">'Learn dva'</span>];</div><div class="line">[...todos, <span class="string">'Learn antd'</span>]; </div><div class="line"><span class="comment">// ['Learn dva', 'Learn antd']</span></div><div class="line"></div><div class="line"><span class="comment">//也可用于获取数组的部分项。</span></div><div class="line"><span class="keyword">const</span> arr = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>];</div><div class="line"><span class="keyword">const</span> [first, ...rest] = arr;</div><div class="line">rest;  <span class="comment">// rest 等于 ['b', 'c']</span></div><div class="line"></div><div class="line"><span class="comment">//还可收集函数参数为数组。</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">directions</span><span class="params">(first, <span class="rest_arg">...rest</span>)</span> </span>&#123;</div><div class="line">  console.log(rest);</div><div class="line">&#125;</div><div class="line">directions(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>);  </div><div class="line"><span class="comment">//输出 ['b', 'c'];</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//对于 Object 而言，用于组合成新的 Object 。(ES2017 stage-2 proposal)</span></div><div class="line"><span class="keyword">const</span> foo = &#123;</div><div class="line">  a: <span class="number">1</span>,</div><div class="line">  b: <span class="number">2</span>,</div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> bar = &#123;</div><div class="line">  b: <span class="number">3</span>,</div><div class="line">  c: <span class="number">2</span>,</div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> d = <span class="number">4</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> ret = &#123; ...foo, ...bar, d &#125;;  </div><div class="line"><span class="comment">// &#123; a:1, b:3, c:2, d:4 &#125;</span></div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/09/27/redux-note-02/" itemprop="url">
                  Redux 快速入门 -- 02
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-09-27T21:25:15+08:00" content="2016-09-27">
              2016-09-27
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/27/redux-note-02/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/27/redux-note-02/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="从Redux开始学习React:">从Redux开始学习React:</h1><p>React的这套机制,之所以那么有特色(也可以说不那么容易被理解),就是因为他所的FLUX单向数据流的概念.</p>
<p>大家都知道React 只是一层简单的view层,那React中的数据交互,ajax应该放到哪里去实现呢?</p>
<p>目前为止,Dan Abramov在flux的理论基础上改进出的Redux公认地是发挥React组件化威力的最佳搭档.<br>Redux 除了和 React 一起用外，还支持其它界面库。</p>
<p>既然react不是必须的,那么不如先把redux单向数据流的概念搞清楚,再来看React,相信会更清晰易懂.</p>
<h1 id="一个简单的Redux实例:">一个简单的Redux实例:</h1><p>在之前配置好的开发目录中的src文件夹下:</p>
<ul>
<li>新建一个index.js文件:</li>
</ul>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">import &#123;</div><div class="line">  createStore,</div><div class="line">&#125; <span class="keyword">from</span> 'redux';</div><div class="line"></div><div class="line">// 创建一个函数,根据函数的action参数决定如何修改传进来的<span class="keyword">state</span>参数</div><div class="line">const reducer = function (<span class="keyword">state</span>, action) &#123;</div><div class="line">  if (action.type === 'INC') &#123;</div><div class="line">    return <span class="keyword">state</span> + action.payload;</div><div class="line">  &#125;</div><div class="line">  return <span class="keyword">state</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 使用redux的createStore来创建一个store,<span class="number">0</span>是<span class="keyword">state</span>初始化的值.</div><div class="line">const store = createStore(reducer, <span class="number">0</span>);</div><div class="line"></div><div class="line">// 给store绑定一个监听函数,当store dispatch事件时,箭头函数就会去获取store当前的<span class="keyword">state</span>状态.</div><div class="line">store.subscribe(() =&gt; &#123;</div><div class="line">  console.<span class="keyword">log</span>('store changed', store.getState());</div><div class="line">&#125;)</div><div class="line"></div><div class="line">//使用store的dispatch方法 dispatch action对象.</div><div class="line">store.dispatch(&#123;</div><div class="line">  type: 'INC',</div><div class="line">  payload: <span class="number">1</span>,</div><div class="line">&#125;);</div><div class="line">store.dispatch(&#123;</div><div class="line">  type: 'INC',</div><div class="line">  payload: <span class="number">100</span>,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>修改package.json文件中的entry,指定为我们新建的index.js.</li>
<li>npm的start命令中<code>index=/src/entries/index.html</code> 需要修改成<code>src/index.html</code></li>
</ul>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">"entry"</span>: &#123;</div><div class="line">   <span class="string">"index"</span>: <span class="string">"./src/index.js"</span></div><div class="line"> &#125;,</div><div class="line">    <span class="string">"start"</span>: <span class="string">"dora -p 8001 --plugins \"</span>webpack,hmr,proxy,livereload?enableJs=<span class="literal">false</span>&amp;injectHost=<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>,browser-history?index=/src/entries/index.html\<span class="string">""</span>,</div></pre></td></tr></table></figure>
<ul>
<li>然后在terminal中cd到项目文件夹的路径下 运行<code>npm start</code>命令.(<a href="http://lyn.s76.org/2016/09/26/redux-notes-01/">参考上一篇文章</a>)</li>
<li>在浏览器中访问 <code>http://localhost:8989</code></li>
</ul>
<h1 id="Redux?">Redux?</h1><blockquote>
<p>Redux is a predictable state container for JavaScript apps.</p>
</blockquote>
<p>redux是 JavaScript App 中一个用于可预测state的容器(管理器),为什么是可预测的呢?带着这个问题去找答案.<br>从上面的简单的实例来看,Redux其实很简单, 主要由三个部分组成: Action、Reducer、及 Store.</p>
<h2 id="Redux的三大原则:">Redux的三大原则:</h2><ul>
<li>单一数据源</li>
<li>State 是只读的</li>
<li>使用纯函数(reducer)来执行修改</li>
</ul>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-9-28/87905454.jpg" alt=""></p>
<p>下面我们分别展开解释这几个概念:</p>
<h2 id="单一数据源">单一数据源</h2><ul>
<li>Redux中所有的 state 都以一个对象树的形式储存在一个单一的 store 中。</li>
</ul>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-9-27/4367012.jpg" alt=""></p>
<p>展开其中的post对象,结构如下:</p>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-9-27/2099696.jpg" alt=""></p>
<h2 id="关于Store:">关于Store:</h2><p>store对象有以下几个方法:</p>
<ul>
<li>store.getState() 可以获取当前的state对象.</li>
<li>store.dispatch(action) 分发action,会立即传到 reducer 来执行。这是触发 state 变化的惟一途径。</li>
<li>store.subscribe(listener) 每当 dispatch action 的时候就会执行listener函数.</li>
<li>store.replaceReducer(nextReducer) store可以替换处理action的reducers函数.</li>
</ul>
<h2 id="State_是只读的">State 是只读的</h2><ul>
<li>惟一改变 state 的办法是触发 action，action是一个描述发生什么的对象。</li>
<li>action对象中必须要有type属性(type的值都是大写的),其他属性都可以自定义.</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">store</span><span class="selector-class">.dispatch</span>(fetchUser())</div><div class="line"><span class="comment">//这里是action文件中的一个action</span></div><div class="line"><span class="selector-tag">function</span> <span class="selector-tag">fetchUser</span>() &#123;</div><div class="line">  <span class="selector-tag">return</span> &#123;</div><div class="line">    <span class="attribute">type</span>: <span class="string">'FETCH_USER_FULFILLED'</span>,</div><div class="line">    <span class="attribute">payload</span>: &#123;</div><div class="line">      <span class="attribute">name</span>: <span class="string">'lyn'</span>,</div><div class="line">      <span class="attribute">age</span>: <span class="number">35</span>,</div><div class="line">    &#125;,</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-9-27/82500906.jpg" alt=""></p>
<h2 id="使用纯函数来执行修改">使用纯函数来执行修改</h2><ul>
<li>reducers 根据触发的 action 来决定如何改变 state 树.</li>
</ul>
<p>Reducers 必须是纯函数，它接收先前的 state 和 action，并返回新的 state。在一个大的应用中,你可以把它拆成多个小的 reducers，分别独立地操作 state tree 的不同部分.</p>
<p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-9-27/90881615.jpg" alt=""></p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">export <span class="keyword">default</span> function reducer(<span class="keyword">state</span> = &#123;</div><div class="line">  fetching: false,</div><div class="line">  fetched: false,</div><div class="line">  posts: [],</div><div class="line">  error: null,</div><div class="line">&#125;, action) &#123;</div><div class="line">  switch (action.type) &#123;</div><div class="line">    case 'FETCH_POSTS_PENDING':</div><div class="line">      &#123;</div><div class="line">        return &#123;</div><div class="line">          ...<span class="keyword">state</span>,</div><div class="line">          fetching: true,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    case 'FETCH_POSTS_REJECTED':</div><div class="line">      &#123;</div><div class="line">        return &#123; ...<span class="keyword">state</span>,</div><div class="line">          fetching: false,</div><div class="line">          error: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    case 'FETCH_POSTS_FULFILLED':</div><div class="line">      &#123;</div><div class="line">        return &#123;</div><div class="line">          ...<span class="keyword">state</span>,</div><div class="line">          fetching: false,</div><div class="line">          fetched: true,</div><div class="line">          posts: action.payload,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      return &#123;</div><div class="line">        ...<span class="keyword">state</span>,</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="关于纯函数">关于纯函数</h3><p>简单的说纯函数就是函数式编程的实现.</p>
<p>函数式编程强调没有”副作用”，意味着相同的输入，永远会得到相同的输出，而且没有任何可观察的副作用；简单理解就是每个函数职责纯粹，所有行为就是返回新的值，没有其他行为(最常见的副作用就是异步操作)，只有采用了纯函数编程,才能保证触发action时reducer总是能返回一个确定的state,由这也就是为什么redux作者说:redux是一个可以预测的state容器.</p>
<p>可以参考下面的一个例子:</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 不纯的</span></div><div class="line"><span class="keyword">var</span> minimum = <span class="number">21</span>;</div><div class="line"><span class="keyword">var</span> checkAge = <span class="function"><span class="keyword">function</span><span class="params">(age)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> age &gt;= minimum;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 纯的 不依赖除了参数以外的变量</span></div><div class="line"><span class="keyword">var</span> checkAge = <span class="function"><span class="keyword">function</span><span class="params">(age)</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> minimum = <span class="number">21</span>;</div><div class="line">  <span class="keyword">return</span> age &gt;= minimum;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>关于纯函数,更多的可以参考这里,这里就不展开了:<br><a href="http://www.ruanyifeng.com/blog/2012/04/functional_programming.html" target="_blank" rel="external">函数式编程初探</a> ,<br><a href="https://llh911001.gitbooks.io/mostly-adequate-guide-chinese/content/ch2.html" target="_blank" rel="external">函数式编程指南</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/09/26/redux-notes-01/" itemprop="url">
                  Redux 快速入门 -- 01
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-09-26T21:25:17+08:00" content="2016-09-26">
              2016-09-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/26/redux-notes-01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/26/redux-notes-01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="配置开发环境">配置开发环境</h1><p>对于新手来说,React和Redux都免不了需要配置各种环境.<br>还好ali的开源项目 <a href="https://ant-tool.github.io/quick-start.html" target="_blank" rel="external">Ant-Tool</a>为大家送上了福利,大大降低了入门的难度.</p>
<h2 id="首先需要确认你的npm版本">首先需要确认你的npm版本</h2><blockquote>
<p>由于atool 依赖了 babel 6，而 babel 6 在npm2 下会有严重的性能问题, 所以npm版本需要&gt;3)</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//检查确认npm版本</span></div><div class="line">npm -v</div><div class="line">3.10.8</div><div class="line"><span class="comment">// 安装手脚架工具</span></div><div class="line">npm i antd-init -<span class="keyword">g</span></div><div class="line"><span class="comment">// 检查版本确认安装成功</span></div><div class="line">antd-init -v</div><div class="line">1.1.2</div><div class="line"><span class="comment">// 在当前目录下创建文件夹并进入这个文件夹</span></div><div class="line"><span class="keyword">mkdir</span> blog &amp;&amp; <span class="keyword">cd</span> blog</div><div class="line"><span class="comment">//运行手脚架工具 任选其一搭建一个sample</span></div><div class="line">antd-init</div><div class="line"><span class="comment">// 启动应用</span></div><div class="line">npm start</div><div class="line"><span class="comment">// 在浏览器中打开</span></div><div class="line"><span class="keyword">open</span> http:<span class="comment">//localhost:8989</span></div></pre></td></tr></table></figure>
<p>配置package.json中的 entry属性:<br>(这个属性和webpack中配置的entry是同一个东西)</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"entry"</span>: &#123;</div><div class="line">    <span class="string">"index"</span>: <span class="string">"./src/index.js"</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="遇到的问题:">遇到的问题:</h2><ul>
<li>在升级npm的过程中升级失败</li>
</ul>
<h3 id="原因:">原因:</h3><p>PATH目录下npm文件夹的权限问题</p>
<h3 id="解决办法:">解决办法:</h3><ul>
<li>重新安装node,并根据NPM官方的方法选择其中一种来 修改npm的三个目录的权限问题(lib/node_modules, bin,share)    </li>
<li>只要是不和别人共用同一台电脑,那就可以用下面的方法把npm的文件夹owner修改成自己来解决:</li>
</ul>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/<span class="regexp">/ 获取npm PATH</span></div><div class="line">npm config get prefix</div><div class="line">/usr<span class="regexp">/local</span></div><div class="line">/<span class="regexp">/ 改变文件夹的owner</span></div><div class="line">sudo chown -R $(whoami) $(npm config get prefix)/&#123;<span class="class"><span class="keyword">lib</span>/<span class="title">node_modules</span>,<span class="title">bin</span>,<span class="title">share</span>&#125;</span></div><div class="line">/<span class="regexp">/ 设置 npm 源为淘宝镜像</span></div><div class="line">npm config set registry https:/<span class="regexp">/registry.npm.taobao.org</span></div><div class="line">/<span class="regexp">/ 更新npm到最新版本</span></div><div class="line">npm install npm -g</div><div class="line">/<span class="regexp">/ 检查更新后的版本</span></div><div class="line">npm -v</div><div class="line">3.10.8</div></pre></td></tr></table></figure>
<h2 id="配置Sublime_Text_3代码检查工具">配置Sublime Text 3代码检查工具</h2><p>打开package control install package(cmd+shift+p),安装下面两个插件:</p>
<ul>
<li>Sublimelinter</li>
<li>Sublimelinter-contrib-eslint</li>
</ul>
<p>可能需要修改Sublimelinter 配置，Preferences-&gt;Package Settings-&gt;SublimeLinter-&gt;Settings-User,</p>
<ul>
<li>debug: true 开启 debug 模式 </li>
<li>paths: 为 ESLint 路径，window 平台下 path：<code>%APPDATA%\\Roaming\\npm</code>，如果该路径已经在系统环境变量中，则可省略，具体可根据实际情况进行相应调整.<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"> &#123;</div><div class="line">    <span class="string">"user"</span>: &#123;</div><div class="line">        <span class="string">"debug"</span>: <span class="literal">true</span>,</div><div class="line">        ...</div><div class="line">        <span class="string">"linters"</span>: &#123;</div><div class="line">            <span class="string">"eslint"</span>: &#123;</div><div class="line">                ...</div><div class="line">                <span class="string">"excludes"</span>: [<span class="string">"*.html"</span>]</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        ...</div><div class="line">        <span class="string">"paths"</span>: &#123;</div><div class="line">            ....</div><div class="line">            <span class="string">"osx"</span>: [</div><div class="line">                <span class="string">"/usr/local/node/v0.12.7/bin"</span></div><div class="line">            ],</div><div class="line">            <span class="string">"windows"</span>: [</div><div class="line">             <span class="string">"C:\\Users\\用户名\\AppData\\Roaming\\npm"</span></div><div class="line">            ]</div><div class="line">        &#125; </div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="eslint全局配置文件">eslint全局配置文件</h3><p>如果想要全局使用一个eslint规则去检查代码.<br>那么需要创建.eslintrc.* 文件放在用户目录下,但是推荐的做法还是在每个项目目录下单独配置.<br>配置方法如下:</p>
<ul>
<li>osx:  <code>/Users/用户名</code></li>
<li>win:  <code>C:\Users\用户名</code></li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"parser"</span>: <span class="string">"babel-eslint"</span>,</div><div class="line">  <span class="string">"extends"</span>: <span class="string">"eslint-config-airbnb"</span>,</div><div class="line">  <span class="string">"rules"</span>: &#123;</div><div class="line">    //<span class="string">"spaced-comment"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"no-unused-vars"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"no-empty"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"react/wrap-multilines"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"react/no-multi-comp"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"no-constant-condition"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"react/jsx-no-bind"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"react/prop-types"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"arrow-body-style"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"react/prefer-stateless-function"</span>: [<span class="number">0</span>],</div><div class="line">    <span class="string">"semi"</span>: [<span class="number">0</span>]</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"ecmaFeatures"</span>: &#123;</div><div class="line">    <span class="string">"experimentalObjectRestSpread"</span>: <span class="literal">true</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>还需要全局安装这些package<code>npm install eslint-config-airbnb eslint babel-eslint  -g</code></li>
</ul>
<h2 id="配置格式化工具">配置格式化工具</h2><p>A-tool使用eslint来检查代码风格(基于airbnb推荐的编码风格)<br>可以选择以下两种方式来配置sublime的格式化功能:</p>
<h3 id="使用sublime的build功能来格式化:">使用sublime的build功能来格式化:</h3><ol>
<li>Tools-&gt;Build System-&gt;New Build System…，</li>
<li>在新建的脚本文件中 添加以下代码，保持为eslint.sublime-build到默认位置。</li>
<li>然后运行cmd+b(mac) 或 ctrl+b(win) 即可。</li>
</ol>
<p>mac：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">   &#123;</div><div class="line">    <span class="attr">"cmd"</span>: [<span class="string">"eslint --fix $file"</span>],</div><div class="line">    <span class="attr">"shell"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"path"</span>: <span class="string">"/usr/local/bin"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>window：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&#123;</div><div class="line">    <span class="attr">"cmd"</span>: [<span class="string">"eslint"</span>, <span class="string">"--fix"</span>, <span class="string">"$file"</span>],</div><div class="line">    <span class="attr">"shell"</span>: <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Tips</strong>：</p>
<ul>
<li>Mac下的”path”可以通过 <code>which node</code>来查看系统中node的路径</li>
</ul>
<h3 id="jsformart">jsformart</h3><p>打开preference&gt;package settings&gt;jsformat&gt;settings user<br>把如下代码粘进去保存即可.</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Documentation: https://github.com/beautify-web/js-beautify</span></div><div class="line"><span class="comment">// Example URL: https://github.com/victorporof/Sublime-HTMLPrettify/blob/master/.jsbeautifyrc</span></div><div class="line"><span class="comment">// Based on Airbnb's JavaScript Style Guide, URL: https://github.com/airbnb/javascript</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Collapse curly brackets</span></div><div class="line">    <span class="string">"brace_style"</span>: <span class="string">"collapse"</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Break chained method calls across subsequent lines</span></div><div class="line">    <span class="string">"break_chained_methods"</span>: <span class="literal">true</span>,</div><div class="line"></div><div class="line">    <span class="comment">// End output with newline</span></div><div class="line">    <span class="string">"end_with_newline"</span>: <span class="literal">true</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Evaluate code</span></div><div class="line">    <span class="string">"eval_code"</span>: <span class="literal">false</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Indentation character</span></div><div class="line">    <span class="string">"indent_char"</span>: <span class="string">" "</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Initial indentation level</span></div><div class="line">    <span class="string">"indent_level"</span>: <span class="number">0</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Indentation character size</span></div><div class="line">    <span class="string">"indent_size"</span>: <span class="number">2</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Indent with tabs, overrides 'indent_size' and 'indent_char'</span></div><div class="line">    <span class="string">"indent_with_tabs"</span>: <span class="literal">false</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Enable jslint-stricter mode</span></div><div class="line">    <span class="string">"jslint_happy"</span>: <span class="literal">false</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Preserve array indentation</span></div><div class="line">    <span class="string">"keep_array_indentation"</span>: <span class="literal">false</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Preserve function indentation</span></div><div class="line">    <span class="string">"keep_function_indentation"</span>: <span class="literal">false</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Number of line-breaks to be preserved in one chunk</span></div><div class="line">    <span class="string">"max_preserve_newlines"</span>: <span class="number">10</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Preserve newlines</span></div><div class="line">    <span class="string">"preserve_newlines"</span>: <span class="literal">true</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a space before an anonymous function's parentheses, i.e. function ()</span></div><div class="line">    <span class="string">"space_after_anon_function"</span>: <span class="literal">true</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a space before the conditional statement i.e. 'if (true)'</span></div><div class="line">    <span class="string">"space_before_conditional"</span>: <span class="literal">true</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add padding spaces within empty parentheses i.e. 'f( )'</span></div><div class="line">    <span class="string">"space_in_empty_paren"</span>: <span class="literal">false</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add padding spaces within parentheses i.e. 'f( a, b )'</span></div><div class="line">    <span class="string">"space_in_paren"</span>: <span class="literal">false</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Decode printable characters encoded in xNN notation</span></div><div class="line">    <span class="string">"unescape_strings"</span>: <span class="literal">false</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Wrap lines at next opportunity after N characters</span></div><div class="line">    <span class="string">"wrap_line_length"</span>: <span class="number">0</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// <span class="doctag">Note:</span> Remove the comments when adding to the project</span></div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/author.png" alt="Lyn's Blog" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Lyn's Blog</p>
        </div>
        <p class="site-description motion-element" itemprop="description">Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">57</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lyn's Blog</span>
</div>

<div class="powered-by">
  <a class="theme-link" href="http://hexo.io">Powered by Hexo
  </a>
</div>

<div class="theme-info">
  
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>

</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-lyn"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
