<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />



  <meta name="description" content="Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes" />




  <meta name="keywords" content="Lyn's blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta property="og:type" content="website">
<meta property="og:title" content="Lyn's Blog">
<meta property="og:url" content="http://lyn.s76.org/page/3/index.html">
<meta property="og:site_name" content="Lyn's Blog">
<meta property="og:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lyn's Blog">
<meta name="twitter:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Lyn's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e1a1e7f61eef21fbacf4a67a19789441";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lyn's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Node.js Angular.js Express.js HTML5 Mongodb Programing Notes</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/23/trans-note-01/" itemprop="url">
                  采访1Password背后的开发故事（自译）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-23T11:58:17+08:00" content="2016-02-23">
              2016-02-23
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/23/trans-note-01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/23/trans-note-01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Behind_the_App:_The_Story_of_1Password">Behind the App: The Story of 1Password</h1><p><img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-2-22/42337210.jpg" alt=""></p>
<p>你的网络生活安全的保障不是一件可以开玩笑的事情，但是还是有很多人为了省事在不同的网站使用相同的密码。毫无疑问这是一种不好的习惯，而且安全而复杂的密码一定是一个你难以记住的密码。这也就是为什么你需要一个密码管理工具去管理你的网络密码，比如说使用：1Password。</p>
<blockquote>
<p>Securing your online life is no joke, but many people still use the same password across different sites for the sake of convenience. Of course, that’s bad practice and the most secure password is one that you can’t remember. Which is why you need a tool to manager your online security like 1Password.</p>
</blockquote>
<p>这个App会为你的网络账号生成随机的复杂且唯一的密码，他会是你最喜欢的密码管家，最近他们最近和收费版本一同推出了带来新功能而且和IOS8兼容的免费增值版本的App</p>
<p>The app generates random, complex, and unique passwords for all of your logins and then manages them for you. It’s one of your favorite password managers, and they recently adopted a freemium model to coincide with new features and integration with iOS 8.</p>
<p>这个APP是怎么开发出来的呢？就像很多软件一样，它最开始就是一个没有计划成为消费品的供内部使用的软件，我们与1Password的团队取得了联系去探究App背后的故事。</p>
<p>How did this security tool come about? Like a lot of software, it started as an internal tool without any real plan to become a consumer product. We caught up with the 1password team at AgileBits to learn more about the story behind the app.</p>
<h2 id="这个App的灵感是从哪里来的？">这个App的灵感是从哪里来的？</h2><p>你们是为了解决一个过去遇到的问题？还是从什么其他地方获得的灵感？</p>
<p>就像很多我们喜欢的产品，我们最初是为了解决一个问题，我们的共同发起人：Dave Teare 和 Roustem Karimov 早在2005年就开始讨论这个产品的想法了，因为他们被各种需要密码的服务和为了记忆各种登录所需要的密码搞得头疼。他们想要一种能为保护不同的账号生成不同的唯一的密码的工具。并且能帮他们记住各种登录密码并在需要登录的时候帮助他们自动登录，这样他们就不会在浪费时间在各种密码登录界面了。</p>
<blockquote>
<p>Where did the idea for the app come from? Were you trying to solve a problem you’d experienced, or did the inspiration come from somewhere else?<br>Like many of our favorite products, we set out to solve a problem. Dave Teare and Roustem Karimov, our co-founders, were kicking around product ideas back in 2005 but started getting annoyed at how many services they had to sign into and all the passwords they needed to remember. They wanted a tool that would create unique passwords to protect all their accounts, and also remember those passwords and log them in automatically so they could spend less time typing into login forms and more time on what they wanted to do.</p>
</blockquote>
<h2 id="当你们有了这个灵感以后，你们的下一步是什么？">当你们有了这个灵感以后，你们的下一步是什么？</h2><p>最有趣的部分就是，原本那是没有下一步的， 我们设想那只是一个三个月的项目，Dave和Roustem当时只是自己使用这个最后成为1Password的工具，直到他们开始向他们在该领域的朋友们展示这个项目并且成功震惊了他们，直到这时他们才意识到他们创造了一个真的很特别的东西！</p>
<p>After you came up with the idea, what was the next step?<br>The funny part of this story is that, originally, there was no next step. It was supposed to be a three-month project, and Dave and Roustem were just using what eventually became 1Password on their own, internally. It wasn’t until they started showing it to friends in the field and blew their minds that they realized they had created something truly special.</p>
<h2 id="你们怎么确定在哪个平台开发这个软件作_而忽略哪些平台或者暂时不开发哪些平台？">你们怎么确定在哪个平台开发这个软件作 而忽略哪些平台或者暂时不开发哪些平台？</h2><p>在那个时候，Dave和 Roustem 两个人都离开了上班族的世界和接触Mac，所以那是难以置信的偶然。当时苹果刚推出了OS X 和 IPOD， 社区的发展极为迅速，两位创始人正在折腾新的项目，刚好就知道了OSX和Cocoa，所以这也很好理解他们在Mac上开发了测试版的1Password，看下效果如何。</p>
<p>Behind the App: The Story of 1Password<br>How did you choose which platforms to target and which to ignore or wait on?<br>Right around this time, Dave and Roustem had both just left the corporate world and discovered the Mac, so it was incredibly serendipitous. Apple was on a roll with OS X and the iPod, and the community was taking off like a rocket ship. Dave and Roustem were tinkering with new projects, getting to know OS X and Cocoa, so it just made sense to try the initial beta version of 1Password on the Mac and see where it went.</p>
<h2 id="什么是你们曾遇到的最大的障碍？你们是怎么克服它的？">什么是你们曾遇到的最大的障碍？你们是怎么克服它的？</h2><p>我不会说我们遇到了相当多的苦难，但是探索和理解安全软件的背景与更深层次的细节都是1Password不可或缺的基础。它储存了人们的密码，信用卡，大量的个人信息，我们必须知道我们的安全入口，我们必须谨慎的对待我们用户的隐私和担忧，这是一种我们不能轻松承担的特俗的责任。</p>
<p>What was your biggest roadblock and how did you overcome it?<br>I wouldn’t say it was so much of a roadblock, but exploring and understanding the context and deeper details of making a security product was an essential element to getting 1Password right. It stores people’s passwords, credit cards, and utmost personal info—we have to know our security chops, we have to be mindful of our customers’ privacy and concerns. It is a uniquely personal responsibility that we do not—cannot—take lightly.</p>
<h2 id="产品上线的时候是什么样的状况？">产品上线的时候是什么样的状况？</h2><p>发布以后让我们大吃一惊，真的。我们以为我们只是创建了一个只有书呆子才会在意的内部的工具。但是我们很快知道我们击中了用户的痛点，一些科技网站发现了它，开始写相关的文章，然后开始制作一些如何使用的教程，当人们开始与其他人讨论你们的作品时，我觉得那是世界上最棒的一种感觉之一。</p>
<p>另一个很棒的地方就是，用户开始来与我们交流，有一些人会有建议，有一些会抱怨，很多人的表扬和感谢。但归根结底就是：人们很在乎1password，他们希望能成为它的一部分从而使它变的更好用。这也是世界上最棒的一种感觉之一。</p>
<p>What was launch like for you?<br>Launch blew us away. It really did. We thought we were building an internal tool that mostly nerds would care about, but we quickly learned we struck a nerve. A few tech sites found out about it (“1Passwd” back in those days), started writing about it, then made “how to do this and that” tutorials. When people start telling other people about this thing you made… that’s one of the best feelings in the world.<br>Another great part of the launch was users coming to talk to us. Some had suggestions, some complaints, plenty of praise and thanks, but it all boils down to the same thing: people care so much about 1Password that they want to be a part of it and make it even better. Again, best feeling in the world.</p>
<h2 id="你们是怎么有效的处理用户的建议和批评的？">你们是怎么有效的处理用户的建议和批评的？</h2><p>我们的合伙人和Ceo建立了一种很棒的企业文化：他们着迷与在各种社交平台上的各种人与人之间的互动，无论是批评还是一般的回馈。我们拥有完善的支持无论什么语言什么国家。而且我们使用协作服务比如Cerberus, Google Drive 积极的与我们的用户交流，并总结反馈的信息。我们使用Jira和basecamp来管理bug报告，讨论和决定改进和增加哪些功能。</p>
<p>How do you handle user requests and criticisms effectively?<br>our co-founders and CEO built a great culture obsessed with human-to-human interaction for all our social media, criticism, and general feedback. We have a thorough support staff that spans continents and languages, and we use collaborative services like Cerberus, Google Drive, and Respond.ly to talk with our customers and organize feedback. For actual bug reporting, discussion, and deciding what to improve and build, we use Jira and Basecamp.</p>
<h2 id="现在你们怎么分配你们的时间在开发新的功能和维护已有的那些功能？">现在你们怎么分配你们的时间在开发新的功能和维护已有的那些功能？</h2><p>在所有的在开发列表上的工作任务和所有我们从用户那里获取的想法之间，一定没有什么区别。因为当决定什么时候去开发还是什么时候去改进，是真的很复杂的步骤。如果有功能不正常的时候并且我们从很多的顾客那里获知的时候，这件事就会变成我们的首要任务，因为没有我们的顾客我们就什么都不是。<br>我们的也有一个令人惊喜和感激的测试版程序，那些用户拥有很大的发言权在什么会添加到1password，包括程序的修复和新的功能。比如说我们的mac程序，就有2万5000名客户参加测试。有的时候外部的因素也会影响到我们的计划，包括操作系统的更新计划。从产品推出的第一天起我们的用户期待看到我们推出新的升级，我们尽我们所能去满足我们的用户，但是有时候那也会导致我们会商量是不是把一些新的东西增加到免费升级的小版本中去。</p>
<p>Now, how do you split time between developing new features and managing existing ones?<br>Between all the tasks already on our list and all the ideas we get from our customers, there is absolutely no shortage of places to take 1Password. As for deciding when it’s time to build and when to improve, that’s a fairly complicated dance. If something isn’t working right and we hear from a lot of customers, it gets top priority; we’d be nothing without our customers.</p>
<p>We also have (and are grateful for!) a surprisingly active beta program. Those customers have a huge voice in what we add to 1Password, including both fixes and new features. Our Mac program, for example, includes over 25,000 customers.<br>Sometimes external elements can factor into our plans as well, including OS release schedules. It’s no secret that our customers love to see our updates ready by day one, and we try our best to hit that. But sometimes that leads to discussions over whether we need to push Feature Y to a free X.1 update.</p>
<h2 id="你们会给那些想做类似的项目的人什么建议么？">你们会给那些想做类似的项目的人什么建议么？</h2><p>解决一个个人的问题，那种影响着你和你亲近的朋友们的问题。找到那件事会让你晚上也很兴奋，或者你总是发现你在和你的朋友抱怨相同的事情，但却没有好好思考过这些东西。正视那个问题，看看是不是它已经有了一个解决方案，然后想想你能不能有一个更好的解决方案。这是最好的方式去确定你可以把这件事做到最好并且保持做事的激情无论遇到在这其中遇到好的时期或者坏的，但这两种时期肯定都会出现。</p>
<p>What advice would you give to others that want to take on a similar project?<br>Solve a personal problem, something that affects you or your closest friends. Find that thing that keeps you up at night, or that you always catch yourself complaining about with friends but might not give a second thought. Look at that problem, see if it might already have a solution, then think about how you can solve it better. It’s the best way to make sure you can do great work and stay passionate through both the good days and the bad, and there will be both.</p>
<h2 id="原文链接">原文链接</h2><p><a href="http://lifehacker.com/behind-the-app-the-story-of-1password-1643425238" target="_blank" rel="external">http://lifehacker.com/behind-the-app-the-story-of-1password-1643425238</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/22/nodejs-note-24/" itemprop="url">
                  Building restfull API by using restify - 02
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-22T21:45:57+08:00" content="2016-02-22">
              2016-02-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/22/nodejs-note-24/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/22/nodejs-note-24/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</span><br><span class="line"><span class="keyword">var</span>  bunyan = <span class="built_in">require</span>(<span class="string">'bunyan'</span>); </span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">	name:<span class="string">"Toodoo API"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span>  server = restify.createServer(options);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'middleware 1 here!'</span> );</span><br><span class="line">	next();</span><br><span class="line">	<span class="comment">// next(new Error('something awful happened!'));</span></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'middleware 2 here!'</span> );</span><br><span class="line">	next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'after'</span>, restify.auditLogger(&#123;</span><br><span class="line">	log: bunyan.createLogger(&#123;</span><br><span class="line">		name:<span class="string">'audit'</span>,</span><br><span class="line">		stream: process.stdout</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// server.on('after', function ()&#123;</span></span><br><span class="line"><span class="comment">//	console.log('after', arguments);</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = server;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./routes'</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</span><br><span class="line"><span class="keyword">var</span>  bunyan = <span class="built_in">require</span>(<span class="string">'bunyan'</span>); </span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">	name:<span class="string">"Toodoo API"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span>  server = restify.createServer(options);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'middleware 1 here!'</span>, req.body);</span><br><span class="line">	next();</span><br><span class="line">	<span class="comment">// next(new Error('something awful happened!'));</span></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.use(restify.bodyParser(&#123;</span><br><span class="line">	maxBodySize: <span class="number">10</span>*<span class="number">1024</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'middleware 2 here!'</span>, req.body);</span><br><span class="line">	next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'after'</span>, restify.auditLogger(&#123;</span><br><span class="line">	log: bunyan.createLogger(&#123;</span><br><span class="line">		name:<span class="string">'audit'</span>,</span><br><span class="line">		stream: process.stdout</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// server.on('after', function ()&#123;</span></span><br><span class="line"><span class="comment">//	console.log('after', arguments);</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = server;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./routes'</span>);</span><br><span class="line"><span class="comment">// test with data</span></span><br><span class="line"><span class="comment">// curl -i -X PUT localhost:8080/lists/mylist --data '&#123;"hey":"there"&#125;' -H 'content-type: application/json'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192</span>:<span class="number">02</span> Lyn$ node .</span><br><span class="line"> API server listening on &#123;<span class="string">"address"</span>:<span class="string">"::"</span>,<span class="string">"family"</span>:<span class="string">"IPv6"</span>,<span class="string">"port"</span>:<span class="number">8080</span>&#125;</span><br><span class="line">middleware <span class="number">1</span> here! undefined</span><br><span class="line">middleware <span class="number">2</span> here! &#123; hey: <span class="string">'there'</span> &#125;</span><br><span class="line">body : &#123; hey: <span class="string">'there'</span> &#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"audit"</span>,<span class="string">"hostname"</span>:<span class="string">"Lyn-Cheung-MBP.local"</span>,<span class="string">"pid"</span>:<span class="number">45195</span>,<span class="string">"audit"</span>:true,<span class="string">"level"</span>:<span class="number">30</span>,<span class="string">"remoteAddress"</span>:<span class="string">"::ffff:127.0.0.1"</span>,<span class="string">"remotePort"</span>:<span class="number">55210</span>,<span class="string">"req_id"</span>:<span class="string">"6185400f-ad38-4578-bec7-2b1618a6ccf6"</span>,<span class="string">"req"</span>:&#123;<span class="string">"query"</span>:<span class="string">""</span>,<span class="string">"method"</span>:<span class="string">"PUT"</span>,<span class="string">"url"</span>:<span class="string">"/lists/mylist"</span>,<span class="string">"headers"</span>:&#123;<span class="string">"host"</span>:<span class="string">"localhost:8080"</span>,<span class="string">"user-agent"</span>:<span class="string">"curl/7.43.0"</span>,<span class="string">"accept"</span>:<span class="string">"*/*"</span>,<span class="string">"content-type"</span>:<span class="string">"application/json"</span>,<span class="string">"content-length"</span>:<span class="string">"15"</span>&#125;,<span class="string">"httpVersion"</span>:<span class="string">"1.1"</span>,<span class="string">"trailers"</span>:&#123;&#125;,<span class="string">"version"</span>:<span class="string">"*"</span>,<span class="string">"timers"</span>:&#123;<span class="string">"handler-0"</span>:<span class="number">449</span>,<span class="string">"readBody"</span>:<span class="number">2179</span>,<span class="string">"parseBody"</span>:<span class="number">242</span>,<span class="string">"handler-1"</span>:<span class="number">1494</span>,<span class="string">"createList"</span>:<span class="number">4112</span>&#125;&#125;,<span class="string">"res"</span>:&#123;<span class="string">"statusCode"</span>:<span class="number">200</span>,<span class="string">"headers"</span>:&#123;<span class="string">"content-type"</span>:<span class="string">"application/json"</span>,<span class="string">"content-length"</span>:<span class="number">15</span>&#125;,<span class="string">"trailer"</span>:false&#125;,<span class="string">"latency"</span>:<span class="number">12</span>,<span class="string">"_audit"</span>:true,<span class="string">"msg"</span>:<span class="string">"handled: 200"</span>,<span class="string">"time"</span>:<span class="string">"2016-02-22T15:00:33.154Z"</span>,<span class="string">"v"</span>:<span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure>
<p>create.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports= <span class="function"><span class="keyword">function</span> <span class="title">createList</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> body = req.body;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'body :'</span>,body);</span><br><span class="line">	res.send(&#123;hey:<span class="string">'there'</span>&#125;);</span><br><span class="line">	next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="validating_the_data">validating the data</h2><h3 id="Joi">Joi</h3><p>joi allows you to create <em>blueprints</em> or <em>schemas</em> for JavaScript objects (an object that stores information) to ensure <em>validation</em> of key information.</p>
<h4 id="Example">Example</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> schema = Joi.object().keys(&#123;</span><br><span class="line">    username: Joi.string().alphanum().min(<span class="number">3</span>).max(<span class="number">30</span>).required(),</span><br><span class="line">    password: Joi.string().regex(<span class="regexp">/^[a-zA-Z0-9]&#123;3,30&#125;$/</span>),</span><br><span class="line">    access_token: [Joi.string(), Joi.number()],</span><br><span class="line">    birthyear: Joi.number().integer().min(<span class="number">1900</span>).max(<span class="number">2013</span>),</span><br><span class="line">    email: Joi.string().email()</span><br><span class="line">&#125;).with(<span class="string">'username'</span>, <span class="string">'birthyear'</span>).without(<span class="string">'password'</span>, <span class="string">'access_token'</span>);</span><br><span class="line"></span><br><span class="line">Joi.validate(&#123; username: <span class="string">'abc'</span>, birthyear: <span class="number">1994</span> &#125;, schema, <span class="function"><span class="keyword">function</span> (<span class="params">err, value</span>) </span>&#123; &#125;);  <span class="comment">// err === null -&gt; valid</span></span><br></pre></td></tr></table></figure>
<p>The above schema defines the following constraints:</p>
<ul>
<li><code>username</code><ul>
<li>a required string</li>
<li>must contain only alphanumeric characters</li>
<li>at least 3 characters long but no more than 30</li>
<li>must be accompanied by <code>birthyear</code></li>
</ul>
</li>
<li><code>password</code><ul>
<li>an optional string</li>
<li>must satisfy the custom regex</li>
<li>cannot appear together with <code>access_token</code></li>
</ul>
</li>
<li><code>access_token</code><ul>
<li>an optional, unconstrained string or number</li>
</ul>
</li>
<li><code>birthyear</code><ul>
<li>an integer between 1900 and 2013</li>
</ul>
</li>
<li><code>email</code><ul>
<li>a valid email address string</li>
</ul>
</li>
</ul>
<h4 id="Usage">Usage</h4><p>Usage is a two steps process. First, a schema is constructed using the provided types and constraints:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = &#123;</span><br><span class="line">    a: Joi.string()</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Note that <strong>joi</strong> schema objects are immutable which means every additional rule added (e.g. <code>.min(5)</code>) will return a<br>new schema object.</p>
<p>Then the value is validated against the schema:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Joi.validate(&#123; a: <span class="string">'a string'</span> &#125;, schema, <span class="function"><span class="keyword">function</span> (<span class="params">err, value</span>) </span>&#123; &#125;);</span><br></pre></td></tr></table></figure>
<p>If the value is valid, <code>null</code> is returned, otherwise an <code>Error</code> object.</p>
<p>The schema can be a plain JavaScript object where every key is assigned a <strong>joi</strong> type, or it can be a <strong>joi</strong> type directly:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = Joi.string().min(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>If the schema is a <strong>joi</strong> type, the <code>schema.validate(value, callback)</code> can be called directly on the type. When passing a non-type schema object,<br>the module converts it internally to an object() type equivalent to:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = Joi.object().keys(&#123;</span><br><span class="line">    a: Joi.string()</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>When validating a schema:</p>
<ul>
<li>Keys are optional by default.</li>
<li>Strings are utf-8 encoded by default.</li>
<li>Rules are defined in an additive fashion and evaluated in order after whitelist and blacklist checks.</li>
</ul>
<p>npm install joi —save</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">var</span> server = <span class="keyword">require</span>(<span class="string">'./server'</span>);</span><br><span class="line"><span class="built_in">var</span> resources = <span class="keyword">require</span>(<span class="string">'./resources'</span>);</span><br><span class="line"><span class="built_in">var</span> validating =  <span class="keyword">require</span>(<span class="string">'./middleware/validating'</span>);</span><br><span class="line"><span class="built_in">var</span> schemas = <span class="keyword">require</span>(<span class="string">'./schemas'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//	server.get(urlPattern, function(req, res)&#123;</span></span><br><span class="line"><span class="comment">//		res.send(obj);</span></span><br><span class="line"><span class="comment">//	&#125;);</span></span><br><span class="line"></span><br><span class="line">server<span class="built_in">.</span>get(<span class="string">'/lists'</span>,resources<span class="built_in">.</span>lists<span class="built_in">.</span><span class="built_in">list</span>);</span><br><span class="line">server<span class="built_in">.</span>put(<span class="string">'/lists/:list'</span>,validating(schemas<span class="built_in">.</span><span class="built_in">list</span>),resources<span class="built_in">.</span>lists<span class="built_in">.</span>create);</span><br><span class="line">server<span class="built_in">.</span>del(<span class="string">'/lists/:list'</span>,resources<span class="built_in">.</span>lists<span class="built_in">.</span>del);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Items</span></span><br><span class="line"></span><br><span class="line">server<span class="built_in">.</span>get(<span class="string">'/lists/:list/items'</span>, resources<span class="built_in">.</span>items<span class="built_in">.</span><span class="built_in">list</span>);</span><br><span class="line">server<span class="built_in">.</span>post(<span class="string">'lists/:list/items'</span>,validating(schemas<span class="built_in">.</span>item),resources<span class="built_in">.</span>items<span class="built_in">.</span>create);</span><br><span class="line">server<span class="built_in">.</span>del(<span class="string">'/lists/:list/items/:item'</span>,resources<span class="built_in">.</span>items<span class="built_in">.</span>del);</span><br><span class="line"><span class="string">``</span><span class="string">` </span><br><span class="line">./middleware/validating.js</span></span><br></pre></td></tr></table></figure>
<p>var Joi = require(‘joi’);</p>
<p>module.exports =  function validating(schema){</p>
<pre><code><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(req,res,next)</span></span>{

    Joi.validate(req.body, schema,<span class="function"><span class="keyword">function</span><span class="params">(err, doc)</span></span>{
        <span class="keyword">if</span> (err){
            err.statusCode = <span class="number">400</span>;
            <span class="built_in">next</span>(err);
        }
        <span class="keyword">else</span>{
            req.body = doc;
            <span class="built_in">next</span>();
        }

    });

};
</code></pre><p>};<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./schmeas/<span class="keyword">index</span>.js</span><br></pre></td></tr></table></figure></p>
<p>exports.list = require(‘./list’);<br>exports.item = require(‘./item’);<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">./schmeas/<span class="type">list</span>.js</span><br></pre></td></tr></table></figure></p>
<p>var Joi = require(‘joi’);</p>
<p>// npm doc joi</p>
<p>module.exports = Joi.object().required().keys({<br>    name: Joi.string().required(),<br>    description: Joi.string(),<br>    priority: Joi.number().integer().default(0)<br>});<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./schemas/<span class="property">item</span>.js</span><br></pre></td></tr></table></figure></p>
<p>var Joi = require(‘joi’);</p>
<p>// npm doc joi</p>
<p>module.exports = Joi.object().required().keys({<br>    label: Joi.string().required()<br>});<br>```</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/21/nodejs-note-23/" itemprop="url">
                  Building restfull API by using restify - 01
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-21T16:19:49+08:00" content="2016-02-21">
              2016-02-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/21/nodejs-note-23/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/21/nodejs-note-23/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Restify">Restify</h2><blockquote>
<p>   restify is a node.js module built specifically to enable you to build correct REST web services. It intentionally borrows heavily from express as that is more or less the de facto API for writing web applications on top of node.js.</p>
</blockquote>
<h3 id="Why_use_restify_and_not_express?">Why use restify and not express?</h3><blockquote>
<pre><code>Express' use case <span class="keyword">is</span> targeted <span class="keyword">at</span> browser applications <span class="keyword">and</span> <span class="keyword">contains</span> a lot <span class="keyword">of</span> functionality, such <span class="keyword">as</span> templating <span class="keyword">and</span> rendering, <span class="keyword">to</span> support <span class="keyword">that</span>. Restify <span class="keyword">does</span> <span class="keyword">not</span>.

Restify exists <span class="keyword">to</span> let you build <span class="string">"strict"</span> API services <span class="keyword">that</span> are maintanable <span class="keyword">and</span> observable. Restify comes <span class="keyword">with</span> automatic DTrace support <span class="keyword">for</span> all your handlers, <span class="keyword">if</span> you're <span class="property">running</span> <span class="function_start"><span class="keyword">on</span></span> a platform <span class="keyword">that</span> supports DTrace.
</code></pre></blockquote>
<h2 id="creating_server">creating server</h2><p>server.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">	name:<span class="string">"Toodoo API"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span>  server = restify.createServer(options);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = server;</span><br></pre></td></tr></table></figure>
<p>index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  server =<span class="built_in">require</span>(<span class="string">'./server'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span>  port = <span class="built_in">Number</span>(process.env.SERVER_PORT) || <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">server.listen(port, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">' API server listening on %j'</span>, server.address());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="Routes">Routes</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// Print  direction structure</span><br><span class="line">192:01 Lyn$ find . -print |<span class="string"> sed -e 's;[^/]*/;</span>|<span class="string">____;g;s;____</span>|<span class="string">; </span>|<span class="string">;g'</span><br><span class="line">.</span><br><span class="line"></span>|<span class="string">____index.js</span><br><span class="line"></span>|____node_modules</span><br><span class="line">|<span class="string"> </span><br><span class="line"></span>|<span class="string">____package.json</span><br><span class="line"></span>|____resources</span><br><span class="line">|<span class="string"> </span>|<span class="string">____index.js</span><br><span class="line"></span>|<span class="string"> </span>|____items</span><br><span class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____create.js</span><br><span class="line"></span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____del.js</span><br><span class="line"></span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____index.js</span><br><span class="line"></span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____list.js</span><br><span class="line"></span>|<span class="string"> </span>|____lists</span><br><span class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____create.js</span><br><span class="line"></span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____del.js</span><br><span class="line"></span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____index.js</span><br><span class="line"></span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____list.js</span><br><span class="line"></span>|<span class="string">____routes.js</span><br><span class="line"></span>|<span class="string">____server.js</span></span><br></pre></td></tr></table></figure>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var <span class="keyword">server</span> = require(<span class="string">'./server'</span>);</span><br><span class="line">var resources = require(<span class="string">'./resources'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//lists</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//	server.get(urlPattern, function(req, res)&#123;</span></span><br><span class="line"><span class="comment">//		res.send(obj);</span></span><br><span class="line"><span class="comment">//	&#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span>.get(<span class="string">'/lists'</span>,resources.lists.list);</span><br><span class="line"><span class="keyword">server</span>.put(<span class="string">'/lists/:list'</span>,resources.lists.create);</span><br><span class="line"><span class="keyword">server</span>.del(<span class="string">'/lists/:list'</span>,resources.lists.del);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Items</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span>.get(<span class="string">'/lists/:list/items'</span>, resources.items.list);</span><br><span class="line"><span class="keyword">server</span>.post(<span class="string">'lists/:list/items'</span>,resources.items.create);</span><br><span class="line"><span class="keyword">server</span>.del(<span class="string">'/lists/:list/items/:item'</span>,resources.items.del);</span><br></pre></td></tr></table></figure>
<p>server.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">	name:<span class="string">"Toodoo API"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span>  server = restify.createServer(options);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = server;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./routes'</span>);</span><br></pre></td></tr></table></figure>
<p>resources/index.js</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exports.lists = <span class="built_in">require</span>(<span class="string">'./lists'</span>);</span><br><span class="line">exports.items = <span class="built_in">require</span>(<span class="string">'./items'</span>);</span><br></pre></td></tr></table></figure>
<p>resources/lists/index.js</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exports<span class="built_in">.</span><span class="built_in">list</span> = <span class="keyword">require</span>(<span class="string">'./list'</span>);</span><br><span class="line">exports<span class="built_in">.</span>create = <span class="keyword">require</span>(<span class="string">'./create'</span>);</span><br><span class="line">exports<span class="built_in">.</span>del =<span class="keyword">require</span>(<span class="string">'./del'</span>);</span><br></pre></td></tr></table></figure>
<p>resources/lists/list.js<br>resources/lists/del.js<br>resources/lists/create.js</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports= <span class="function"><span class="keyword">function</span> <span class="title">createItem</span><span class="params">(req,res,next)</span></span>&#123;</span><br><span class="line">	res.send(<span class="number">202</span>,&#123;hey:<span class="string">'there'</span>&#125;);</span><br><span class="line">	<span class="built_in">next</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -R resources<span class="regexp">/lists/</span>* resources<span class="regexp">/items/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192</span>:~ Lyn$ curl -I localhost:<span class="number">8080</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">404</span> Not Found</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: <span class="number">56</span></span><br><span class="line">Date: Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">46</span> GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line"><span class="number">192</span>:~ Lyn$ curl -i localhost:<span class="number">8080</span>/lists</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: <span class="number">15</span></span><br><span class="line">Date: Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">40</span>:<span class="number">03</span> GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"hey"</span>:<span class="string">"there"</span>&#125;</span><br><span class="line"><span class="number">192</span>:~ Lyn$</span><br><span class="line"> </span><br><span class="line"><span class="number">192</span>:~ Lyn$ curl -X PUT -i localhost:<span class="number">8080</span>/lists/mylist</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: <span class="number">15</span></span><br><span class="line">Date: Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">41</span>:<span class="number">28</span> GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"hey"</span>:<span class="string">"there"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">192</span>:~ Lyn$</span><br><span class="line"><span class="number">192</span>:~ Lyn$ curl  -i localhost:<span class="number">8080</span>/lists/mylist/items</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: <span class="number">15</span></span><br><span class="line">Date: Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">45</span>:<span class="number">50</span> GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"hey"</span>:<span class="string">"there"</span>&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="number">192</span>:~ Lyn$ curl -X DELETE  -i localhost:<span class="number">8080</span>/lists/mylist/items/itemid</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: <span class="number">15</span></span><br><span class="line">Date: Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">03</span> GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"hey"</span>:<span class="string">"there"</span>&#125;<span class="number">192</span>:~ Lyn$</span><br><span class="line"><span class="number">192</span>:~ Lyn$</span><br></pre></td></tr></table></figure>
<h2 id="Logging_requests">Logging requests</h2><h3 id="Bunyan">Bunyan</h3><blockquote>
<p>Bunyan is a simple and fast JSON logging library for node.js services<br>It is very powerfull tool which help you to logging specific info </p>
</blockquote>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var <span class="built_in">log</span> = bunyan.createLogger(&#123;</span><br><span class="line">  name: <span class="string">'myapp'</span>,</span><br><span class="line">  streams: [</span><br><span class="line">    &#123;</span><br><span class="line">      level: <span class="string">'info'</span>,</span><br><span class="line">      stream: process.stdout            // <span class="built_in">log</span> INFO <span class="literal">and</span> above <span class="keyword">to</span> stdout</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      level: <span class="string">'error'</span>,</span><br><span class="line">      path: <span class="string">'/var/tmp/myapp-error.log'</span>  // <span class="built_in">log</span> ERROR <span class="literal">and</span> above <span class="keyword">to</span> a file</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192</span>:<span class="number">01</span> Lyn$ npm install bunyan --save</span><br><span class="line"></span><br><span class="line">npm WARN package.json api01@<span class="number">1.0</span><span class="number">.0</span> No repository field.</span><br><span class="line">npm WARN package.json api01@<span class="number">1.0</span><span class="number">.0</span> No README data</span><br><span class="line"></span><br><span class="line">&gt; dtrace-provider@<span class="number">0.6</span><span class="number">.0</span> install /Users/Lyn/src/node/node-api/<span class="number">01</span>/node_modules/bunyan/node_modules/dtrace-provider</span><br><span class="line">&gt; node scripts/install.js</span><br><span class="line"></span><br><span class="line">bunyan@<span class="number">1.6</span><span class="number">.0</span> node_modules/bunyan</span><br><span class="line">├── safe-json-stringify@<span class="number">1.0</span><span class="number">.3</span></span><br><span class="line">├── moment@<span class="number">2.11</span><span class="number">.2</span></span><br><span class="line">├── dtrace-provider@<span class="number">0.6</span><span class="number">.0</span> (nan@<span class="number">2.2</span><span class="number">.0</span>)</span><br><span class="line">└── mv@<span class="number">2.1</span><span class="number">.1</span> (ncp@<span class="number">2.0</span><span class="number">.0</span>, mkdirp@<span class="number">0.5</span><span class="number">.1</span>, rimraf@<span class="number">2.4</span><span class="number">.5</span>)</span><br></pre></td></tr></table></figure>
<p>server.js<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">var</span>  restify = <span class="keyword">require</span>(<span class="string">'restify'</span>);</span><br><span class="line"><span class="built_in">var</span>  bunyan = <span class="keyword">require</span>(<span class="string">'bunyan'</span>); </span><br><span class="line"><span class="built_in">var</span> options = &#123;</span><br><span class="line">	name:<span class="string">"Toodoo API"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">var</span>  server = restify<span class="built_in">.</span>createServer(options);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server<span class="built_in">.</span><span class="keyword">on</span>(<span class="string">'after'</span>, restify<span class="built_in">.</span>auditLogger(&#123;</span><br><span class="line">	<span class="keyword">log</span>: bunyan<span class="built_in">.</span>createLogger(&#123;</span><br><span class="line">		name:<span class="string">'audit'</span>,</span><br><span class="line">		stream: process<span class="built_in">.</span>stdout</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// server.on('after', function ()&#123;</span></span><br><span class="line"><span class="comment">//	console.log('after', arguments);</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line">module<span class="built_in">.</span>exports = server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'./routes'</span>);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192</span>:<span class="number">01</span> Lyn$ node index.js</span><br><span class="line"></span><br><span class="line">API server listening on &#123;<span class="string">"address"</span>:<span class="string">"::"</span>,<span class="string">"family"</span>:<span class="string">"IPv6"</span>,<span class="string">"port"</span>:<span class="number">8080</span>&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"audit"</span>,<span class="string">"hostname"</span>:<span class="string">"Lyn-Cheung-MBP.local"</span>,<span class="string">"pid"</span>:<span class="number">44385</span>,<span class="string">"audit"</span>:<span class="literal">true</span>,<span class="string">"level"</span>:<span class="number">30</span>,<span class="string">"remoteAddress"</span>:<span class="string">"::ffff:127.0.0.1"</span>,<span class="string">"remotePort"</span>:<span class="number">56088</span>,<span class="string">"req_id"</span>:<span class="string">"a701a353-6b55-4aa0-8888-5d67518867fb"</span>,<span class="string">"req"</span>:&#123;<span class="string">"query"</span>:<span class="string">""</span>,<span class="string">"method"</span>:<span class="string">"DELETE"</span>,<span class="string">"url"</span>:<span class="string">"/lists/mylist/items/itemid"</span>,<span class="string">"headers"</span>:&#123;<span class="string">"host"</span>:<span class="string">"localhost:8080"</span>,<span class="string">"user-agent"</span>:<span class="string">"curl/7.43.0"</span>,<span class="string">"accept"</span>:<span class="string">"*/*"</span>&#125;,<span class="string">"httpVersion"</span>:<span class="string">"1.1"</span>,<span class="string">"trailers"</span>:&#123;&#125;,<span class="string">"version"</span>:<span class="string">"*"</span>,<span class="string">"timers"</span>:&#123;<span class="string">"delItem"</span>:<span class="number">4500</span>&#125;&#125;,<span class="string">"res"</span>:&#123;<span class="string">"statusCode"</span>:<span class="number">200</span>,<span class="string">"headers"</span>:&#123;<span class="string">"content-type"</span>:<span class="string">"application/json"</span>,<span class="string">"content-length"</span>:<span class="number">15</span>&#125;,<span class="string">"trailer"</span>:<span class="literal">false</span>&#125;,<span class="string">"latency"</span>:<span class="number">8</span>,<span class="string">"_audit"</span>:<span class="literal">true</span>,<span class="string">"msg"</span>:<span class="string">"handled: 200"</span>,<span class="string">"time"</span>:<span class="string">"2016-02-21T14:21:20.022Z"</span>,<span class="string">"v"</span>:<span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/06/nodejs-note-21/" itemprop="url">
                  Asynchronous Programming - 08 async.queue
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-06T13:59:13+08:00" content="2016-02-06">
              2016-02-06
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/06/nodejs-note-21/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/06/nodejs-note-21/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Concepts:">Concepts:</h1><h2 id="queue(worker,_[concurrency])">queue(worker, [concurrency])</h2><p>Creates a <code>queue</code> object with the specified <code>concurrency</code>. Tasks added to the<br><code>queue</code> are processed in parallel (up to the <code>concurrency</code> limit). If all<br><code>worker</code>s are in progress, the task is queued until one becomes available.<br>Once a <code>worker</code> completes a <code>task</code>, that <code>task</code>‘s callback is called.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>worker(task, callback)</code> - An asynchronous function for processing a queued<br>task, which must call its <code>callback(err)</code> argument when finished, with an<br>optional <code>error</code> as an argument.  If you want to handle errors from an individual task, pass a callback to <code>q.push()</code>.</li>
<li><code>concurrency</code> - An <code>integer</code> for determining how many <code>worker</code> functions should be<br>run in parallel.  If omitted, the concurrency defaults to <code>1</code>.  If the concurrency is <code>0</code>, an error is thrown.</li>
</ul>
<p><strong>Queue objects</strong></p>
<p>The <code>queue</code> object returned by this function has the following properties and<br>methods:</p>
<ul>
<li><code>length()</code> - a function returning the number of items waiting to be processed.</li>
<li><code>started</code> - a function returning whether or not any items have been pushed and processed by the queue</li>
<li><code>running()</code> - a function returning the number of items currently being processed.</li>
<li><code>workersList()</code> - a function returning the array of items currently being processed.</li>
<li><code>idle()</code> - a function returning false if there are items waiting or being processed, or true if not.</li>
<li><code>concurrency</code> - an integer for determining how many <code>worker</code> functions should be<br>run in parallel. This property can be changed after a <code>queue</code> is created to<br>alter the concurrency on-the-fly.</li>
<li><code>push(task, [callback])</code> - add a new task to the <code>queue</code>. Calls <code>callback</code> once<br>the <code>worker</code> has finished processing the task. Instead of a single task, a <code>tasks</code> array<br>can be submitted. The respective callback is used for every task in the list.</li>
<li><code>unshift(task, [callback])</code> - add a new task to the front of the <code>queue</code>.</li>
<li><code>saturated</code> - a callback that is called when the <code>queue</code> length hits the <code>concurrency</code> limit,<br> and further tasks will be queued.</li>
<li><code>empty</code> - a callback that is called when the last item from the <code>queue</code> is given to a <code>worker</code>.</li>
<li><code>drain</code> - a callback that is called when the last item from the <code>queue</code> has returned from the <code>worker</code>.</li>
<li><code>paused</code> - a boolean for determining whether the queue is in a paused state</li>
<li><code>pause()</code> - a function that pauses the processing of tasks until <code>resume()</code> is called.</li>
<li><code>resume()</code> - a function that resumes the processing of queued tasks when the queue is paused.</li>
<li><code>kill()</code> - a function that removes the <code>drain</code> callback and empties remaining tasks from the queue forcing it to go idle.</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create a queue object with concurrency 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> q = <span class="keyword">async</span>.queue(<span class="function"><span class="keyword">function</span> (<span class="params">task, callback</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'hello '</span> + task.name);</span><br><span class="line">    callback();</span><br><span class="line">&#125;, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// assign a callback</span></span><br><span class="line">q.drain = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'all items have been processed'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add some items to the queue</span></span><br><span class="line"></span><br><span class="line">q.push(&#123;name: <span class="string">'foo'</span>&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finished processing foo'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">q.push(&#123;name: <span class="string">'bar'</span>&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finished processing bar'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add some items to the queue (batch-wise)</span></span><br><span class="line"></span><br><span class="line">q.push([&#123;name: <span class="string">'baz'</span>&#125;,&#123;name: <span class="string">'bay'</span>&#125;,&#123;name: <span class="string">'bax'</span>&#125;], <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finished processing item'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add some items to the front of the queue</span></span><br><span class="line"></span><br><span class="line">q.unshift(&#123;name: <span class="string">'bar'</span>&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finished processing bar'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="priorityQueue(worker,_concurrency)">priorityQueue(worker, concurrency)</h2><p>The same as Queue only tasks are assigned a priority and completed in ascending priority order. There are two differences between <code>queue</code> and <code>priorityQueue</code> objects:</p>
<ul>
<li><code>push(task, priority, [callback])</code> - <code>priority</code> should be a number. If an array of<br><code>tasks</code> is given, all tasks will be assigned the same priority.</li>
<li>The <code>unshift</code> method was removed.</li>
</ul>
<hr>
<h2 id="Self-Invoking_Functions">Self-Invoking Functions</h2><pre><code>Function expressions can be made <span class="string">"self-invoking"</span>.

A self-invoking expression is invoked (started) automatically, <span class="keyword">without</span> being called.

Function expressions will execute automatically <span class="keyword">if</span> <span class="operator">the</span> expression is followed <span class="keyword">by</span> ().

You cannot self-invoke <span class="operator">a</span> <span class="function"><span class="keyword">function</span> <span class="title">declaration</span>.</span>

You have <span class="built_in">to</span> <span class="built_in">add</span> parentheses around <span class="operator">the</span> <span class="function"><span class="keyword">function</span> <span class="title">to</span> <span class="title">indicate</span> <span class="title">that</span> <span class="title">it</span> <span class="title">is</span> <span class="title">a</span> <span class="title">function</span> <span class="title">expression</span>:</span>
</code></pre><h3 id="Example:">Example:</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(function<span class="function"> (</span><span class="function">)</span> &#123;</span><br><span class="line">    var x = <span class="string">"Hello!!"</span>;      // I will<span class="instruction"> invoke </span>myself</span><br><span class="line">&#125;<span class="function">)</span>(<span class="function">)</span>;</span><br></pre></td></tr></table></figure>
<h1 id="apply_these_concepts_to_our_example:">apply these concepts to our example:</h1><h2 id="client-js">client.js</h2><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  sendQueue = require('./queue');</span><br><span class="line"></span><br><span class="line">//A self-invoking expression <span class="keyword">is</span> invoked (started) automatically, <span class="keyword">without</span> being called.</span><br><span class="line">//<span class="type">Function</span> expressions will execute automatically <span class="keyword">if</span> the expression <span class="keyword">is</span> followed by ().</span><br><span class="line"></span><br><span class="line">sendQueue.drain = drained;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i= <span class="number">1</span> ; i &lt; <span class="number">50</span>; i++)&#123;</span><br><span class="line">		(function(i)&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> message = 'message' + i;</span><br><span class="line"></span><br><span class="line">		sendQueue.push(message, function(err,<span class="literal">result</span>)&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			console.log(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			console.log('finish sending message %s. <span class="literal">result</span>: %s', message ,<span class="literal">result</span>);</span><br><span class="line">		&#125;</span><br><span class="line"> 	&#125;);</span><br><span class="line"> &#125;(i));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function drained()&#123;</span><br><span class="line">	console.log('<span class="type">Queue</span> <span class="keyword">is</span> drained, this function <span class="keyword">is</span> excueted at <span class="keyword">end</span> <span class="keyword">of</span> this queue!');</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="queue-js">queue.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set default value 5</span></span><br><span class="line"><span class="keyword">var</span> maxParallel =  <span class="built_in">Number</span>(process.env.MAX_PARALLEL_SENDS) || <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> queue= <span class="keyword">async</span>.queue(send, maxParallel);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = queue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'sending %s'</span>, message);</span><br><span class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomResult());</span><br><span class="line">	</span><br><span class="line"> &#125;    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomResult</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="running_results:">running results:</h2><p>change MAX_PARALLEL_SENDS as 10 :</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lyn</span>$ <span class="type">MAX_PARALLEL_SENDS</span>=<span class="number">10</span> node client02.js</span><br><span class="line">sending message1</span><br><span class="line">sending message2</span><br><span class="line">sending message3</span><br><span class="line">sending message4</span><br><span class="line">sending message5</span><br><span class="line">sending message6</span><br><span class="line">sending message7</span><br><span class="line">sending message8</span><br><span class="line">sending message9</span><br><span class="line">sending message10</span><br><span class="line">finish sending message message5. <span class="literal">result</span>: <span class="number">1964500988</span></span><br><span class="line">sending message11</span><br><span class="line">finish sending message message11. <span class="literal">result</span>: <span class="number">2539043910</span></span><br><span class="line">sending message12</span><br><span class="line">finish sending message message9. <span class="literal">result</span>: <span class="number">5102366274</span></span><br><span class="line">sending message13</span><br><span class="line">finish sending message message1. <span class="literal">result</span>: <span class="number">2859386303</span></span><br><span class="line">sending message14</span><br><span class="line">finish sending message message14. <span class="literal">result</span>: <span class="number">1262963870</span></span><br><span class="line">sending message15</span><br><span class="line">finish sending message message10. <span class="literal">result</span>: <span class="number">5341776136</span></span><br><span class="line">sending message16</span><br><span class="line">finish sending message message13. <span class="literal">result</span>: <span class="number">9353475617</span></span><br><span class="line">sending message17</span><br><span class="line">finish sending message message2. <span class="literal">result</span>: <span class="number">229454392</span></span><br><span class="line">sending message18</span><br><span class="line">finish sending message message8. <span class="literal">result</span>: <span class="number">204195834</span></span><br><span class="line">sending message19</span><br><span class="line">finish sending message message7. <span class="literal">result</span>: <span class="number">5462231705</span></span><br><span class="line">sending message20</span><br><span class="line">finish sending message message3. <span class="literal">result</span>: <span class="number">2648265475</span></span><br><span class="line">sending message21</span><br><span class="line">finish sending message message17. <span class="literal">result</span>: <span class="number">1555040027</span></span><br><span class="line">sending message22</span><br><span class="line">finish sending message message20. <span class="literal">result</span>: <span class="number">1378923130</span></span><br><span class="line">sending message23</span><br><span class="line">finish sending message message16. <span class="literal">result</span>: <span class="number">567535762</span></span><br><span class="line">sending message24</span><br><span class="line">finish sending message message12. <span class="literal">result</span>: <span class="number">3640659751</span></span><br><span class="line">sending message25</span><br><span class="line">finish sending message message4. <span class="literal">result</span>: <span class="number">846371499</span></span><br><span class="line">sending message26</span><br><span class="line">finish sending message message6. <span class="literal">result</span>: <span class="number">8943664734</span></span><br><span class="line">sending message27</span><br><span class="line">finish sending message message19. <span class="literal">result</span>: <span class="number">5956872827</span></span><br><span class="line">sending message28</span><br><span class="line">finish sending message message28. <span class="literal">result</span>: <span class="number">2633528902</span></span><br><span class="line">sending message29</span><br><span class="line">finish sending message message25. <span class="literal">result</span>: <span class="number">6858472616</span></span><br><span class="line">sending message30</span><br><span class="line">finish sending message message23. <span class="literal">result</span>: <span class="number">6577321235</span></span><br><span class="line">sending message31</span><br><span class="line">finish sending message message31. <span class="literal">result</span>: <span class="number">4663092873</span></span><br><span class="line">sending message32</span><br><span class="line">finish sending message message22. <span class="literal">result</span>: <span class="number">1162227960</span></span><br><span class="line">sending message33</span><br><span class="line">finish sending message message18. <span class="literal">result</span>: <span class="number">482677198</span></span><br><span class="line">sending message34</span><br><span class="line">finish sending message message15. <span class="literal">result</span>: <span class="number">7190919378</span></span><br><span class="line">sending message35</span><br><span class="line">finish sending message message29. <span class="literal">result</span>: <span class="number">6405112494</span></span><br><span class="line">sending message36</span><br><span class="line">finish sending message message30. <span class="literal">result</span>: <span class="number">9917983878</span></span><br><span class="line">sending message37</span><br><span class="line">finish sending message message36. <span class="literal">result</span>: <span class="number">3782009345</span></span><br><span class="line">sending message38</span><br><span class="line">finish sending message message26. <span class="literal">result</span>: <span class="number">1491269115</span></span><br><span class="line">sending message39</span><br><span class="line">finish sending message message21. <span class="literal">result</span>: <span class="number">1522164435</span></span><br><span class="line">sending message40</span><br><span class="line">finish sending message message27. <span class="literal">result</span>: <span class="number">1241898911</span></span><br><span class="line">sending message41</span><br><span class="line">finish sending message message24. <span class="literal">result</span>: <span class="number">294576718</span></span><br><span class="line">sending message42</span><br><span class="line">finish sending message message40. <span class="literal">result</span>: <span class="number">4806017791</span></span><br><span class="line">sending message43</span><br><span class="line">finish sending message message32. <span class="literal">result</span>: <span class="number">573896444</span></span><br><span class="line">sending message44</span><br><span class="line">finish sending message message42. <span class="literal">result</span>: <span class="number">3477258647</span></span><br><span class="line">sending message45</span><br><span class="line">finish sending message message34. <span class="literal">result</span>: <span class="number">879555882</span></span><br><span class="line">sending message46</span><br><span class="line">finish sending message message41. <span class="literal">result</span>: <span class="number">6116542278</span></span><br><span class="line">sending message47</span><br><span class="line">finish sending message message39. <span class="literal">result</span>: <span class="number">147665396</span></span><br><span class="line">sending message48</span><br><span class="line">finish sending message message46. <span class="literal">result</span>: <span class="number">1423920742</span></span><br><span class="line">sending message49</span><br><span class="line">finish sending message message47. <span class="literal">result</span>: <span class="number">87184496</span></span><br><span class="line">finish sending message message48. <span class="literal">result</span>: <span class="number">3536678084</span></span><br><span class="line">finish sending message message33. <span class="literal">result</span>: <span class="number">2796673960</span></span><br><span class="line">finish sending message message38. <span class="literal">result</span>: <span class="number">3577113223</span></span><br><span class="line">finish sending message message43. <span class="literal">result</span>: <span class="number">7041824071</span></span><br><span class="line">finish sending message message37. <span class="literal">result</span>: <span class="number">1977048416</span></span><br><span class="line">finish sending message message35. <span class="literal">result</span>: <span class="number">2434279993</span></span><br><span class="line">finish sending message message44. <span class="literal">result</span>: <span class="number">1471318043</span></span><br><span class="line">finish sending message message49. <span class="literal">result</span>: <span class="number">1047097761</span></span><br><span class="line">finish sending message message45. <span class="literal">result</span>: <span class="number">9316147507</span></span><br><span class="line"><span class="type">Queue</span> <span class="keyword">is</span> drained, this function <span class="keyword">is</span> excueted at <span class="keyword">end</span> <span class="keyword">of</span> this queue!</span><br></pre></td></tr></table></figure>
<p>change MAX_PARALLEL_SENDS value to 20 :</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lyn</span>$ <span class="type">MAX_PARALLEL_SENDS</span>=<span class="number">20</span> node client02.js</span><br><span class="line">sending message1</span><br><span class="line">sending message2</span><br><span class="line">sending message3</span><br><span class="line">sending message4</span><br><span class="line">sending message5</span><br><span class="line">sending message6</span><br><span class="line">sending message7</span><br><span class="line">sending message8</span><br><span class="line">sending message9</span><br><span class="line">sending message10</span><br><span class="line">sending message11</span><br><span class="line">sending message12</span><br><span class="line">sending message13</span><br><span class="line">sending message14</span><br><span class="line">sending message15</span><br><span class="line">sending message16</span><br><span class="line">sending message17</span><br><span class="line">sending message18</span><br><span class="line">sending message19</span><br><span class="line">sending message20</span><br><span class="line">finish sending message message15. <span class="literal">result</span>: <span class="number">737988750</span></span><br><span class="line">sending message21</span><br><span class="line">finish sending message message8. <span class="literal">result</span>: <span class="number">8598609317</span></span><br><span class="line">sending message22</span><br><span class="line">finish sending message message9. <span class="literal">result</span>: <span class="number">2646334483</span></span><br><span class="line">sending message23</span><br><span class="line">finish sending message message19. <span class="literal">result</span>: <span class="number">9558195846</span></span><br><span class="line">sending message24</span><br><span class="line">finish sending message message17. <span class="literal">result</span>: <span class="number">8144184104</span></span><br><span class="line">sending message25</span><br><span class="line">finish sending message message14. <span class="literal">result</span>: <span class="number">4364975024</span></span><br><span class="line">sending message26</span><br><span class="line">finish sending message message5. <span class="literal">result</span>: <span class="number">1724673530</span></span><br><span class="line">sending message27</span><br><span class="line">finish sending message message1. <span class="literal">result</span>: <span class="number">4582815656</span></span><br><span class="line">sending message28</span><br><span class="line">finish sending message message20. <span class="literal">result</span>: <span class="number">7956206179</span></span><br><span class="line">sending message29</span><br><span class="line">finish sending message message10. <span class="literal">result</span>: <span class="number">9008091217</span></span><br><span class="line">sending message30</span><br><span class="line">finish sending message message22. <span class="literal">result</span>: <span class="number">3582278867</span></span><br><span class="line">sending message31</span><br><span class="line">finish sending message message6. <span class="literal">result</span>: <span class="number">4367040095</span></span><br><span class="line">sending message32</span><br><span class="line">finish sending message message13. <span class="literal">result</span>: <span class="number">3988986646</span></span><br><span class="line">sending message33</span><br><span class="line">finish sending message message28. <span class="literal">result</span>: <span class="number">6466557176</span></span><br><span class="line">sending message34</span><br><span class="line">finish sending message message16. <span class="literal">result</span>: <span class="number">1716755733</span></span><br><span class="line">sending message35</span><br><span class="line">finish sending message message29. <span class="literal">result</span>: <span class="number">4922675376</span></span><br><span class="line">sending message36</span><br><span class="line">finish sending message message32. <span class="literal">result</span>: <span class="number">4885254576</span></span><br><span class="line">sending message37</span><br><span class="line">finish sending message message3. <span class="literal">result</span>: <span class="number">1153001314</span></span><br><span class="line">sending message38</span><br><span class="line">finish sending message message31. <span class="literal">result</span>: <span class="number">781061809</span></span><br><span class="line">sending message39</span><br><span class="line">finish sending message message12. <span class="literal">result</span>: <span class="number">460623404</span></span><br><span class="line">sending message40</span><br><span class="line">finish sending message message37. <span class="literal">result</span>: <span class="number">8715749820</span></span><br><span class="line">sending message41</span><br><span class="line">finish sending message message11. <span class="literal">result</span>: <span class="number">4536053752</span></span><br><span class="line">sending message42</span><br><span class="line">finish sending message message27. <span class="literal">result</span>: <span class="number">3200931774</span></span><br><span class="line">sending message43</span><br><span class="line">finish sending message message33. <span class="literal">result</span>: <span class="number">250894566</span></span><br><span class="line">sending message44</span><br><span class="line">finish sending message message42. <span class="literal">result</span>: <span class="number">4747473378</span></span><br><span class="line">sending message45</span><br><span class="line">finish sending message message24. <span class="literal">result</span>: <span class="number">4962016146</span></span><br><span class="line">sending message46</span><br><span class="line">finish sending message message26. <span class="literal">result</span>: <span class="number">1931993842</span></span><br><span class="line">sending message47</span><br><span class="line">finish sending message message2. <span class="literal">result</span>: <span class="number">986454577</span></span><br><span class="line">sending message48</span><br><span class="line">finish sending message message35. <span class="literal">result</span>: <span class="number">2301575674</span></span><br><span class="line">sending message49</span><br><span class="line">finish sending message message7. <span class="literal">result</span>: <span class="number">5626737338</span></span><br><span class="line">finish sending message message34. <span class="literal">result</span>: <span class="number">6771650929</span></span><br><span class="line">finish sending message message23. <span class="literal">result</span>: <span class="number">8719486794</span></span><br><span class="line">finish sending message message25. <span class="literal">result</span>: <span class="number">5572523672</span></span><br><span class="line">finish sending message message18. <span class="literal">result</span>: <span class="number">5171451447</span></span><br><span class="line">finish sending message message38. <span class="literal">result</span>: <span class="number">5175544791</span></span><br><span class="line">finish sending message message40. <span class="literal">result</span>: <span class="number">8014775183</span></span><br><span class="line">finish sending message message4. <span class="literal">result</span>: <span class="number">3714943323</span></span><br><span class="line">finish sending message message30. <span class="literal">result</span>: <span class="number">2933020694</span></span><br><span class="line">finish sending message message21. <span class="literal">result</span>: <span class="number">686769762</span></span><br><span class="line">finish sending message message46. <span class="literal">result</span>: <span class="number">6016617582</span></span><br><span class="line">finish sending message message39. <span class="literal">result</span>: <span class="number">4313526025</span></span><br><span class="line">finish sending message message41. <span class="literal">result</span>: <span class="number">9950625901</span></span><br><span class="line">finish sending message message36. <span class="literal">result</span>: <span class="number">6170342438</span></span><br><span class="line">finish sending message message49. <span class="literal">result</span>: <span class="number">5550757215</span></span><br><span class="line">finish sending message message43. <span class="literal">result</span>: <span class="number">4634869126</span></span><br><span class="line">finish sending message message45. <span class="literal">result</span>: <span class="number">4358491804</span></span><br><span class="line">finish sending message message48. <span class="literal">result</span>: <span class="number">9321907304</span></span><br><span class="line">finish sending message message44. <span class="literal">result</span>: <span class="number">6880509853</span></span><br><span class="line">finish sending message message47. <span class="literal">result</span>: <span class="number">6660414687</span></span><br><span class="line"><span class="type">Queue</span> <span class="keyword">is</span> drained, this function <span class="keyword">is</span> excueted at <span class="keyword">end</span> <span class="keyword">of</span> this queue!</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/06/nodejs-note-22/" itemprop="url">
                  TCP programing
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-06T00:16:43+08:00" content="2016-02-06">
              2016-02-06
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/06/nodejs-note-22/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/06/nodejs-note-22/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>index.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  server = <span class="built_in">require</span>(<span class="string">'./server05'</span>);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">8000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'TCP server listening on %j'</span>, server.address());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p> var net = require(‘net’);</p>
<p> var server = net.createServer();</p>
<p> server.on(‘connection’, function(conn){</p>
<pre><code><span class="built_in">console</span>.log(<span class="string">'new connection'</span>);
conn.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="built_in">console</span>.log(<span class="string">'connection closed'</span>);
});

<span class="keyword">var</span> emit =conn.emit;
conn.emit = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>{
    <span class="built_in">console</span>.log(<span class="string">'connetion emitted  event type %s'</span>, event);
    emit.apply(conn, <span class="built_in">arguments</span>);
};
</code></pre><p> }); </p>
<p> module.exports = server ;<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="escape">``</span><span class="escape">`</span><br><span class="line"></span>server03.js</span><br></pre></td></tr></table></figure></p>
<p> var net = require(‘net’);</p>
<p> var server = net.createServer();</p>
<p> server.on(‘connection’, function(conn){</p>
<pre><code><span class="built_in">console</span>.log(<span class="string">'new connection'</span>);

conn.setEncoding(<span class="string">'utf8'</span>);

conn.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="built_in">console</span>.log(<span class="string">'connection closed'</span>);
});

conn.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">buf</span>)</span>{
    process.stdout.write(<span class="string">'data'</span> + buf);
});
</code></pre><p> }); </p>
<p> module.exports = server ;<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">server04</span><span class="class">.js</span></span><br></pre></td></tr></table></figure></p>
<p> var net = require(‘net’);</p>
<p> var server = net.createServer();</p>
<p> server.on(‘connection’, function(conn){</p>
<pre><code>console.<span class="built_in">log</span>(<span class="string">'new connection'</span>);

conn.setEncoding(<span class="string">'utf8'</span>);

conn.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
    console.<span class="built_in">log</span>(<span class="string">'connection closed'</span>);
});

conn.<span class="keyword">on</span>(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span><span class="params">(buf)</span>{</span>
    process.stdout.<span class="keyword">write</span>(<span class="string">'User send message: '</span> + buf);
    conn.<span class="keyword">write</span>(<span class="string">'Server send message: '</span>+ buf);
    conn.<span class="keyword">write</span>(<span class="string">'Server capitalize your message:'</span> + buf.toUpperCase());
});
</code></pre><p> }); </p>
<p> module.exports = server ;</p>
<p> #through2</p>
 <figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fs.createReadStream(<span class="string">'ex.txt'</span>)</span><br><span class="line"> .pipe(through2(<span class="function"><span class="keyword">function</span> <span class="params">(chunk, enc, callback)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; chunk.length; i++)</span><br><span class="line">     <span class="keyword">if</span> (chunk[i] == <span class="number">97</span>)</span><br><span class="line">       chunk[i] = <span class="number">122</span> <span class="comment">// swap 'a' for 'z'</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.push(chunk)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">callback</span>()</span><br><span class="line">  &#125;))</span><br><span class="line"> .pipe(fs.createWriteStream(<span class="string">'out.txt'</span>))</span><br></pre></td></tr></table></figure>
<p>Or object streams:</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> all = []</span><br><span class="line"></span><br><span class="line">fs.createReadStream(<span class="string">'data.csv'</span>)</span><br><span class="line">  .pipe(csv2())</span><br><span class="line">  .pipe(through2.obj(<span class="function"><span class="keyword">function</span> <span class="params">(chunk, enc, callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = &#123;</span><br><span class="line">        name    : chunk[<span class="number">0</span>]</span><br><span class="line">      , address : chunk[<span class="number">3</span>]</span><br><span class="line">      , phone   : chunk[<span class="number">10</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.push(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">callback</span>()</span><br><span class="line">  &#125;))</span><br><span class="line">  .on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</span><br><span class="line">    all.push(data)</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    doSomethingSpecial(all)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server05</span><br></pre></td></tr></table></figure>
<p> var through = require(‘through2’);<br> var net = require(‘net’);</p>
<p> var server = net.createServer();</p>
<p> server.on(‘connection’, function(conn){</p>
<pre><code><span class="built_in">console</span>.log(<span class="string">'new connection'</span>);

conn.setEncoding(<span class="string">'utf8'</span>);

conn.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="built_in">console</span>.log(<span class="string">'connection closed'</span>);
});

<span class="keyword">var</span> upperCasing = through.obj(<span class="function"><span class="keyword">function</span>(<span class="params">str, enc, cb</span>)</span>{
    <span class="keyword">this</span>.push(str.toUpperCase());
    cb();
});

conn.pipe(upperCasing).pipe(conn);
<span class="comment">// conn.pipe(conn);</span>
</code></pre><p> }); </p>
<p> module.exports = server ;<br>```</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/05/nodejs-note-20/" itemprop="url">
                  Asynchronous Programming - 07 async.each .map .eachSeries .eachLimit .mapLimit
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-05T15:59:11+08:00" content="2016-02-05">
              2016-02-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/05/nodejs-note-20/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/05/nodejs-note-20/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="each(arr,_iterator,_[callback])">each(arr, iterator, [callback])</h3><p>Applies the function <code>iterator</code> to each item in <code>arr</code>, in parallel.<br>The <code>iterator</code> is called with an item from the list, and a callback for when it<br>has finished. If the <code>iterator</code> passes an error to its <code>callback</code>, the main<br><code>callback</code> (for the <code>each</code> function) is immediately called with the error.</p>
<p>Note, that since this function applies <code>iterator</code> to each item in parallel,<br>there is no guarantee that the iterator functions will complete in order.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>arr</code> - An array to iterate over.</li>
<li><code>iterator(item, callback)</code> - A function to apply to each item in <code>arr</code>.<br>The iterator is passed a <code>callback(err)</code> which must be called once it has<br>completed. If no error has occurred, the <code>callback</code> should be run without<br>arguments or with an explicit <code>null</code> argument.  The array index is not passed<br>to the iterator.  If you need the index, use forEachOf.</li>
<li><code>callback(err)</code> - <em>Optional</em> A callback which is called when all <code>iterator</code> functions<br>have finished, or an error occurs.</li>
</ul>
<p><strong>Examples</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// assuming openFiles is an array of file names and saveFile is a function</span></span><br><span class="line"><span class="comment">// to save the modified contents of that file:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span>.each(openFiles, saveFile, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// if any of the saves produced an error, err would equal that error</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// assuming openFiles is an array of file names</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span>.each(openFiles, <span class="function"><span class="keyword">function</span>(<span class="params">file, callback</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Perform operation on file here.</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Processing file '</span> + file);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>( file.length &gt; <span class="number">32</span> ) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'This file name is too long'</span>);</span><br><span class="line">    callback(<span class="string">'File name too long'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Do work to process file here</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'File processed'</span>);</span><br><span class="line">    callback();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// if any of the file processing produced an error, err would equal that error</span></span><br><span class="line">    <span class="keyword">if</span>( err ) &#123;</span><br><span class="line">      <span class="comment">// One of the iterations produced an error.</span></span><br><span class="line">      <span class="comment">// All processing will now stop.</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'A file failed to process'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'All files have been processed successfully'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>Related</strong></p>
<ul>
<li>eachSeries(arr, iterator, [callback])</li>
<li>eachLimit(arr, limit, iterator, [callback])</li>
</ul>
<hr>
<h2 id="Asynchronous_iteration_using_async">Asynchronous iteration using async</h2><p>apply async.each to our example:</p>
<p>send_all.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = sendAll;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendAll</span>(<span class="params">messages,cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">async</span>.each(messages, send, cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</span><br><span class="line">	<span class="comment">// echo start message </span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'sending message %s'</span>, message);</span><br><span class="line"></span><br><span class="line">	setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// echo finish message</span></span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'finish sending message: %s '</span>, message);</span><br><span class="line">		cb();</span><br><span class="line">	&#125;, randomTimeout());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  sendAll =<span class="built_in">require</span>(<span class="string">'./send_all'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,<span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span>];</span><br><span class="line"></span><br><span class="line">sendAll(messages, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125; <span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages send'</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Running result:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Lyn$ node client.js</span><br><span class="line">sending <span class="keyword">message</span> message1</span><br><span class="line">sending <span class="keyword">message</span> message2</span><br><span class="line">sending <span class="keyword">message</span> message3</span><br><span class="line">sending <span class="keyword">message</span> message4</span><br><span class="line">sending <span class="keyword">message</span> message5</span><br><span class="line">sending <span class="keyword">message</span> message6</span><br><span class="line">finish sending <span class="keyword">message</span>: message2</span><br><span class="line">finish sending <span class="keyword">message</span>: message6</span><br><span class="line">finish sending <span class="keyword">message</span>: message5</span><br><span class="line">finish sending <span class="keyword">message</span>: message1</span><br><span class="line">finish sending <span class="keyword">message</span>: message4</span><br><span class="line">finish sending <span class="keyword">message</span>: message3</span><br><span class="line">all messages send</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="map(arr,_iterator,_[callback])">map(arr, iterator, [callback])</h2><p>Produces a new array of values by mapping each value in <code>arr</code> through<br>the <code>iterator</code> function. The <code>iterator</code> is called with an item from <code>arr</code> and a<br>callback for when it has finished processing. Each of these callback takes 2 arguments:<br>an <code>error</code>, and the transformed item from <code>arr</code>. If <code>iterator</code> passes an error to its<br>callback, the main <code>callback</code> (for the <code>map</code> function) is immediately called with the error.</p>
<p>Note, that since this function applies the <code>iterator</code> to each item in parallel,<br>there is no guarantee that the <code>iterator</code> functions will complete in order.<br>However, the results array will be in the same order as the original <code>arr</code>.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>arr</code> - An array to iterate over.</li>
<li><code>iterator(item, callback)</code> - A function to apply to each item in <code>arr</code>.<br>The iterator is passed a <code>callback(err, transformed)</code> which must be called once<br>it has completed with an error (which can be <code>null</code>) and a transformed item.</li>
<li><code>callback(err, results)</code> - <em>Optional</em> A callback which is called when all <code>iterator</code><br>functions have finished, or an error occurs. Results is an array of the<br>transformed items from the <code>arr</code>.</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span>.map([<span class="string">'file1'</span>,<span class="string">'file2'</span>,<span class="string">'file3'</span>], fs.stat, <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// results is now an array of stats for each file</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>Related</strong></p>
<ul>
<li>mapSeries(arr, iterator, [callback])</li>
<li>mapLimit(arr, limit, iterator, [callback])</li>
</ul>
<h2 id="Mapping_in_parallel_by_using_async-map">Mapping in parallel by using async.map</h2><p>send_all03.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = sendAll;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendAll</span>(<span class="params">messages,cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">async</span>.map(messages, send, cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'sending message %s'</span>, message);</span><br><span class="line">	setTimeout(cb, randomTimeout(),<span class="literal">null</span>,randomResult());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomResult</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client03.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  sendAll =<span class="built_in">require</span>(<span class="string">'./send_all03'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,</span><br><span class="line">			   <span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span>];</span><br><span class="line"></span><br><span class="line">sendAll(messages, <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages send,results: %s'</span>, results);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Running results:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Lyn$ node client03.js</span><br><span class="line">sending <span class="keyword">message</span> message1</span><br><span class="line">sending <span class="keyword">message</span> message2</span><br><span class="line">sending <span class="keyword">message</span> message3</span><br><span class="line">sending <span class="keyword">message</span> message4</span><br><span class="line">sending <span class="keyword">message</span> message5</span><br><span class="line">sending <span class="keyword">message</span> message6</span><br><span class="line">all messages send,results: <span class="number">2688018348</span>,<span class="number">9740347757</span>,<span class="number">1796786184</span>,<span class="number">9157391262</span>,<span class="number">9049146866</span>,<span class="number">9496613333</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="eachSeries(arr,_iterator,_[callback])">eachSeries(arr, iterator, [callback])</h2><h2 id="iterating_in_series_by_using_Async-eachSeries_and_async-mapSeries">iterating in series by using Async.eachSeries and async.mapSeries</h2><p>if any error occur during the proccess, it will not excute the rest messages and return error.</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> async = require('async');</span><br><span class="line"></span><br><span class="line">module.exports = sendAll;</span><br><span class="line"></span><br><span class="line">function sendAll(messages,cb)&#123;</span><br><span class="line">	async.eachSeries(messages, send, cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function send(message,cb)&#123;</span><br><span class="line">	console.log('sending message %s', message);</span><br><span class="line">	setTimeout(finished, randomTimeout(),null,randomResult());</span><br><span class="line"> 	</span><br><span class="line"> 	function finished(err, <span class="literal">result</span>)&#123;</span><br><span class="line"> 		console.log('finished sending %s, <span class="literal">result</span> <span class="keyword">is</span>:', message, <span class="literal">result</span>);</span><br><span class="line"> 		cb(err, <span class="literal">result</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line"> &#125;    </span><br><span class="line"></span><br><span class="line">function randomTimeout()&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">Math</span>.floor(<span class="type">Math</span>.random()*<span class="number">1</span>e3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function randomResult()&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">Math</span>.floor(<span class="type">Math</span>.random()*<span class="number">1</span>e10);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  sendAll =<span class="built_in">require</span>(<span class="string">'./send_all04'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,</span><br><span class="line">			   <span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span>];</span><br><span class="line"></span><br><span class="line">sendAll(messages, <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages send,results: %s'</span>, results);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lyn</span>$ node client04.js</span><br><span class="line">sending message message1</span><br><span class="line">finished sending message1, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">7154820929</span></span><br><span class="line">sending message message2</span><br><span class="line">finished sending message2, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">3823260059</span></span><br><span class="line">sending message message3</span><br><span class="line">finished sending message3, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">3379720377</span></span><br><span class="line">sending message message4</span><br><span class="line">finished sending message4, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">7657029824</span></span><br><span class="line">sending message message5</span><br><span class="line">finished sending message5, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">8405372535</span></span><br><span class="line">sending message message6</span><br><span class="line">finished sending message6, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">5340888185</span></span><br><span class="line">all messages send,results: undefined</span><br></pre></td></tr></table></figure>
<p>if any error occur during the proccess, it will not excute the rest messages and return error.<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> async = require('async');</span><br><span class="line"></span><br><span class="line">module.exports = sendAll;</span><br><span class="line"></span><br><span class="line">function sendAll(messages,cb)&#123;</span><br><span class="line">	async.eachSeries(messages, send, cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function send(message,cb)&#123;</span><br><span class="line">	console.log('sending message %s', message);</span><br><span class="line">	setTimeout(finished, randomTimeout(), new <span class="type">Error</span>('whoops!'),randomResult());</span><br><span class="line"> 	</span><br><span class="line"> 	function finished(err, <span class="literal">result</span>)&#123;</span><br><span class="line"> 		console.log('finished sending %s, <span class="literal">result</span> <span class="keyword">is</span>:', message, <span class="literal">result</span>);</span><br><span class="line"> 		cb(err, <span class="literal">result</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line"> &#125;    </span><br><span class="line"></span><br><span class="line">function randomTimeout()&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">Math</span>.floor(<span class="type">Math</span>.random()*<span class="number">1</span>e3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function randomResult()&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">Math</span>.floor(<span class="type">Math</span>.random()*<span class="number">1</span>e10);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lyn</span>$ node client04.js</span><br><span class="line">sending message message1</span><br><span class="line">finished sending message1, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">9289228790</span></span><br><span class="line">[<span class="type">Error</span>: whoops!]</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Limiting_parallel_opreations_using_async-eachLimit_and_async-mapLimit">Limiting parallel opreations using async.eachLimit and async.mapLimit</h2><p>send_all05.js<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> async = require('async');</span><br><span class="line"></span><br><span class="line">module.exports = sendAll;</span><br><span class="line"></span><br><span class="line">function sendAll(messages,cb)&#123;</span><br><span class="line">	async.mapLimit(messages,<span class="number">1</span>, send, cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function send(message,cb)&#123;</span><br><span class="line">	console.log('sending message %s', message);</span><br><span class="line">	setTimeout(finished, randomTimeout(), null,randomResult());</span><br><span class="line"> 	</span><br><span class="line"> 	function finished(err, <span class="literal">result</span>)&#123;</span><br><span class="line"> 		console.log('finished sending %s, <span class="literal">result</span> <span class="keyword">is</span>:', message, <span class="literal">result</span>);</span><br><span class="line"> 		cb(err, <span class="literal">result</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line"> &#125;    </span><br><span class="line"></span><br><span class="line">function randomTimeout()&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">Math</span>.floor(<span class="type">Math</span>.random()*<span class="number">1</span>e3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function randomResult()&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">Math</span>.floor(<span class="type">Math</span>.random()*<span class="number">1</span>e10);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> async = require('async');</span><br><span class="line"></span><br><span class="line">module.exports = sendAll;</span><br><span class="line"></span><br><span class="line">function sendAll(messages,cb)&#123;</span><br><span class="line">	async.mapLimit(messages,<span class="number">1</span>, send, cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function send(message,cb)&#123;</span><br><span class="line">	console.log('sending message %s', message);</span><br><span class="line">	setTimeout(finished, randomTimeout(), null,randomResult());</span><br><span class="line"> 	</span><br><span class="line"> 	function finished(err, <span class="literal">result</span>)&#123;</span><br><span class="line"> 		console.log('finished sending %s, <span class="literal">result</span> <span class="keyword">is</span>:', message, <span class="literal">result</span>);</span><br><span class="line"> 		cb(err, <span class="literal">result</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line"> &#125;    </span><br><span class="line"></span><br><span class="line">function randomTimeout()&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">Math</span>.floor(<span class="type">Math</span>.random()*<span class="number">1</span>e3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function randomResult()&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">Math</span>.floor(<span class="type">Math</span>.random()*<span class="number">1</span>e10);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>running results:<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// async.mapLimit(messages,<span class="number">1</span>, send, cb)</span><br><span class="line">node client05.js </span><br><span class="line">sending message message1</span><br><span class="line">finished sending message1, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">5214791572</span></span><br><span class="line">sending message message2</span><br><span class="line">finished sending message2, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">7899478934</span></span><br><span class="line">sending message message3</span><br><span class="line">finished sending message3, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">4825203265</span></span><br><span class="line">sending message message4</span><br><span class="line">finished sending message4, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">3875634921</span></span><br><span class="line">sending message message5</span><br><span class="line">finished sending message5, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">2315958645</span></span><br><span class="line">sending message message6</span><br><span class="line">finished sending message6, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">9344773869</span></span><br><span class="line">all messages send,results: <span class="number">5214791572</span>,<span class="number">7899478934</span>,<span class="number">4825203265</span>,<span class="number">3875634921</span>,<span class="number">2315958645</span>,<span class="number">9344773869</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// async.mapLimit(messages,<span class="number">2</span>, send, cb)</span><br><span class="line">node client05.js</span><br><span class="line">sending message message1</span><br><span class="line">sending message message2</span><br><span class="line">finished sending message1, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">7242625339</span></span><br><span class="line">sending message message3</span><br><span class="line">finished sending message3, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">8989950458</span></span><br><span class="line">sending message message4</span><br><span class="line">finished sending message2, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">5234759687</span></span><br><span class="line">sending message message5</span><br><span class="line">finished sending message5, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">8056981025</span></span><br><span class="line">sending message message6</span><br><span class="line">finished sending message4, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">1524076925</span></span><br><span class="line">finished sending message6, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">5004728934</span></span><br><span class="line">all messages send,results: <span class="number">7242625339</span>,<span class="number">5234759687</span>,<span class="number">8989950458</span>,<span class="number">1524076925</span>,<span class="number">8056981025</span>,<span class="number">5004728934</span></span><br></pre></td></tr></table></figure></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/04/nodejs-note-19/" itemprop="url">
                  Asynchronous Programming -06 async.parallel
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-04T00:33:51+08:00" content="2016-02-04">
              2016-02-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/04/nodejs-note-19/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/04/nodejs-note-19/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="parallel(tasks,_[callback])">parallel(tasks, [callback])</h2><p>Run the <code>tasks</code> array of functions in parallel, without waiting until the previous<br>function has completed. If any of the functions pass an error to its<br>callback, the main <code>callback</code> is immediately called with the value of the error.<br>Once the <code>tasks</code> have completed, the results are passed to the final <code>callback</code> as an<br>array.</p>
<p><strong>Note:</strong> <code>parallel</code> is about kicking-off I/O tasks in parallel, not about parallel execution of code.  If your tasks do not use any timers or perform any I/O, they will actually be executed in series.  Any synchronous setup sections for each task will happen one after the other.  JavaScript remains single-threaded.</p>
<p>It is also possible to use an object instead of an array. Each property will be<br>run as a function and the results will be passed to the final <code>callback</code> as an object<br>instead of an array. This can be a more readable way of handling results from parallel.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>tasks</code> - An array or object containing functions to run. Each function is passed<br>a <code>callback(err, result)</code> which it must call on completion with an error <code>err</code><br>(which can be <code>null</code>) and an optional <code>result</code> value.</li>
<li><code>callback(err, results)</code> - An optional callback to run once all the functions<br>have completed successfully. This function gets a results array (or object) containing all<br>the result arguments passed to the task callbacks.</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span>.parallel([</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="string">'one'</span>);</span><br><span class="line">        &#125;, <span class="number">200</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="string">'two'</span>);</span><br><span class="line">        &#125;, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br><span class="line"><span class="comment">// optional callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// the results array will equal ['one','two'] even though</span></span><br><span class="line">    <span class="comment">// the second function had a shorter timeout.</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// an example using an object instead of an array</span></span><br><span class="line"><span class="keyword">async</span>.parallel(&#123;</span><br><span class="line">    one: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;, <span class="number">200</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    two: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">        &#125;, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// results is now equals to: &#123;one: 1, two: 2&#125;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="apply_async-parallel_in_our_example">apply async.parallel in our example</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> parallelOperations=[	 </span><br><span class="line">	fs.mkdir.bind(context, dir),</span><br><span class="line">	fs.readFile.bind(context, source)</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span>  opreations = [</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">async</span>.parallel(parallelOperations, cb);</span><br><span class="line">	&#125;,</span><br><span class="line">	extractResult(<span class="number">1</span>),</span><br><span class="line">	fs.writeFile.bind(context, target)</span><br><span class="line">];</span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span>.waterfall(opreations, done);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractResult</span>(<span class="params">pos</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">results,callback</span>)</span>&#123;</span><br><span class="line">		str = results.toString(<span class="string">'utf-8'</span>);</span><br><span class="line">		<span class="built_in">console</span>.log(str);</span><br><span class="line">		callback(<span class="literal">null</span>, results[pos]);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> context;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span>  opreations = [</span><br><span class="line">	parallel(</span><br><span class="line">	fs.mkdir.bind(context, dir),</span><br><span class="line">	fs.readFile.bind(context, source)),</span><br><span class="line">	extractResult(<span class="number">1</span>),</span><br><span class="line">	fs.writeFile.bind(context, target)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span>.waterfall(opreations, done);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parallel</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> ops = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">	<span class="comment">//Array.prototype.slice.call(arguments)能将具有length属性的对象转成数组</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">async</span>.parallel(ops,cb);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractResult</span>(<span class="params">pos</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">results,callback</span>)</span>&#123;</span><br><span class="line">		str = results.toString(<span class="string">'utf-8'</span>);</span><br><span class="line">		<span class="built_in">console</span>.log(str);</span><br><span class="line">		<span class="comment">//检查结果</span></span><br><span class="line">		callback(<span class="literal">null</span>, results[pos]);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/03/nodejs-note-18/" itemprop="url">
                  Asynchronous Programming -05 Async.series
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-03T12:24:11+08:00" content="2016-02-03">
              2016-02-03
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/03/nodejs-note-18/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/03/nodejs-note-18/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Ordinary_code_form_previous_blog">Ordinary code form previous blog</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname,<span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line">fs.mkdir(dir, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err)&#123;</span><br><span class="line">				handleError(err);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				fs.writeFile(target, content, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">if</span>(err)&#123;</span><br><span class="line"></span><br><span class="line">					handleError(err);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="aync-series">aync.series</h2><h3 id="series(tasks,_[callback])">series(tasks, [callback])</h3><p>Run the functions in the <code>tasks</code> array in series, each one running once the previous<br>function has completed. If any functions in the series pass an error to its<br>callback, no more functions are run, and <code>callback</code> is immediately called with the value of the error.<br>Otherwise, <code>callback</code> receives an array of results when <code>tasks</code> have completed.</p>
<p>It is also possible to use an object instead of an array. Each property will be<br>run as a function, and the results will be passed to the final <code>callback</code> as an object<br>instead of an array. This can be a more readable way of handling results from<br>series.</p>
<p><strong>Note</strong> that while many implementations preserve the order of object properties, the<br><a href="http://www.ecma-international.org/ecma-262/5.1/#sec-8.6" target="_blank" rel="external">ECMAScript Language Specification</a><br>explicitly states that</p>
<blockquote>
<p>The mechanics and order of enumerating the properties is not specified.</p>
</blockquote>
<p>So if you rely on the order in which your series of functions are executed, and want<br>this to work on all platforms, consider using an array.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>tasks</code> - An array or object containing functions to run, each function is passed<br>a <code>callback(err, result)</code> it must call on completion with an error <code>err</code> (which can<br>be <code>null</code>) and an optional <code>result</code> value.</li>
<li><code>callback(err, results)</code> - An optional callback to run once all the functions<br>have completed. This function gets a results array (or object) containing all<br>the result arguments passed to the <code>task</code> callbacks.</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span>.series([</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// do some stuff ...</span></span><br><span class="line">        callback(<span class="literal">null</span>, <span class="string">'one'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// do some more stuff ...</span></span><br><span class="line">        callback(<span class="literal">null</span>, <span class="string">'two'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br><span class="line"><span class="comment">// optional callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// results is now equal to ['one', 'two']</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// an example using an object instead of an array</span></span><br><span class="line"><span class="keyword">async</span>.series(&#123;</span><br><span class="line">    one: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;, <span class="number">200</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    two: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">        &#125;, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// results is now equal to: &#123;one: 1, two: 2&#125;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<p>01.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> opreations = [</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">		fs.mkdir(dir,cb)</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"> <span class="keyword">async</span>.series(opreations, done);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>02.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileContent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> opreations = [</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">		fs.mkdir(dir,cb);</span><br><span class="line">		</span><br><span class="line">	&#125;,</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span>(<span class="params">err,content</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err)&#123;</span><br><span class="line">				cb(err);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				fileContent = content;</span><br><span class="line">				cb();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		fs.writeFile(target, fileContent, cb);</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"> <span class="keyword">async</span>.series(opreations, done);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>03.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileContent;</span><br><span class="line"><span class="keyword">var</span> fs1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> opreations = [</span><br><span class="line">	fs.mkdir.bind(fs1,dir),</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span>(<span class="params">err,content</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err)&#123;</span><br><span class="line">				cb(err);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				fileContent = content;</span><br><span class="line">				cb();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		fs.writeFile(target, fileContent, cb);</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"> <span class="keyword">async</span>.series(opreations, done);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>04.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileContent;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span>.series([mkdir, read, write], done);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdir</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">		fs.mkdir(dir,cb);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span>(<span class="params">err,content</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err)&#123;</span><br><span class="line">				cb(err);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				fileContent = content;</span><br><span class="line">				cb();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		fs.writeFile(target, fileContent, cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>,results);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## aync.waterfall</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### waterfall(tasks, [callback])</span></span><br><span class="line"></span><br><span class="line"><span class="type">Runs</span> the `tasks` <span class="type">array</span> <span class="keyword">of</span> functions <span class="keyword">in</span> series, each passing their results to the next <span class="keyword">in</span></span><br><span class="line">the <span class="type">array</span>. <span class="type">However</span>, <span class="keyword">if</span> <span class="type">any</span> <span class="keyword">of</span> the `tasks` pass an error to their own callback, the</span><br><span class="line">next function <span class="keyword">is</span> <span class="keyword">not</span> executed, <span class="keyword">and</span> the main `callback` <span class="keyword">is</span> immediately called <span class="keyword">with</span></span><br><span class="line">the error.</span><br><span class="line"></span><br><span class="line">__Arguments__</span><br><span class="line"></span><br><span class="line">* `tasks` - <span class="type">An</span> <span class="type">array</span> <span class="keyword">of</span> functions to run, each function <span class="keyword">is</span> passed a</span><br><span class="line">  `callback(err, result1, result2, ...)` it must call on completion. <span class="type">The</span> first</span><br><span class="line">  argument <span class="keyword">is</span> an error (which can be `null`) <span class="keyword">and</span> <span class="type">any</span> further arguments will be</span><br><span class="line">  passed <span class="keyword">as</span> arguments <span class="keyword">in</span> order to the next task.</span><br><span class="line">* `callback(err, [results])` - <span class="type">An</span> optional callback to run once all the functions</span><br><span class="line">  have completed. <span class="type">This</span> will be passed the results <span class="keyword">of</span> the last task's callback.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__Example__</span><br><span class="line"></span><br><span class="line">```js</span><br><span class="line">async.waterfall([</span><br><span class="line">    function(callback) &#123;</span><br><span class="line">        callback(null, 'one', 'two');</span><br><span class="line">    &#125;,</span><br><span class="line">    function(arg1, arg2, callback) &#123;</span><br><span class="line">      // arg1 now equals 'one' <span class="keyword">and</span> arg2 now equals 'two'</span><br><span class="line">        callback(null, 'three');</span><br><span class="line">    &#125;,</span><br><span class="line">    function(arg1, callback) &#123;</span><br><span class="line">        // arg1 now equals 'three'</span><br><span class="line">        callback(null, 'done');</span><br><span class="line">    &#125;</span><br><span class="line">], function (err, <span class="literal">result</span>) &#123;</span><br><span class="line">    // <span class="literal">result</span> now equals 'done'</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Or, with named functions:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span>.waterfall([</span><br><span class="line">    myFirstFunction,</span><br><span class="line">    mySecondFunction,</span><br><span class="line">    myLastFunction,</span><br><span class="line">], <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// result now equals 'done'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFirstFunction</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">'one'</span>, <span class="string">'two'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mySecondFunction</span>(<span class="params">arg1, arg2, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// arg1 now equals 'one' and arg2 now equals 'two'</span></span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">'three'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myLastFunction</span>(<span class="params">arg1, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// arg1 now equals 'three'</span></span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">'done'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Or, if you need to pass any argument to the first function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span>.waterfall([</span><br><span class="line">    <span class="keyword">async</span>.apply(myFirstFunction, <span class="string">'zero'</span>),</span><br><span class="line">    mySecondFunction,</span><br><span class="line">    myLastFunction,</span><br><span class="line">], <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// result now equals 'done'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFirstFunction</span>(<span class="params">arg1, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// arg1 now equals 'zero'</span></span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">'one'</span>, <span class="string">'two'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mySecondFunction</span>(<span class="params">arg1, arg2, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// arg1 now equals 'one' and arg2 now equals 'two'</span></span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">'three'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myLastFunction</span>(<span class="params">arg1, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// arg1 now equals 'three'</span></span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">'done'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>05.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"><span class="comment">//var fileContent;</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span>  opreations = [</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">		fs.mkdir(dir,callback);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		fs.readFile(source,&#123;encoding:<span class="string">'utf8'</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">			callback(<span class="literal">null</span>,results);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">results,callback</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(results);</span><br><span class="line">		callback(<span class="literal">null</span>, results);</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">fileContent,callback</span>)</span>&#123;</span><br><span class="line">		fs.writeFile(target, fileContent);</span><br><span class="line">		callback(<span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line">];</span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span>.waterfall(opreations, done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"><span class="keyword">var</span> context;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span>  opreations = [</span><br><span class="line">	fs.mkdir.bind(context, dir),</span><br><span class="line">	fs.readFile.bind(context, source),</span><br><span class="line">	fs.writeFile.bind(context, target)</span><br><span class="line">];</span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span>.waterfall(opreations, done);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/26/nodejs-note-17/" itemprop="url">
                  Asynchronous Programming -04 Coordinating series Calls
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-26T02:38:42+08:00" content="2016-01-26">
              2016-01-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/26/nodejs-note-17/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/26/nodejs-note-17/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> eachAsyncSeries = <span class="built_in">require</span>(<span class="string">'./eachAsyncSeries'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</span><br><span class="line"></span><br><span class="line">eachAsyncSeries(messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	setTimeout(cb, randomTimeout(), err);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">' handling: %s'</span>,   message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports =eachAsyncSeries;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eachAsyncSeries</span>(<span class="params">collection, iterate, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> pending = collection.slice();</span><br><span class="line"></span><br><span class="line">	next();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(! pending.length)&#123;</span><br><span class="line">			cb();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">'pending messages:'</span>, pending);</span><br><span class="line">			iterate(pending.shift(),iterated);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">iterated</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			cb(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			next();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="running_results:">running results:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line">[<span class="string">Error:</span> whaaa]</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message2</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message3</span><br><span class="line">all messages sent</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line">[<span class="string">Error:</span> whaaa]</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mapAsyncSeries = <span class="built_in">require</span>(<span class="string">'./mapAsyncSeries'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages = [<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</span><br><span class="line"><span class="keyword">var</span> index= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mapAsyncSeries(messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent, results'</span>, results);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">var</span> value = ++index;</span><br><span class="line"></span><br><span class="line">	setTimeout(cb, randomTimeout(), err, value);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">' handling: %s'</span>,  message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">module.exports = mapAsyncSeries;</span><br><span class="line"></span><br><span class="line">function mapAsyncSeries(collection, map, cb)&#123;</span><br><span class="line">	<span class="keyword">var</span> pending = collection.slice();</span><br><span class="line">	<span class="keyword">var</span> results = [];</span><br><span class="line"></span><br><span class="line">	next();</span><br><span class="line"></span><br><span class="line">	function next()&#123;</span><br><span class="line">		<span class="keyword">if</span>(! pending.length)&#123;</span><br><span class="line">			cb(null, results);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			console.log('pending messages:',pending);</span><br><span class="line">			map(pending.shift(),mapped);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	function mapped(err, <span class="literal">result</span>)&#123;</span><br><span class="line"></span><br><span class="line">		results.push(<span class="literal">result</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			cb(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			next();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="running_results:-1">running results:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main01.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message2</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message3</span><br><span class="line">all messages sent, results [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main01.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line">[<span class="string">Error:</span> whaaa]</span><br></pre></td></tr></table></figure>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">module.exports = mapAsyncLimit;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapAsyncLimit</span><span class="params">(limit, collection, map, cb)</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> pos = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> pending = <span class="number">0</span>; </span><br><span class="line">	<span class="keyword">var</span> results = [];</span><br><span class="line">	<span class="keyword">var</span> calledback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	next();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(pos &gt;= collection.length)&#123;</span><br><span class="line">			<span class="keyword">if</span>(!pending)&#123;</span><br><span class="line">				<span class="keyword">callback</span>(<span class="literal">null</span>, results);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">			pending++;</span><br><span class="line">			map(collection[pos],mapping(pos));</span><br><span class="line">			pos++</span><br><span class="line">			next();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">mapping</span><span class="params">(pos)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">mapped</span><span class="params">(err, result)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		pending --;</span><br><span class="line">		console.log(<span class="string">'handling:'</span>,collection[pos]);</span><br><span class="line">		results[pos]=result;</span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			<span class="keyword">callback</span>(err);</span><br><span class="line">		&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">			next();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err, results)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(! calledback)&#123;</span><br><span class="line"></span><br><span class="line">			calledback = <span class="literal">true</span>;</span><br><span class="line">			cb(err, results);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mapAsyncLimit = <span class="built_in">require</span>(<span class="string">'./mapAsyncLimit'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages = [</span><br><span class="line">	<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,</span><br><span class="line">	<span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span></span><br><span class="line">	];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> index= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mapAsyncLimit(<span class="number">1</span>,messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent, results'</span>, results);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.9</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">var</span> value = ++index;</span><br><span class="line"></span><br><span class="line">	setTimeout(cb, randomTimeout(), err, value);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">		<span class="comment">//console.log('handling: %s',  message);</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="runnning_result:">runnning result:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main02.js</span><br><span class="line"><span class="string">handling:</span> message5</span><br><span class="line"><span class="string">handling:</span> message3</span><br><span class="line"><span class="string">handling:</span> message4</span><br><span class="line"><span class="string">handling:</span> message2</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line"><span class="string">handling:</span> message6</span><br><span class="line">all messages sent, results [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span> ]</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main02.js</span><br><span class="line"><span class="string">handling:</span> message3</span><br><span class="line"><span class="string">handling:</span> message2</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line"><span class="string">handling:</span> message5</span><br><span class="line"><span class="string">handling:</span> message6</span><br><span class="line"><span class="string">handling:</span> message4</span><br><span class="line">[<span class="string">Error:</span> whaaa]</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/24/nodejs-note-16/" itemprop="url">
                  Asynchronous Programming -03 Mapping result
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-24T13:01:26+08:00" content="2016-01-24">
              2016-01-24
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/24/nodejs-note-16/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/24/nodejs-note-16/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> eachAsync = <span class="built_in">require</span>(<span class="string">'./each_async'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</span><br><span class="line"></span><br><span class="line">eachAsync(messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// random error will occour</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	setTimeout(cb, randomTimeout(), err);</span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">' elem is %s'</span>,   message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>eachAsync.js</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">module.exports = eachAsync;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">eachAsync</span><span class="params">(collection, iterate,  cb)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> pending = collection.length;</span><br><span class="line">		<span class="keyword">var</span> calledback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		collection.forEach(<span class="function"><span class="keyword">function</span><span class="params">(elem)</span></span>&#123;</span><br><span class="line">		iterate(elem, terminated);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">terminated</span><span class="params">(err)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		pending --;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			<span class="keyword">callback</span>(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(! pending)&#123;</span><br><span class="line">			<span class="keyword">callback</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(! calledback)&#123;</span><br><span class="line">			calledback = <span class="literal">true</span>;</span><br><span class="line">			cb(err);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Running results:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Lyn-Cheung-MBP:<span class="number">03</span> Lyn$ <span class="keyword">node</span><span class="identifier"> </span><span class="title">main</span>.js</span><br><span class="line"> elem is message1</span><br><span class="line"> elem is message2</span><br><span class="line"> elem is message3</span><br><span class="line">all messages sent</span><br><span class="line">Lyn-Cheung-MBP:<span class="number">03</span> Lyn$ <span class="keyword">node</span><span class="identifier"> </span><span class="title">main</span>.js</span><br><span class="line"> elem is message2</span><br><span class="line"> elem is message3</span><br><span class="line">[Error: whaaa]</span><br></pre></td></tr></table></figure>
<p>Main01.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mapAsync = <span class="built_in">require</span>(<span class="string">'./map_async'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> index = <span class="number">0</span> ;</span><br><span class="line">mapAsync(messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent,result:'</span>, results);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// random error will occour</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err = <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">var</span> result = ++index;</span><br><span class="line">	setTimeout(cb, randomTimeout(), err, result);</span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'index is %s, elem is %s'</span>, index, message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mapAsync.js</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">module.exports = mapAsync;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">mapAsync</span><span class="params">(collection, map,  cb)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> results = [];</span><br><span class="line">		<span class="keyword">var</span> pending = collection.length;</span><br><span class="line">		<span class="keyword">var</span> calledback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		collection.forEach(<span class="function"><span class="keyword">function</span><span class="params">(elem, index)</span></span>&#123;</span><br><span class="line">		map(elem, terminating(index));</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">terminating</span><span class="params">(index)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">terminated</span><span class="params">(err, result)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		pending --;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			<span class="keyword">callback</span>(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			results[index] = result;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(! pending)&#123;</span><br><span class="line">			<span class="keyword">callback</span>(<span class="literal">null</span>, results);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; </span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err, results)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(! calledback)&#123;</span><br><span class="line">			calledback = <span class="literal">true</span>;</span><br><span class="line">			cb(err, results);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Running results:</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lyn</span>-<span class="type">Cheung</span>-<span class="type">MBP</span>:<span class="number">03</span> <span class="type">Lyn</span>$ node main01.js</span><br><span class="line">index <span class="keyword">is</span> <span class="number">1</span>, elem <span class="keyword">is</span> message1</span><br><span class="line">index <span class="keyword">is</span> <span class="number">2</span>, elem <span class="keyword">is</span> message2</span><br><span class="line">index <span class="keyword">is</span> <span class="number">3</span>, elem <span class="keyword">is</span> message3</span><br><span class="line">all messages sent,<span class="literal">result</span>: [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line"><span class="type">Lyn</span>-<span class="type">Cheung</span>-<span class="type">MBP</span>:<span class="number">03</span> <span class="type">Lyn</span>$ node main01.js</span><br><span class="line">index <span class="keyword">is</span> <span class="number">1</span>, elem <span class="keyword">is</span> message1</span><br><span class="line">index <span class="keyword">is</span> <span class="number">2</span>, elem <span class="keyword">is</span> message2</span><br><span class="line">index <span class="keyword">is</span> <span class="number">3</span>, elem <span class="keyword">is</span> message3</span><br><span class="line">[<span class="type">Error</span>: whaaa]</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/author.png" alt="Lyn's Blog" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Lyn's Blog</p>
        </div>
        <p class="site-description motion-element" itemprop="description">Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">48</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">30</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lyn's Blog</span>
</div>

<div class="powered-by">
  <a class="theme-link" href="http://hexo.io">Powered by Hexo
  </a>
</div>

<div class="theme-info">
  
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>

</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-lyn"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
