<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />



  <meta name="description" content="Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes" />




  <meta name="keywords" content="Lyn's blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta property="og:type" content="website">
<meta property="og:title" content="Lyn's Blog">
<meta property="og:url" content="http://lyn.s76.org/page/4/index.html">
<meta property="og:site_name" content="Lyn's Blog">
<meta property="og:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lyn's Blog">
<meta name="twitter:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Lyn's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e1a1e7f61eef21fbacf4a67a19789441";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lyn's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Node.js Angular.js Express.js HTML5 Mongodb Programing Notes</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/26/nodejs-note-17/" itemprop="url">
                  Asynchronous Programming -04 Coordinating series Calls
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-26T02:38:42+08:00" content="2016-01-26">
              2016-01-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/26/nodejs-note-17/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/26/nodejs-note-17/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> eachAsyncSeries = <span class="built_in">require</span>(<span class="string">'./eachAsyncSeries'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</span><br><span class="line"></span><br><span class="line">eachAsyncSeries(messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	setTimeout(cb, randomTimeout(), err);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">' handling: %s'</span>,   message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports =eachAsyncSeries;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eachAsyncSeries</span>(<span class="params">collection, iterate, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> pending = collection.slice();</span><br><span class="line"></span><br><span class="line">	next();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(! pending.length)&#123;</span><br><span class="line">			cb();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">'pending messages:'</span>, pending);</span><br><span class="line">			iterate(pending.shift(),iterated);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">iterated</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			cb(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			next();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="running_results:">running results:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line">[<span class="string">Error:</span> whaaa]</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message2</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message3</span><br><span class="line">all messages sent</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line">[<span class="string">Error:</span> whaaa]</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mapAsyncSeries = <span class="built_in">require</span>(<span class="string">'./mapAsyncSeries'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages = [<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</span><br><span class="line"><span class="keyword">var</span> index= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mapAsyncSeries(messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent, results'</span>, results);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">var</span> value = ++index;</span><br><span class="line"></span><br><span class="line">	setTimeout(cb, randomTimeout(), err, value);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">' handling: %s'</span>,  message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">module.exports = mapAsyncSeries;</span><br><span class="line"></span><br><span class="line">function mapAsyncSeries(collection, map, cb)&#123;</span><br><span class="line">	<span class="keyword">var</span> pending = collection.slice();</span><br><span class="line">	<span class="keyword">var</span> results = [];</span><br><span class="line"></span><br><span class="line">	next();</span><br><span class="line"></span><br><span class="line">	function next()&#123;</span><br><span class="line">		<span class="keyword">if</span>(! pending.length)&#123;</span><br><span class="line">			cb(null, results);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			console.log('pending messages:',pending);</span><br><span class="line">			map(pending.shift(),mapped);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	function mapped(err, <span class="literal">result</span>)&#123;</span><br><span class="line"></span><br><span class="line">		results.push(<span class="literal">result</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			cb(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			next();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="running_results:-1">running results:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main01.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message2</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message3'</span> ]</span><br><span class="line"><span class="string">handling:</span> message3</span><br><span class="line">all messages sent, results [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main01.js</span><br><span class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</span><br><span class="line">[<span class="string">Error:</span> whaaa]</span><br></pre></td></tr></table></figure>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">module.exports = mapAsyncLimit;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapAsyncLimit</span><span class="params">(limit, collection, map, cb)</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> pos = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> pending = <span class="number">0</span>; </span><br><span class="line">	<span class="keyword">var</span> results = [];</span><br><span class="line">	<span class="keyword">var</span> calledback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	next();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(pos &gt;= collection.length)&#123;</span><br><span class="line">			<span class="keyword">if</span>(!pending)&#123;</span><br><span class="line">				<span class="keyword">callback</span>(<span class="literal">null</span>, results);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">			pending++;</span><br><span class="line">			map(collection[pos],mapping(pos));</span><br><span class="line">			pos++</span><br><span class="line">			next();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">mapping</span><span class="params">(pos)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">mapped</span><span class="params">(err, result)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		pending --;</span><br><span class="line">		console.log(<span class="string">'handling:'</span>,collection[pos]);</span><br><span class="line">		results[pos]=result;</span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			<span class="keyword">callback</span>(err);</span><br><span class="line">		&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">			next();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err, results)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(! calledback)&#123;</span><br><span class="line"></span><br><span class="line">			calledback = <span class="literal">true</span>;</span><br><span class="line">			cb(err, results);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mapAsyncLimit = <span class="built_in">require</span>(<span class="string">'./mapAsyncLimit'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages = [</span><br><span class="line">	<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,</span><br><span class="line">	<span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span></span><br><span class="line">	];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> index= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mapAsyncLimit(<span class="number">1</span>,messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent, results'</span>, results);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.9</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">var</span> value = ++index;</span><br><span class="line"></span><br><span class="line">	setTimeout(cb, randomTimeout(), err, value);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">		<span class="comment">//console.log('handling: %s',  message);</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="runnning_result:">runnning result:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main02.js</span><br><span class="line"><span class="string">handling:</span> message5</span><br><span class="line"><span class="string">handling:</span> message3</span><br><span class="line"><span class="string">handling:</span> message4</span><br><span class="line"><span class="string">handling:</span> message2</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line"><span class="string">handling:</span> message6</span><br><span class="line">all messages sent, results [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span> ]</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main02.js</span><br><span class="line"><span class="string">handling:</span> message3</span><br><span class="line"><span class="string">handling:</span> message2</span><br><span class="line"><span class="string">handling:</span> message1</span><br><span class="line"><span class="string">handling:</span> message5</span><br><span class="line"><span class="string">handling:</span> message6</span><br><span class="line"><span class="string">handling:</span> message4</span><br><span class="line">[<span class="string">Error:</span> whaaa]</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/24/nodejs-note-16/" itemprop="url">
                  Asynchronous Programming -03 Mapping result
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-24T13:01:26+08:00" content="2016-01-24">
              2016-01-24
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/24/nodejs-note-16/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/24/nodejs-note-16/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> eachAsync = <span class="built_in">require</span>(<span class="string">'./each_async'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</span><br><span class="line"></span><br><span class="line">eachAsync(messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// random error will occour</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	setTimeout(cb, randomTimeout(), err);</span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">' elem is %s'</span>,   message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>eachAsync.js</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">module.exports = eachAsync;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">eachAsync</span><span class="params">(collection, iterate,  cb)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> pending = collection.length;</span><br><span class="line">		<span class="keyword">var</span> calledback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		collection.forEach(<span class="function"><span class="keyword">function</span><span class="params">(elem)</span></span>&#123;</span><br><span class="line">		iterate(elem, terminated);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">terminated</span><span class="params">(err)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		pending --;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			<span class="keyword">callback</span>(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(! pending)&#123;</span><br><span class="line">			<span class="keyword">callback</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(! calledback)&#123;</span><br><span class="line">			calledback = <span class="literal">true</span>;</span><br><span class="line">			cb(err);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Running results:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Lyn-Cheung-MBP:<span class="number">03</span> Lyn$ <span class="keyword">node</span><span class="identifier"> </span><span class="title">main</span>.js</span><br><span class="line"> elem is message1</span><br><span class="line"> elem is message2</span><br><span class="line"> elem is message3</span><br><span class="line">all messages sent</span><br><span class="line">Lyn-Cheung-MBP:<span class="number">03</span> Lyn$ <span class="keyword">node</span><span class="identifier"> </span><span class="title">main</span>.js</span><br><span class="line"> elem is message2</span><br><span class="line"> elem is message3</span><br><span class="line">[Error: whaaa]</span><br></pre></td></tr></table></figure>
<p>Main01.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mapAsync = <span class="built_in">require</span>(<span class="string">'./map_async'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> index = <span class="number">0</span> ;</span><br><span class="line">mapAsync(messages,send,done);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent,result:'</span>, results);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// random error will occour</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> err = <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">var</span> result = ++index;</span><br><span class="line">	setTimeout(cb, randomTimeout(), err, result);</span><br><span class="line">	<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'index is %s, elem is %s'</span>, index, message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mapAsync.js</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">module.exports = mapAsync;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">mapAsync</span><span class="params">(collection, map,  cb)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> results = [];</span><br><span class="line">		<span class="keyword">var</span> pending = collection.length;</span><br><span class="line">		<span class="keyword">var</span> calledback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		collection.forEach(<span class="function"><span class="keyword">function</span><span class="params">(elem, index)</span></span>&#123;</span><br><span class="line">		map(elem, terminating(index));</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">terminating</span><span class="params">(index)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">terminated</span><span class="params">(err, result)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		pending --;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			<span class="keyword">callback</span>(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			results[index] = result;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(! pending)&#123;</span><br><span class="line">			<span class="keyword">callback</span>(<span class="literal">null</span>, results);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; </span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err, results)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(! calledback)&#123;</span><br><span class="line">			calledback = <span class="literal">true</span>;</span><br><span class="line">			cb(err, results);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Running results:</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lyn</span>-<span class="type">Cheung</span>-<span class="type">MBP</span>:<span class="number">03</span> <span class="type">Lyn</span>$ node main01.js</span><br><span class="line">index <span class="keyword">is</span> <span class="number">1</span>, elem <span class="keyword">is</span> message1</span><br><span class="line">index <span class="keyword">is</span> <span class="number">2</span>, elem <span class="keyword">is</span> message2</span><br><span class="line">index <span class="keyword">is</span> <span class="number">3</span>, elem <span class="keyword">is</span> message3</span><br><span class="line">all messages sent,<span class="literal">result</span>: [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line"><span class="type">Lyn</span>-<span class="type">Cheung</span>-<span class="type">MBP</span>:<span class="number">03</span> <span class="type">Lyn</span>$ node main01.js</span><br><span class="line">index <span class="keyword">is</span> <span class="number">1</span>, elem <span class="keyword">is</span> message1</span><br><span class="line">index <span class="keyword">is</span> <span class="number">2</span>, elem <span class="keyword">is</span> message2</span><br><span class="line">index <span class="keyword">is</span> <span class="number">3</span>, elem <span class="keyword">is</span> message3</span><br><span class="line">[<span class="type">Error</span>: whaaa]</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/22/nodejs-note-15/" itemprop="url">
                  Asynchronous Programming - 02 Coordinating Parallel Calls
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-22T19:10:47+08:00" content="2016-01-22">
              2016-01-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/22/nodejs-note-15/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/22/nodejs-note-15/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Coordinating_Parallel_Calls">Coordinating Parallel Calls</h1><p>composedCall.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">composedCall</span>(<span class="params">args, cb</span>)</span>&#123;</span><br><span class="line">	call1(args,handlingError(<span class="function"><span class="keyword">function</span>(<span class="params">result1</span>)</span>&#123;</span><br><span class="line">		call2(args, handlingError(<span class="function"><span class="keyword">function</span>(<span class="params">result2</span>)</span>&#123;</span><br><span class="line">			call3(args, handlingError(<span class="function"><span class="keyword">function</span>(<span class="params">result3</span>)</span>&#123;</span><br><span class="line">				cb(<span class="literal">null</span>,[result1, result2, result3])</span><br><span class="line"></span><br><span class="line">			&#125;));</span><br><span class="line">		&#125;));</span><br><span class="line">	&#125;));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlingError</span>(<span class="params">fn</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (err)&#123;</span><br><span class="line">			cb(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			fn(result);  </span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call1</span>(<span class="params">args, cb</span>)</span>&#123;</span><br><span class="line">	setTimeout(cb,randomTimeout(), <span class="literal">null</span>, randomValue());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call2</span>(<span class="params">args, cb</span>)</span>&#123;</span><br><span class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomValue());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call3</span>(<span class="params">args, cb</span>)</span>&#123;</span><br><span class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomValue());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomValue</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>main.js</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> operation = require('./composedCall');</span><br><span class="line"></span><br><span class="line">operation(&#123;some:'args'&#125;, function(err,<span class="literal">result</span>)&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		console.log(err);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		console.log('successful <span class="literal">result</span>:', <span class="literal">result</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Make this function run in parallel.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">composedCall</span>(<span class="params">args, cb</span>)</span>&#123;</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">var</span> pending = <span class="number">0</span> ;</span><br><span class="line">	<span class="keyword">var</span> results =[] ;</span><br><span class="line">	<span class="keyword">var</span> calledback = <span class="literal">false</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call function with call id.</span></span><br><span class="line"></span><br><span class="line">	call1(args, handleResult(<span class="number">1</span>));</span><br><span class="line">	call2(args, handleResult(<span class="number">2</span>));</span><br><span class="line">	call3(args, handleResult(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Insert value into  array by order. </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleResult</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">	 </span><br><span class="line">	 <span class="keyword">var</span> order = pending;</span><br><span class="line">	 pending ++;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'Call id is: %s, order: %s,  pending value is: %s.'</span>,id,order,pending);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">	 <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	 	pending--;</span><br><span class="line"></span><br><span class="line">	 	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">	 		callback(err);</span><br><span class="line">	 	&#125;</span><br><span class="line">	 	<span class="keyword">else</span>&#123;</span><br><span class="line">	 		results[order] =result;</span><br><span class="line">	 		</span><br><span class="line">	 		<span class="built_in">console</span>.log(<span class="string">'Call id is: %s, order: %s, Pending value is: %s, results now is: %s. '</span>, id,   order, pending, results);</span><br><span class="line">	 		</span><br><span class="line">	 		<span class="keyword">if</span> (! pending)&#123;</span><br><span class="line">	 		callback(<span class="literal">null</span>, results);</span><br><span class="line">	 		&#125;</span><br><span class="line">	 	&#125;</span><br><span class="line">	 &#125;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check the calledback value, Make sure cb function will be called only once</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">err, value</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(! calledback)&#123;</span><br><span class="line">		calledback = <span class="literal">true</span>;</span><br><span class="line">		cb(err, value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call1</span>(<span class="params">args, cb</span>)</span>&#123;</span><br><span class="line">	setTimeout(cb,randomTimeout(), <span class="literal">null</span>, randomValue());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call2</span>(<span class="params">args, cb</span>)</span>&#123;</span><br><span class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomValue());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call3</span>(<span class="params">args, cb</span>)</span>&#123;</span><br><span class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomValue());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomValue</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Run this code to check the running process:</p>
<p>because it is running parallel, therefore the sequence is random. </p>
<p>however,  we use order value to keep the array in the right order.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Lyn-Cheung-MBP:02 Lyn$ node main.js</span><br><span class="line"><span class="operator"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">1</span>, <span class="keyword">order</span>: <span class="number">0</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">1.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">2</span>, <span class="keyword">order</span>: <span class="number">1</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">2.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">3</span>, <span class="keyword">order</span>: <span class="number">2</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">3.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">1</span>, <span class="keyword">order</span>: <span class="number">0</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">2</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: <span class="number">2632852697.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">3</span>, <span class="keyword">order</span>: <span class="number">2</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">1</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: <span class="number">2632852697</span>,,<span class="number">1775016640.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">2</span>, <span class="keyword">order</span>: <span class="number">1</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">0</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: <span class="number">2632852697</span>,<span class="number">2485099832</span>,<span class="number">1775016640.</span></span><br><span class="line">successful <span class="keyword">result</span>: [ <span class="number">2632852697</span>, <span class="number">2485099832</span>, <span class="number">1775016640</span> ]</span><br><span class="line"></span><br><span class="line">Lyn-Cheung-MBP:<span class="number">02</span> Lyn$ node <span class="keyword">main</span>.js</span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">1</span>, <span class="keyword">order</span>: <span class="number">0</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">1.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">2</span>, <span class="keyword">order</span>: <span class="number">1</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">2.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">3</span>, <span class="keyword">order</span>: <span class="number">2</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">3.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">2</span>, <span class="keyword">order</span>: <span class="number">1</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">2</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: ,<span class="number">7063975371.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">3</span>, <span class="keyword">order</span>: <span class="number">2</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">1</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: ,<span class="number">7063975371</span>,<span class="number">3080169013.</span></span><br><span class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">1</span>, <span class="keyword">order</span>: <span class="number">0</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">0</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: <span class="number">1889156524</span>,<span class="number">7063975371</span>,<span class="number">3080169013.</span></span><br><span class="line">successful <span class="keyword">result</span>: [ <span class="number">1889156524</span>, <span class="number">7063975371</span>, <span class="number">3080169013</span> ]</span></span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/21/nodejs-note-14/" itemprop="url">
                  Asynchronous Programming - 01 Chaining  callback
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-21T00:04:26+08:00" content="2016-01-21">
              2016-01-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/21/nodejs-note-14/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/21/nodejs-note-14/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p> In JavaScript, any operation involving the network or the file system is always asynchronous. Once you start implementing complex logic, coordinating I/O operations can become a challenge in Node.</p>
<h1 id="The_callback_pattern:">The callback pattern:</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>  fs =<span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(__filename,&#123;encoding:<span class="string">'utf8'</span>&#125;,gotFileContent);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gotFileContent</span>(<span class="params">err, content</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		<span class="built_in">console</span>.error(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'this file content: \n\n %s'</span>,content);</span><br><span class="line">	&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="CHAINING_CALLS">CHAINING CALLS</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname,<span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line">fs.mkdir(dir, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err)&#123;</span><br><span class="line">				handleError(err);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				fs.writeFile(target, content, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">if</span>(err)&#123;</span><br><span class="line"></span><br><span class="line">					handleError(err);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ESCAPING_Callback_HEll">ESCAPING Callback HEll</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname,<span class="string">'temp'</span>);</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fs.mkdir(dir, mkdirped);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdirped</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		fs.readFile(source, haveFile)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">haveFile</span>(<span class="params">err, content</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">		fs.writeFile(target, content, wroteFile);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wroteFile</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (err)&#123;</span><br><span class="line">		handleError(err);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Generalizing_Error_Handling">Generalizing Error Handling</h1><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = require('fs');</span><br><span class="line"><span class="keyword">var</span> path = require('path')</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dir = path.join(__dirname,'temp');</span><br><span class="line"><span class="keyword">var</span> source = __filename;</span><br><span class="line"><span class="keyword">var</span> target = path.join(dir, 'target');</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fs.mkdir(dir, handlingError(mkdirped));</span><br><span class="line"></span><br><span class="line">function mkdirped() &#123;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">var</span> readresult = fs.readFile(source, handlingError(haveFile));</span><br><span class="line">	 </span><br><span class="line">	 	console.log('readresult <span class="keyword">is</span>:' + readresult);</span><br><span class="line">	  	console.log('haveFile <span class="keyword">is</span>:'+haveFile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function haveFile(content)&#123;</span><br><span class="line"> 		</span><br><span class="line">		fs.writeFile(target, content, handlingError(wroteFile));</span><br><span class="line">	 </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function wroteFile() &#123;	 </span><br><span class="line">	console.log('all done');</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function handlingError(cb)&#123;</span><br><span class="line">	<span class="keyword">return</span> function(err, <span class="literal">result</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)&#123;</span><br><span class="line">		console.log(err );</span><br><span class="line">		console.log('params:'+<span class="literal">result</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		cb(<span class="literal">result</span>);</span><br><span class="line">		console.log('callback function <span class="keyword">is</span> :'+ cb);</span><br><span class="line">		console.log('params <span class="keyword">is</span>:'+<span class="literal">result</span>);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/16/nodejs-note-13/" itemprop="url">
                  How to learn Node.js -- Protect your website from CSRF
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-16T00:25:04+08:00" content="2016-01-16">
              2016-01-16
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/16/nodejs-note-13/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/16/nodejs-note-13/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="CSRF_DEMO">CSRF DEMO</h1><blockquote>
<p>跨站请求伪造（Cross-site request forgery），也被称为 one-click attack 或者 session riding，通常缩写为 CSRF 或者 XSRF，<br>是一种挟制用户在当前已登录的Web应用程序上执行非本意的操作的攻击方法。[1] 跟跨网站脚本（XSS）相比，XSS 利用的是用户对指定网站的信任，CSRF<br>利用的是网站对用户网页浏览器的信任。</p>
</blockquote>
<h2 id="CSRF_Examples">CSRF Examples</h2><p>假如一家银行用以执行转账操作的URL地址如下：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/www.examplebank.com/withdraw</span>?account=<span class="constant">AccoutName</span>&amp;amount=<span class="number">1000</span>&amp;<span class="keyword">for</span>=<span class="constant">PayeeName</span></span><br></pre></td></tr></table></figure></p>
<p>那么，一个恶意攻击者可以在网站上放置如下代码： </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="tag">img</span> src=<span class="string">"http://www.examplebank.com/withdraw?account=Alice&amp;amount=1000&amp;for=Badman"</span>&gt;</span><br></pre></td></tr></table></figure>
<p>如果有账户名为Alice的用户访问了恶意站点，而她之前刚访问过银行不久，登录信息尚未过期，那么她就会损失1000资金。</p>
<p>这种恶意的网址可以有很多种形式，藏身于网页中的许多地方。此外，攻击者也不需要控制放置恶意网址的网站。例如他可以将这种地址藏在论坛，博客等任何用户生成内容的网站中。这意味着如果服务器端没有合适的防御措施的话，用户即使访问熟悉的可信网站也有受攻击的危险。</p>
<p>透过例子能够看出，攻击者并不能通过CSRF攻击来直接获取用户的账户控制权，也不能直接窃取用户的任何信息。他们能做到的，是欺骗用户浏览器，让其以用户的名义执行操作。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span> <span class="attribute">lang</span>=<span class="value">"en"</span> <span class="attribute">class</span>=<span class="value">"no-js"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span>This is a safe and legitimate forum.<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span></span><br><span class="line">      This paragraph contains an image that you can't see.</span><br><span class="line">      <span class="tag">&lt;<span class="title">img</span> <span class="attribute">src</span>=<span class="value">"http://website:3000/portal/billing/dangerous_action?amount=5000&amp;receiver=lyn"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">form</span> <span class="attribute">method</span>=<span class="value">"POST"</span> <span class="attribute">action</span>=<span class="value">"http://website:3000/portal/billing/dangerous_action"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"hidden"</span> <span class="attribute">name</span>=<span class="value">"amount"</span> <span class="attribute">value</span>=<span class="value">"5000"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"hidden"</span> <span class="attribute">name</span>=<span class="value">"receiver"</span> <span class="attribute">value</span>=<span class="value">"lyn"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">button</span> <span class="attribute">type</span>=<span class="value">"submit"</span>&gt;</span>Click here to save baby dolphins<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line">      Note: Each time you click this, a baby dolphin gets its wings.</span><br><span class="line">    <span class="tag">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果使用express 中 定义的route 是get的话 图片链接就可以成功攻击。<br>但即使让表单提交全部用POST的方式提交，还是可以通过伪装表格的方式来提交</p>
<h1 id="CSURF">CSURF</h1><p>我们可以使用CSURF，来轻松的避免这种攻击，</p>
<p>它的原理就是为每一个敏感的表单添加校验token，来保证提交的真实性。<br>由于CSRF的本质在于攻击者欺骗用户去访问自己设置的地址，所以如果要求在访问敏感数据请求时，要求用户浏览器提供不保存在cookie中，并且攻击者无法伪造的数据作为校验，那么攻击者就无法再执行CSRF攻击。这种数据通常是表单中的一个数据项。服务器将其生成并附加在表单中，其内容是一个伪乱数。当客户端通过表单提交请求时，这个伪乱数也一并提交上去以供校验。正常的访问时，客户端浏览器能够正确得到并传回这个伪乱数，而通过CSRF传来的欺骗性攻击中，攻击者无从事先得知这个伪乱数的值，服务器端就会因为校验token的值为空或者错误，拒绝这个可疑请求。</p>
<h2 id="Simple_express_example">Simple express example</h2><p>The following is an example of some server-side code that generates a form that requires a CSRF token to post back.<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cookieParser = <span class="keyword">require</span>(<span class="string">'cookie-parser'</span>)</span><br><span class="line"><span class="keyword">var</span> csrf = <span class="keyword">require</span>(<span class="string">'csurf'</span>)</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="keyword">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// setup route middlewares</span></span><br><span class="line"><span class="keyword">var</span> csrfProtection = csrf(&#123; cookie: <span class="keyword">true</span> &#125;)</span><br><span class="line"><span class="keyword">var</span> parseForm = bodyParser.urlencoded(&#123; extended: <span class="keyword">false</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// create express app</span></span><br><span class="line"><span class="keyword">var</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// parse cookies</span></span><br><span class="line"><span class="comment">// we need this because "cookie" is true in csrfProtection</span></span><br><span class="line">app.<span class="keyword">use</span>(cookieParser())</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/form'</span>, csrfProtection, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// pass the csrfToken to the view</span></span><br><span class="line">  res.render(<span class="string">'send'</span>, &#123; csrfToken: req.csrfToken() &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/process'</span>, parseForm, csrfProtection, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</span><br><span class="line">  res.send(<span class="string">'data is being processed'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>Inside the view (depending on your template language; handlebars-style is demonstrated here), set the csrfToken value as the value of a hidden input field named _csrf:</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"/process"</span> method=<span class="string">"<span class="keyword">POST</span>"</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"_csrf"</span> value=<span class="string">"&#123;&#123;csrfToken&#125;&#125;"</span>&gt;</span><br><span class="line"></span><br><span class="line">  Favorite color: &lt;input type=<span class="string">"text"</span> name=<span class="string">"favoriteColor"</span>&gt;</span><br><span class="line">  &lt;button type=<span class="string">"submit"</span>&gt;Submit&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<h1 id="Use_middleware">Use middleware</h1><p>我们这里可以自己定义两个middleware 来减少我们的代码量</p>
<h2 id="invalidCsrfToken">invalidCsrfToken</h2><p>这个middleware可以帮助我们自定义所有的不安全的访问进行特定的跳转或者提示。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invalidCsrfToken</span>(<span class="params">err, req, res, next</span>)</span>&#123;</span><br><span class="line">	 <span class="keyword">if</span> (err.code !== <span class="string">'EBADCSRFTOKEN'</span>) <span class="keyword">return</span> next(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// handle CSRF token errors here</span></span><br><span class="line">  	res.status(<span class="number">403</span>)</span><br><span class="line">		res.send(<span class="string">'session has expired or form tampered with'</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = invalidCsrfToken</span><br></pre></td></tr></table></figure>
<h2 id="attachCsrfToken">attachCsrfToken</h2><p>我们可以通过定义这个middleware来实现避免在每一个Route中都要传递 req.csrfToken() 这个值给templates</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attachCsrfToken</span><span class="params">(req, res, next)</span></span>&#123;</span><br><span class="line">	res.locals.csrfTokenFunction = req.csrfToken()</span><br><span class="line">	<span class="built_in">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = attachCsrfToken</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/15/web-development-tool-sublime/" itemprop="url">
                  Sublime handy  features and  plugins
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-15T13:07:18+08:00" content="2016-01-15">
              2016-01-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/15/web-development-tool-sublime/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/15/web-development-tool-sublime/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Sublime-HTMLPrettify">Sublime-HTMLPrettify</h1><h2 id="Installation">Installation</h2><p>First of all, be sure you have node.js installed in order to run the beautifier. After you’ve installed node.js, you will need to setup this plugin. Each OS has a different Packages folder required by Sublime Text. Open it via Preferences -&gt; Browse Packages, and copy this repository contents to the Sublime-HTMLPrettify folder there.</p>
<p>The shorter way of doing this is:</p>
<p>Through Sublime Package Manager</p>
<p>Ctrl+Shift+P or Cmd+Shift+P in Linux/Windows/OS X<br>type install, select Package Control: Install Package<br>type prettify, select HTML-CSS-JS Prettify</p>
<h2 id="Manually">Manually</h2><p>Make sure you use the right Sublime Text folder. For example, on OS X, packages for version 2 are in ~/Library/Application\ Support/Sublime\ Text\ 2, while version 3 is labeled ~/Library/Application\ Support/Sublime\ Text\ 3.</p>
<p>These are for Sublime Text 3:</p>
<p>Mac</p>
<p>git clone <a href="https://github.com/victorporof/Sublime-HTMLPrettify.git" target="_blank" rel="external">https://github.com/victorporof/Sublime-HTMLPrettify.git</a> ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/Sublime-HTMLPrettify</p>
<p>Linux</p>
<p>git clone <a href="https://github.com/victorporof/Sublime-HTMLPrettify.git" target="_blank" rel="external">https://github.com/victorporof/Sublime-HTMLPrettify.git</a> ~/.config/sublime-text-3/Packages/Sublime-HTMLPrettify</p>
<p>Windows</p>
<p>git clone <a href="https://github.com/victorporof/Sublime-HTMLPrettify.git" target="_blank" rel="external">https://github.com/victorporof/Sublime-HTMLPrettify.git</a> %APPDATA%/Sublime\ Text\ 3/Packages/Sublime-HTMLPrettify</p>
<h2 id="Usage">Usage</h2><p>Tools -&gt; Command Palette (Cmd+Shift+P or Ctrl+Shift+P) and type htmlprettify.</p>
<p>– or –</p>
<p>Ctrl+Shift+H (or Cmd+Shift+H if you’re on a Mac).</p>
<h1 id="Alignment">Alignment</h1><ul>
<li>CMD + CTRL + A </li>
</ul>
<h1 id="ShortCuts快捷键">ShortCuts快捷键</h1><h2 id="定位搜索相关">定位搜索相关</h2><ul>
<li>Cmd + Shift + F  全局搜索</li>
<li>Ctrl + R：跳转到函数，在html文件中跳到某ID的节点上 @ #跳转到变量</li>
</ul>
<h2 id="选择相关：">选择相关：</h2><ul>
<li>CMD + D  选中相同的单词。</li>
<li>CMD + L        选中行</li>
<li>Option + Shift+↑一行一行向上选中|Add previous line</li>
<li>Option + Shift+↓一行一行向下选中|Add next line</li>
<li>CMD + Ctrl + ↑ 将光标所在行和上一行代码互换（将光标所在行插入到上一行之前）。</li>
<li>CMD + Ctrl + ↓ 将光标所在行和下一行代码互换（将光标所在行插入到下一行之后）。</li>
<li>Ctrl + M ：光标移动至括号内开始或结束的位置；</li>
<li>Ctrl + Shift + M ：选择括号内的内容（按住-继续选择父括号）；</li>
<li>Ctrl + Alt + ↑ 向上添加多行光标，可同时编辑多行。</li>
<li><p>Ctrl + Alt + ↓ 向下添加多行光标，可同时编辑多行。</p>
<h2 id="编辑类">编辑类</h2></li>
<li><p>Ctrl+J         合并选中的多行代码为一行。举个栗子：将多行格式的CSS属性合并为一行。</p>
</li>
<li>CMD+Shift+D    复制光标所在整行，插入到下一行。</li>
<li>CMD + ENTER    在当前行后面插入空白行</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/12/03/nodejs-note-12/" itemprop="url">
                  How to learn Node.js -- Using bootstrap
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-12-03T01:26:19+08:00" content="2015-12-03">
              2015-12-03
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/03/nodejs-note-12/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/03/nodejs-note-12/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Bootstrap">Bootstrap</h1><p>This is a framework which integrate CSS rules and Js files to  accelerate our development. </p>
<p>After you import bootstrap, you only need add class and id into your html,then you can get a pretty Website.</p>
<h1 id="Usage">Usage</h1><p>Import bootstrap js and css file in header.hbs</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">meta</span> <span class="attribute">http-equiv</span>=<span class="value">"X-UA-Compatible"</span> <span class="attribute">content</span>=<span class="value">"IE=edge"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"viewport"</span> <span class="attribute">content</span>=<span class="value">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">title</span>&gt;</span>Node.js<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">type</span>=<span class="value">"text/css"</span> <span class="attribute">href</span>=<span class="value">"/css/bootstrap.min.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"/js/bootstrap.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Put our links into our navigation bar (nav.hbs). </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">nav</span> <span class="attribute">class</span>=<span class="value">"navbar navbar-inverse"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"navbar-header"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">button</span> <span class="attribute">class</span>=<span class="value">"navbar-toggle collapsed"</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">data-toggle</span>=<span class="value">"collapse"</span> <span class="attribute">data-target</span>=<span class="value">"#main_site_nav"</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"sr-only"</span>&gt;</span>Toggle Navigation<span class="tag">&lt;/<span class="title">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"navbar-brand"</span> <span class="attribute">href</span>=<span class="value">"/"</span>&gt;</span> NodeSlash<span class="tag">&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"collapse navbar-collapse"</span> <span class="attribute">id</span>=<span class="value">"main_site_nav"</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">      <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">class</span>=<span class="value">"nav navbar-nav"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"/about"</span>&gt;</span>About<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"/sign_in"</span>&gt;</span>Sign in<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"/sign_up"</span>&gt;</span>Sign up<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"/sign_out"</span>&gt;</span>Sign out<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">nav</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Or you can use less-middleware to complie bootstrap less file :</p>
<p>Simply put bootstrap less files under  app/stylesheets/bootstrap/  </p>
<p>app/stylesheets/application.less</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="at_rule">@<span class="keyword">import</span> <span class="string">"bootstrap/bootstrap"</span></span>;</span><br></pre></td></tr></table></figure>
<p>Then quote file in header </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"text/css"</span> href=<span class="string">"/stylesheets/application.css"</span>&gt;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/12/01/nodejs-note-11/" itemprop="url">
                  How to learn Node.js -- Using less and lessMiddleware to complie css file
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-12-01T23:52:25+08:00" content="2015-12-01">
              2015-12-01
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/01/nodejs-note-11/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/01/nodejs-note-11/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Why_using_less_?">Why using less ?</h1><p>less is an extension to CSS, Less is not only backwards compatible with CSS, but the extra features it adds use existing CSS syntax.</p>
<p>it add some features to make css file more easy to maintain in development, for example:</p>
<h2 id="Variables">Variables</h2><p>We can add variables in less:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@color:</span> <span class="hexcolor">#4D926F</span>;</span><br><span class="line"></span><br><span class="line"><span class="id">#header</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="variable">@color</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">h2</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="variable">@color</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Mixins">Mixins</h2><p> You can mix-in class selectors and id selectors, e.g.<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.a</span>, <span class="id">#b</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class">.mixin-class</span> &#123;</span><br><span class="line">  <span class="class">.a</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="class">.mixin-id</span> &#123;</span><br><span class="line">  <span class="id">#b</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> which results in:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.a</span>, <span class="id">#b</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">color</span>:<span class="value"> red</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.mixin-class</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">color</span>:<span class="value"> red</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.mixin-id</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">color</span>:<span class="value"> red</span></span>;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="Nested_Rules">Nested Rules</h2><p>Less enable us to use nesting instead of, or in combination with cascading:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="id">#header</span> <span class="tag">h1</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">font-size</span>:<span class="value"> <span class="number">26px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">font-weight</span>:<span class="value"> bold</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#header</span> <span class="tag">p</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">font-size</span>:<span class="value"> <span class="number">12px</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#header</span> <span class="tag">p</span> <span class="tag">a</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">text-decoration</span>:<span class="value"> none</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#header</span> <span class="tag">p</span> <span class="tag">a</span><span class="pseudo">:hover</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">border-width</span>:<span class="value"> <span class="number">1px</span></span></span>;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<p>In Less, we can also write it this way:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="id">#header</span> &#123;</span><br><span class="line">    <span class="tag">h1</span> &#123;</span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">26px</span>;</span><br><span class="line">        <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="tag">p</span> &#123;</span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">12px</span>;</span><br><span class="line">        <span class="tag">a</span> &#123;</span><br><span class="line">            <span class="attribute">text-decoration</span>: none;</span><br><span class="line">            <span class="keyword">&amp;</span><span class="pseudo">:hover</span> &#123;</span><br><span class="line">                <span class="attribute">border-width</span>: <span class="number">1px</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This looks more nature like html structrue </p>
<h1 id="Install_lessMiddleware">Install lessMiddleware</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="operator"><span class="keyword">install</span> <span class="keyword">less</span>-middleware <span class="comment">--save</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Usage">Usage</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">lessMiddleware</span><span class="params">(source, [&#123;options&#125;])</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Express">Express</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lessMiddleware = <span class="keyword">require</span>(<span class="string">'less-middleware'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line">app.<span class="keyword">use</span>(lessMiddleware(__dirname + <span class="string">'/public'</span>));</span><br><span class="line">app.<span class="keyword">use</span>(express.<span class="keyword">static</span>(__dirname + <span class="string">'/public'</span>));</span><br></pre></td></tr></table></figure>
<h1 id="configure_lessMiddleware">configure lessMiddleware</h1><h2 id="options">options</h2><p>The following options can be used to control the behavior of the middleware:</p>
<p> <img src="http://7xnuw0.com1.z0.glb.clouddn.com/16-1-16/54670514.jpg" alt=""><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|Option |Description                 |Default|</span><br><span class="line">|<span class="comment">---|---|---|</span></span><br><span class="line">|debug  |<span class="operator"><span class="keyword">Show</span> more verbose <span class="keyword">logging</span>?	|<span class="literal">false</span>  |</span><br><span class="line">|dest	 |Destination <span class="keyword">directory</span> <span class="keyword">to</span> <span class="keyword">output</span> the <span class="keyword">compiled</span> .css files.	Same <span class="keyword">directory</span> <span class="keyword">as</span> <span class="keyword">less</span> <span class="keyword">source</span> files.<span class="keyword">force</span> <span class="keyword">Always</span> re-compile <span class="keyword">less</span> files <span class="keyword">on</span> <span class="keyword">each</span> request. |<span class="literal">false</span></span><br><span class="line">|once	|<span class="keyword">Only</span> recompile once <span class="keyword">after</span> <span class="keyword">each</span> <span class="keyword">server</span> restart. Useful <span class="keyword">for</span> reducing disk <span class="keyword">i</span>/o <span class="keyword">on</span> production.	|<span class="literal">false</span></span><br><span class="line">|pathRoot	|Common root <span class="keyword">of</span> the <span class="keyword">source</span> <span class="keyword">and</span> destination. It <span class="keyword">is</span> prepended <span class="keyword">to</span> <span class="keyword">both</span> the <span class="keyword">source</span> <span class="keyword">and</span> destination <span class="keyword">before</span> being used.	|<span class="literal">null</span></span><br><span class="line">|postprocess	|<span class="keyword">Object</span> containing functions relevant <span class="keyword">to</span> preprocessing <span class="keyword">data</span>.postprocess.css	<span class="keyword">Function</span> that modifies the <span class="keyword">compiled</span> css <span class="keyword">output</span> <span class="keyword">before</span> being <span class="keyword">stored</span>.	|<span class="keyword">function</span>(css, req)&#123;...&#125;</span><br><span class="line">|preprocess	|<span class="keyword">Object</span> containing functions relevant <span class="keyword">to</span> preprocessing <span class="keyword">data</span>.preprocess.<span class="keyword">less</span>	<span class="keyword">Function</span> that modifies the <span class="keyword">raw</span> <span class="keyword">less</span> <span class="keyword">output</span> <span class="keyword">before</span> being parsed <span class="keyword">and</span> <span class="keyword">compiled</span>.	|<span class="keyword">function</span>(src, req)&#123;...&#125;</span><br><span class="line">|preprocess.<span class="keyword">path</span>|	<span class="keyword">Function</span> that modifies the <span class="keyword">less</span> pathname <span class="keyword">before</span> being loaded <span class="keyword">from</span> the filesystem.	|<span class="keyword">function</span>(pathname, req)&#123;...&#125;</span><br><span class="line">|preprocess.importPaths |	<span class="keyword">Function</span> that modifies the <span class="keyword">import</span> paths used <span class="keyword">by</span> the <span class="keyword">less</span> parser per request.|<span class="keyword">function</span>(paths, req)&#123;...&#125;</span><br><span class="line">|render|	Options <span class="keyword">for</span> the <span class="keyword">less</span> render. See the “render Options” <span class="keyword">section</span> below.	|…</span><br><span class="line">|storeCss|	<span class="keyword">Function</span> that <span class="keyword">is</span> <span class="keyword">in</span> charge <span class="keyword">of</span> storing the css <span class="keyword">in</span> the filesystem.	|<span class="keyword">function</span>(pathname, css, req, <span class="keyword">next</span>)&#123;...&#125;</span><br><span class="line">|cacheFile	|<span class="keyword">Path</span> <span class="keyword">to</span> a <span class="keyword">JSON</span> <span class="keyword">file</span> that will be used <span class="keyword">to</span> <span class="keyword">cache</span> <span class="keyword">less</span> <span class="keyword">data</span> across <span class="keyword">server</span> restarts. This can greatly speed up <span class="keyword">initial</span> <span class="keyword">load</span> <span class="keyword">time</span> <span class="keyword">after</span> a <span class="keyword">server</span> restart - <span class="keyword">if</span> the <span class="keyword">less</span> files haven’<span class="keyword">t</span> <span class="keyword">changed</span> <span class="keyword">and</span> the css files still exist, specifying this <span class="keyword">option</span> will mean that the <span class="keyword">less</span> files don’<span class="keyword">t</span> need <span class="keyword">to</span> be recompiled <span class="keyword">after</span> a <span class="keyword">server</span> restart.|</span></span><br></pre></td></tr></table></figure></p>
<p>We’ll use the compress option in the compiler. We don’t want to compress in development mode, so we’ll  do the App.env !== ‘development` trick.</p>
<p>Note that if compress is set to true, then the dumpLineNumbers option is effectively ignored.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Configure less</span></span><br><span class="line"><span class="keyword">var</span> lessMiddleware = <span class="built_in">require</span>(<span class="string">'less-middleware'</span>)</span><br><span class="line">  , lessMiddlewareOptions = &#123;</span><br><span class="line">      dest: App.appPath(<span class="string">'/public'</span>)</span><br><span class="line">    , relativeUrls: <span class="literal">true</span></span><br><span class="line">    , force: App.env === <span class="string">'development'</span></span><br><span class="line">    , once: App.env !== <span class="string">'development'</span></span><br><span class="line">    , debug: App.env === <span class="string">'development'</span></span><br><span class="line">    , preprocess: &#123;</span><br><span class="line">        path: <span class="function"><span class="keyword">function</span>(<span class="params">pathname,req</span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(pathname)</span><br><span class="line">          <span class="keyword">return</span> pathname.replace(<span class="string">'/stylesheets'</span>, <span class="string">''</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  , lessParserOptions = &#123;</span><br><span class="line">      dumpLineNumbers: <span class="string">'mediaquery'</span></span><br><span class="line">    &#125;</span><br><span class="line">  , lessCompilerOptions = &#123;</span><br><span class="line">      compress: App.env !== <span class="string">'development'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">App.app.use(lessMiddleware(</span><br><span class="line">  App.appPath(<span class="string">'app/stylesheets'</span>)</span><br><span class="line">, lessMiddlewareOptions</span><br><span class="line">, lessParserOptions</span><br><span class="line">, lessCompilerOptions</span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>/app/stylesheets/dummy.less</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// example of nesting styles and a variable</span></span><br><span class="line"><span class="variable">@administrator-text-color:</span> <span class="hexcolor">#00B4FF</span>;</span><br><span class="line"></span><br><span class="line"><span class="class">.system_message</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="hexcolor">#EEE</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line"></span><br><span class="line">  <span class="tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="variable">@administrator-text-color</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/11/15/nodejs-note-10/" itemprop="url">
                  How to learn Node.js -- mongoose validation &unique records in mongodb
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-15T00:49:39+08:00" content="2015-11-15">
              2015-11-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/15/nodejs-note-10/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/15/nodejs-note-10/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Concepts:">Concepts:</h1><h2 id="Unique_value_in_mongodb:_Changing_the_email_type_to_an_object_with_type_rather_than_just_string">Unique value in mongodb: Changing the email type to an object with type rather than just string</h2><h3 id="example:">example:</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var s = <span class="keyword">new</span> Schema(&#123; <span class="string">name:</span> &#123; <span class="string">type:</span> String, <span class="string">unique:</span> <span class="literal">true</span> &#125;&#125;);</span><br><span class="line">Schema.path(<span class="string">'name'</span>).index(&#123; <span class="string">unique:</span> <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="validation">validation</h2><pre><code>SchemaType#<span class="function"><span class="title">validate</span><span class="params">(obj, [errorMsg], [type])</span></span>

Adds <span class="function"><span class="title">validator</span><span class="params">(s)</span></span> <span class="keyword">for</span> this document path.
</code></pre><h3 id="Parameters:">Parameters:</h3><pre><code>- obj &lt;<span class="built_in">RegExp</span>, <span class="built_in">Function</span>, <span class="built_in">Object</span>&gt; validator
- [errorMsg] &lt;<span class="built_in">String</span>&gt; optional error message
- [<span class="keyword">type</span>] &lt;<span class="built_in">String</span>&gt; optional validator <span class="keyword">type</span>
</code></pre><h3 id="Returns:">Returns:</h3><pre><code>&lt;SchemaType&gt; this
Validators always receive the value <span class="keyword">to</span> validate <span class="keyword">as</span> their first argument <span class="keyword">and</span> must <span class="keyword">return</span> <span class="built_in">Boolean</span>. Returning <span class="literal">false</span> means validation failed.

The <span class="keyword">error</span> message argument <span class="keyword">is</span> <span class="keyword">optional</span>. <span class="keyword">If</span> <span class="keyword">not</span> passed, the <span class="keyword">default</span> generic <span class="keyword">error</span> message template will be used.
</code></pre><h3 id="Examples:">Examples:</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// make sure every value is equal to "something"</span></span><br><span class="line">function validator (val) &#123;</span><br><span class="line">  <span class="keyword">return</span> val == <span class="string">'something'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> Schema(&#123; <span class="string">name:</span> &#123; <span class="string">type:</span> String, <span class="string">validate:</span> validator &#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// with a custom error message</span></span><br><span class="line"></span><br><span class="line">var custom = [validator, <span class="string">'Uh oh, &#123;PATH&#125; does not equal "something".'</span>]</span><br><span class="line"><span class="keyword">new</span> Schema(&#123; <span class="string">name:</span> &#123; <span class="string">type:</span> String, <span class="string">validate:</span> custom &#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// adding many validators at a time</span></span><br><span class="line"></span><br><span class="line">var many = [</span><br><span class="line">    &#123; <span class="string">validator:</span> validator, <span class="string">msg:</span> <span class="string">'uh oh'</span> &#125;</span><br><span class="line">  , &#123; <span class="string">validator:</span> anotherValidator, <span class="string">msg:</span> <span class="string">'failed'</span> &#125;</span><br><span class="line">]</span><br><span class="line"><span class="keyword">new</span> Schema(&#123; <span class="string">name:</span> &#123; <span class="string">type:</span> String, <span class="string">validate:</span> many &#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or utilizing SchemaType methods directly:</span></span><br><span class="line"></span><br><span class="line">var schema = <span class="keyword">new</span> Schema(&#123; <span class="string">name:</span> <span class="string">'string'</span> &#125;);</span><br><span class="line">schema.path(<span class="string">'name'</span>).validate(validator, <span class="string">'validation of `&#123;PATH&#125;` failed with value `&#123;VALUE&#125;`'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Error_message_templates:">Error message templates:</h3><pre><code>From the examples above, you may have noticed that error messages support baseic templating. There are a few other template keywords besides {PATH}<span class="instruction"> and </span>{VALUE} too.

Validation occurs<span class="function"> pre(</span>'save'<span class="function">)</span><span class="instruction"> or </span>whenever you manually<span class="instruction"> execute </span>document<span class="comment">#validate.</span>
</code></pre><p><strong> Mongoose model instances have an update function, in which you pass on object containing the properties you want the instance to be updated to. This update function on a model does not pass through the validation middleware. </strong></p>
<hr>
<h2 id="How_To_Safely_Store_A_Password">How To Safely Store A Password</h2><h3 id="Use_bcrypt">Use bcrypt</h3><blockquote>
<p>   Use bcrypt. Use bcrypt. Use bcrypt. Use bcrypt. Use bcrypt. Use bcrypt. Use bcrypt. Use bcrypt. Use bcrypt.</p>
</blockquote>
<h3 id="Why_Not_{MD5,_SHA1,_SHA256,_SHA512,_SHA-3,_etc}?">Why Not {MD5, SHA1, SHA256, SHA512, SHA-3, etc}?</h3><blockquote>
<p>  These are all general purpose hash functions, designed to calculate a digest of huge amounts of data in as short a time as possible. This means that they are fantastic for ensuring the integrity of data and utterly rubbish for storing passwords.</p>
<p>   A modern server can calculate the MD5 hash of about 330MB every second. If your users have passwords which are lowercase, alphanumeric, and 6 characters long, you can try every single possible password of that size in around 40 seconds.</p>
<p>  And that’s without investing anything.</p>
<p>  If you’re willing to spend about 2,000 USD and a week or two picking up CUDA, you can put together your own little supercomputer cluster which will let you try around 700,000,000 passwords a second. And that rate you’ll be cracking those passwords at the rate of more than one per second.</p>
</blockquote>
<h3 id="Salts_Will_Not_Help_You">Salts Will Not Help You</h3><blockquote>
<p>  It’s important to note that salts are useless for preventing dictionary attacks or brute force attacks. You can use huge salts or many salts or hand-harvested, shade-grown, organic Himalayan pink salt. It doesn’t affect how fast an attacker can try a candidate password, given the hash and the salt from your database.</p>
</blockquote>
<pre><code>Salt <span class="operator">or</span> no, <span class="keyword">if</span> you’re <span class="keyword">using</span> <span class="operator">a</span> general-purpose hash <span class="function"><span class="keyword">function</span> <span class="title">designed</span> <span class="title">for</span> <span class="title">speed</span> <span class="title">you</span>’<span class="title">re</span> <span class="title">well</span> <span class="title">and</span> <span class="title">truly</span> <span class="title">effed</span>.</span>
</code></pre><h3 id="bcrypt_Solves_These_Problems">bcrypt Solves These Problems</h3><blockquote>
<p>   How? Basically, it’s slow as hell. It uses a variant of the Blowfish encryption algorithm’s keying schedule, and introduces a work factor, which allows you to determine how expensive the hash function will be. Because of this, bcrypt can keep up with Moore’s law. As computers get faster you can increase the work factor and the hash will get slower.</p>
<p>   How much slower is bcrypt than, say, MD5? Depends on the work factor. <strong> Using a work factor of 12, bcrypt hashes the password yaaa in about 0.3 seconds on my laptop. MD5, on the other hand, takes less than a microsecond.</strong></p>
</blockquote>
<ul>
<li>Quote form <a href="http://codahale.com/how-to-safely-store-a-password/" target="_blank" rel="external">How To Safely Store A Password</a> *</li>
</ul>
<h2 id="Rule_of_Three">Rule of Three</h2><p>As our sign_in and sign_up template is very similar,but we haven’t yet hit the Rule of 3 wall, so we’ll just do a copy/paste + bit of modification</p>
<blockquote>
<p>   Rule of three is a code refactoring rule of thumb to decide when a replicated piece of code should be replaced by a new procedure. It states that the code can be copied once, but that when the same code is used three times, it should be extracted into a new procedure. The rule was introduced by Martin Fowler in Refactoring[1] and attributed to Don Roberts.</p>
<p>   Duplication in programming is a bad practice because it makes the code harder to maintain. However, code refactoring to eliminate duplication also takes time, which might be better spent on other tasks. Triplication has an even higher cost because it makes maintenance harder yet. When the rule encoded in a replicated piece of code changes, whoever maintains the code will have to change it in all places correctly. This process is error-prone and often leads to problems. If the code exists in only one place, then it can be easily changed there. The rule proposes that the cost of maintenance certainly outweighs the cost of refactoring when there are three copies, and may or may not if there are two copies.</p>
<p>   This rule is typically only applied to a small number of lines of code, or even single lines of code[citation needed]. For example, if a program calls a function, and then calls it again when it fails, it is acceptable to have two call sites; however, if it is to be called five times before giving up, all of the calls should be replaced with loop containing a single call.</p>
<p>   As Charles Petzold puts it, “Three or more? Use a for!”</p>
</blockquote>
<h1 id="code_of_sign_in_and_sign_up">code of sign_in and sign_up</h1><p>user.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line">,   validate = <span class="built_in">require</span>(<span class="string">'mongoose-validate'</span>)</span><br><span class="line">,	bcrypt	 = <span class="built_in">require</span>(<span class="string">'bcrypt'</span>)</span><br><span class="line">,	SALT_WORK_FACTOR = <span class="number">10</span> </span><br><span class="line">,	REQUIRED_PASSWORD_LENGTH = <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateStringLength</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> value &amp;&amp; value.length &gt;= REQUIRED_PASSWORD_LENGTH</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dummyEmailValidator</span>(<span class="params">candidate</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span>  <span class="regexp">/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/</span>.test(candidate);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> schema = mongoose.Schema(&#123;</span><br><span class="line">	email:&#123;type: <span class="built_in">String</span>, required: <span class="literal">true</span>, unique: <span class="literal">true</span>, validate: [dummyEmailValidator,<span class="string">'is not a valid email address'</span>]&#125;</span><br><span class="line">   ,passwordHash:&#123;type: <span class="built_in">String</span>, required: <span class="literal">true</span>, validate: [validateStringLength,<span class="string">'is too short !(minimum is'</span> + REQUIRED_PASSWORD_LENGTH +<span class="string">'character'</span>]&#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">schema.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">next</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!self.isModified(<span class="string">'passwordHash'</span>))<span class="keyword">return</span> next() </span><br><span class="line"></span><br><span class="line">	bcrypt.hash(self.passwordHash, SALT_WORK_FACTOR, <span class="function"><span class="keyword">function</span>(<span class="params">err,hash</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err) <span class="keyword">return</span> next(err)</span><br><span class="line"></span><br><span class="line">		self.passwordHash = hash;</span><br><span class="line"></span><br><span class="line">		next()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">schema.statics.findByEmailAndPassword = <span class="function"><span class="keyword">function</span> <span class="title">findByEmailAndPassword</span>(<span class="params">email, password,cb</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.findOne(&#123;email: email&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err,user</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err)</span><br><span class="line">		<span class="keyword">if</span> (!user) <span class="keyword">return</span> cb()</span><br><span class="line"></span><br><span class="line">			bcrypt.compare(password, user.passwordHash,<span class="function"><span class="keyword">function</span>(<span class="params">err,res</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> cb(err,res ? user:<span class="literal">null</span>)</span><br><span class="line">			&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// auto disable autoIndex mode in production environment</span></span><br><span class="line"></span><br><span class="line">schema.set(<span class="string">'autoIndex'</span>, App.env !== <span class="string">'production'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Model = mongoose.model(<span class="string">'User'</span>, schema)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Model</span><br></pre></td></tr></table></figure>
<p>userRoutes.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> User = App.model(<span class="string">'user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newUser</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> data = &#123;title:<span class="string">'Join the adventure!'</span>&#125;</span><br><span class="line">	</span><br><span class="line">	res.render(<span class="string">'users/new'</span>,data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> u = <span class="keyword">new</span> User(&#123;email:req.body.email, passwordHash:req.body.password&#125;); </span><br><span class="line"></span><br><span class="line">	 <span class="built_in">console</span>.log(req.body.email);</span><br><span class="line">	 <span class="built_in">console</span>.log(req.body.password);</span><br><span class="line"></span><br><span class="line">	u.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(err);</span><br><span class="line">			res.status(<span class="number">422</span>).send(<span class="string">'Problem:'</span> + err.message);</span><br><span class="line">		</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">			res.status(<span class="number">200</span>).send(<span class="string">'welcome to the game'</span>);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exports.new     = newUser</span><br><span class="line">exports.create  = create</span><br></pre></td></tr></table></figure>
<p>sessionRoutes.js</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">newSession</span>(<span class="title">req</span>,<span class="title">res</span>)&#123;</span></span><br><span class="line">	data =&#123;title:<span class="string">'welcome back!'</span>&#125;</span><br><span class="line">	res.render(<span class="string">'sessions/new'</span>) </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var User = App.model(<span class="string">'user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="title">req</span>,<span class="title">res</span>)&#123;</span></span><br><span class="line">	User.findByEmailAndPassword(req.body.email,req.body.password,<span class="function"><span class="keyword">function</span>(<span class="title">err</span>,<span class="title">user</span>)&#123;</span></span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			res.status(<span class="number">422</span>).<span class="built_in">send</span>(<span class="string">'problem'</span>,err.message)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(!user)&#123;</span><br><span class="line">			res.status(<span class="number">401</span>).<span class="built_in">send</span>(<span class="string">'That email &amp; password did not match our records'</span>)</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			res.status(<span class="number">200</span>).<span class="built_in">send</span>(<span class="string">'Welcome back  !!! '</span>+ user.email )</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exports.<span class="built_in">new</span>    = newSession</span><br><span class="line">exports.<span class="built_in">create</span> = <span class="built_in">create</span></span><br></pre></td></tr></table></figure>
<p>update our routes.js file </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">var</span> express       =  <span class="function"><span class="title">require</span><span class="params">(<span class="string">"express"</span>)</span></span></span><br><span class="line"><span class="tag">var</span> indexRouter   =  express.<span class="function"><span class="title">Router</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="tag">var</span> homeRoutes    =  App.<span class="function"><span class="title">routes</span><span class="params">(<span class="string">'homeRoutes'</span>)</span></span>	</span><br><span class="line">indexRouter.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'/'</span>, homeRoutes.home)</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">var</span> adventuresRoutes = App.<span class="function"><span class="title">routes</span><span class="params">(<span class="string">'adventruesRoutes'</span>)</span></span></span><br><span class="line"></span><br><span class="line">indexRouter.<span class="function"><span class="title">route</span><span class="params">(<span class="string">'/adventures'</span>)</span></span></span><br><span class="line">	.<span class="function"><span class="title">get</span><span class="params">(adventuresRoutes.index)</span></span></span><br><span class="line">	.<span class="function"><span class="title">post</span><span class="params">(adventuresRoutes.create)</span></span></span><br><span class="line">	.<span class="function"><span class="title">put</span><span class="params">(adventuresRoutes.update)</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">var</span> lootRoutes = App.<span class="function"><span class="title">routes</span><span class="params">(<span class="string">'lootRoutes'</span>)</span></span></span><br><span class="line">indexRouter.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'/loot'</span>, lootRoutes.index)</span></span></span><br><span class="line">indexRouter.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'/loot/:id'</span>, lootRoutes.show)</span></span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="tag">var</span> userRoutes = App.<span class="function"><span class="title">routes</span><span class="params">(<span class="string">'userRoutes'</span>)</span></span></span><br><span class="line">indexRouter.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'/sign_up'</span>, userRoutes.new)</span></span></span><br><span class="line">indexRouter.<span class="function"><span class="title">post</span><span class="params">(<span class="string">'/sign_up'</span>, userRoutes.create)</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// session routes</span></span><br><span class="line"><span class="tag">var</span> sessionRoutes = App.<span class="function"><span class="title">routes</span><span class="params">(<span class="string">'sessionRoutes'</span>)</span></span></span><br><span class="line"></span><br><span class="line">indexRouter.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'/sign_in'</span>, sessionRoutes.new)</span></span></span><br><span class="line">indexRouter.<span class="function"><span class="title">post</span><span class="params">(<span class="string">'/sign_in'</span>, sessionRoutes.create)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">module<span class="class">.exports</span> = indexRouter</span><br></pre></td></tr></table></figure>
<p>sign_up templates<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span> join the web's premiere adventure venue<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"/sign_up"</span><span class="value">,</span> <span class="attribute">method</span>=<span class="value">"post"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">label</span> <span class="attribute">class</span>=<span class="value">"form-group"</span>&gt;</span>Email<span class="tag">&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"email"</span><span class="value">,</span> <span class="attribute">name</span>=<span class="value">"email"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">label</span> <span class="attribute">class</span>=<span class="value">"form-group"</span>&gt;</span>Password<span class="tag">&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"password"</span> <span class="attribute">name</span>=<span class="value">"password"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> <span class="attribute">type</span>=<span class="value">"submit"</span>&gt;</span>Start your adventure!<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>sign_in templates</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span> Welcome back. login to the web again! <span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"/sign_in"</span><span class="value">,</span> <span class="attribute">method</span>=<span class="value">"post"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">label</span> <span class="attribute">class</span>=<span class="value">"form-group"</span>&gt;</span>Email<span class="tag">&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"email"</span><span class="value">,</span> <span class="attribute">name</span>=<span class="value">"email"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">label</span> <span class="attribute">class</span>=<span class="value">"form-group"</span>&gt;</span>Password<span class="tag">&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"password"</span> <span class="attribute">name</span>=<span class="value">"password"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> <span class="attribute">type</span>=<span class="value">"submit"</span>&gt;</span>Contintue your adventure!<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/11/13/nodejs-note-09/" itemprop="url">
                  How to learn Node.js - Node working with Mongodb
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-13T14:44:51+08:00" content="2015-11-13">
              2015-11-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/13/nodejs-note-09/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/13/nodejs-note-09/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Installation_of_Mongodb">Installation of Mongodb</h1><p>install homebrew first</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">Lyn</span>-<span class="constant">Cheung</span>-<span class="constant">MBP</span><span class="symbol">:~</span> <span class="constant">Lyn</span><span class="variable">$ </span>ruby -e <span class="string">"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</span></span><br><span class="line"></span><br><span class="line"><span class="constant">Lyn</span>-<span class="constant">Cheung</span>-<span class="constant">MBP</span><span class="symbol">:~</span> <span class="constant">Lyn</span><span class="variable">$ </span>brew doctor</span><br><span class="line"></span><br><span class="line"><span class="constant">Lyn</span>-<span class="constant">Cheung</span>-<span class="constant">MBP</span><span class="symbol">:~</span> <span class="constant">Lyn</span><span class="variable">$ </span>brew update</span><br><span class="line"></span><br><span class="line"><span class="constant">Lyn</span>-<span class="constant">Cheung</span>-<span class="constant">MBP</span><span class="symbol">:~</span> <span class="constant">Lyn</span><span class="variable">$ </span>brew install mongodb</span><br></pre></td></tr></table></figure>
<h1 id="Start_mongodb_in_your_Src_folder">Start mongodb in your Src folder</h1><p>it will create db under ./data/db directory</p>
<p>or  using  mongod –dbpath  </p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Lyn-Cheung-MBP:<span class="keyword">node</span><span class="identifier"></span><span class="title">-08</span> Lyn$ mongod</span><br></pre></td></tr></table></figure>
<h1 id="Install_mongoose">Install  mongoose</h1><p> edit package.json add mongoose dependenices</p>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> &#123;</span><br><span class="line">  "<span class="attribute">name</span>": <span class="value"><span class="string">"node-mongodb"</span></span>,</span><br><span class="line">  "<span class="attribute">version</span>": <span class="value"><span class="string">"1.0.0"</span></span>,</span><br><span class="line">  "<span class="attribute">description</span>": <span class="value"><span class="string">"first express app"</span></span>,</span><br><span class="line">  "<span class="attribute">main</span>": <span class="value"><span class="string">"index.js"</span></span>,</span><br><span class="line">  "<span class="attribute">scripts</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">test</span>": <span class="value"><span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">author</span>": <span class="value"><span class="string">"lyn"</span></span>,</span><br><span class="line">  "<span class="attribute">license</span>": <span class="value"><span class="string">"MIT"</span></span>,</span><br><span class="line">  "<span class="attribute">dependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">method-override</span>": <span class="value"><span class="string">"2.3.5"</span></span>,</span><br><span class="line">    "<span class="attribute">express</span>": <span class="value"><span class="string">"^4.13.3"</span></span>,</span><br><span class="line">    "<span class="attribute">body-parser</span>":<span class="value"><span class="string">"1.14.1"</span></span>,</span><br><span class="line">    "<span class="attribute">cookie-session</span>":<span class="value"><span class="string">"2.0.0-alpha.1"</span></span>,</span><br><span class="line">    "<span class="attribute">cookie-parser</span>":<span class="value"><span class="string">"1.4.0"</span></span>,</span><br><span class="line">    "<span class="attribute">express-handlebars</span>":<span class="value"><span class="string">"2.0.1"</span></span>,</span><br><span class="line">    "<span class="attribute">mongoose</span>":<span class="value"><span class="string">"4.2.*"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Test_connection_with_Mongodb">Test connection with Mongodb</h1><p>create a test connection file : ./config/database.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span> (<span class="string">'mongoose'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">connectionString</span>)</span>&#123;</span><br><span class="line">	mongoose.connect(connectionString)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> db= mongoose.connection</span><br><span class="line">	db.on(<span class="string">'error'</span>, <span class="built_in">console</span>.error.bind(<span class="built_in">console</span>, <span class="string">'connection error'</span>))</span><br><span class="line">	db.once(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'Mongoose connected at:'</span>, connectionString)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = connect</span><br><span class="line"></span><br><span class="line">connect(<span class="string">'mongodb://localhost/nodemongodb_development'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">var</span> mongoose = <span class="built_in">require</span> (<span class="string">'mongoose'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">connectionString</span>)</span>&#123;</span><br><span class="line">	mongoose.connect(connectionString)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> db= mongoose.connection</span><br><span class="line">	db.on(<span class="string">'error'</span>, <span class="built_in">console</span>.error.bind(<span class="built_in">console</span>, <span class="string">'connection error'</span>))</span><br><span class="line">	db.once(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'Mongoose connected at:'</span>, connectionString)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> schema = mongoose.Schema(&#123;</span><br><span class="line">		name: <span class="built_in">String</span></span><br><span class="line">	   ,description: <span class="built_in">String</span>  </span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> Model = mongoose.model(<span class="string">'ItemTemplate'</span>, schema)</span><br><span class="line">	<span class="keyword">var</span> itemTemplate = <span class="keyword">new</span> Model(&#123;name: <span class="string">'Oger-slaying knife'</span>, description: <span class="string">'It\'s got +9 against orges!'</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	itemTemplate.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err) <span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">'error:'</span>, err.message)</span><br><span class="line"></span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'it saved:'</span>, ItemTemplate.name)	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		itemTemplate.name = <span class="string">'Ogre-slaying knife'</span></span><br><span class="line">		itemTemplate.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err) <span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">'problem saving:'</span> err.message)</span><br><span class="line"></span><br><span class="line">			getKnife()</span><br><span class="line"></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getknife</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		Model.find(&#123;name: <span class="string">'Orger-slaying knife'</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,records</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err) <span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">'Error retrieving knife'</span>, err.message)</span><br><span class="line"></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">'we got the'</span>, records[<span class="number">0</span>].name, <span class="string">'!'</span>)</span><br><span class="line"></span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = connect</span><br><span class="line"></span><br><span class="line">connect(<span class="string">'mongodb://localhost/nodemongodb_development'</span>)</span><br></pre></td></tr></table></figure>
<p>Run ‘node /config/database.js’  to save instance data to Mongodb</p>
<p>Now,let’s put the connection  function into our previous express app</p>
<p>Clean the database.js code first </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span> (<span class="string">'mongoose'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">connectionString</span>)</span>&#123;</span><br><span class="line">	mongoose.connect(connectionString)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> db = mongoose.connection</span><br><span class="line">	db.on(<span class="string">'error'</span>, <span class="built_in">console</span>.error.bind(<span class="built_in">console</span>, <span class="string">'connection error'</span>))</span><br><span class="line">	db.once(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'Mongoose connected at:'</span>, connectionString)</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = connect</span><br></pre></td></tr></table></figure>
<p>create a model file  named itemTemplate.js udner ./model direction</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> mongoose =<span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> schema =mongoose.Schema(&#123;</span><br><span class="line">	name: <span class="built_in">String</span></span><br><span class="line">	,description: <span class="built_in">String</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Model = mongoose.model(<span class="string">'itemTemplate'</span>, schema)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'model is loading'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = Model</span><br></pre></td></tr></table></figure>
<p>Quote our model folder path in application.js and bootstrap our DB </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> env         = process.env.NODE_ENV || <span class="string">'development'</span></span><br><span class="line"><span class="keyword">var</span> packageJson = <span class="keyword">require</span>(<span class="string">'../package.json'</span>)</span><br><span class="line"><span class="keyword">var</span> path        = <span class="keyword">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">var</span> express     = <span class="keyword">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">var</span> bodyParser     = <span class="keyword">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">var</span> methodOverride = <span class="keyword">require</span>(<span class="string">'method-override'</span>)</span><br><span class="line"><span class="keyword">var</span> cookieParser   = <span class="keyword">require</span>(<span class="string">'cookie-parser'</span>)</span><br><span class="line"><span class="keyword">var</span> cookieSession  = <span class="keyword">require</span>(<span class="string">'cookie-session'</span>) </span><br><span class="line"><span class="keyword">var</span> exphbs  	   = <span class="keyword">require</span>(<span class="string">'express-handlebars'</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">console.log(<span class="string">'loading App in '</span> + env + <span class="string">'node.'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span>.App = &#123;</span><br><span class="line"></span><br><span class="line">	app: express()</span><br><span class="line">,   port: process.env.PORT || <span class="number">3000</span></span><br><span class="line">,   version: packageJson.version</span><br><span class="line">,   root: path.join(__dirname, <span class="string">'..'</span>)</span><br><span class="line">,   appPath: <span class="function"><span class="keyword">function</span><span class="params">(path)</span></span>&#123;</span><br><span class="line">	  <span class="keyword">return</span> this.root + <span class="string">'/'</span> + path</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">,   <span class="keyword">require</span>: <span class="function"><span class="keyword">function</span><span class="params">(path)</span></span>&#123;</span><br><span class="line">	  <span class="keyword">return</span> <span class="keyword">require</span>(this.appPath(path))	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">,   env: env</span><br><span class="line"></span><br><span class="line">,  start: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!this.started)&#123;</span><br><span class="line"></span><br><span class="line">			this.started = <span class="keyword">true</span></span><br><span class="line">			this.app.listen(this.port)</span><br><span class="line">			console.log( <span class="string">"running App version"</span> + App.version + <span class="string">" on port:"</span> + App.port + <span class="string">" in "</span>  + App.env + <span class="string">" mode"</span> )</span><br><span class="line">		</span><br><span class="line">			&#125;</span><br><span class="line">	  	&#125;</span><br><span class="line">,	model: <span class="function"><span class="keyword">function</span><span class="params">(path)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> this.<span class="keyword">require</span>(<span class="string">"app/models/"</span> + path)</span><br><span class="line">	&#125;	</span><br><span class="line">,	routes: <span class="function"><span class="keyword">function</span><span class="params">(path)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> this.<span class="keyword">require</span>(<span class="string">"app/routes/"</span> + path)</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line">App.app.engine(<span class="string">'hbs'</span>, exphbs(&#123;extname:<span class="string">'hbs'</span>, defaultLayout:<span class="string">'main.hbs'</span>&#125;));</span><br><span class="line">App.app.set(<span class="string">'view engine'</span>, <span class="string">'hbs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// bootstrap the  DB</span></span><br><span class="line">App.<span class="keyword">require</span>(<span class="string">'config/database'</span>)(process.env.DATABASE_URL || <span class="string">'mongodb://localhost/nodemongodb_development'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//middlewares</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> indexRouter =  App.<span class="keyword">require</span>(<span class="string">"./config/routes.js"</span>)</span><br><span class="line">App.app.<span class="keyword">use</span>(bodyParser.urlencoded(&#123;     <span class="comment">// to support URL-encoded bodies</span></span><br><span class="line">	  extended: <span class="keyword">false</span></span><br><span class="line">	&#125;)); </span><br><span class="line">App.app.<span class="keyword">use</span>(methodOverride(<span class="string">'_method'</span>));</span><br><span class="line">App.app.<span class="keyword">use</span>(cookieParser())</span><br><span class="line">App.app.<span class="keyword">use</span>(cookieSession(&#123;secret: <span class="string">"it's a secret to  everybody"</span>, key:<span class="string">"session"</span>&#125;))</span><br><span class="line">App.app.<span class="keyword">use</span>(<span class="string">'/images'</span>, express.<span class="keyword">static</span>( App.appPath(<span class="string">'images'</span>)));</span><br><span class="line"></span><br><span class="line">App.app.<span class="keyword">use</span>(<span class="string">'/'</span>,indexRouter)</span><br></pre></td></tr></table></figure>
<p>edit our lootroutes.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ItemTemplate =App.model(<span class="string">'itemTemplate'</span>)</span><br><span class="line"></span><br><span class="line">exports.index = <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	ItemTemplate.find(&#123;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err, records</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err) <span class="keyword">return</span> res.status(<span class="number">422</span>).send(<span class="string">'problem laoding the records:'</span>, err.message)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'itemTemplate running'</span>);	</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">var</span> data = &#123;loots: records&#125; </span><br><span class="line">		<span class="built_in">console</span>.log(data);</span><br><span class="line">		res.render(<span class="string">'loot/index'</span>,data)</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">exports.show = <span class="function"><span class="keyword">function</span> <span class="title">showLoot</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> id   = req.params.id</span><br><span class="line"></span><br><span class="line">	ItemTemplate.findById(id, <span class="function"><span class="keyword">function</span>(<span class="params">err, loot</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(err) <span class="keyword">return</span> res.status(<span class="number">422</span>).send(<span class="string">'Problem loding the loot:'</span>, err.message)</span><br><span class="line">		<span class="keyword">if</span>(!loot) <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'could not find the loot'</span>)	</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'itemTemplate_find_by_id running'</span>);	</span><br><span class="line">		<span class="keyword">var</span> data = &#123;loot: loot&#125;</span><br><span class="line">		res.render(<span class="string">'loot/show'</span>,data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>add index.js for loot path </p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"> <span class="tag">&lt;<span class="title">h1</span>&gt;</span> Loot Table<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="title">table</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">thead</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="title">th</span>&gt;</span>Name<span class="tag">&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="title">th</span>&gt;</span>Description<span class="tag">&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="title">thead</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="title">tbody</span>&gt;</span></span><br><span class="line">			</span><span class="expression">&#123;&#123;<span class="begin-block">#<span class="keyword">each</span> loots</span>&#125;&#125;</span><span class="xml"></span><br><span class="line"> 			 <span class="tag">&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"> 			 <span class="tag">&lt;<span class="title">td</span>&gt;</span>	<span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"/loot/</span></span></span><span class="expression">&#123;&#123;<span class="variable">id</span>&#125;&#125;</span><span class="xml"><span class="tag"><span class="value">"</span>&gt;</span></span><span class="expression">&#123;&#123;<span class="variable">name</span>&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="title">a</span>&gt;</span> <span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"> 			 												</span><br><span class="line"> 			 <span class="tag">&lt;<span class="title">td</span>&gt;</span>	</span><span class="expression">&#123;&#123;<span class="variable">description</span>&#125;&#125;</span><span class="xml"> <span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">			</span><span class="expression">&#123;&#123;<span class="end-block">/<span class="keyword">each</span></span>&#125;&#125;</span><span class="xml"></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="title">tbody</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">table</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>update show.js  for loot path</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><br><span class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>Check out your loot details<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">h2</span>&gt;</span> </span><span class="expression">&#123;&#123;<span class="variable">loot.name</span>&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span> there is a line on this loot:" </span><span class="expression">&#123;&#123;<span class="variable">loot.description</span>&#125;&#125;</span><span class="xml"> "<span class="tag">&lt;/<span class="title">p</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span> Your loot id is: </span><span class="expression">&#123;&#123;<span class="variable">loot.id</span>&#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>We also need add loot index function into Express router function </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="stylus"><span class="tag">var</span> express       =  <span class="function"><span class="title">require</span><span class="params">(<span class="string">"express"</span>)</span></span></span><br><span class="line"><span class="tag">var</span> indexRouter   =  express.<span class="function"><span class="title">Router</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="tag">var</span> homeRoutes    =  App.<span class="function"><span class="title">routes</span><span class="params">(<span class="string">'homeRoutes'</span>)</span></span>	</span><br><span class="line">indexRouter.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'/'</span>, homeRoutes.home)</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">var</span> adventuresRoutes = App.<span class="function"><span class="title">routes</span><span class="params">(<span class="string">'adventruesRoutes'</span>)</span></span></span><br><span class="line"></span><br><span class="line">indexRouter.<span class="function"><span class="title">route</span><span class="params">(<span class="string">'/adventures'</span>)</span></span></span><br><span class="line">	.<span class="function"><span class="title">get</span><span class="params">(adventuresRoutes.index)</span></span></span><br><span class="line">	.<span class="function"><span class="title">post</span><span class="params">(adventuresRoutes.create)</span></span></span><br><span class="line">	.<span class="function"><span class="title">put</span><span class="params">(adventuresRoutes.update)</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">var</span> lootRoutes = App.<span class="function"><span class="title">routes</span><span class="params">(<span class="string">'lootRoutes'</span>)</span></span></span><br><span class="line">indexRouter.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'/loot'</span>, lootRoutes.index)</span></span></span><br><span class="line">indexRouter.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'/loot/:id'</span>, lootRoutes.show)</span></span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">module<span class="class">.exports</span> = indexRouter</span></span><br></pre></td></tr></table></figure>
<p>Here we go !</p>
<p>these code retrive  what we have in Mongodb collection and  show  loots on index page </p>
<p>on /loot/:id path we could catch Mongodb id from the link params and show all loot detail infomation!  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Lyn-Cheung-MBP:node-<span class="number">08</span> Lyn$ mongo nodemongodb_development</span><br><span class="line"></span><br><span class="line">MongoDB shell version: <span class="number">3.0</span><span class="number">.7</span></span><br><span class="line">connecting to: nodemongodb_development</span><br><span class="line">Welcome to the MongoDB shell.</span><br><span class="line">For interactive help, type <span class="string">"help"</span>.</span><br><span class="line">For more comprehensive documentation, see</span><br><span class="line">	http:<span class="comment">//docs.mongodb.org/</span></span><br><span class="line">Questions? Try the support group</span><br><span class="line">	http:<span class="comment">//groups.google.com/group/mongodb-user</span></span><br><span class="line">Server has startup warnings:</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">13</span>T14:<span class="number">40</span>:<span class="number">20.398</span>+<span class="number">0800</span> I CONTROL  [initandlisten]</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">13</span>T14:<span class="number">40</span>:<span class="number">20.398</span>+<span class="number">0800</span> I CONTROL  [initandlisten] ** WARNING: soft rlimits too low. Number of files is <span class="number">256</span>, should be at least <span class="number">1000</span></span><br><span class="line">&gt; db.itemtemplates.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5645acece25bb56b3cec4c10"</span>), <span class="string">"name"</span> : <span class="string">"Oger-slaying knife"</span>, <span class="string">"description"</span> : <span class="string">"It's got +9 against orges!"</span>, <span class="string">"__v"</span> : <span class="number">0</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5645ada7df30bb723cbd2f3e"</span>), <span class="string">"name"</span> : <span class="string">"Oger-slaying knife"</span>, <span class="string">"description"</span> : <span class="string">"It's got +9 against orges!"</span>, <span class="string">"__v"</span> : <span class="number">0</span> &#125;</span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/author.png" alt="Lyn's Blog" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Lyn's Blog</p>
        </div>
        <p class="site-description motion-element" itemprop="description">Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">50</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lyn's Blog</span>
</div>

<div class="powered-by">
  <a class="theme-link" href="http://hexo.io">Powered by Hexo
  </a>
</div>

<div class="theme-info">
  
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>

</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-lyn"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
