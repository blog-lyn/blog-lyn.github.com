<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />



  <meta name="description" content="Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes" />




  <meta name="keywords" content="Lyn's blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta property="og:type" content="website">
<meta property="og:title" content="Lyn's Blog">
<meta property="og:url" content="http://lyn.s76.org/page/4/index.html">
<meta property="og:site_name" content="Lyn's Blog">
<meta property="og:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lyn's Blog">
<meta name="twitter:description" content="Lyn&apos;s Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Lyn's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36568696-2', 'auto');
  ga('send', 'pageview');

</script>








  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lyn's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Node.js Angular.js Express.js HTML5 Mongodb Programing Notes</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/22/nodejs-note-24/" itemprop="url">
                  Building restfull API by using restify - 02
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-22T21:45:57+08:00" content="2016-02-22">
              2016-02-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/22/nodejs-note-24/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/22/nodejs-note-24/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</div><div class="line"><span class="keyword">var</span>  bunyan = <span class="built_in">require</span>(<span class="string">'bunyan'</span>); </div><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line">	<span class="attr">name</span>:<span class="string">"Toodoo API"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span>  server = restify.createServer(options);</div><div class="line"></div><div class="line"></div><div class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'middleware 1 here!'</span> );</div><div class="line">	next();</div><div class="line">	<span class="comment">// next(new Error('something awful happened!'));</span></div><div class="line"></div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'middleware 2 here!'</span> );</div><div class="line">	next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.on(<span class="string">'after'</span>, restify.auditLogger(&#123;</div><div class="line">	<span class="attr">log</span>: bunyan.createLogger(&#123;</div><div class="line">		<span class="attr">name</span>:<span class="string">'audit'</span>,</div><div class="line">		<span class="attr">stream</span>: process.stdout</div><div class="line">	&#125;)</div><div class="line">&#125;));</div><div class="line"></div><div class="line"><span class="comment">// server.on('after', function ()&#123;</span></div><div class="line"><span class="comment">//	console.log('after', arguments);</span></div><div class="line"><span class="comment">// &#125;);</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = server;</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'./routes'</span>);</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</div><div class="line"><span class="keyword">var</span>  bunyan = <span class="built_in">require</span>(<span class="string">'bunyan'</span>); </div><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line">	<span class="attr">name</span>:<span class="string">"Toodoo API"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span>  server = restify.createServer(options);</div><div class="line"></div><div class="line"></div><div class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'middleware 1 here!'</span>, req.body);</div><div class="line">	next();</div><div class="line">	<span class="comment">// next(new Error('something awful happened!'));</span></div><div class="line"></div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.use(restify.bodyParser(&#123;</div><div class="line">	<span class="attr">maxBodySize</span>: <span class="number">10</span>*<span class="number">1024</span></div><div class="line">&#125;));</div><div class="line"></div><div class="line">server.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'middleware 2 here!'</span>, req.body);</div><div class="line">	next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.on(<span class="string">'after'</span>, restify.auditLogger(&#123;</div><div class="line">	<span class="attr">log</span>: bunyan.createLogger(&#123;</div><div class="line">		<span class="attr">name</span>:<span class="string">'audit'</span>,</div><div class="line">		<span class="attr">stream</span>: process.stdout</div><div class="line">	&#125;)</div><div class="line">&#125;));</div><div class="line"></div><div class="line"><span class="comment">// server.on('after', function ()&#123;</span></div><div class="line"><span class="comment">//	console.log('after', arguments);</span></div><div class="line"><span class="comment">// &#125;);</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = server;</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'./routes'</span>);</div><div class="line"><span class="comment">// test with data</span></div><div class="line"><span class="comment">// curl -i -X PUT localhost:8080/lists/mylist --data '&#123;"hey":"there"&#125;' -H 'content-type: application/json'</span></div></pre></td></tr></table></figure>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">192</span>:<span class="number">02</span> Lyn$ node .</div><div class="line"> API server listening on &#123;<span class="string">"address"</span>:<span class="string">"::"</span>,<span class="string">"family"</span>:<span class="string">"IPv6"</span>,<span class="string">"port"</span>:<span class="number">8080</span>&#125;</div><div class="line">middleware <span class="number">1</span> here! undefined</div><div class="line">middleware <span class="number">2</span> here! &#123; hey: <span class="string">'there'</span> &#125;</div><div class="line">body : &#123; hey: <span class="string">'there'</span> &#125;</div><div class="line">&#123;<span class="string">"name"</span>:<span class="string">"audit"</span>,<span class="string">"hostname"</span>:<span class="string">"Lyn-Cheung-MBP.local"</span>,<span class="string">"pid"</span>:<span class="number">45195</span>,<span class="string">"audit"</span>:true,<span class="string">"level"</span>:<span class="number">30</span>,<span class="string">"remoteAddress"</span>:<span class="string">"::ffff:127.0.0.1"</span>,<span class="string">"remotePort"</span>:<span class="number">55210</span>,<span class="string">"req_id"</span>:<span class="string">"6185400f-ad38-4578-bec7-2b1618a6ccf6"</span>,<span class="string">"req"</span>:&#123;<span class="string">"query"</span>:<span class="string">""</span>,<span class="string">"method"</span>:<span class="string">"PUT"</span>,<span class="string">"url"</span>:<span class="string">"/lists/mylist"</span>,<span class="string">"headers"</span>:&#123;<span class="string">"host"</span>:<span class="string">"localhost:8080"</span>,<span class="string">"user-agent"</span>:<span class="string">"curl/7.43.0"</span>,<span class="string">"accept"</span>:<span class="string">"*/*"</span>,<span class="string">"content-type"</span>:<span class="string">"application/json"</span>,<span class="string">"content-length"</span>:<span class="string">"15"</span>&#125;,<span class="string">"httpVersion"</span>:<span class="string">"1.1"</span>,<span class="string">"trailers"</span>:&#123;&#125;,<span class="string">"version"</span>:<span class="string">"*"</span>,<span class="string">"timers"</span>:&#123;<span class="string">"handler-0"</span>:<span class="number">449</span>,<span class="string">"readBody"</span>:<span class="number">2179</span>,<span class="string">"parseBody"</span>:<span class="number">242</span>,<span class="string">"handler-1"</span>:<span class="number">1494</span>,<span class="string">"createList"</span>:<span class="number">4112</span>&#125;&#125;,<span class="string">"res"</span>:&#123;<span class="string">"statusCode"</span>:<span class="number">200</span>,<span class="string">"headers"</span>:&#123;<span class="string">"content-type"</span>:<span class="string">"application/json"</span>,<span class="string">"content-length"</span>:<span class="number">15</span>&#125;,<span class="string">"trailer"</span>:false&#125;,<span class="string">"latency"</span>:<span class="number">12</span>,<span class="string">"_audit"</span>:true,<span class="string">"msg"</span>:<span class="string">"handled: 200"</span>,<span class="string">"time"</span>:<span class="string">"2016-02-22T15:00:33.154Z"</span>,<span class="string">"v"</span>:<span class="number">0</span>&#125;</div></pre></td></tr></table></figure>
<p>create.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports= <span class="function"><span class="keyword">function</span> <span class="title">createList</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> body = req.body;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'body :'</span>,body);</div><div class="line">	res.send(&#123;<span class="attr">hey</span>:<span class="string">'there'</span>&#125;);</div><div class="line">	next();</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="validating_the_data">validating the data</h2><h3 id="Joi">Joi</h3><p>joi allows you to create <em>blueprints</em> or <em>schemas</em> for JavaScript objects (an object that stores information) to ensure <em>validation</em> of key information.</p>
<h4 id="Example">Example</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> schema = Joi.object().keys(&#123;</div><div class="line">    <span class="attr">username</span>: Joi.string().alphanum().min(<span class="number">3</span>).max(<span class="number">30</span>).required(),</div><div class="line">    <span class="attr">password</span>: Joi.string().regex(<span class="regexp">/^[a-zA-Z0-9]&#123;3,30&#125;$/</span>),</div><div class="line">    <span class="attr">access_token</span>: [Joi.string(), Joi.number()],</div><div class="line">    <span class="attr">birthyear</span>: Joi.number().integer().min(<span class="number">1900</span>).max(<span class="number">2013</span>),</div><div class="line">    <span class="attr">email</span>: Joi.string().email()</div><div class="line">&#125;).with(<span class="string">'username'</span>, <span class="string">'birthyear'</span>).without(<span class="string">'password'</span>, <span class="string">'access_token'</span>);</div><div class="line"></div><div class="line">Joi.validate(&#123; <span class="attr">username</span>: <span class="string">'abc'</span>, <span class="attr">birthyear</span>: <span class="number">1994</span> &#125;, schema, <span class="function"><span class="keyword">function</span> (<span class="params">err, value</span>) </span>&#123; &#125;);  <span class="comment">// err === null -&gt; valid</span></div></pre></td></tr></table></figure>
<p>The above schema defines the following constraints:</p>
<ul>
<li><code>username</code><ul>
<li>a required string</li>
<li>must contain only alphanumeric characters</li>
<li>at least 3 characters long but no more than 30</li>
<li>must be accompanied by <code>birthyear</code></li>
</ul>
</li>
<li><code>password</code><ul>
<li>an optional string</li>
<li>must satisfy the custom regex</li>
<li>cannot appear together with <code>access_token</code></li>
</ul>
</li>
<li><code>access_token</code><ul>
<li>an optional, unconstrained string or number</li>
</ul>
</li>
<li><code>birthyear</code><ul>
<li>an integer between 1900 and 2013</li>
</ul>
</li>
<li><code>email</code><ul>
<li>a valid email address string</li>
</ul>
</li>
</ul>
<h4 id="Usage">Usage</h4><p>Usage is a two steps process. First, a schema is constructed using the provided types and constraints:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> schema = &#123;</div><div class="line">    <span class="attr">a</span>: Joi.string()</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Note that <strong>joi</strong> schema objects are immutable which means every additional rule added (e.g. <code>.min(5)</code>) will return a<br>new schema object.</p>
<p>Then the value is validated against the schema:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Joi.validate(&#123; <span class="attr">a</span>: <span class="string">'a string'</span> &#125;, schema, <span class="function"><span class="keyword">function</span> (<span class="params">err, value</span>) </span>&#123; &#125;);</div></pre></td></tr></table></figure>
<p>If the value is valid, <code>null</code> is returned, otherwise an <code>Error</code> object.</p>
<p>The schema can be a plain JavaScript object where every key is assigned a <strong>joi</strong> type, or it can be a <strong>joi</strong> type directly:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> schema = Joi.string().min(<span class="number">10</span>);</div></pre></td></tr></table></figure>
<p>If the schema is a <strong>joi</strong> type, the <code>schema.validate(value, callback)</code> can be called directly on the type. When passing a non-type schema object,<br>the module converts it internally to an object() type equivalent to:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> schema = Joi.object().keys(&#123;</div><div class="line">    <span class="attr">a</span>: Joi.string()</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>When validating a schema:</p>
<ul>
<li>Keys are optional by default.</li>
<li>Strings are utf-8 encoded by default.</li>
<li>Rules are defined in an additive fashion and evaluated in order after whitelist and blacklist checks.</li>
</ul>
<p>npm install joi —save</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">var server = require(<span class="string">'./server'</span>);</div><div class="line">var <span class="built_in">resources</span> = require(<span class="string">'./resources'</span>);</div><div class="line">var validating =  require(<span class="string">'./middleware/validating'</span>);</div><div class="line">var schemas = require(<span class="string">'./schemas'</span>);</div><div class="line"></div><div class="line"><span class="comment">//	server.get(urlPattern, function(req, res)&#123;</span></div><div class="line"><span class="comment">//		res.send(obj);</span></div><div class="line"><span class="comment">//	&#125;);</span></div><div class="line"></div><div class="line">server.get(<span class="string">'/lists'</span>,<span class="built_in">resources</span>.lists.<span class="built_in">list</span>);</div><div class="line">server.put(<span class="string">'/lists/:list'</span>,validating(schemas.<span class="built_in">list</span>),<span class="built_in">resources</span>.lists.create);</div><div class="line">server.del(<span class="string">'/lists/:list'</span>,<span class="built_in">resources</span>.lists.del);</div><div class="line"></div><div class="line"><span class="comment">// Items</span></div><div class="line"></div><div class="line">server.get(<span class="string">'/lists/:list/items'</span>, <span class="built_in">resources</span>.<span class="built_in">items</span>.<span class="built_in">list</span>);</div><div class="line">server.post(<span class="string">'lists/:list/items'</span>,validating(schemas.item),<span class="built_in">resources</span>.<span class="built_in">items</span>.create);</div><div class="line">server.del(<span class="string">'/lists/:list/items/:item'</span>,<span class="built_in">resources</span>.<span class="built_in">items</span>.del);</div><div class="line">``` </div><div class="line">./middleware/validating.js</div></pre></td></tr></table></figure>
<p>var Joi = require(‘joi’);</p>
<p>module.exports =  function validating(schema){</p>
<pre><code><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(req,res,next)</span></span>{

    Joi.validate(req.body, schema,<span class="function"><span class="keyword">function</span><span class="params">(err, doc)</span></span>{
        <span class="keyword">if</span> (err){
            err.statusCode = <span class="number">400</span>;
            <span class="built_in">next</span>(err);
        }
        <span class="keyword">else</span>{
            req.body = doc;
            <span class="built_in">next</span>();
        }

    });

};
</code></pre><p>};<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/schmeas/i</span>ndex.js</div></pre></td></tr></table></figure></p>
<p>exports.list = require(‘./list’);<br>exports.item = require(‘./item’);<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">./schmeas/<span class="built_in">list</span>.js</div></pre></td></tr></table></figure></p>
<p>var Joi = require(‘joi’);</p>
<p>// npm doc joi</p>
<p>module.exports = Joi.object().required().keys({<br>    name: Joi.string().required(),<br>    description: Joi.string(),<br>    priority: Joi.number().integer().default(0)<br>});<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./schemas/<span class="built_in">item</span>.js</div></pre></td></tr></table></figure></p>
<p>var Joi = require(‘joi’);</p>
<p>// npm doc joi</p>
<p>module.exports = Joi.object().required().keys({<br>    label: Joi.string().required()<br>});<br>```</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/21/nodejs-note-23/" itemprop="url">
                  Building restfull API by using restify - 01
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-21T16:19:49+08:00" content="2016-02-21">
              2016-02-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/21/nodejs-note-23/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/21/nodejs-note-23/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Restify">Restify</h2><blockquote>
<p>   restify is a node.js module built specifically to enable you to build correct REST web services. It intentionally borrows heavily from express as that is more or less the de facto API for writing web applications on top of node.js.</p>
</blockquote>
<h3 id="Why_use_restify_and_not_express?">Why use restify and not express?</h3><blockquote>
<pre><code>Express' use case <span class="keyword">is</span> targeted <span class="keyword">at</span> browser applications <span class="keyword">and</span> <span class="keyword">contains</span> a lot <span class="keyword">of</span> functionality, such <span class="keyword">as</span> templating <span class="keyword">and</span> rendering, <span class="keyword">to</span> support <span class="keyword">that</span>. Restify <span class="keyword">does</span> <span class="keyword">not</span>.

Restify exists <span class="keyword">to</span> let you build <span class="string">"strict"</span> API services <span class="keyword">that</span> are maintanable <span class="keyword">and</span> observable. Restify comes <span class="keyword">with</span> automatic DTrace support <span class="keyword">for</span> all your handlers, <span class="keyword">if</span> you're <span class="property">running</span> <span class="function_start"><span class="keyword">on</span></span> a platform <span class="keyword">that</span> supports DTrace.
</code></pre></blockquote>
<h2 id="creating_server">creating server</h2><p>server.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line">	<span class="attr">name</span>:<span class="string">"Toodoo API"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span>  server = restify.createServer(options);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = server;</div></pre></td></tr></table></figure>
<p>index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  server =<span class="built_in">require</span>(<span class="string">'./server'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span>  port = <span class="built_in">Number</span>(process.env.SERVER_PORT) || <span class="number">8080</span>;</div><div class="line"></div><div class="line">server.listen(port, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">' API server listening on %j'</span>, server.address());</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="Routes">Routes</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">// Print  direction structure</div><div class="line">192:01 Lyn$ find . -print |<span class="string"> sed -e 's;[^/]*/;</span>|<span class="string">____;g;s;____</span>|<span class="string">; </span>|<span class="string">;g'</span></div><div class="line">.</div><div class="line">|<span class="string">____index.js</span></div><div class="line">|____node_modules</div><div class="line">|<span class="string"> </span></div><div class="line">|<span class="string">____package.json</span></div><div class="line">|____resources</div><div class="line">|<span class="string"> </span>|<span class="string">____index.js</span></div><div class="line">|<span class="string"> </span>|____items</div><div class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____create.js</span></div><div class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____del.js</span></div><div class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____index.js</span></div><div class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____list.js</span></div><div class="line">|<span class="string"> </span>|____lists</div><div class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____create.js</span></div><div class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____del.js</span></div><div class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____index.js</span></div><div class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string">____list.js</span></div><div class="line">|<span class="string">____routes.js</span></div><div class="line">|<span class="string">____server.js</span></div></pre></td></tr></table></figure>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">var server = require(<span class="string">'./server'</span>);</div><div class="line">var <span class="built_in">resources</span> = require(<span class="string">'./resources'</span>)</div><div class="line"></div><div class="line"><span class="comment">//lists</span></div><div class="line"></div><div class="line"><span class="comment">//	server.get(urlPattern, function(req, res)&#123;</span></div><div class="line"><span class="comment">//		res.send(obj);</span></div><div class="line"><span class="comment">//	&#125;);</span></div><div class="line"></div><div class="line">server.get(<span class="string">'/lists'</span>,<span class="built_in">resources</span>.lists.<span class="built_in">list</span>);</div><div class="line">server.put(<span class="string">'/lists/:list'</span>,<span class="built_in">resources</span>.lists.create);</div><div class="line">server.del(<span class="string">'/lists/:list'</span>,<span class="built_in">resources</span>.lists.del);</div><div class="line"></div><div class="line"><span class="comment">// Items</span></div><div class="line"></div><div class="line">server.get(<span class="string">'/lists/:list/items'</span>, <span class="built_in">resources</span>.<span class="built_in">items</span>.<span class="built_in">list</span>);</div><div class="line">server.post(<span class="string">'lists/:list/items'</span>,<span class="built_in">resources</span>.<span class="built_in">items</span>.create);</div><div class="line">server.del(<span class="string">'/lists/:list/items/:item'</span>,<span class="built_in">resources</span>.<span class="built_in">items</span>.del);</div></pre></td></tr></table></figure>
<p>server.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line">	<span class="attr">name</span>:<span class="string">"Toodoo API"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span>  server = restify.createServer(options);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = server;</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'./routes'</span>);</div></pre></td></tr></table></figure>
<p>resources/index.js</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">exports.lists = <span class="built_in">require</span>(<span class="string">'./lists'</span>);</div><div class="line">exports.items = <span class="built_in">require</span>(<span class="string">'./items'</span>);</div></pre></td></tr></table></figure>
<p>resources/lists/index.js</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">exports.<span class="built_in">list</span> = <span class="keyword">require</span>(<span class="string">'./list'</span>);</div><div class="line">exports.create = <span class="keyword">require</span>(<span class="string">'./create'</span>);</div><div class="line">exports.del =<span class="keyword">require</span>(<span class="string">'./del'</span>);</div></pre></td></tr></table></figure>
<p>resources/lists/list.js<br>resources/lists/del.js<br>resources/lists/create.js</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports= <span class="function"><span class="keyword">function</span> <span class="title">createItem</span><span class="params">(req,res,next)</span></span>&#123;</div><div class="line">	res.send(<span class="number">202</span>,&#123;hey:<span class="string">'there'</span>&#125;);</div><div class="line">	<span class="built_in">next</span>();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp -R resources<span class="regexp">/lists/</span>* resources<span class="regexp">/items/</span></div></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="number">192</span>:~ Lyn$ curl -I <span class="string">localhost:</span><span class="number">8080</span></div><div class="line">HTTP/<span class="number">1.1</span> <span class="number">404</span> Not Found</div><div class="line">Content-<span class="string">Type:</span> application/json</div><div class="line">Content-<span class="string">Length:</span> <span class="number">56</span></div><div class="line"><span class="string">Date:</span> Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">46</span> GMT</div><div class="line"><span class="string">Connection:</span> keep-alive</div><div class="line"><span class="symbol"></span></div><div class="line">192:~ Lyn$ curl -i <span class="string">localhost:</span><span class="number">8080</span>/lists</div><div class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">Content-<span class="string">Type:</span> application/json</div><div class="line">Content-<span class="string">Length:</span> <span class="number">15</span></div><div class="line"><span class="string">Date:</span> Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">40</span>:<span class="number">03</span> GMT</div><div class="line"><span class="string">Connection:</span> keep-alive</div><div class="line"></div><div class="line">&#123;<span class="string">"hey"</span>:<span class="string">"there"</span>&#125;</div><div class="line"><span class="number">192</span>:~ Lyn$</div><div class="line"><span class="symbol"> </span></div><div class="line">192:~ Lyn$ curl -X PUT -i <span class="string">localhost:</span><span class="number">8080</span><span class="regexp">/lists/</span>mylist</div><div class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">Content-<span class="string">Type:</span> application/json</div><div class="line">Content-<span class="string">Length:</span> <span class="number">15</span></div><div class="line"><span class="string">Date:</span> Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">41</span>:<span class="number">28</span> GMT</div><div class="line"><span class="string">Connection:</span> keep-alive</div><div class="line"></div><div class="line">&#123;<span class="string">"hey"</span>:<span class="string">"there"</span>&#125;</div><div class="line"><span class="symbol"></span></div><div class="line">192:~ Lyn$</div><div class="line"><span class="number">192</span>:~ Lyn$ curl  -i <span class="string">localhost:</span><span class="number">8080</span><span class="regexp">/lists/</span>mylist/items</div><div class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">Content-<span class="string">Type:</span> application/json</div><div class="line">Content-<span class="string">Length:</span> <span class="number">15</span></div><div class="line"><span class="string">Date:</span> Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">45</span>:<span class="number">50</span> GMT</div><div class="line"><span class="string">Connection:</span> keep-alive</div><div class="line"></div><div class="line">&#123;<span class="string">"hey"</span>:<span class="string">"there"</span>&#125;</div><div class="line"><span class="symbol"></span></div><div class="line"> </div><div class="line">192:~ Lyn$ curl -X DELETE  -i <span class="string">localhost:</span><span class="number">8080</span><span class="regexp">/lists/</span>mylist<span class="regexp">/items/</span>itemid</div><div class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">Content-<span class="string">Type:</span> application/json</div><div class="line">Content-<span class="string">Length:</span> <span class="number">15</span></div><div class="line"><span class="string">Date:</span> Sun, <span class="number">21</span> Feb <span class="number">2016</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">03</span> GMT</div><div class="line"><span class="string">Connection:</span> keep-alive</div><div class="line"></div><div class="line">&#123;<span class="string">"hey"</span>:<span class="string">"there"</span>&#125;<span class="number">192</span>:~ Lyn$</div><div class="line"><span class="number">192</span>:~ Lyn$</div></pre></td></tr></table></figure>
<h2 id="Logging_requests">Logging requests</h2><h3 id="Bunyan">Bunyan</h3><blockquote>
<p>Bunyan is a simple and fast JSON logging library for node.js services<br>It is very powerfull tool which help you to logging specific info </p>
</blockquote>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">var <span class="built_in">log</span> = bunyan.createLogger(&#123;</div><div class="line">  name: <span class="string">'myapp'</span>,</div><div class="line">  streams: [</div><div class="line">    &#123;</div><div class="line">      level: <span class="string">'info'</span>,</div><div class="line">      stream: process.stdout            // <span class="built_in">log</span> INFO <span class="literal">and</span> above <span class="keyword">to</span> stdout</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      level: <span class="string">'error'</span>,</div><div class="line">      path: <span class="string">'/var/tmp/myapp-error.log'</span>  // <span class="built_in">log</span> ERROR <span class="literal">and</span> above <span class="keyword">to</span> a file</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;)<span class="comment">;</span></div></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="number">192</span>:<span class="number">01</span> Lyn$ npm install bunyan --save</div><div class="line"></div><div class="line">npm WARN <span class="keyword">package</span>.json <span class="symbol">api01@</span><span class="number">1.0</span><span class="number">.0</span> No repository field.</div><div class="line">npm WARN <span class="keyword">package</span>.json <span class="symbol">api01@</span><span class="number">1.0</span><span class="number">.0</span> No README <span class="keyword">data</span></div><div class="line"></div><div class="line">&gt; dtrace-<span class="symbol">provider@</span><span class="number">0.6</span><span class="number">.0</span> install /Users/Lyn/src/node/node-api/<span class="number">01</span>/node_modules/bunyan/node_modules/dtrace-provider</div><div class="line">&gt; node scripts/install.js</div><div class="line"></div><div class="line"><span class="symbol">bunyan@</span><span class="number">1.6</span><span class="number">.0</span> node_modules/bunyan</div><div class="line">├── safe-json-<span class="symbol">stringify@</span><span class="number">1.0</span><span class="number">.3</span></div><div class="line">├── <span class="symbol">moment@</span><span class="number">2.11</span><span class="number">.2</span></div><div class="line">├── dtrace-<span class="symbol">provider@</span><span class="number">0.6</span><span class="number">.0</span> (<span class="symbol">nan@</span><span class="number">2.2</span><span class="number">.0</span>)</div><div class="line">└── <span class="symbol">mv@</span><span class="number">2.1</span><span class="number">.1</span> (<span class="symbol">ncp@</span><span class="number">2.0</span><span class="number">.0</span>, <span class="symbol">mkdirp@</span><span class="number">0.5</span><span class="number">.1</span>, <span class="symbol">rimraf@</span><span class="number">2.4</span><span class="number">.5</span>)</div></pre></td></tr></table></figure>
<p>server.js<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span>  restify = <span class="keyword">require</span>(<span class="string">'restify'</span>);</div><div class="line"><span class="built_in">var</span>  bunyan = <span class="keyword">require</span>(<span class="string">'bunyan'</span>); </div><div class="line"><span class="built_in">var</span> options = &#123;</div><div class="line">	name:<span class="string">"Toodoo API"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">var</span>  server = restify.createServer(options);</div><div class="line"></div><div class="line"></div><div class="line">server.<span class="keyword">on</span>(<span class="string">'after'</span>, restify.auditLogger(&#123;</div><div class="line">	<span class="keyword">log</span>: bunyan.createLogger(&#123;</div><div class="line">		name:<span class="string">'audit'</span>,</div><div class="line">		stream: process.stdout</div><div class="line">	&#125;)</div><div class="line">&#125;));</div><div class="line"></div><div class="line"><span class="comment">// server.on('after', function ()&#123;</span></div><div class="line"><span class="comment">//	console.log('after', arguments);</span></div><div class="line"><span class="comment">// &#125;);</span></div><div class="line"></div><div class="line">module.exports = server;</div><div class="line"></div><div class="line"><span class="keyword">require</span>(<span class="string">'./routes'</span>);</div></pre></td></tr></table></figure></p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">192</span>:<span class="number">01</span> Lyn$ node index.js</div><div class="line"></div><div class="line">API server listening on &#123;<span class="string">"address"</span>:<span class="string">"::"</span>,<span class="string">"family"</span>:<span class="string">"IPv6"</span>,<span class="string">"port"</span>:<span class="number">8080</span>&#125;</div><div class="line"></div><div class="line">&#123;<span class="string">"name"</span>:<span class="string">"audit"</span>,<span class="string">"hostname"</span>:<span class="string">"Lyn-Cheung-MBP.local"</span>,<span class="string">"pid"</span>:<span class="number">44385</span>,<span class="string">"audit"</span>:true,<span class="string">"level"</span>:<span class="number">30</span>,<span class="string">"remoteAddress"</span>:<span class="string">"::ffff:127.0.0.1"</span>,<span class="string">"remotePort"</span>:<span class="number">56088</span>,<span class="string">"req_id"</span>:<span class="string">"a701a353-6b55-4aa0-8888-5d67518867fb"</span>,<span class="string">"req"</span>:&#123;<span class="string">"query"</span>:<span class="string">""</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">DELETE</span>"</span>,<span class="string">"url"</span>:<span class="string">"/lists/mylist/items/itemid"</span>,<span class="string">"headers"</span>:&#123;<span class="string">"host"</span>:<span class="string">"localhost:8080"</span>,<span class="string">"user-agent"</span>:<span class="string">"curl/7.43.0"</span>,<span class="string">"accept"</span>:<span class="string">"*/*"</span>&#125;,<span class="string">"httpVersion"</span>:<span class="string">"1.1"</span>,<span class="string">"trailers"</span>:&#123;&#125;,<span class="string">"version"</span>:<span class="string">"*"</span>,<span class="string">"timers"</span>:&#123;<span class="string">"delItem"</span>:<span class="number">4500</span>&#125;&#125;,<span class="string">"res"</span>:&#123;<span class="string">"statusCode"</span>:<span class="number">200</span>,<span class="string">"headers"</span>:&#123;<span class="string">"content-type"</span>:<span class="string">"application/json"</span>,<span class="string">"content-length"</span>:<span class="number">15</span>&#125;,<span class="string">"trailer"</span>:false&#125;,<span class="string">"latency"</span>:<span class="number">8</span>,<span class="string">"_audit"</span>:true,<span class="string">"msg"</span>:<span class="string">"handled: 200"</span>,<span class="string">"time"</span>:<span class="string">"2016-02-21T14:21:20.022Z"</span>,<span class="string">"v"</span>:<span class="number">0</span>&#125;</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/06/nodejs-note-21/" itemprop="url">
                  Asynchronous Programming - 08 async.queue
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-06T13:59:13+08:00" content="2016-02-06">
              2016-02-06
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/06/nodejs-note-21/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/06/nodejs-note-21/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Concepts:">Concepts:</h1><h2 id="queue(worker,_[concurrency])">queue(worker, [concurrency])</h2><p>Creates a <code>queue</code> object with the specified <code>concurrency</code>. Tasks added to the<br><code>queue</code> are processed in parallel (up to the <code>concurrency</code> limit). If all<br><code>worker</code>s are in progress, the task is queued until one becomes available.<br>Once a <code>worker</code> completes a <code>task</code>, that <code>task</code>‘s callback is called.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>worker(task, callback)</code> - An asynchronous function for processing a queued<br>task, which must call its <code>callback(err)</code> argument when finished, with an<br>optional <code>error</code> as an argument.  If you want to handle errors from an individual task, pass a callback to <code>q.push()</code>.</li>
<li><code>concurrency</code> - An <code>integer</code> for determining how many <code>worker</code> functions should be<br>run in parallel.  If omitted, the concurrency defaults to <code>1</code>.  If the concurrency is <code>0</code>, an error is thrown.</li>
</ul>
<p><strong>Queue objects</strong></p>
<p>The <code>queue</code> object returned by this function has the following properties and<br>methods:</p>
<ul>
<li><code>length()</code> - a function returning the number of items waiting to be processed.</li>
<li><code>started</code> - a function returning whether or not any items have been pushed and processed by the queue</li>
<li><code>running()</code> - a function returning the number of items currently being processed.</li>
<li><code>workersList()</code> - a function returning the array of items currently being processed.</li>
<li><code>idle()</code> - a function returning false if there are items waiting or being processed, or true if not.</li>
<li><code>concurrency</code> - an integer for determining how many <code>worker</code> functions should be<br>run in parallel. This property can be changed after a <code>queue</code> is created to<br>alter the concurrency on-the-fly.</li>
<li><code>push(task, [callback])</code> - add a new task to the <code>queue</code>. Calls <code>callback</code> once<br>the <code>worker</code> has finished processing the task. Instead of a single task, a <code>tasks</code> array<br>can be submitted. The respective callback is used for every task in the list.</li>
<li><code>unshift(task, [callback])</code> - add a new task to the front of the <code>queue</code>.</li>
<li><code>saturated</code> - a callback that is called when the <code>queue</code> length hits the <code>concurrency</code> limit,<br> and further tasks will be queued.</li>
<li><code>empty</code> - a callback that is called when the last item from the <code>queue</code> is given to a <code>worker</code>.</li>
<li><code>drain</code> - a callback that is called when the last item from the <code>queue</code> has returned from the <code>worker</code>.</li>
<li><code>paused</code> - a boolean for determining whether the queue is in a paused state</li>
<li><code>pause()</code> - a function that pauses the processing of tasks until <code>resume()</code> is called.</li>
<li><code>resume()</code> - a function that resumes the processing of queued tasks when the queue is paused.</li>
<li><code>kill()</code> - a function that removes the <code>drain</code> callback and empties remaining tasks from the queue forcing it to go idle.</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// create a queue object with concurrency 2</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> q = <span class="keyword">async</span>.queue(<span class="function"><span class="keyword">function</span> (<span class="params">task, callback</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'hello '</span> + task.name);</div><div class="line">    callback();</div><div class="line">&#125;, <span class="number">2</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// assign a callback</span></div><div class="line">q.drain = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'all items have been processed'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// add some items to the queue</span></div><div class="line"></div><div class="line">q.push(&#123;<span class="attr">name</span>: <span class="string">'foo'</span>&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'finished processing foo'</span>);</div><div class="line">&#125;);</div><div class="line">q.push(&#123;<span class="attr">name</span>: <span class="string">'bar'</span>&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'finished processing bar'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// add some items to the queue (batch-wise)</span></div><div class="line"></div><div class="line">q.push([&#123;<span class="attr">name</span>: <span class="string">'baz'</span>&#125;,&#123;<span class="attr">name</span>: <span class="string">'bay'</span>&#125;,&#123;<span class="attr">name</span>: <span class="string">'bax'</span>&#125;], <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'finished processing item'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// add some items to the front of the queue</span></div><div class="line"></div><div class="line">q.unshift(&#123;<span class="attr">name</span>: <span class="string">'bar'</span>&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'finished processing bar'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<hr>
<h2 id="priorityQueue(worker,_concurrency)">priorityQueue(worker, concurrency)</h2><p>The same as Queue only tasks are assigned a priority and completed in ascending priority order. There are two differences between <code>queue</code> and <code>priorityQueue</code> objects:</p>
<ul>
<li><code>push(task, priority, [callback])</code> - <code>priority</code> should be a number. If an array of<br><code>tasks</code> is given, all tasks will be assigned the same priority.</li>
<li>The <code>unshift</code> method was removed.</li>
</ul>
<hr>
<h2 id="Self-Invoking_Functions">Self-Invoking Functions</h2><pre><code>Function expressions can be made <span class="string">"self-invoking"</span>.

A self-invoking expression is invoked (started) automatically, <span class="keyword">without</span> being called.

Function expressions will execute automatically <span class="keyword">if</span> <span class="operator">the</span> expression is followed <span class="keyword">by</span> ().

You cannot self-invoke <span class="operator">a</span> <span class="function"><span class="keyword">function</span> <span class="title">declaration</span>.</span>

You have <span class="built_in">to</span> <span class="built_in">add</span> parentheses around <span class="operator">the</span> <span class="function"><span class="keyword">function</span> <span class="title">to</span> <span class="title">indicate</span> <span class="title">that</span> <span class="title">it</span> <span class="title">is</span> <span class="title">a</span> <span class="title">function</span> <span class="title">expression</span>:</span>
</code></pre><h3 id="Example:">Example:</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(function () &#123;</div><div class="line">    var x = <span class="string">"Hello!!"</span>;      // I will<span class="built_in"> invoke </span>myself</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<h1 id="apply_these_concepts_to_our_example:">apply these concepts to our example:</h1><h2 id="client-js">client.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  sendQueue = <span class="built_in">require</span>(<span class="string">'./queue'</span>);</div><div class="line"></div><div class="line"><span class="comment">//A self-invoking expression is invoked (started) automatically, without being called.</span></div><div class="line"><span class="comment">//Function expressions will execute automatically if the expression is followed by ().</span></div><div class="line"></div><div class="line">sendQueue.drain = drained;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i= <span class="number">1</span> ; i &lt; <span class="number">50</span>; i++)&#123;</div><div class="line">		(<span class="function"><span class="keyword">function</span>(<span class="params">i</span>)</span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">var</span> message = <span class="string">'message'</span> + i;</div><div class="line"></div><div class="line">		sendQueue.push(message, <span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(err)&#123;</div><div class="line">			<span class="built_in">console</span>.log(err);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span>&#123;</div><div class="line">			<span class="built_in">console</span>.log(<span class="string">'finish sending message %s. result: %s'</span>, message ,result);</div><div class="line">		&#125;</div><div class="line"> 	&#125;);</div><div class="line"> &#125;(i));</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">drained</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'Queue is drained, this function is excueted at end of this queue!'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="queue-js">queue.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="comment">// set default value 5</span></div><div class="line"><span class="keyword">var</span> maxParallel =  <span class="built_in">Number</span>(process.env.MAX_PARALLEL_SENDS) || <span class="number">5</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> queue= <span class="keyword">async</span>.queue(send, maxParallel);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = queue;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sending %s'</span>, message);</div><div class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomResult());</div><div class="line">	</div><div class="line"> &#125;    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomResult</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="running_results:">running results:</h2><p>change MAX_PARALLEL_SENDS as 10 :</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line">Lyn$ MAX_PARALLEL_SENDS=<span class="number">10</span> node client02.js</div><div class="line">sending message1</div><div class="line">sending message2</div><div class="line">sending message3</div><div class="line">sending message4</div><div class="line">sending message5</div><div class="line">sending message6</div><div class="line">sending message7</div><div class="line">sending message8</div><div class="line">sending message9</div><div class="line">sending message10</div><div class="line"><span class="keyword">finish</span> sending message message5. resul<span class="variable">t:</span> <span class="number">1964500988</span></div><div class="line">sending message11</div><div class="line"><span class="keyword">finish</span> sending message message11. resul<span class="variable">t:</span> <span class="number">2539043910</span></div><div class="line">sending message12</div><div class="line"><span class="keyword">finish</span> sending message message9. resul<span class="variable">t:</span> <span class="number">5102366274</span></div><div class="line">sending message13</div><div class="line"><span class="keyword">finish</span> sending message message1. resul<span class="variable">t:</span> <span class="number">2859386303</span></div><div class="line">sending message14</div><div class="line"><span class="keyword">finish</span> sending message message14. resul<span class="variable">t:</span> <span class="number">1262963870</span></div><div class="line">sending message15</div><div class="line"><span class="keyword">finish</span> sending message message10. resul<span class="variable">t:</span> <span class="number">5341776136</span></div><div class="line">sending message16</div><div class="line"><span class="keyword">finish</span> sending message message13. resul<span class="variable">t:</span> <span class="number">9353475617</span></div><div class="line">sending message17</div><div class="line"><span class="keyword">finish</span> sending message message2. resul<span class="variable">t:</span> <span class="number">229454392</span></div><div class="line">sending message18</div><div class="line"><span class="keyword">finish</span> sending message message8. resul<span class="variable">t:</span> <span class="number">204195834</span></div><div class="line">sending message19</div><div class="line"><span class="keyword">finish</span> sending message message7. resul<span class="variable">t:</span> <span class="number">5462231705</span></div><div class="line">sending message20</div><div class="line"><span class="keyword">finish</span> sending message message3. resul<span class="variable">t:</span> <span class="number">2648265475</span></div><div class="line">sending message21</div><div class="line"><span class="keyword">finish</span> sending message message17. resul<span class="variable">t:</span> <span class="number">1555040027</span></div><div class="line">sending message22</div><div class="line"><span class="keyword">finish</span> sending message message20. resul<span class="variable">t:</span> <span class="number">1378923130</span></div><div class="line">sending message23</div><div class="line"><span class="keyword">finish</span> sending message message16. resul<span class="variable">t:</span> <span class="number">567535762</span></div><div class="line">sending message24</div><div class="line"><span class="keyword">finish</span> sending message message12. resul<span class="variable">t:</span> <span class="number">3640659751</span></div><div class="line">sending message25</div><div class="line"><span class="keyword">finish</span> sending message message4. resul<span class="variable">t:</span> <span class="number">846371499</span></div><div class="line">sending message26</div><div class="line"><span class="keyword">finish</span> sending message message6. resul<span class="variable">t:</span> <span class="number">8943664734</span></div><div class="line">sending message27</div><div class="line"><span class="keyword">finish</span> sending message message19. resul<span class="variable">t:</span> <span class="number">5956872827</span></div><div class="line">sending message28</div><div class="line"><span class="keyword">finish</span> sending message message28. resul<span class="variable">t:</span> <span class="number">2633528902</span></div><div class="line">sending message29</div><div class="line"><span class="keyword">finish</span> sending message message25. resul<span class="variable">t:</span> <span class="number">6858472616</span></div><div class="line">sending message30</div><div class="line"><span class="keyword">finish</span> sending message message23. resul<span class="variable">t:</span> <span class="number">6577321235</span></div><div class="line">sending message31</div><div class="line"><span class="keyword">finish</span> sending message message31. resul<span class="variable">t:</span> <span class="number">4663092873</span></div><div class="line">sending message32</div><div class="line"><span class="keyword">finish</span> sending message message22. resul<span class="variable">t:</span> <span class="number">1162227960</span></div><div class="line">sending message33</div><div class="line"><span class="keyword">finish</span> sending message message18. resul<span class="variable">t:</span> <span class="number">482677198</span></div><div class="line">sending message34</div><div class="line"><span class="keyword">finish</span> sending message message15. resul<span class="variable">t:</span> <span class="number">7190919378</span></div><div class="line">sending message35</div><div class="line"><span class="keyword">finish</span> sending message message29. resul<span class="variable">t:</span> <span class="number">6405112494</span></div><div class="line">sending message36</div><div class="line"><span class="keyword">finish</span> sending message message30. resul<span class="variable">t:</span> <span class="number">9917983878</span></div><div class="line">sending message37</div><div class="line"><span class="keyword">finish</span> sending message message36. resul<span class="variable">t:</span> <span class="number">3782009345</span></div><div class="line">sending message38</div><div class="line"><span class="keyword">finish</span> sending message message26. resul<span class="variable">t:</span> <span class="number">1491269115</span></div><div class="line">sending message39</div><div class="line"><span class="keyword">finish</span> sending message message21. resul<span class="variable">t:</span> <span class="number">1522164435</span></div><div class="line">sending message40</div><div class="line"><span class="keyword">finish</span> sending message message27. resul<span class="variable">t:</span> <span class="number">1241898911</span></div><div class="line">sending message41</div><div class="line"><span class="keyword">finish</span> sending message message24. resul<span class="variable">t:</span> <span class="number">294576718</span></div><div class="line">sending message42</div><div class="line"><span class="keyword">finish</span> sending message message40. resul<span class="variable">t:</span> <span class="number">4806017791</span></div><div class="line">sending message43</div><div class="line"><span class="keyword">finish</span> sending message message32. resul<span class="variable">t:</span> <span class="number">573896444</span></div><div class="line">sending message44</div><div class="line"><span class="keyword">finish</span> sending message message42. resul<span class="variable">t:</span> <span class="number">3477258647</span></div><div class="line">sending message45</div><div class="line"><span class="keyword">finish</span> sending message message34. resul<span class="variable">t:</span> <span class="number">879555882</span></div><div class="line">sending message46</div><div class="line"><span class="keyword">finish</span> sending message message41. resul<span class="variable">t:</span> <span class="number">6116542278</span></div><div class="line">sending message47</div><div class="line"><span class="keyword">finish</span> sending message message39. resul<span class="variable">t:</span> <span class="number">147665396</span></div><div class="line">sending message48</div><div class="line"><span class="keyword">finish</span> sending message message46. resul<span class="variable">t:</span> <span class="number">1423920742</span></div><div class="line">sending message49</div><div class="line"><span class="keyword">finish</span> sending message message47. resul<span class="variable">t:</span> <span class="number">87184496</span></div><div class="line"><span class="keyword">finish</span> sending message message48. resul<span class="variable">t:</span> <span class="number">3536678084</span></div><div class="line"><span class="keyword">finish</span> sending message message33. resul<span class="variable">t:</span> <span class="number">2796673960</span></div><div class="line"><span class="keyword">finish</span> sending message message38. resul<span class="variable">t:</span> <span class="number">3577113223</span></div><div class="line"><span class="keyword">finish</span> sending message message43. resul<span class="variable">t:</span> <span class="number">7041824071</span></div><div class="line"><span class="keyword">finish</span> sending message message37. resul<span class="variable">t:</span> <span class="number">1977048416</span></div><div class="line"><span class="keyword">finish</span> sending message message35. resul<span class="variable">t:</span> <span class="number">2434279993</span></div><div class="line"><span class="keyword">finish</span> sending message message44. resul<span class="variable">t:</span> <span class="number">1471318043</span></div><div class="line"><span class="keyword">finish</span> sending message message49. resul<span class="variable">t:</span> <span class="number">1047097761</span></div><div class="line"><span class="keyword">finish</span> sending message message45. resul<span class="variable">t:</span> <span class="number">9316147507</span></div><div class="line">Queue <span class="keyword">is</span> drained, this <span class="function"><span class="keyword">function</span> <span class="title">is</span> <span class="title">excueted</span> <span class="title">at</span> <span class="title">end</span> <span class="title">of</span> <span class="title">this</span> <span class="title">queue</span>!</span></div></pre></td></tr></table></figure>
<p>change MAX_PARALLEL_SENDS value to 20 :</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line">Lyn$ MAX_PARALLEL_SENDS=<span class="number">20</span> node client02.js</div><div class="line">sending message1</div><div class="line">sending message2</div><div class="line">sending message3</div><div class="line">sending message4</div><div class="line">sending message5</div><div class="line">sending message6</div><div class="line">sending message7</div><div class="line">sending message8</div><div class="line">sending message9</div><div class="line">sending message10</div><div class="line">sending message11</div><div class="line">sending message12</div><div class="line">sending message13</div><div class="line">sending message14</div><div class="line">sending message15</div><div class="line">sending message16</div><div class="line">sending message17</div><div class="line">sending message18</div><div class="line">sending message19</div><div class="line">sending message20</div><div class="line"><span class="keyword">finish</span> sending message message15. resul<span class="variable">t:</span> <span class="number">737988750</span></div><div class="line">sending message21</div><div class="line"><span class="keyword">finish</span> sending message message8. resul<span class="variable">t:</span> <span class="number">8598609317</span></div><div class="line">sending message22</div><div class="line"><span class="keyword">finish</span> sending message message9. resul<span class="variable">t:</span> <span class="number">2646334483</span></div><div class="line">sending message23</div><div class="line"><span class="keyword">finish</span> sending message message19. resul<span class="variable">t:</span> <span class="number">9558195846</span></div><div class="line">sending message24</div><div class="line"><span class="keyword">finish</span> sending message message17. resul<span class="variable">t:</span> <span class="number">8144184104</span></div><div class="line">sending message25</div><div class="line"><span class="keyword">finish</span> sending message message14. resul<span class="variable">t:</span> <span class="number">4364975024</span></div><div class="line">sending message26</div><div class="line"><span class="keyword">finish</span> sending message message5. resul<span class="variable">t:</span> <span class="number">1724673530</span></div><div class="line">sending message27</div><div class="line"><span class="keyword">finish</span> sending message message1. resul<span class="variable">t:</span> <span class="number">4582815656</span></div><div class="line">sending message28</div><div class="line"><span class="keyword">finish</span> sending message message20. resul<span class="variable">t:</span> <span class="number">7956206179</span></div><div class="line">sending message29</div><div class="line"><span class="keyword">finish</span> sending message message10. resul<span class="variable">t:</span> <span class="number">9008091217</span></div><div class="line">sending message30</div><div class="line"><span class="keyword">finish</span> sending message message22. resul<span class="variable">t:</span> <span class="number">3582278867</span></div><div class="line">sending message31</div><div class="line"><span class="keyword">finish</span> sending message message6. resul<span class="variable">t:</span> <span class="number">4367040095</span></div><div class="line">sending message32</div><div class="line"><span class="keyword">finish</span> sending message message13. resul<span class="variable">t:</span> <span class="number">3988986646</span></div><div class="line">sending message33</div><div class="line"><span class="keyword">finish</span> sending message message28. resul<span class="variable">t:</span> <span class="number">6466557176</span></div><div class="line">sending message34</div><div class="line"><span class="keyword">finish</span> sending message message16. resul<span class="variable">t:</span> <span class="number">1716755733</span></div><div class="line">sending message35</div><div class="line"><span class="keyword">finish</span> sending message message29. resul<span class="variable">t:</span> <span class="number">4922675376</span></div><div class="line">sending message36</div><div class="line"><span class="keyword">finish</span> sending message message32. resul<span class="variable">t:</span> <span class="number">4885254576</span></div><div class="line">sending message37</div><div class="line"><span class="keyword">finish</span> sending message message3. resul<span class="variable">t:</span> <span class="number">1153001314</span></div><div class="line">sending message38</div><div class="line"><span class="keyword">finish</span> sending message message31. resul<span class="variable">t:</span> <span class="number">781061809</span></div><div class="line">sending message39</div><div class="line"><span class="keyword">finish</span> sending message message12. resul<span class="variable">t:</span> <span class="number">460623404</span></div><div class="line">sending message40</div><div class="line"><span class="keyword">finish</span> sending message message37. resul<span class="variable">t:</span> <span class="number">8715749820</span></div><div class="line">sending message41</div><div class="line"><span class="keyword">finish</span> sending message message11. resul<span class="variable">t:</span> <span class="number">4536053752</span></div><div class="line">sending message42</div><div class="line"><span class="keyword">finish</span> sending message message27. resul<span class="variable">t:</span> <span class="number">3200931774</span></div><div class="line">sending message43</div><div class="line"><span class="keyword">finish</span> sending message message33. resul<span class="variable">t:</span> <span class="number">250894566</span></div><div class="line">sending message44</div><div class="line"><span class="keyword">finish</span> sending message message42. resul<span class="variable">t:</span> <span class="number">4747473378</span></div><div class="line">sending message45</div><div class="line"><span class="keyword">finish</span> sending message message24. resul<span class="variable">t:</span> <span class="number">4962016146</span></div><div class="line">sending message46</div><div class="line"><span class="keyword">finish</span> sending message message26. resul<span class="variable">t:</span> <span class="number">1931993842</span></div><div class="line">sending message47</div><div class="line"><span class="keyword">finish</span> sending message message2. resul<span class="variable">t:</span> <span class="number">986454577</span></div><div class="line">sending message48</div><div class="line"><span class="keyword">finish</span> sending message message35. resul<span class="variable">t:</span> <span class="number">2301575674</span></div><div class="line">sending message49</div><div class="line"><span class="keyword">finish</span> sending message message7. resul<span class="variable">t:</span> <span class="number">5626737338</span></div><div class="line"><span class="keyword">finish</span> sending message message34. resul<span class="variable">t:</span> <span class="number">6771650929</span></div><div class="line"><span class="keyword">finish</span> sending message message23. resul<span class="variable">t:</span> <span class="number">8719486794</span></div><div class="line"><span class="keyword">finish</span> sending message message25. resul<span class="variable">t:</span> <span class="number">5572523672</span></div><div class="line"><span class="keyword">finish</span> sending message message18. resul<span class="variable">t:</span> <span class="number">5171451447</span></div><div class="line"><span class="keyword">finish</span> sending message message38. resul<span class="variable">t:</span> <span class="number">5175544791</span></div><div class="line"><span class="keyword">finish</span> sending message message40. resul<span class="variable">t:</span> <span class="number">8014775183</span></div><div class="line"><span class="keyword">finish</span> sending message message4. resul<span class="variable">t:</span> <span class="number">3714943323</span></div><div class="line"><span class="keyword">finish</span> sending message message30. resul<span class="variable">t:</span> <span class="number">2933020694</span></div><div class="line"><span class="keyword">finish</span> sending message message21. resul<span class="variable">t:</span> <span class="number">686769762</span></div><div class="line"><span class="keyword">finish</span> sending message message46. resul<span class="variable">t:</span> <span class="number">6016617582</span></div><div class="line"><span class="keyword">finish</span> sending message message39. resul<span class="variable">t:</span> <span class="number">4313526025</span></div><div class="line"><span class="keyword">finish</span> sending message message41. resul<span class="variable">t:</span> <span class="number">9950625901</span></div><div class="line"><span class="keyword">finish</span> sending message message36. resul<span class="variable">t:</span> <span class="number">6170342438</span></div><div class="line"><span class="keyword">finish</span> sending message message49. resul<span class="variable">t:</span> <span class="number">5550757215</span></div><div class="line"><span class="keyword">finish</span> sending message message43. resul<span class="variable">t:</span> <span class="number">4634869126</span></div><div class="line"><span class="keyword">finish</span> sending message message45. resul<span class="variable">t:</span> <span class="number">4358491804</span></div><div class="line"><span class="keyword">finish</span> sending message message48. resul<span class="variable">t:</span> <span class="number">9321907304</span></div><div class="line"><span class="keyword">finish</span> sending message message44. resul<span class="variable">t:</span> <span class="number">6880509853</span></div><div class="line"><span class="keyword">finish</span> sending message message47. resul<span class="variable">t:</span> <span class="number">6660414687</span></div><div class="line">Queue <span class="keyword">is</span> drained, this <span class="function"><span class="keyword">function</span> <span class="title">is</span> <span class="title">excueted</span> <span class="title">at</span> <span class="title">end</span> <span class="title">of</span> <span class="title">this</span> <span class="title">queue</span>!</span></div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/06/nodejs-note-22/" itemprop="url">
                  TCP programing
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-06T00:16:43+08:00" content="2016-02-06">
              2016-02-06
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/06/nodejs-note-22/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/06/nodejs-note-22/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>index.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  server = <span class="built_in">require</span>(<span class="string">'./server05'</span>);</div><div class="line"></div><div class="line">server.listen(<span class="number">8000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'TCP server listening on %j'</span>, server.address());</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p> var net = require(‘net’);</p>
<p> var server = net.createServer();</p>
<p> server.on(‘connection’, function(conn){</p>
<pre><code><span class="built_in">console</span>.log(<span class="string">'new connection'</span>);
conn.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="built_in">console</span>.log(<span class="string">'connection closed'</span>);
});

<span class="keyword">var</span> emit =conn.emit;
conn.emit = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>{
    <span class="built_in">console</span>.log(<span class="string">'connetion emitted  event type %s'</span>, event);
    emit.apply(conn, <span class="built_in">arguments</span>);
};
</code></pre><p> }); </p>
<p> module.exports = server ;<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line">server03.js</div></pre></td></tr></table></figure></p>
<p> var net = require(‘net’);</p>
<p> var server = net.createServer();</p>
<p> server.on(‘connection’, function(conn){</p>
<pre><code><span class="built_in">console</span>.log(<span class="string">'new connection'</span>);

conn.setEncoding(<span class="string">'utf8'</span>);

conn.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="built_in">console</span>.log(<span class="string">'connection closed'</span>);
});

conn.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">buf</span>)</span>{
    process.stdout.write(<span class="string">'data'</span> + buf);
});
</code></pre><p> }); </p>
<p> module.exports = server ;<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">server04</span><span class="selector-class">.js</span></div></pre></td></tr></table></figure></p>
<p> var net = require(‘net’);</p>
<p> var server = net.createServer();</p>
<p> server.on(‘connection’, function(conn){</p>
<pre><code>console.<span class="built_in">log</span>(<span class="string">'new connection'</span>);

conn.setEncoding(<span class="string">'utf8'</span>);

conn.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
    console.<span class="built_in">log</span>(<span class="string">'connection closed'</span>);
});

conn.<span class="keyword">on</span>(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span><span class="params">(buf)</span>{</span>
    process.stdout.<span class="keyword">write</span>(<span class="string">'User send message: '</span> + buf);
    conn.<span class="keyword">write</span>(<span class="string">'Server send message: '</span>+ buf);
    conn.<span class="keyword">write</span>(<span class="string">'Server capitalize your message:'</span> + buf.toUpperCase());
});
</code></pre><p> }); </p>
<p> module.exports = server ;</p>
<p> #through2</p>
 <figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">fs.createReadStream(<span class="string">'ex.txt'</span>)</div><div class="line"> .pipe(through2(<span class="function"><span class="keyword">function</span> <span class="params">(chunk, enc, callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; chunk.length; i++)</div><div class="line">     <span class="keyword">if</span> (chunk[i] == <span class="number">97</span>)</div><div class="line">       chunk[i] = <span class="number">122</span> <span class="comment">// swap 'a' for 'z'</span></div><div class="line"></div><div class="line">   <span class="keyword">this</span>.push(chunk)</div><div class="line"></div><div class="line">   <span class="keyword">callback</span>()</div><div class="line">  &#125;))</div><div class="line"> .pipe(fs.createWriteStream(<span class="string">'out.txt'</span>))</div></pre></td></tr></table></figure>
<p>Or object streams:</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> all = []</div><div class="line"></div><div class="line">fs.createReadStream(<span class="string">'data.csv'</span>)</div><div class="line">  .pipe(csv2())</div><div class="line">  .pipe(through2.obj(<span class="function"><span class="keyword">function</span> <span class="params">(chunk, enc, callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> data = &#123;</div><div class="line">        name    : chunk[<span class="number">0</span>]</div><div class="line">      , address : chunk[<span class="number">3</span>]</div><div class="line">      , phone   : chunk[<span class="number">10</span>]</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.push(data)</div><div class="line"></div><div class="line">    <span class="keyword">callback</span>()</div><div class="line">  &#125;))</div><div class="line">  .on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</div><div class="line">    all.push(data)</div><div class="line">  &#125;)</div><div class="line">  .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    doSomethingSpecial(all)</div><div class="line">  &#125;)</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server05</div></pre></td></tr></table></figure>
<p> var through = require(‘through2’);<br> var net = require(‘net’);</p>
<p> var server = net.createServer();</p>
<p> server.on(‘connection’, function(conn){</p>
<pre><code><span class="built_in">console</span>.log(<span class="string">'new connection'</span>);

conn.setEncoding(<span class="string">'utf8'</span>);

conn.once(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="built_in">console</span>.log(<span class="string">'connection closed'</span>);
});

<span class="keyword">var</span> upperCasing = through.obj(<span class="function"><span class="keyword">function</span>(<span class="params">str, enc, cb</span>)</span>{
    <span class="keyword">this</span>.push(str.toUpperCase());
    cb();
});

conn.pipe(upperCasing).pipe(conn);
<span class="comment">// conn.pipe(conn);</span>
</code></pre><p> }); </p>
<p> module.exports = server ;<br>```</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/05/nodejs-note-20/" itemprop="url">
                  Asynchronous Programming - 07 async.each .map .eachSeries .eachLimit .mapLimit
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-05T15:59:11+08:00" content="2016-02-05">
              2016-02-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/05/nodejs-note-20/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/05/nodejs-note-20/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="each(arr,_iterator,_[callback])">each(arr, iterator, [callback])</h3><p>Applies the function <code>iterator</code> to each item in <code>arr</code>, in parallel.<br>The <code>iterator</code> is called with an item from the list, and a callback for when it<br>has finished. If the <code>iterator</code> passes an error to its <code>callback</code>, the main<br><code>callback</code> (for the <code>each</code> function) is immediately called with the error.</p>
<p>Note, that since this function applies <code>iterator</code> to each item in parallel,<br>there is no guarantee that the iterator functions will complete in order.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>arr</code> - An array to iterate over.</li>
<li><code>iterator(item, callback)</code> - A function to apply to each item in <code>arr</code>.<br>The iterator is passed a <code>callback(err)</code> which must be called once it has<br>completed. If no error has occurred, the <code>callback</code> should be run without<br>arguments or with an explicit <code>null</code> argument.  The array index is not passed<br>to the iterator.  If you need the index, use forEachOf.</li>
<li><code>callback(err)</code> - <em>Optional</em> A callback which is called when all <code>iterator</code> functions<br>have finished, or an error occurs.</li>
</ul>
<p><strong>Examples</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// assuming openFiles is an array of file names and saveFile is a function</span></div><div class="line"><span class="comment">// to save the modified contents of that file:</span></div><div class="line"></div><div class="line"><span class="keyword">async</span>.each(openFiles, saveFile, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">    <span class="comment">// if any of the saves produced an error, err would equal that error</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// assuming openFiles is an array of file names</span></div><div class="line"></div><div class="line"><span class="keyword">async</span>.each(openFiles, <span class="function"><span class="keyword">function</span>(<span class="params">file, callback</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// Perform operation on file here.</span></div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Processing file '</span> + file);</div><div class="line"></div><div class="line">  <span class="keyword">if</span>( file.length &gt; <span class="number">32</span> ) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'This file name is too long'</span>);</div><div class="line">    callback(<span class="string">'File name too long'</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Do work to process file here</span></div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'File processed'</span>);</div><div class="line">    callback();</div><div class="line">  &#125;</div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">    <span class="comment">// if any of the file processing produced an error, err would equal that error</span></div><div class="line">    <span class="keyword">if</span>( err ) &#123;</div><div class="line">      <span class="comment">// One of the iterations produced an error.</span></div><div class="line">      <span class="comment">// All processing will now stop.</span></div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'A file failed to process'</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'All files have been processed successfully'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>Related</strong></p>
<ul>
<li>eachSeries(arr, iterator, [callback])</li>
<li>eachLimit(arr, limit, iterator, [callback])</li>
</ul>
<hr>
<h2 id="Asynchronous_iteration_using_async">Asynchronous iteration using async</h2><p>apply async.each to our example:</p>
<p>send_all.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = sendAll;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendAll</span>(<span class="params">messages,cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">async</span>.each(messages, send, cb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</div><div class="line">	<span class="comment">// echo start message </span></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sending message %s'</span>, message);</div><div class="line"></div><div class="line">	setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// echo finish message</span></div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'finish sending message: %s '</span>, message);</div><div class="line">		cb();</div><div class="line">	&#125;, randomTimeout());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>client.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  sendAll =<span class="built_in">require</span>(<span class="string">'./send_all'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,<span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span>];</div><div class="line"></div><div class="line">sendAll(messages, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.error(err);</div><div class="line">	&#125; <span class="keyword">else</span>&#123;</div><div class="line"></div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages send'</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Running result:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Lyn$ node client.js</div><div class="line">sending <span class="keyword">message</span> message1</div><div class="line">sending <span class="keyword">message</span> message2</div><div class="line">sending <span class="keyword">message</span> message3</div><div class="line">sending <span class="keyword">message</span> message4</div><div class="line">sending <span class="keyword">message</span> message5</div><div class="line">sending <span class="keyword">message</span> message6</div><div class="line">finish sending <span class="keyword">message</span>: message2</div><div class="line">finish sending <span class="keyword">message</span>: message6</div><div class="line">finish sending <span class="keyword">message</span>: message5</div><div class="line">finish sending <span class="keyword">message</span>: message1</div><div class="line">finish sending <span class="keyword">message</span>: message4</div><div class="line">finish sending <span class="keyword">message</span>: message3</div><div class="line">all messages send</div></pre></td></tr></table></figure>
<hr>
<h2 id="map(arr,_iterator,_[callback])">map(arr, iterator, [callback])</h2><p>Produces a new array of values by mapping each value in <code>arr</code> through<br>the <code>iterator</code> function. The <code>iterator</code> is called with an item from <code>arr</code> and a<br>callback for when it has finished processing. Each of these callback takes 2 arguments:<br>an <code>error</code>, and the transformed item from <code>arr</code>. If <code>iterator</code> passes an error to its<br>callback, the main <code>callback</code> (for the <code>map</code> function) is immediately called with the error.</p>
<p>Note, that since this function applies the <code>iterator</code> to each item in parallel,<br>there is no guarantee that the <code>iterator</code> functions will complete in order.<br>However, the results array will be in the same order as the original <code>arr</code>.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>arr</code> - An array to iterate over.</li>
<li><code>iterator(item, callback)</code> - A function to apply to each item in <code>arr</code>.<br>The iterator is passed a <code>callback(err, transformed)</code> which must be called once<br>it has completed with an error (which can be <code>null</code>) and a transformed item.</li>
<li><code>callback(err, results)</code> - <em>Optional</em> A callback which is called when all <code>iterator</code><br>functions have finished, or an error occurs. Results is an array of the<br>transformed items from the <code>arr</code>.</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span>.map([<span class="string">'file1'</span>,<span class="string">'file2'</span>,<span class="string">'file3'</span>], fs.stat, <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">    <span class="comment">// results is now an array of stats for each file</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>Related</strong></p>
<ul>
<li>mapSeries(arr, iterator, [callback])</li>
<li>mapLimit(arr, limit, iterator, [callback])</li>
</ul>
<h2 id="Mapping_in_parallel_by_using_async-map">Mapping in parallel by using async.map</h2><p>send_all03.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = sendAll;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendAll</span>(<span class="params">messages,cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">async</span>.map(messages, send, cb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sending message %s'</span>, message);</div><div class="line">	setTimeout(cb, randomTimeout(),<span class="literal">null</span>,randomResult());</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomResult</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>client03.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  sendAll =<span class="built_in">require</span>(<span class="string">'./send_all03'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,</div><div class="line">			   <span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span>];</div><div class="line"></div><div class="line">sendAll(messages, <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.error(err);</div><div class="line">	&#125; <span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages send,results: %s'</span>, results);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Running results:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Lyn$ node client03.js</div><div class="line">sending <span class="keyword">message</span> message1</div><div class="line">sending <span class="keyword">message</span> message2</div><div class="line">sending <span class="keyword">message</span> message3</div><div class="line">sending <span class="keyword">message</span> message4</div><div class="line">sending <span class="keyword">message</span> message5</div><div class="line">sending <span class="keyword">message</span> message6</div><div class="line">all messages send,results: <span class="number">2688018348</span>,<span class="number">9740347757</span>,<span class="number">1796786184</span>,<span class="number">9157391262</span>,<span class="number">9049146866</span>,<span class="number">9496613333</span></div></pre></td></tr></table></figure>
<hr>
<h2 id="eachSeries(arr,_iterator,_[callback])">eachSeries(arr, iterator, [callback])</h2><h2 id="iterating_in_series_by_using_Async-eachSeries_and_async-mapSeries">iterating in series by using Async.eachSeries and async.mapSeries</h2><p>if any error occur during the proccess, it will not excute the rest messages and return error.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = sendAll;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendAll</span>(<span class="params">messages,cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">async</span>.eachSeries(messages, send, cb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sending message %s'</span>, message);</div><div class="line">	setTimeout(finished, randomTimeout(),<span class="literal">null</span>,randomResult());</div><div class="line"> 	</div><div class="line"> 	<span class="function"><span class="keyword">function</span> <span class="title">finished</span>(<span class="params">err, result</span>)</span>&#123;</div><div class="line"> 		<span class="built_in">console</span>.log(<span class="string">'finished sending %s, result is:'</span>, message, result);</div><div class="line"> 		cb(err, result);</div><div class="line"> 	&#125;</div><div class="line"></div><div class="line"> &#125;    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomResult</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span>  sendAll =<span class="built_in">require</span>(<span class="string">'./send_all04'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,</div><div class="line">			   <span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span>];</div><div class="line"></div><div class="line">sendAll(messages, <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.error(err);</div><div class="line">	&#125; <span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages send,results: %s'</span>, results);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Lyn$ node client04.js</div><div class="line">sending message message1</div><div class="line">finished sending message1, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">7154820929</span></div><div class="line">sending message message2</div><div class="line">finished sending message2, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">3823260059</span></div><div class="line">sending message message3</div><div class="line">finished sending message3, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">3379720377</span></div><div class="line">sending message message4</div><div class="line">finished sending message4, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">7657029824</span></div><div class="line">sending message message5</div><div class="line">finished sending message5, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">8405372535</span></div><div class="line">sending message message6</div><div class="line">finished sending message6, <span class="literal">result</span> <span class="keyword">is</span>: <span class="number">5340888185</span></div><div class="line">all messages send,results: undefined</div></pre></td></tr></table></figure>
<p>if any error occur during the proccess, it will not excute the rest messages and return error.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = sendAll;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendAll</span>(<span class="params">messages,cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">async</span>.eachSeries(messages, send, cb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sending message %s'</span>, message);</div><div class="line">	setTimeout(finished, randomTimeout(), <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whoops!'</span>),randomResult());</div><div class="line"> 	</div><div class="line"> 	<span class="function"><span class="keyword">function</span> <span class="title">finished</span>(<span class="params">err, result</span>)</span>&#123;</div><div class="line"> 		<span class="built_in">console</span>.log(<span class="string">'finished sending %s, result is:'</span>, message, result);</div><div class="line"> 		cb(err, result);</div><div class="line"> 	&#125;</div><div class="line"></div><div class="line"> &#125;    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomResult</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Lyn$ <span class="keyword">node</span> <span class="title">client04</span>.js</div><div class="line">sending message message1</div><div class="line">finished sending message1, result is: <span class="number">9289228790</span></div><div class="line">[Error: whoops!]</div></pre></td></tr></table></figure>
<hr>
<h2 id="Limiting_parallel_opreations_using_async-eachLimit_and_async-mapLimit">Limiting parallel opreations using async.eachLimit and async.mapLimit</h2><p>send_all05.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = sendAll;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendAll</span>(<span class="params">messages,cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">async</span>.mapLimit(messages,<span class="number">1</span>, send, cb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sending message %s'</span>, message);</div><div class="line">	setTimeout(finished, randomTimeout(), <span class="literal">null</span>,randomResult());</div><div class="line"> 	</div><div class="line"> 	<span class="function"><span class="keyword">function</span> <span class="title">finished</span>(<span class="params">err, result</span>)</span>&#123;</div><div class="line"> 		<span class="built_in">console</span>.log(<span class="string">'finished sending %s, result is:'</span>, message, result);</div><div class="line"> 		cb(err, result);</div><div class="line"> 	&#125;</div><div class="line"></div><div class="line"> &#125;    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomResult</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</div><div class="line">	</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = sendAll;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendAll</span>(<span class="params">messages,cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">async</span>.mapLimit(messages,<span class="number">1</span>, send, cb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message,cb</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sending message %s'</span>, message);</div><div class="line">	setTimeout(finished, randomTimeout(), <span class="literal">null</span>,randomResult());</div><div class="line"> 	</div><div class="line"> 	<span class="function"><span class="keyword">function</span> <span class="title">finished</span>(<span class="params">err, result</span>)</span>&#123;</div><div class="line"> 		<span class="built_in">console</span>.log(<span class="string">'finished sending %s, result is:'</span>, message, result);</div><div class="line"> 		cb(err, result);</div><div class="line"> 	&#125;</div><div class="line"></div><div class="line"> &#125;    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomResult</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>running results:<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// async.mapLimit(messages,1, send, cb)</span></div><div class="line">node client05.js </div><div class="line">sending <span class="keyword">message</span> message1</div><div class="line">finished sending message1, result <span class="keyword">is</span>: <span class="number">5214791572</span></div><div class="line">sending <span class="keyword">message</span> message2</div><div class="line">finished sending message2, result <span class="keyword">is</span>: <span class="number">7899478934</span></div><div class="line">sending <span class="keyword">message</span> message3</div><div class="line">finished sending message3, result <span class="keyword">is</span>: <span class="number">4825203265</span></div><div class="line">sending <span class="keyword">message</span> message4</div><div class="line">finished sending message4, result <span class="keyword">is</span>: <span class="number">3875634921</span></div><div class="line">sending <span class="keyword">message</span> message5</div><div class="line">finished sending message5, result <span class="keyword">is</span>: <span class="number">2315958645</span></div><div class="line">sending <span class="keyword">message</span> message6</div><div class="line">finished sending message6, result <span class="keyword">is</span>: <span class="number">9344773869</span></div><div class="line">all messages send,results: <span class="number">5214791572</span>,<span class="number">7899478934</span>,<span class="number">4825203265</span>,<span class="number">3875634921</span>,<span class="number">2315958645</span>,<span class="number">9344773869</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// async.mapLimit(messages,2, send, cb)</span></div><div class="line">node client05.js</div><div class="line">sending <span class="keyword">message</span> message1</div><div class="line">sending <span class="keyword">message</span> message2</div><div class="line">finished sending message1, result <span class="keyword">is</span>: <span class="number">7242625339</span></div><div class="line">sending <span class="keyword">message</span> message3</div><div class="line">finished sending message3, result <span class="keyword">is</span>: <span class="number">8989950458</span></div><div class="line">sending <span class="keyword">message</span> message4</div><div class="line">finished sending message2, result <span class="keyword">is</span>: <span class="number">5234759687</span></div><div class="line">sending <span class="keyword">message</span> message5</div><div class="line">finished sending message5, result <span class="keyword">is</span>: <span class="number">8056981025</span></div><div class="line">sending <span class="keyword">message</span> message6</div><div class="line">finished sending message4, result <span class="keyword">is</span>: <span class="number">1524076925</span></div><div class="line">finished sending message6, result <span class="keyword">is</span>: <span class="number">5004728934</span></div><div class="line">all messages send,results: <span class="number">7242625339</span>,<span class="number">5234759687</span>,<span class="number">8989950458</span>,<span class="number">1524076925</span>,<span class="number">8056981025</span>,<span class="number">5004728934</span></div></pre></td></tr></table></figure></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/04/nodejs-note-19/" itemprop="url">
                  Asynchronous Programming -06 async.parallel
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-04T00:33:51+08:00" content="2016-02-04">
              2016-02-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/04/nodejs-note-19/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/04/nodejs-note-19/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="parallel(tasks,_[callback])">parallel(tasks, [callback])</h2><p>Run the <code>tasks</code> array of functions in parallel, without waiting until the previous<br>function has completed. If any of the functions pass an error to its<br>callback, the main <code>callback</code> is immediately called with the value of the error.<br>Once the <code>tasks</code> have completed, the results are passed to the final <code>callback</code> as an<br>array.</p>
<p><strong>Note:</strong> <code>parallel</code> is about kicking-off I/O tasks in parallel, not about parallel execution of code.  If your tasks do not use any timers or perform any I/O, they will actually be executed in series.  Any synchronous setup sections for each task will happen one after the other.  JavaScript remains single-threaded.</p>
<p>It is also possible to use an object instead of an array. Each property will be<br>run as a function and the results will be passed to the final <code>callback</code> as an object<br>instead of an array. This can be a more readable way of handling results from parallel.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>tasks</code> - An array or object containing functions to run. Each function is passed<br>a <code>callback(err, result)</code> which it must call on completion with an error <code>err</code><br>(which can be <code>null</code>) and an optional <code>result</code> value.</li>
<li><code>callback(err, results)</code> - An optional callback to run once all the functions<br>have completed successfully. This function gets a results array (or object) containing all<br>the result arguments passed to the task callbacks.</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span>.parallel([</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            callback(<span class="literal">null</span>, <span class="string">'one'</span>);</div><div class="line">        &#125;, <span class="number">200</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            callback(<span class="literal">null</span>, <span class="string">'two'</span>);</div><div class="line">        &#125;, <span class="number">100</span>);</div><div class="line">    &#125;</div><div class="line">],</div><div class="line"><span class="comment">// optional callback</span></div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">    <span class="comment">// the results array will equal ['one','two'] even though</span></div><div class="line">    <span class="comment">// the second function had a shorter timeout.</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// an example using an object instead of an array</span></div><div class="line"><span class="keyword">async</span>.parallel(&#123;</div><div class="line">    <span class="attr">one</span>: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            callback(<span class="literal">null</span>, <span class="number">1</span>);</div><div class="line">        &#125;, <span class="number">200</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">two</span>: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            callback(<span class="literal">null</span>, <span class="number">2</span>);</div><div class="line">        &#125;, <span class="number">100</span>);</div><div class="line">    &#125;</div><div class="line">&#125;,</div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</div><div class="line">    <span class="comment">// results is now equals to: &#123;one: 1, two: 2&#125;</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="apply_async-parallel_in_our_example">apply async.parallel in our example</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> context;</div><div class="line"></div><div class="line"><span class="keyword">var</span> parallelOperations=[	 </div><div class="line">	fs.mkdir.bind(context, dir),</div><div class="line">	fs.readFile.bind(context, source)</div><div class="line">];</div><div class="line"><span class="keyword">var</span>  opreations = [</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line">		<span class="keyword">async</span>.parallel(parallelOperations, cb);</div><div class="line">	&#125;,</div><div class="line">	extractResult(<span class="number">1</span>),</div><div class="line">	fs.writeFile.bind(context, target)</div><div class="line">];</div><div class="line"> </div><div class="line"><span class="keyword">async</span>.waterfall(opreations, done);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span> (err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractResult</span>(<span class="params">pos</span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">results,callback</span>)</span>&#123;</div><div class="line">		str = results.toString(<span class="string">'utf-8'</span>);</div><div class="line">		<span class="built_in">console</span>.log(str);</div><div class="line">		callback(<span class="literal">null</span>, results[pos]);</div><div class="line">	&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> context;</div><div class="line"></div><div class="line"> </div><div class="line"><span class="keyword">var</span>  opreations = [</div><div class="line">	parallel(</div><div class="line">	fs.mkdir.bind(context, dir),</div><div class="line">	fs.readFile.bind(context, source)),</div><div class="line">	extractResult(<span class="number">1</span>),</div><div class="line">	fs.writeFile.bind(context, target)</div><div class="line">];</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">async</span>.waterfall(opreations, done);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span> (err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">parallel</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> ops = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</div><div class="line">	<span class="comment">//Array.prototype.slice.call(arguments)能将具有length属性的对象转成数组</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line">		<span class="keyword">async</span>.parallel(ops,cb);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractResult</span>(<span class="params">pos</span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">results,callback</span>)</span>&#123;</div><div class="line">		str = results.toString(<span class="string">'utf-8'</span>);</div><div class="line">		<span class="built_in">console</span>.log(str);</div><div class="line">		<span class="comment">//检查结果</span></div><div class="line">		callback(<span class="literal">null</span>, results[pos]);</div><div class="line">	&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/02/03/nodejs-note-18/" itemprop="url">
                  Asynchronous Programming -05 Async.series
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-02-03T12:24:11+08:00" content="2016-02-03">
              2016-02-03
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/03/nodejs-note-18/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/03/nodejs-note-18/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Ordinary_code_form_previous_blog">Ordinary code form previous blog</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname,<span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"></div><div class="line">fs.mkdir(dir, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>)</span>&#123;</div><div class="line">			<span class="keyword">if</span>(err)&#123;</div><div class="line">				handleError(err);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span>&#123;</div><div class="line">				fs.writeFile(target, content, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">				<span class="keyword">if</span>(err)&#123;</div><div class="line"></div><div class="line">					handleError(err);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span>&#123;</div><div class="line">					<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				&#125;);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="aync-series">aync.series</h2><h3 id="series(tasks,_[callback])">series(tasks, [callback])</h3><p>Run the functions in the <code>tasks</code> array in series, each one running once the previous<br>function has completed. If any functions in the series pass an error to its<br>callback, no more functions are run, and <code>callback</code> is immediately called with the value of the error.<br>Otherwise, <code>callback</code> receives an array of results when <code>tasks</code> have completed.</p>
<p>It is also possible to use an object instead of an array. Each property will be<br>run as a function, and the results will be passed to the final <code>callback</code> as an object<br>instead of an array. This can be a more readable way of handling results from<br>series.</p>
<p><strong>Note</strong> that while many implementations preserve the order of object properties, the<br><a href="http://www.ecma-international.org/ecma-262/5.1/#sec-8.6" target="_blank" rel="external">ECMAScript Language Specification</a><br>explicitly states that</p>
<blockquote>
<p>The mechanics and order of enumerating the properties is not specified.</p>
</blockquote>
<p>So if you rely on the order in which your series of functions are executed, and want<br>this to work on all platforms, consider using an array.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><code>tasks</code> - An array or object containing functions to run, each function is passed<br>a <code>callback(err, result)</code> it must call on completion with an error <code>err</code> (which can<br>be <code>null</code>) and an optional <code>result</code> value.</li>
<li><code>callback(err, results)</code> - An optional callback to run once all the functions<br>have completed. This function gets a results array (or object) containing all<br>the result arguments passed to the <code>task</code> callbacks.</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span>.series([</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        <span class="comment">// do some stuff ...</span></div><div class="line">        callback(<span class="literal">null</span>, <span class="string">'one'</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        <span class="comment">// do some more stuff ...</span></div><div class="line">        callback(<span class="literal">null</span>, <span class="string">'two'</span>);</div><div class="line">    &#125;</div><div class="line">],</div><div class="line"><span class="comment">// optional callback</span></div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">    <span class="comment">// results is now equal to ['one', 'two']</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// an example using an object instead of an array</span></div><div class="line"><span class="keyword">async</span>.series(&#123;</div><div class="line">    <span class="attr">one</span>: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            callback(<span class="literal">null</span>, <span class="number">1</span>);</div><div class="line">        &#125;, <span class="number">200</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">two</span>: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            callback(<span class="literal">null</span>, <span class="number">2</span>);</div><div class="line">        &#125;, <span class="number">100</span>);</div><div class="line">    &#125;</div><div class="line">&#125;,</div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</div><div class="line">    <span class="comment">// results is now equal to: &#123;one: 1, two: 2&#125;</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<hr>
<p>01.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> opreations = [</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line">		fs.mkdir(dir,cb)</div><div class="line">	&#125;</div><div class="line">]</div><div class="line"></div><div class="line"> <span class="keyword">async</span>.series(opreations, done);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>02.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> fileContent;</div><div class="line"></div><div class="line"><span class="keyword">var</span> opreations = [</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line">		fs.mkdir(dir,cb);</div><div class="line">		</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span>(<span class="params">err,content</span>)</span>&#123;</div><div class="line">			<span class="keyword">if</span>(err)&#123;</div><div class="line">				cb(err);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span>&#123;</div><div class="line">				fileContent = content;</div><div class="line">				cb();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;,</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line"></div><div class="line">		fs.writeFile(target, fileContent, cb);</div><div class="line">	&#125;</div><div class="line">]</div><div class="line"></div><div class="line"> <span class="keyword">async</span>.series(opreations, done);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>03.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> fileContent;</div><div class="line"><span class="keyword">var</span> fs1;</div><div class="line"></div><div class="line"><span class="keyword">var</span> opreations = [</div><div class="line">	fs.mkdir.bind(fs1,dir),</div><div class="line">	</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span>(<span class="params">err,content</span>)</span>&#123;</div><div class="line">			<span class="keyword">if</span>(err)&#123;</div><div class="line">				cb(err);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span>&#123;</div><div class="line">				fileContent = content;</div><div class="line">				cb();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;,</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line"></div><div class="line">		fs.writeFile(target, fileContent, cb);</div><div class="line">	&#125;</div><div class="line">]</div><div class="line"></div><div class="line"> <span class="keyword">async</span>.series(opreations, done);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>04.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> fileContent;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">async</span>.series([mkdir, read, write], done);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdir</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line">		fs.mkdir(dir,cb);</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line">		fs.readFile(source,<span class="function"><span class="keyword">function</span>(<span class="params">err,content</span>)</span>&#123;</div><div class="line">			<span class="keyword">if</span>(err)&#123;</div><div class="line">				cb(err);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span>&#123;</div><div class="line">				fileContent = content;</div><div class="line">				cb();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">cb</span>)</span>&#123;</div><div class="line"></div><div class="line">		fs.writeFile(target, fileContent, cb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>,results);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">## aync.waterfall</div><div class="line"></div><div class="line">### waterfall(tasks, [callback])</div><div class="line"></div><div class="line">Runs the `tasks` <span class="keyword">array</span> <span class="keyword">of</span> functions <span class="keyword">in</span> series, each passing their results to the next <span class="keyword">in</span></div><div class="line">the <span class="keyword">array</span>. However, <span class="keyword">if</span> any <span class="keyword">of</span> the `tasks` pass an error to their own callback, the</div><div class="line">next <span class="keyword">function</span> <span class="title">is</span> not executed, and the main `callback` <span class="keyword">is</span> immediately called <span class="keyword">with</span></div><div class="line">the error.</div><div class="line"></div><div class="line">__Arguments__</div><div class="line"></div><div class="line">* `tasks` - An <span class="keyword">array</span> <span class="keyword">of</span> functions to run, each <span class="keyword">function</span> <span class="title">is</span> passed a</div><div class="line">  `callback(err, result1, result2, ...)` it must call on completion. The first</div><div class="line">  argument <span class="keyword">is</span> an error (which can be `null`) <span class="keyword">and</span> any further arguments will be</div><div class="line">  passed as arguments <span class="keyword">in</span> order to the next <span class="keyword">task</span>.</div><div class="line">* `callback(err, [results])` - An optional callback to run once <span class="keyword">all</span> the functions</div><div class="line">  have completed. This will be passed the results <span class="keyword">of</span> the last <span class="keyword">task</span><span class="symbol">'s</span> callback.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">__Example__</div><div class="line"></div><div class="line">```js</div><div class="line">async.waterfall([</div><div class="line">    <span class="keyword">function</span>(callback) &#123;</div><div class="line">        callback(null, <span class="symbol">'one</span>', <span class="symbol">'two</span>');</div><div class="line">    &#125;,</div><div class="line">    <span class="keyword">function</span>(arg1, arg2, callback) &#123;</div><div class="line">      // arg1 now equals <span class="symbol">'one</span>' <span class="keyword">and</span> arg2 now equals <span class="symbol">'two</span>'</div><div class="line">        callback(null, <span class="symbol">'three</span>');</div><div class="line">    &#125;,</div><div class="line">    <span class="keyword">function</span>(arg1, callback) &#123;</div><div class="line">        // arg1 now equals <span class="symbol">'three</span>'</div><div class="line">        callback(null, <span class="symbol">'done</span>');</div><div class="line">    &#125;</div><div class="line">], <span class="keyword">function</span> <span class="title"></span>(err, result) &#123;</div><div class="line">    // result now equals 'done'</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Or, with named functions:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span>.waterfall([</div><div class="line">    myFirstFunction,</div><div class="line">    mySecondFunction,</div><div class="line">    myLastFunction,</div><div class="line">], <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</div><div class="line">    <span class="comment">// result now equals 'done'</span></div><div class="line">&#125;);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFirstFunction</span>(<span class="params">callback</span>) </span>&#123;</div><div class="line">    callback(<span class="literal">null</span>, <span class="string">'one'</span>, <span class="string">'two'</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mySecondFunction</span>(<span class="params">arg1, arg2, callback</span>) </span>&#123;</div><div class="line">    <span class="comment">// arg1 now equals 'one' and arg2 now equals 'two'</span></div><div class="line">    callback(<span class="literal">null</span>, <span class="string">'three'</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myLastFunction</span>(<span class="params">arg1, callback</span>) </span>&#123;</div><div class="line">    <span class="comment">// arg1 now equals 'three'</span></div><div class="line">    callback(<span class="literal">null</span>, <span class="string">'done'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Or, if you need to pass any argument to the first function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span>.waterfall([</div><div class="line">    <span class="keyword">async</span>.apply(myFirstFunction, <span class="string">'zero'</span>),</div><div class="line">    mySecondFunction,</div><div class="line">    myLastFunction,</div><div class="line">], <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</div><div class="line">    <span class="comment">// result now equals 'done'</span></div><div class="line">&#125;);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFirstFunction</span>(<span class="params">arg1, callback</span>) </span>&#123;</div><div class="line">    <span class="comment">// arg1 now equals 'zero'</span></div><div class="line">    callback(<span class="literal">null</span>, <span class="string">'one'</span>, <span class="string">'two'</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mySecondFunction</span>(<span class="params">arg1, arg2, callback</span>) </span>&#123;</div><div class="line">    <span class="comment">// arg1 now equals 'one' and arg2 now equals 'two'</span></div><div class="line">    callback(<span class="literal">null</span>, <span class="string">'three'</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myLastFunction</span>(<span class="params">arg1, callback</span>) </span>&#123;</div><div class="line">    <span class="comment">// arg1 now equals 'three'</span></div><div class="line">    callback(<span class="literal">null</span>, <span class="string">'done'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>05.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"><span class="comment">//var fileContent;</span></div><div class="line"> </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span>  opreations = [</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">		fs.mkdir(dir,callback);</div><div class="line">		</div><div class="line">		</div><div class="line">	&#125;,</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line"></div><div class="line">		fs.readFile(source,&#123;<span class="attr">encoding</span>:<span class="string">'utf8'</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">			callback(<span class="literal">null</span>,results);</div><div class="line">		&#125;);</div><div class="line">	&#125;,</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">results,callback</span>)</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(results);</div><div class="line">		callback(<span class="literal">null</span>, results);</div><div class="line">	&#125;,</div><div class="line">	<span class="function"><span class="keyword">function</span>(<span class="params">fileContent,callback</span>)</span>&#123;</div><div class="line">		fs.writeFile(target, fileContent);</div><div class="line">		callback(<span class="literal">null</span>);</div><div class="line">	&#125;</div><div class="line">	 </div><div class="line">];</div><div class="line"> </div><div class="line"><span class="keyword">async</span>.waterfall(opreations, done);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span> (err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> dir = path.join(__dirname, <span class="string">'temp'</span>);</div><div class="line"><span class="keyword">var</span> source = __filename;</div><div class="line"><span class="keyword">var</span> target = path.join(dir, <span class="string">'target'</span>);</div><div class="line"><span class="keyword">var</span> context;</div><div class="line"> </div><div class="line"><span class="keyword">var</span>  opreations = [</div><div class="line">	fs.mkdir.bind(context, dir),</div><div class="line">	fs.readFile.bind(context, source),</div><div class="line">	fs.writeFile.bind(context, target)</div><div class="line">];</div><div class="line"> </div><div class="line"><span class="keyword">async</span>.waterfall(opreations, done);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span> (err)&#123;</div><div class="line">		handleError(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all done'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/26/nodejs-note-17/" itemprop="url">
                  Asynchronous Programming -04 Coordinating series Calls
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-26T02:38:42+08:00" content="2016-01-26">
              2016-01-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/26/nodejs-note-17/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/26/nodejs-note-17/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> eachAsyncSeries = <span class="built_in">require</span>(<span class="string">'./eachAsyncSeries'</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</div><div class="line"></div><div class="line">eachAsyncSeries(messages,send,done);</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.error(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</div><div class="line">	setTimeout(cb, randomTimeout(), err);</div><div class="line">	</div><div class="line">	<span class="keyword">if</span>(!err)&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">' handling: %s'</span>,   message);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports =eachAsyncSeries;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">eachAsyncSeries</span>(<span class="params">collection, iterate, cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> pending = collection.slice();</div><div class="line"></div><div class="line">	next();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">if</span>(! pending.length)&#123;</div><div class="line">			cb();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span>&#123;</div><div class="line">			<span class="built_in">console</span>.log(<span class="string">'pending messages:'</span>, pending);</div><div class="line">			iterate(pending.shift(),iterated);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">iterated</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">		<span class="keyword">if</span>(err)&#123;</div><div class="line">			cb(err);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span>&#123;</div><div class="line">			next();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="running_results:">running results:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</div><div class="line"><span class="string">handling:</span> message1</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</div><div class="line">[<span class="string">Error:</span> whaaa]</div><div class="line"></div><div class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</div><div class="line"><span class="string">handling:</span> message1</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</div><div class="line"><span class="string">handling:</span> message2</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message3'</span> ]</div><div class="line"><span class="string">handling:</span> message3</div><div class="line">all messages sent</div><div class="line"></div><div class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main.js</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</div><div class="line">[<span class="string">Error:</span> whaaa]</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mapAsyncSeries = <span class="built_in">require</span>(<span class="string">'./mapAsyncSeries'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> messages = [<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</div><div class="line"><span class="keyword">var</span> index= <span class="number">0</span>;</div><div class="line"></div><div class="line">mapAsyncSeries(messages,send,done);</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.error(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent, results'</span>, results);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</div><div class="line">	<span class="keyword">var</span> value = ++index;</div><div class="line"></div><div class="line">	setTimeout(cb, randomTimeout(), err, value);</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(!err)&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">' handling: %s'</span>,  message);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = mapAsyncSeries;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapAsyncSeries</span>(<span class="params">collection, map, cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> pending = collection.slice();</div><div class="line">	<span class="keyword">var</span> results = [];</div><div class="line"></div><div class="line">	next();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">if</span>(! pending.length)&#123;</div><div class="line">			cb(<span class="literal">null</span>, results);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span>&#123;</div><div class="line">			<span class="built_in">console</span>.log(<span class="string">'pending messages:'</span>,pending);</div><div class="line">			map(pending.shift(),mapped);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">mapped</span>(<span class="params">err, result</span>)</span>&#123;</div><div class="line"></div><div class="line">		results.push(result);</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(err)&#123;</div><div class="line">			cb(err);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span>&#123;</div><div class="line">			next();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="running_results:-1">running results:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main01.js</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</div><div class="line"><span class="string">handling:</span> message1</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</div><div class="line"><span class="string">handling:</span> message2</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message3'</span> ]</div><div class="line"><span class="string">handling:</span> message3</div><div class="line">all messages sent, results [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</div><div class="line"></div><div class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main01.js</div><div class="line">pending <span class="string">messages:</span> [ <span class="string">'message1'</span>, <span class="string">'message2'</span>, <span class="string">'message3'</span> ]</div><div class="line">[<span class="string">Error:</span> whaaa]</div></pre></td></tr></table></figure>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">module.exports = mapAsyncLimit;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapAsyncLimit</span><span class="params">(limit, collection, map, cb)</span></span>&#123;</div><div class="line">	<span class="keyword">var</span> pos = <span class="number">0</span>;</div><div class="line">	<span class="keyword">var</span> pending = <span class="number">0</span>; </div><div class="line">	<span class="keyword">var</span> results = [];</div><div class="line">	<span class="keyword">var</span> calledback = <span class="literal">false</span>;</div><div class="line"></div><div class="line">	next();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">if</span>(pos &gt;= collection.length)&#123;</div><div class="line">			<span class="keyword">if</span>(!pending)&#123;</div><div class="line">				<span class="keyword">callback</span>(<span class="literal">null</span>, results);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125; <span class="keyword">else</span>&#123;</div><div class="line">			pending++;</div><div class="line">			map(collection[pos],mapping(pos));</div><div class="line">			pos++</div><div class="line">			next();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">mapping</span><span class="params">(pos)</span></span>&#123;</div><div class="line">		</div><div class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">mapped</span><span class="params">(err, result)</span></span>&#123;</div><div class="line"></div><div class="line">		pending --;</div><div class="line">		console.log(<span class="string">'handling:'</span>,collection[pos]);</div><div class="line">		results[pos]=result;</div><div class="line">		<span class="keyword">if</span>(err)&#123;</div><div class="line">			<span class="keyword">callback</span>(err);</div><div class="line">		&#125; <span class="keyword">else</span>&#123;</div><div class="line">			next();</div><div class="line">		&#125;</div><div class="line"></div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err, results)</span></span>&#123;</div><div class="line">		<span class="keyword">if</span>(! calledback)&#123;</div><div class="line"></div><div class="line">			calledback = <span class="literal">true</span>;</div><div class="line">			cb(err, results);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mapAsyncLimit = <span class="built_in">require</span>(<span class="string">'./mapAsyncLimit'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> messages = [</div><div class="line">	<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>,</div><div class="line">	<span class="string">'message4'</span>,<span class="string">'message5'</span>,<span class="string">'message6'</span></div><div class="line">	];</div><div class="line"></div><div class="line"><span class="keyword">var</span> index= <span class="number">0</span>;</div><div class="line"></div><div class="line">mapAsyncLimit(<span class="number">1</span>,messages,send,done);</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.error(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent, results'</span>, results);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.9</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</div><div class="line">	<span class="keyword">var</span> value = ++index;</div><div class="line"></div><div class="line">	setTimeout(cb, randomTimeout(), err, value);</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(!err)&#123;</div><div class="line">		<span class="comment">//console.log('handling: %s',  message);</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="runnning_result:">runnning result:</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main02.js</div><div class="line"><span class="string">handling:</span> message5</div><div class="line"><span class="string">handling:</span> message3</div><div class="line"><span class="string">handling:</span> message4</div><div class="line"><span class="string">handling:</span> message2</div><div class="line"><span class="string">handling:</span> message1</div><div class="line"><span class="string">handling:</span> message6</div><div class="line">all messages sent, results [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span> ]</div><div class="line"></div><div class="line">Lyn-Cheung-<span class="string">MBP:</span><span class="number">04</span> Lyn$ node main02.js</div><div class="line"><span class="string">handling:</span> message3</div><div class="line"><span class="string">handling:</span> message2</div><div class="line"><span class="string">handling:</span> message1</div><div class="line"><span class="string">handling:</span> message5</div><div class="line"><span class="string">handling:</span> message6</div><div class="line"><span class="string">handling:</span> message4</div><div class="line">[<span class="string">Error:</span> whaaa]</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/24/nodejs-note-16/" itemprop="url">
                  Asynchronous Programming -03 Mapping result
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-24T13:01:26+08:00" content="2016-01-24">
              2016-01-24
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/24/nodejs-note-16/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/24/nodejs-note-16/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> eachAsync = <span class="built_in">require</span>(<span class="string">'./each_async'</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</div><div class="line"></div><div class="line">eachAsync(messages,send,done);</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.error(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent'</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// random error will occour</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> err= <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</div><div class="line">	setTimeout(cb, randomTimeout(), err);</div><div class="line">	<span class="keyword">if</span>(!err)&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">' elem is %s'</span>,   message);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>eachAsync.js</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">module.exports = eachAsync;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">eachAsync</span><span class="params">(collection, iterate,  cb)</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">var</span> pending = collection.length;</div><div class="line">		<span class="keyword">var</span> calledback = <span class="literal">false</span>;</div><div class="line"></div><div class="line">		collection.forEach(<span class="function"><span class="keyword">function</span><span class="params">(elem)</span></span>&#123;</div><div class="line">		iterate(elem, terminated);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">terminated</span><span class="params">(err)</span></span>&#123;</div><div class="line"></div><div class="line">		pending --;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(err)&#123;</div><div class="line">			<span class="keyword">callback</span>(err);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(! pending)&#123;</div><div class="line">			<span class="keyword">callback</span>();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err)</span></span>&#123;</div><div class="line">		<span class="keyword">if</span>(! calledback)&#123;</div><div class="line">			calledback = <span class="literal">true</span>;</div><div class="line">			cb(err);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Running results:</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Lyn-Cheung-MBP:<span class="number">03</span> Lyn$ node main.js</div><div class="line"> <span class="built_in">elem</span> <span class="built_in">is</span> message1</div><div class="line"> <span class="built_in">elem</span> <span class="built_in">is</span> message2</div><div class="line"> <span class="built_in">elem</span> <span class="built_in">is</span> message3</div><div class="line">all messages sent</div><div class="line">Lyn-Cheung-MBP:<span class="number">03</span> Lyn$ node main.js</div><div class="line"> <span class="built_in">elem</span> <span class="built_in">is</span> message2</div><div class="line"> <span class="built_in">elem</span> <span class="built_in">is</span> message3</div><div class="line">[Error: whaaa]</div></pre></td></tr></table></figure>
<p>Main01.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mapAsync = <span class="built_in">require</span>(<span class="string">'./map_async'</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> messages =[<span class="string">'message1'</span>,<span class="string">'message2'</span>,<span class="string">'message3'</span>];</div><div class="line"></div><div class="line"><span class="keyword">var</span> index = <span class="number">0</span> ;</div><div class="line">mapAsync(messages,send,done);</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err, results</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.error(err);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'all messages sent,result:'</span>, results);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// random error will occour</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">message, cb</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> err = <span class="built_in">Math</span>.random()&gt;<span class="number">0.8</span> ? <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'whaaa'</span>) : <span class="literal">null</span>;</div><div class="line">	<span class="keyword">var</span> result = ++index;</div><div class="line">	setTimeout(cb, randomTimeout(), err, result);</div><div class="line">	<span class="keyword">if</span>(!err)&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'index is %s, elem is %s'</span>, index, message);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mapAsync.js</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">module.exports = mapAsync;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">mapAsync</span><span class="params">(collection, map,  cb)</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">var</span> results = [];</div><div class="line">		<span class="keyword">var</span> pending = collection.length;</div><div class="line">		<span class="keyword">var</span> calledback = <span class="literal">false</span>;</div><div class="line"></div><div class="line">		collection.forEach(<span class="function"><span class="keyword">function</span><span class="params">(elem, index)</span></span>&#123;</div><div class="line">		map(elem, terminating(index));</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">terminating</span><span class="params">(index)</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">terminated</span><span class="params">(err, result)</span></span>&#123;</div><div class="line"></div><div class="line">		pending --;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(err)&#123;</div><div class="line">			<span class="keyword">callback</span>(err);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span>&#123;</div><div class="line">			results[index] = result;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span>(! pending)&#123;</div><div class="line">			<span class="keyword">callback</span>(<span class="literal">null</span>, results);</div><div class="line">				&#125;</div><div class="line">			&#125; </div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err, results)</span></span>&#123;</div><div class="line">		<span class="keyword">if</span>(! calledback)&#123;</div><div class="line">			calledback = <span class="literal">true</span>;</div><div class="line">			cb(err, results);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Running results:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Lyn-Cheung-MBP:<span class="number">03</span> Lyn$ node main01.js</div><div class="line"><span class="built_in">index</span> <span class="keyword">is</span> <span class="number">1</span>, elem <span class="keyword">is</span> message1</div><div class="line"><span class="built_in">index</span> <span class="keyword">is</span> <span class="number">2</span>, elem <span class="keyword">is</span> message2</div><div class="line"><span class="built_in">index</span> <span class="keyword">is</span> <span class="number">3</span>, elem <span class="keyword">is</span> message3</div><div class="line"><span class="keyword">all</span> <span class="keyword">messages</span> sent,resul<span class="variable">t:</span> [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</div><div class="line">Lyn-Cheung-MBP:<span class="number">03</span> Lyn$ node main01.js</div><div class="line"><span class="built_in">index</span> <span class="keyword">is</span> <span class="number">1</span>, elem <span class="keyword">is</span> message1</div><div class="line"><span class="built_in">index</span> <span class="keyword">is</span> <span class="number">2</span>, elem <span class="keyword">is</span> message2</div><div class="line"><span class="built_in">index</span> <span class="keyword">is</span> <span class="number">3</span>, elem <span class="keyword">is</span> message3</div><div class="line">[Error: whaaa]</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2016/01/22/nodejs-note-15/" itemprop="url">
                  Asynchronous Programming - 02 Coordinating Parallel Calls
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2016-01-22T19:10:47+08:00" content="2016-01-22">
              2016-01-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/22/nodejs-note-15/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/22/nodejs-note-15/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Coordinating_Parallel_Calls">Coordinating Parallel Calls</h1><p>composedCall.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">composedCall</span>(<span class="params">args, cb</span>)</span>&#123;</div><div class="line">	call1(args,handlingError(<span class="function"><span class="keyword">function</span>(<span class="params">result1</span>)</span>&#123;</div><div class="line">		call2(args, handlingError(<span class="function"><span class="keyword">function</span>(<span class="params">result2</span>)</span>&#123;</div><div class="line">			call3(args, handlingError(<span class="function"><span class="keyword">function</span>(<span class="params">result3</span>)</span>&#123;</div><div class="line">				cb(<span class="literal">null</span>,[result1, result2, result3])</div><div class="line"></div><div class="line">			&#125;));</div><div class="line">		&#125;));</div><div class="line">	&#125;));</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlingError</span>(<span class="params">fn</span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>)</span>&#123;</div><div class="line">		<span class="keyword">if</span> (err)&#123;</div><div class="line">			cb(err);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			fn(result);  </div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;;</div><div class="line">&#125;	</div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">call1</span>(<span class="params">args, cb</span>)</span>&#123;</div><div class="line">	setTimeout(cb,randomTimeout(), <span class="literal">null</span>, randomValue());</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">call2</span>(<span class="params">args, cb</span>)</span>&#123;</div><div class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomValue());</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">call3</span>(<span class="params">args, cb</span>)</span>&#123;</div><div class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomValue());</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e3</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomValue</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e10</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> operation = <span class="built_in">require</span>(<span class="string">'./composedCall'</span>);</div><div class="line"></div><div class="line">operation(&#123;<span class="attr">some</span>:<span class="string">'args'</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		<span class="built_in">console</span>.log(err);</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'successful result:'</span>, result);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Make this function run in parallel.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">composedCall</span>(<span class="params">args, cb</span>)</span>&#123;</div><div class="line">	 </div><div class="line">	<span class="keyword">var</span> pending = <span class="number">0</span> ;</div><div class="line">	<span class="keyword">var</span> results =[] ;</div><div class="line">	<span class="keyword">var</span> calledback = <span class="literal">false</span> ;</div><div class="line"></div><div class="line"><span class="comment">// Call function with call id.</span></div><div class="line"></div><div class="line">	call1(args, handleResult(<span class="number">1</span>));</div><div class="line">	call2(args, handleResult(<span class="number">2</span>));</div><div class="line">	call3(args, handleResult(<span class="number">3</span>));</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Insert value into  array by order. </span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleResult</span>(<span class="params">id</span>)</span>&#123;</div><div class="line">	 </div><div class="line">	 <span class="keyword">var</span> order = pending;</div><div class="line">	 pending ++;</div><div class="line">	</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'Call id is: %s, order: %s,  pending value is: %s.'</span>,id,order,pending);</div><div class="line"> </div><div class="line"></div><div class="line">	 <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>)</span>&#123;</div><div class="line"></div><div class="line">	 	pending--;</div><div class="line"></div><div class="line">	 	<span class="keyword">if</span> (err)&#123;</div><div class="line">	 		callback(err);</div><div class="line">	 	&#125;</div><div class="line">	 	<span class="keyword">else</span>&#123;</div><div class="line">	 		results[order] =result;</div><div class="line">	 		</div><div class="line">	 		<span class="built_in">console</span>.log(<span class="string">'Call id is: %s, order: %s, Pending value is: %s, results now is: %s. '</span>, id,   order, pending, results);</div><div class="line">	 		</div><div class="line">	 		<span class="keyword">if</span> (! pending)&#123;</div><div class="line">	 		callback(<span class="literal">null</span>, results);</div><div class="line">	 		&#125;</div><div class="line">	 	&#125;</div><div class="line">	 &#125;;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">// Check the calledback value, Make sure cb function will be called only once</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">err, value</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(! calledback)&#123;</div><div class="line">		calledback = <span class="literal">true</span>;</div><div class="line">		cb(err, value);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">call1</span>(<span class="params">args, cb</span>)</span>&#123;</div><div class="line">	setTimeout(cb,randomTimeout(), <span class="literal">null</span>, randomValue());</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">call2</span>(<span class="params">args, cb</span>)</span>&#123;</div><div class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomValue());</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">call3</span>(<span class="params">args, cb</span>)</span>&#123;</div><div class="line">	setTimeout(cb, randomTimeout(), <span class="literal">null</span>,randomValue());</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomTimeout</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e3</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomValue</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1e10</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Run this code to check the running process:</p>
<p>because it is running parallel, therefore the sequence is random. </p>
<p>however,  we use order value to keep the array in the right order.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Lyn-Cheung-MBP:02 Lyn$ node main.js</div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">1</span>, <span class="keyword">order</span>: <span class="number">0</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">1.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">2</span>, <span class="keyword">order</span>: <span class="number">1</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">2.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">3</span>, <span class="keyword">order</span>: <span class="number">2</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">3.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">1</span>, <span class="keyword">order</span>: <span class="number">0</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">2</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: <span class="number">2632852697.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">3</span>, <span class="keyword">order</span>: <span class="number">2</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">1</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: <span class="number">2632852697</span>,,<span class="number">1775016640.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">2</span>, <span class="keyword">order</span>: <span class="number">1</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">0</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: <span class="number">2632852697</span>,<span class="number">2485099832</span>,<span class="number">1775016640.</span></div><div class="line">successful <span class="keyword">result</span>: [ <span class="number">2632852697</span>, <span class="number">2485099832</span>, <span class="number">1775016640</span> ]</div><div class="line"></div><div class="line">Lyn-Cheung-MBP:<span class="number">02</span> Lyn$ node main.js</div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">1</span>, <span class="keyword">order</span>: <span class="number">0</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">1.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">2</span>, <span class="keyword">order</span>: <span class="number">1</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">2.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">3</span>, <span class="keyword">order</span>: <span class="number">2</span>,  pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">3.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">2</span>, <span class="keyword">order</span>: <span class="number">1</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">2</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: ,<span class="number">7063975371.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">3</span>, <span class="keyword">order</span>: <span class="number">2</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">1</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: ,<span class="number">7063975371</span>,<span class="number">3080169013.</span></div><div class="line"><span class="keyword">Call</span> <span class="keyword">id</span> <span class="keyword">is</span>: <span class="number">1</span>, <span class="keyword">order</span>: <span class="number">0</span>, Pending <span class="keyword">value</span> <span class="keyword">is</span>: <span class="number">0</span>, results <span class="keyword">now</span> <span class="keyword">is</span>: <span class="number">1889156524</span>,<span class="number">7063975371</span>,<span class="number">3080169013.</span></div><div class="line">successful <span class="keyword">result</span>: [ <span class="number">1889156524</span>, <span class="number">7063975371</span>, <span class="number">3080169013</span> ]</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/author.png" alt="Lyn's Blog" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Lyn's Blog</p>
        </div>
        <p class="site-description motion-element" itemprop="description">Lyn's Blog about Node.js  Express.js Angular.js HTML5 Mongodb Programing Notes</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">57</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lyn's Blog</span>
</div>

<div class="powered-by">
  <a class="theme-link" href="http://hexo.io">Powered by Hexo
  </a>
</div>

<div class="theme-info">
  
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>

</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-lyn"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
